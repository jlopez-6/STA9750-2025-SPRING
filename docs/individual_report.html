<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Money Talks: Connecticut’s Real Estate Market – STA9750 Submission Material</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-5732d83e2b6a4d0ea9313647c5a03cb2.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">STA9750 Submission Material</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./mp01.html"> 
<span class="menu-text">CATS Payroll Report</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./mp02.html"> 
<span class="menu-text">GTA IV 2025 Greenies</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./mp03.html"> 
<span class="menu-text">The Ultimate Playlist</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./mp04.html"> 
<span class="menu-text">Political Paradigm Shift</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./about.html"> 
<span class="menu-text">About Me</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#data-acquisition" id="toc-data-acquisition" class="nav-link" data-scroll-target="#data-acquisition">Data Acquisition</a>
  <ul class="collapse">
  <li><a href="#connecticut-town-to-county-mapping" id="toc-connecticut-town-to-county-mapping" class="nav-link" data-scroll-target="#connecticut-town-to-county-mapping">Connecticut Town-to-County Mapping</a></li>
  <li><a href="#connecticut-real-estate-sales" id="toc-connecticut-real-estate-sales" class="nav-link" data-scroll-target="#connecticut-real-estate-sales">Connecticut Real Estate Sales</a></li>
  <li><a href="#gdp-by-county" id="toc-gdp-by-county" class="nav-link" data-scroll-target="#gdp-by-county">GDP by County</a></li>
  <li><a href="#income-by-county" id="toc-income-by-county" class="nav-link" data-scroll-target="#income-by-county">Income by County</a></li>
  <li><a href="#unemployment" id="toc-unemployment" class="nav-link" data-scroll-target="#unemployment">Unemployment</a></li>
  <li><a href="#municipal-financial-indicators" id="toc-municipal-financial-indicators" class="nav-link" data-scroll-target="#municipal-financial-indicators">Municipal Financial Indicators</a></li>
  </ul></li>
  <li><a href="#merging" id="toc-merging" class="nav-link" data-scroll-target="#merging">Merging</a></li>
  <li><a href="#main-statistical-analysis" id="toc-main-statistical-analysis" class="nav-link" data-scroll-target="#main-statistical-analysis">Main Statistical Analysis</a>
  <ul class="collapse">
  <li><a href="#box-cox-transformations" id="toc-box-cox-transformations" class="nav-link" data-scroll-target="#box-cox-transformations">Box-Cox Transformations</a></li>
  <li><a href="#correlation-matrix" id="toc-correlation-matrix" class="nav-link" data-scroll-target="#correlation-matrix">Correlation Matrix</a></li>
  <li><a href="#backwards-elimination" id="toc-backwards-elimination" class="nav-link" data-scroll-target="#backwards-elimination">Backwards Elimination</a></li>
  <li><a href="#model-validation" id="toc-model-validation" class="nav-link" data-scroll-target="#model-validation">Model Validation</a>
  <ul class="collapse">
  <li><a href="#coefficient-of-determination" id="toc-coefficient-of-determination" class="nav-link" data-scroll-target="#coefficient-of-determination">Coefficient of Determination</a></li>
  <li><a href="#residual-plots" id="toc-residual-plots" class="nav-link" data-scroll-target="#residual-plots">Residual Plots</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Money Talks: Connecticut’s Real Estate Market</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
<p class="subtitle lead">Exploring the Economic Drivers of Housing Prices Using Machine Learning</p>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>This work is part of a final course project, where my teammates, <a href="https://allcr.github.io/STA9750-2025-SPRING/about.html">Craig</a>, and <a href="https://hongzhuang1.github.io/STA9750-2025-SPRING/">Hong</a>, and I explored what factors drive real estate prices in Connecticut. To narrow down such a broad question, we split it into three subquestions, each focused on a key meta-factor: the local economy, <a href="">education quality</a>, and <a href="">public transit accessibility</a>. I was randomly assigned the question: How strongly does Connecticut’s real estate market correlate with economic growth? To answer it, I built a random forest model that predicts the median sale price of a home in Connecticut using county-level economic indicators. This page documents the technical details of the analysis, including data acquisition, cleaning, exploratory data analysis, and the modeling process. It provides reproducible code snippets and explanations to illustrate how the random forest model was developed and evaluated using county-level economic data.</p>
<p>The analysis in this project was completed with R and selected packages<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>, and with Python and selected packages<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>.</p>
</section>
<section id="data-acquisition" class="level1">
<h1>Data Acquisition</h1>
<p>The data acquisition part of this project gave me a chance to put into practice the responsible data intake skills we covered in class and applied in Mini-Projects <a href="https://jlopez-6.github.io/STA9750-2025-SPRING/mp03.html">03</a> and <a href="https://jlopez-6.github.io/STA9750-2025-SPRING/mp04.html">04</a>. As usual, the process began with loading the necessary packages and setting some global constants. To make the setup cleaner, I wrote a helper function, <code>load_if_needed()</code> that installs and loads the R packages used in this analysis.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Load a package, installing it if necessary.</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param pkg A character string naming the package to load.</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return Invisibly returns TRUE if the package is successfully loaded.</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' load_if_needed("dplyr")</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>load_if_needed <span class="ot">&lt;-</span> <span class="cf">function</span>(pkg) {</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(pkg, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">install.packages</span>(pkg)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">suppressPackageStartupMessages</span>(<span class="fu">library</span>(pkg, <span class="at">character.only =</span> <span class="cn">TRUE</span>))</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>PACKAGES <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"readr"</span>, <span class="st">"dplyr"</span>, <span class="st">"stringr"</span>, <span class="st">"rvest"</span>, <span class="st">"httr"</span>, <span class="st">"jsonlite"</span>,</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>              <span class="st">"lubridate"</span>, <span class="st">"tidyr"</span>, <span class="st">"janitor"</span>, <span class="st">"purrr"</span>, <span class="st">"tidyverse"</span>, <span class="st">"car"</span>,</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>              <span class="st">"randomForest"</span>, <span class="st">"scales"</span>)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(PACKAGES, load_if_needed)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>SEED <span class="ot">&lt;-</span> <span class="dv">1747187262</span> </span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>CORR_THRESHOLD <span class="ot">&lt;-</span> <span class="fl">0.8</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="connecticut-town-to-county-mapping" class="level2">
<h2 class="anchored" data-anchor-id="connecticut-town-to-county-mapping">Connecticut Town-to-County Mapping</h2>
<p>While downloading and cleaning up the various datasets, I noticed that many of the town-level sources didn’t include the county each town belonged to. To fix this, I pulled in the <a href="https://portal.ct.gov/csl?language=en_US">Connecticut State Library’s</a> online list of Connecticut Towns &amp; Counties<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>. This dataset includes all 169 towns, their corresponding counties, year of incorporation, and parent town. I used the code below to download it and merge the county information into the relevant datasets.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Load or download Connecticut town-to-county mapping.</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' Downloads a table mapping Connecticut towns to counties from the Connecticut State Library</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' website if it doesn't already exist locally. Saves the table as a CSV for reuse.</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A data frame with town and county mappings.</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' ct_towns &lt;- load_ct_town_mapping()</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>load_ct_town_mapping <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  target_dir <span class="ot">&lt;-</span> <span class="st">"data/individual_report"</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  f_name <span class="ot">&lt;-</span> <span class="st">"ct_towns.csv"</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  file_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, f_name)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(target_dir)) {</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(target_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(file_path)) {</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Download CT Town &lt;- County mapping</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    url <span class="ot">&lt;-</span> <span class="st">"https://libguides.ctstatelibrary.org/cttowns"</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    webpage <span class="ot">&lt;-</span> <span class="fu">read_html</span>(url)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    tables <span class="ot">&lt;-</span> <span class="fu">html_table</span>(webpage, <span class="at">fill =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    ct_towns_counties <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(tables[[<span class="dv">1</span>]])</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set first row as column names and remove it from data</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(ct_towns_counties) <span class="ot">&lt;-</span> ct_towns_counties[<span class="dv">1</span>, ]</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    ct_towns_counties <span class="ot">&lt;-</span> ct_towns_counties[<span class="sc">-</span><span class="dv">1</span>, ]</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">row.names</span>(ct_towns_counties) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(ct_towns_counties, file_path)</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Reading existing data from CSV..."</span>)</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>    ct_towns_counties <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(file_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(ct_towns_counties)</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="connecticut-real-estate-sales" class="level2">
<h2 class="anchored" data-anchor-id="connecticut-real-estate-sales">Connecticut Real Estate Sales</h2>
<p>The Connecticut Real Estate Sales data set contained sales information about all real estate transactions greater than $2,000 between October 1, 2001 and September 30, 2022. This comprehensive data set was compiled and published by <a href="https://portal.ct.gov/opm">Connecticut’s Office of Policy and Management</a> (CT OPM)<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>. With over 1.09 million records and 20 attributes per transaction, the dats set includes information on the sale amount, the sales ratio, and the property’s assessed value for each transaction. This data set is valuable for researchers looking to explore the spatio-temporal dynamics of Connecticut’s real estate market. The code used to download this data set is included below.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Load and clean Connecticut real estate sales data.</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' Downloads, processes, and saves Connecticut real estate sales data from the CT Open Data portal.</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' If a cleaned version already exists locally, it is loaded directly. Otherwise, the function:</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Downloads raw data (if not already downloaded)</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Cleans and filters the dataset (e.g., removes duplicates, fixes town names, parses dates)</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Merges with town-to-county mapping</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Saves the cleaned data for future use</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A cleaned data frame of real estate sales in Connecticut from 2001–2022.</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="co">#' ct_sales &lt;- load_ct_sales()</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>load_ct_sales <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  target_dir <span class="ot">&lt;-</span> <span class="st">"/Users/jocelylopez/CT-HousingLens/data/individual_report"</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  raw_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, <span class="st">"CT_SALES_raw.csv"</span>)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>  clean_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, <span class="st">"Real_Estate_Sales_2001-2022_GL.csv"</span>)</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(target_dir)){<span class="fu">dir.create</span>(target_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)}</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(clean_file)) {</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Download raw data if needed</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(raw_file)) {</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>      base_url <span class="ot">&lt;-</span> <span class="st">"https://data.ct.gov/resource/5mzw-sjtu.json"</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Since there is a request limit on the API, I will find the count of data</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>      <span class="co"># points so I can override the default limit. </span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>      query <span class="ot">&lt;-</span> <span class="st">"SELECT COUNT(*)"</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>      encoded_query <span class="ot">&lt;-</span> <span class="fu">URLencode</span>(query, <span class="at">reserved =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>      count_query <span class="ot">&lt;-</span> <span class="fu">paste0</span>(base_url, <span class="st">"?$query="</span>, encoded_query)</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>      response <span class="ot">&lt;-</span> <span class="fu">GET</span>(count_query)</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>      count_data <span class="ot">&lt;-</span> <span class="fu">fromJSON</span>(<span class="fu">content</span>(response, <span class="at">as =</span> <span class="st">"text"</span>))</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>      total_count <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(count_data<span class="sc">$</span>COUNT[<span class="dv">1</span>])</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>      base_url <span class="ot">&lt;-</span> <span class="fu">paste0</span>(base_url,<span class="st">"?$limit="</span>, total_count)</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>      response <span class="ot">&lt;-</span> <span class="fu">GET</span>(base_url)</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>      CT_SALES <span class="ot">&lt;-</span> <span class="fu">fromJSON</span>(<span class="fu">content</span>(response, <span class="at">as =</span> <span class="st">"text"</span>)) <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>geo_coordinates) <span class="co">#removing geo_coordinates because it's nested...</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>      <span class="fu">write_csv</span>(<span class="fu">as.data.frame</span>(CT_SALES), raw_file)</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>      CT_SALES <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(raw_file, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clean data</span></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>    ct_sales <span class="ot">&lt;-</span> CT_SALES <span class="sc">|&gt;</span></span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>        <span class="at">serial_number =</span> serialnumber,</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>        <span class="at">list_year =</span> listyear,</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>        <span class="at">date_recorded =</span> daterecorded,</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>        <span class="at">address =</span> address,</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>        <span class="at">assessed_value =</span> assessedvalue,</span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>        <span class="at">sale_amount =</span> saleamount,</span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>        <span class="at">sales_ratio =</span> salesratio,</span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>        <span class="at">property_type =</span> propertytype,</span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>        <span class="at">residential_type =</span> residentialtype,</span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>        <span class="at">non_use_code =</span> nonusecode,</span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>        <span class="at">assessor_remarks =</span> remarks,</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>        <span class="at">opm_remarks =</span> opm_remarks</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(date_recorded), sale_amount <span class="sc">&gt;=</span> <span class="dv">2000</span>) <span class="sc">|&gt;</span></span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>        <span class="at">town =</span> <span class="fu">if_else</span>(town <span class="sc">==</span> <span class="st">"***Unknown***"</span>, <span class="st">"East Hampton"</span>, town),</span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>        <span class="at">address =</span> <span class="fu">str_to_title</span>(address),</span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>        <span class="at">year_recorded =</span> <span class="fu">year</span>(date_recorded),</span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>        <span class="at">month_recorded =</span> <span class="fu">month</span>(date_recorded),</span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>        <span class="at">day_recorded =</span> <span class="fu">day</span>(date_recorded)</span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(<span class="sc">~</span> <span class="fu">is.character</span>(.) <span class="sc">&amp;&amp;</span> <span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(<span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(.))))), as.numeric)) <span class="sc">|&gt;</span></span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(year_recorded <span class="sc">&gt;=</span> <span class="dv">2001</span>)</span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Join town-county mapping</span></span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>    ct_towns_counties <span class="ot">&lt;-</span> <span class="fu">load_ct_town_mapping</span>()</span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>    ct_sales <span class="ot">&lt;-</span> ct_sales <span class="sc">|&gt;</span></span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a>      <span class="fu">left_join</span>(<span class="fu">select</span>(ct_towns_counties, <span class="st">"Town name"</span>, County), <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"town"</span> <span class="ot">=</span> <span class="st">"Town name"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">county =</span> County)</span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter out problematic or non-residential records</span></span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a>    is_concerning <span class="ot">&lt;-</span> <span class="cf">function</span>(text) {</span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(text, <span class="fu">regex</span>(<span class="st">"duplicate|incorrect|wrong|error|missing|gas station"</span>, <span class="at">ignore_case =</span> <span class="cn">TRUE</span>))</span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>    to_remove <span class="ot">&lt;-</span> ct_sales <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="fu">is_concerning</span>(opm_remarks))</span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a>    ct_sales <span class="ot">&lt;-</span> ct_sales <span class="sc">|&gt;</span> <span class="fu">anti_join</span>(to_remove, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"serial_number"</span>, <span class="st">"address"</span>))</span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a>    ct_sales <span class="ot">&lt;-</span> ct_sales <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span>non_use_code <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"20 - Cemetery"</span>), sale_amount <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add unique ID</span></span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a>    ct_sales <span class="ot">&lt;-</span> ct_sales <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">paste</span>(address, town, property_type))</span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(<span class="fu">as.data.frame</span>(ct_sales), clean_file)</span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Optional: file.remove(raw_file)</span></span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Reading existing data from CSV..."</span>)</span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a>    ct_sales <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(clean_file, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(ct_sales)</span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a>CT_SALES <span class="ot">&lt;-</span> <span class="fu">load_ct_sales</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="gdp-by-county" class="level2">
<h2 class="anchored" data-anchor-id="gdp-by-county">GDP by County</h2>
<p>The <a href="https://bea.gov">U.S. Bureau of Economic Analysis (BEA)</a> publishes annual county-level GDP estimates by industry for every state<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>. The Connecticut file covers all 8 counties from 2001 to 2023. When paired with the real estate sales data, this dataset makes it possible to explore how local GDP relates to housing prices. I downloaded it using the code below.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Load and process BEA County-level GDP data (CAGDP2) for Connecticut (2001–2023).</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' Downloads and processes GDP data if not already saved locally. </span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' Cleans and reshapes the dataset into tidy format.</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A cleaned tibble with columns: county, industry_class, industry_desc, year, and gdp.</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>load_CAGDP2_data <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  target_dir <span class="ot">&lt;-</span> <span class="st">"data/individual_report/CAGDP2"</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  f_name <span class="ot">&lt;-</span> <span class="st">"CAGDP2_CT_2001_2023.csv"</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  f_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, f_name)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(target_dir)) {</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(target_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(f_path)) {</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    zip_url <span class="ot">&lt;-</span> <span class="st">"https://apps.bea.gov/regional/zip/CAGDP2.zip"</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    zip_f_name <span class="ot">&lt;-</span> <span class="fu">basename</span>(zip_url)</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    zip_f_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, zip_f_name)</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Download zip if not already there</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(zip_f_path)) {</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>      <span class="fu">download.file</span>(zip_url, zip_f_path)</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Unzip contents</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unzip</span>(zip_f_path, <span class="at">exdir =</span> target_dir)</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Keep only relevant files</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>    keep_files <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, <span class="fu">c</span>(</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>      <span class="st">"CAGDP2_CT_2001_2023.csv"</span>,</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>      <span class="st">"CAGDP2__Footnotes.html"</span>,</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>      <span class="st">"CAGDP2__definition.xml"</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>    all_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(target_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">file.remove</span>(<span class="fu">setdiff</span>(all_files, keep_files))</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Read and clean data</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>    CAGDP2 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(f_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(TableName, GeoFIPS, Region, LineCode)) <span class="sc">|&gt;</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">unit =</span> Unit, <span class="at">industry_desc =</span> Description) <span class="sc">|&gt;</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">county =</span> <span class="fu">str_split</span>(GeoName, <span class="st">", "</span>, <span class="at">simplify =</span> <span class="cn">TRUE</span>)[, <span class="dv">1</span>]) <span class="sc">|&gt;</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pivot_longer</span>(</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span><span class="fu">c</span>(GeoName, IndustryClassification, industry_desc, unit, county),</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_to =</span> <span class="st">"year"</span>,</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_to =</span> <span class="st">"gdp"</span></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>        <span class="at">year =</span> <span class="fu">as.numeric</span>(<span class="fu">str_remove</span>(year, <span class="st">"^X"</span>)),</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>        <span class="at">gdp =</span> <span class="fu">as.numeric</span>(gdp) <span class="sc">*</span> <span class="dv">1000</span></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(gdp)) <span class="sc">|&gt;</span></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span>GeoName, <span class="sc">-</span>unit) <span class="sc">|&gt;</span></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">industry_class =</span> IndustryClassification)</span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(CAGDP2, f_path)</span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Reading existing data from CSV..."</span>)</span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>    CAGDP2 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(f_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(CAGDP2)</span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>CAGDP2 <span class="ot">&lt;-</span> <span class="fu">load_CAGDP2_data</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="income-by-county" class="level2">
<h2 class="anchored" data-anchor-id="income-by-county">Income by County</h2>
<p>In addition to GDP, the BEA publishes various data sets containing information on personal income<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a>. For this project, I used four of them: CAINC1, CAINC4, CAINC30, and CAINC91. Respectively, these files provide annual county-level data on total personal income, income and employment by major component, economic profiles, and gross earnings flows. Including these in the analysis brings in a fuller picture of personal income as a factor that could shape Connecticut’s real estate market. The code I used to download them is below.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Load and process BEA County-level Income Data (CAINC1) for Connecticut (2001–2023).</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' Downloads and processes personal income data if not already saved locally. </span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' Cleans, reshapes, and standardizes the dataset into a tidy format with one row per county-year.</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A cleaned tibble with columns: county, year, personal_income, population, per_capita_income.</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>load_CAINC1_data <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  target_dir <span class="ot">&lt;-</span> <span class="st">"data/individual_report/CAINC1"</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  f_name <span class="ot">&lt;-</span> <span class="st">"CAINC1_CT_2001_2023.csv"</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  f_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, f_name)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(target_dir)) {</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(target_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(f_path)) {</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    zip_url <span class="ot">&lt;-</span> <span class="st">"https://apps.bea.gov/regional/zip/CAINC1.zip"</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    zip_f_name <span class="ot">&lt;-</span> <span class="fu">basename</span>(zip_url)</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    zip_f_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, zip_f_name)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(zip_f_path)) {</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>      <span class="fu">download.file</span>(zip_url, zip_f_path)</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unzip</span>(zip_f_path, <span class="at">exdir =</span> target_dir)</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>    keep_files <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, <span class="fu">c</span>(</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>      <span class="st">"CAINC1_CT_1969_2023.csv"</span>,</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>      <span class="st">"CAINC1__Footnotes.html"</span>,</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>      <span class="st">"CAINC1__definition.xml"</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>    extracted_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(target_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">file.remove</span>(<span class="fu">setdiff</span>(extracted_files, keep_files))</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>    CAINC1 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">file.path</span>(target_dir, <span class="st">"CAINC1_CT_1969_2023.csv"</span>), <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(TableName, GeoFIPS, Region, LineCode, IndustryClassification)) <span class="sc">|&gt;</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">unit =</span> Unit, <span class="at">metric_desc =</span> Description) <span class="sc">|&gt;</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">county =</span> <span class="fu">str_split</span>(GeoName, <span class="st">", "</span>, <span class="at">simplify =</span> <span class="cn">TRUE</span>)[, <span class="dv">1</span>]) <span class="sc">|&gt;</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pivot_longer</span>(</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span><span class="fu">c</span>(GeoName, metric_desc, unit, county),</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_to =</span> <span class="st">"year"</span>,</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_to =</span> <span class="st">"metric_value"</span></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>        <span class="at">year =</span> <span class="fu">as.numeric</span>(<span class="fu">str_remove</span>(year, <span class="st">"^X"</span>)),</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>        <span class="at">metric_value =</span> <span class="fu">as.numeric</span>(metric_value)</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(metric_value)) <span class="sc">|&gt;</span></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>        <span class="at">metric_value =</span> <span class="fu">case_when</span>(</span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>          metric_desc <span class="sc">==</span> <span class="st">"Personal income (thousands of dollars)"</span> <span class="sc">~</span> metric_value <span class="sc">*</span> <span class="dv">1000</span>,</span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>          <span class="cn">TRUE</span> <span class="sc">~</span> metric_value</span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>        <span class="at">metric_desc =</span> <span class="fu">case_when</span>(</span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>          metric_desc <span class="sc">==</span> <span class="st">"Personal income (thousands of dollars)"</span> <span class="sc">~</span> <span class="st">"Personal income"</span>,</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>          metric_desc <span class="sc">==</span> <span class="st">"Population (persons) 1/"</span> <span class="sc">~</span> <span class="st">"Population"</span>,</span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>          metric_desc <span class="sc">==</span> <span class="st">"Per capita personal income (dollars) 2/"</span> <span class="sc">~</span> <span class="st">"Per capita personal income"</span>,</span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>          <span class="cn">TRUE</span> <span class="sc">~</span> metric_desc</span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(year <span class="sc">&gt;=</span> <span class="dv">2001</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pivot_wider</span>(</span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>unit,</span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_from =</span> metric_desc,</span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_from =</span> metric_value</span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span> </span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a>      <span class="fu">clean_names</span>() <span class="sc">|&gt;</span></span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(county, year, personal_income, population, per_capita_personal_income)</span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(CAINC1, f_path)</span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a>    <span class="fu">file.remove</span>(<span class="fu">file.path</span>(target_dir, <span class="st">"CAINC1_CT_1969_2023.csv"</span>))</span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Reading existing data from CSV..."</span>)</span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a>    CAINC1 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(f_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(CAINC1)</span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a>CAINC1 <span class="ot">&lt;-</span> <span class="fu">load_CAINC1_data</span>()</span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a><span class="co">#' Load and process BEA County-level Detailed Income Data (CAINC4) for Connecticut (2001–2023).</span></span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a><span class="co">#' Downloads and processes detailed personal income data if not already saved locally.</span></span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a><span class="co">#' Cleans, reshapes, and standardizes the dataset into a tidy format with one row per county-year.</span></span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A cleaned tibble with county-level income and earnings components from 2001–2023.</span></span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a>load_CAINC4_data <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true" tabindex="-1"></a>  target_dir <span class="ot">&lt;-</span> <span class="st">"data/individual_report/CAINC4"</span></span>
<span id="cb5-90"><a href="#cb5-90" aria-hidden="true" tabindex="-1"></a>  f_name <span class="ot">&lt;-</span> <span class="st">"CAINC4_CT_2001_2023.csv"</span></span>
<span id="cb5-91"><a href="#cb5-91" aria-hidden="true" tabindex="-1"></a>  f_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, f_name)</span>
<span id="cb5-92"><a href="#cb5-92" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-93"><a href="#cb5-93" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(target_dir)) {</span>
<span id="cb5-94"><a href="#cb5-94" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(target_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-95"><a href="#cb5-95" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-96"><a href="#cb5-96" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-97"><a href="#cb5-97" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(f_path)) {</span>
<span id="cb5-98"><a href="#cb5-98" aria-hidden="true" tabindex="-1"></a>    zip_url <span class="ot">&lt;-</span> <span class="st">"https://apps.bea.gov/regional/zip/CAINC4.zip"</span></span>
<span id="cb5-99"><a href="#cb5-99" aria-hidden="true" tabindex="-1"></a>    zip_f_name <span class="ot">&lt;-</span> <span class="fu">basename</span>(zip_url)</span>
<span id="cb5-100"><a href="#cb5-100" aria-hidden="true" tabindex="-1"></a>    zip_f_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, zip_f_name)</span>
<span id="cb5-101"><a href="#cb5-101" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-102"><a href="#cb5-102" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(zip_f_path)) {</span>
<span id="cb5-103"><a href="#cb5-103" aria-hidden="true" tabindex="-1"></a>      <span class="fu">download.file</span>(zip_url, zip_f_path)</span>
<span id="cb5-104"><a href="#cb5-104" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-105"><a href="#cb5-105" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-106"><a href="#cb5-106" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unzip</span>(zip_f_path, <span class="at">exdir =</span> target_dir)</span>
<span id="cb5-107"><a href="#cb5-107" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-108"><a href="#cb5-108" aria-hidden="true" tabindex="-1"></a>    keep_files <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, <span class="fu">c</span>(</span>
<span id="cb5-109"><a href="#cb5-109" aria-hidden="true" tabindex="-1"></a>      <span class="st">"CAINC4_CT_1969_2023.csv"</span>,</span>
<span id="cb5-110"><a href="#cb5-110" aria-hidden="true" tabindex="-1"></a>      <span class="st">"CAINC4__Footnotes.html"</span>,</span>
<span id="cb5-111"><a href="#cb5-111" aria-hidden="true" tabindex="-1"></a>      <span class="st">"CAINC4__definition.xml"</span></span>
<span id="cb5-112"><a href="#cb5-112" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb5-113"><a href="#cb5-113" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-114"><a href="#cb5-114" aria-hidden="true" tabindex="-1"></a>    extracted_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(target_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-115"><a href="#cb5-115" aria-hidden="true" tabindex="-1"></a>    <span class="fu">file.remove</span>(<span class="fu">setdiff</span>(extracted_files, keep_files))</span>
<span id="cb5-116"><a href="#cb5-116" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-117"><a href="#cb5-117" aria-hidden="true" tabindex="-1"></a>    CAINC4 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">file.path</span>(target_dir, <span class="st">"CAINC4_CT_1969_2023.csv"</span>), <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-118"><a href="#cb5-118" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(TableName, GeoFIPS, Region, LineCode, IndustryClassification)) <span class="sc">|&gt;</span></span>
<span id="cb5-119"><a href="#cb5-119" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">unit =</span> Unit, <span class="at">amount_type =</span> Description) <span class="sc">|&gt;</span></span>
<span id="cb5-120"><a href="#cb5-120" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">county =</span> <span class="fu">str_split</span>(GeoName, <span class="st">", "</span>, <span class="at">simplify =</span> <span class="cn">TRUE</span>)[, <span class="dv">1</span>]) <span class="sc">|&gt;</span></span>
<span id="cb5-121"><a href="#cb5-121" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pivot_longer</span>(</span>
<span id="cb5-122"><a href="#cb5-122" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span><span class="fu">c</span>(GeoName, amount_type, unit, county),</span>
<span id="cb5-123"><a href="#cb5-123" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_to =</span> <span class="st">"year"</span>,</span>
<span id="cb5-124"><a href="#cb5-124" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_to =</span> <span class="st">"amount"</span></span>
<span id="cb5-125"><a href="#cb5-125" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb5-126"><a href="#cb5-126" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb5-127"><a href="#cb5-127" aria-hidden="true" tabindex="-1"></a>        <span class="at">year =</span> <span class="fu">as.numeric</span>(<span class="fu">str_remove</span>(year, <span class="st">"^X"</span>)),</span>
<span id="cb5-128"><a href="#cb5-128" aria-hidden="true" tabindex="-1"></a>        <span class="at">amount =</span> <span class="fu">as.numeric</span>(amount)</span>
<span id="cb5-129"><a href="#cb5-129" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb5-130"><a href="#cb5-130" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(amount), year <span class="sc">&gt;=</span> <span class="dv">2001</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-131"><a href="#cb5-131" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span>GeoName) <span class="sc">|&gt;</span></span>
<span id="cb5-132"><a href="#cb5-132" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">amount =</span> <span class="fu">if_else</span>(unit <span class="sc">==</span> <span class="st">"Thousands of dollars"</span>, amount <span class="sc">*</span> <span class="dv">1000</span>, amount)) <span class="sc">|&gt;</span></span>
<span id="cb5-133"><a href="#cb5-133" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pivot_wider</span>(</span>
<span id="cb5-134"><a href="#cb5-134" aria-hidden="true" tabindex="-1"></a>        <span class="at">id_cols =</span> <span class="sc">-</span>unit,</span>
<span id="cb5-135"><a href="#cb5-135" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_from =</span> amount_type,</span>
<span id="cb5-136"><a href="#cb5-136" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_from =</span> amount</span>
<span id="cb5-137"><a href="#cb5-137" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span> </span>
<span id="cb5-138"><a href="#cb5-138" aria-hidden="true" tabindex="-1"></a>      <span class="fu">clean_names</span>() <span class="sc">|&gt;</span></span>
<span id="cb5-139"><a href="#cb5-139" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename_with</span>(<span class="sc">~</span> . <span class="sc">|&gt;</span> </span>
<span id="cb5-140"><a href="#cb5-140" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">str_remove_all</span>(<span class="st">"_[0-9]+"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb5-141"><a href="#cb5-141" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">str_remove_all</span>(<span class="st">"_thousands_of_dollars"</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-142"><a href="#cb5-142" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">str_remove_all</span>(<span class="st">"_dollars"</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-143"><a href="#cb5-143" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">str_remove_all</span>(<span class="st">"_persons"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb5-144"><a href="#cb5-144" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.list), <span class="sc">~</span> <span class="fu">sapply</span>(., <span class="st">`</span><span class="at">[</span><span class="st">`</span>, <span class="dv">1</span>))) <span class="sc">|&gt;</span></span>
<span id="cb5-145"><a href="#cb5-145" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="sc">-</span>county, as.double))</span>
<span id="cb5-146"><a href="#cb5-146" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-147"><a href="#cb5-147" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(CAINC4, f_path)</span>
<span id="cb5-148"><a href="#cb5-148" aria-hidden="true" tabindex="-1"></a>    <span class="fu">file.remove</span>(<span class="fu">file.path</span>(target_dir, <span class="st">"CAINC4_CT_1969_2023.csv"</span>))</span>
<span id="cb5-149"><a href="#cb5-149" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb5-150"><a href="#cb5-150" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Reading existing data from CSV..."</span>)</span>
<span id="cb5-151"><a href="#cb5-151" aria-hidden="true" tabindex="-1"></a>    CAINC4 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(f_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-152"><a href="#cb5-152" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-153"><a href="#cb5-153" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-154"><a href="#cb5-154" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(CAINC4)</span>
<span id="cb5-155"><a href="#cb5-155" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-156"><a href="#cb5-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-157"><a href="#cb5-157" aria-hidden="true" tabindex="-1"></a>CAINC4 <span class="ot">&lt;-</span> <span class="fu">load_CAINC4_data</span>()</span>
<span id="cb5-158"><a href="#cb5-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-159"><a href="#cb5-159" aria-hidden="true" tabindex="-1"></a><span class="co">#' Load and process BEA CAINC30 data for Connecticut counties (2001–2023)</span></span>
<span id="cb5-160"><a href="#cb5-160" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb5-161"><a href="#cb5-161" aria-hidden="true" tabindex="-1"></a><span class="co">#' Downloads, processes, and returns the CAINC30 dataset from the U.S. Bureau of Economic Analysis.</span></span>
<span id="cb5-162"><a href="#cb5-162" aria-hidden="true" tabindex="-1"></a><span class="co">#' If the processed file is already present locally, it reads from that instead.</span></span>
<span id="cb5-163"><a href="#cb5-163" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb5-164"><a href="#cb5-164" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A cleaned tibble containing annual income and population data by county.</span></span>
<span id="cb5-165"><a href="#cb5-165" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb5-166"><a href="#cb5-166" aria-hidden="true" tabindex="-1"></a><span class="co">#' df &lt;- load_CAINC30_data()</span></span>
<span id="cb5-167"><a href="#cb5-167" aria-hidden="true" tabindex="-1"></a>load_CAINC30_data <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb5-168"><a href="#cb5-168" aria-hidden="true" tabindex="-1"></a>  target_dir <span class="ot">&lt;-</span> <span class="st">"data/individual_report/CAINC30"</span></span>
<span id="cb5-169"><a href="#cb5-169" aria-hidden="true" tabindex="-1"></a>  f_name <span class="ot">&lt;-</span> <span class="st">"CAINC30_CT_2001_2023.csv"</span></span>
<span id="cb5-170"><a href="#cb5-170" aria-hidden="true" tabindex="-1"></a>  f_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, f_name)</span>
<span id="cb5-171"><a href="#cb5-171" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-172"><a href="#cb5-172" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(target_dir)) <span class="fu">dir.create</span>(target_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-173"><a href="#cb5-173" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-174"><a href="#cb5-174" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(f_path)) {</span>
<span id="cb5-175"><a href="#cb5-175" aria-hidden="true" tabindex="-1"></a>    zip_url <span class="ot">&lt;-</span> <span class="st">"https://apps.bea.gov/regional/zip/CAINC30.zip"</span></span>
<span id="cb5-176"><a href="#cb5-176" aria-hidden="true" tabindex="-1"></a>    zip_f_name <span class="ot">&lt;-</span> <span class="fu">basename</span>(zip_url)</span>
<span id="cb5-177"><a href="#cb5-177" aria-hidden="true" tabindex="-1"></a>    zip_f_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, zip_f_name)</span>
<span id="cb5-178"><a href="#cb5-178" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-179"><a href="#cb5-179" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(zip_f_path)) {</span>
<span id="cb5-180"><a href="#cb5-180" aria-hidden="true" tabindex="-1"></a>      <span class="fu">download.file</span>(zip_url, zip_f_path)</span>
<span id="cb5-181"><a href="#cb5-181" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-182"><a href="#cb5-182" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-183"><a href="#cb5-183" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unzip</span>(zip_f_path, <span class="at">exdir =</span> target_dir)</span>
<span id="cb5-184"><a href="#cb5-184" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-185"><a href="#cb5-185" aria-hidden="true" tabindex="-1"></a>    keep_files <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, <span class="fu">c</span>(</span>
<span id="cb5-186"><a href="#cb5-186" aria-hidden="true" tabindex="-1"></a>      <span class="st">"CAINC30_CT_1969_2023.csv"</span>,</span>
<span id="cb5-187"><a href="#cb5-187" aria-hidden="true" tabindex="-1"></a>      <span class="st">"CAINC30__Footnotes.html"</span>,</span>
<span id="cb5-188"><a href="#cb5-188" aria-hidden="true" tabindex="-1"></a>      <span class="st">"CAINC30__definition.xml"</span></span>
<span id="cb5-189"><a href="#cb5-189" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb5-190"><a href="#cb5-190" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-191"><a href="#cb5-191" aria-hidden="true" tabindex="-1"></a>    extracted_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(target_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-192"><a href="#cb5-192" aria-hidden="true" tabindex="-1"></a>    <span class="fu">file.remove</span>(<span class="fu">setdiff</span>(extracted_files, keep_files))</span>
<span id="cb5-193"><a href="#cb5-193" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-194"><a href="#cb5-194" aria-hidden="true" tabindex="-1"></a>    CAINC30 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">file.path</span>(target_dir, <span class="st">"CAINC30_CT_1969_2023.csv"</span>), <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-195"><a href="#cb5-195" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span>TableName, <span class="sc">-</span>GeoFIPS, <span class="sc">-</span>Region, <span class="sc">-</span>LineCode, <span class="sc">-</span>IndustryClassification) <span class="sc">|&gt;</span></span>
<span id="cb5-196"><a href="#cb5-196" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">unit =</span> Unit, <span class="at">amount_type =</span> Description) <span class="sc">|&gt;</span></span>
<span id="cb5-197"><a href="#cb5-197" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">county =</span> <span class="fu">str_split</span>(GeoName, <span class="st">", "</span>, <span class="at">simplify =</span> <span class="cn">TRUE</span>)[, <span class="dv">1</span>]) <span class="sc">|&gt;</span></span>
<span id="cb5-198"><a href="#cb5-198" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pivot_longer</span>(<span class="sc">-</span><span class="fu">c</span>(GeoName, amount_type, unit, county), <span class="at">names_to =</span> <span class="st">"year"</span>, <span class="at">values_to =</span> <span class="st">"amount"</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-199"><a href="#cb5-199" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb5-200"><a href="#cb5-200" aria-hidden="true" tabindex="-1"></a>        <span class="at">year =</span> <span class="fu">as.numeric</span>(<span class="fu">str_remove</span>(year, <span class="st">"^X"</span>)),</span>
<span id="cb5-201"><a href="#cb5-201" aria-hidden="true" tabindex="-1"></a>        <span class="at">amount =</span> <span class="fu">as.numeric</span>(amount)</span>
<span id="cb5-202"><a href="#cb5-202" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb5-203"><a href="#cb5-203" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(amount), year <span class="sc">&gt;=</span> <span class="dv">2001</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-204"><a href="#cb5-204" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span>GeoName) <span class="sc">|&gt;</span></span>
<span id="cb5-205"><a href="#cb5-205" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">amount =</span> <span class="fu">if_else</span>(unit <span class="sc">==</span> <span class="st">"Thousands of dollars"</span>, amount <span class="sc">*</span> <span class="dv">1000</span>, amount)) <span class="sc">|&gt;</span></span>
<span id="cb5-206"><a href="#cb5-206" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pivot_wider</span>(<span class="at">id_cols =</span> <span class="sc">-</span>unit, <span class="at">names_from =</span> amount_type, <span class="at">values_from =</span> amount) <span class="sc">|&gt;</span></span>
<span id="cb5-207"><a href="#cb5-207" aria-hidden="true" tabindex="-1"></a>      <span class="fu">clean_names</span>() <span class="sc">|&gt;</span></span>
<span id="cb5-208"><a href="#cb5-208" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename_with</span>(<span class="sc">~</span> . <span class="sc">|&gt;</span></span>
<span id="cb5-209"><a href="#cb5-209" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">str_remove_all</span>(<span class="st">"_[0-9]+"</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-210"><a href="#cb5-210" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">str_remove_all</span>(<span class="st">"_thousands_of_dollars"</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-211"><a href="#cb5-211" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">str_remove_all</span>(<span class="st">"_dollars"</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-212"><a href="#cb5-212" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">str_remove_all</span>(<span class="st">"_persons"</span>))</span>
<span id="cb5-213"><a href="#cb5-213" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-214"><a href="#cb5-214" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(CAINC30, f_path)</span>
<span id="cb5-215"><a href="#cb5-215" aria-hidden="true" tabindex="-1"></a>    <span class="fu">file.remove</span>(<span class="fu">file.path</span>(target_dir, <span class="st">"CAINC30_CT_1969_2023.csv"</span>))</span>
<span id="cb5-216"><a href="#cb5-216" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb5-217"><a href="#cb5-217" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Reading existing data from CSV..."</span>)</span>
<span id="cb5-218"><a href="#cb5-218" aria-hidden="true" tabindex="-1"></a>    CAINC30 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(f_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-219"><a href="#cb5-219" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-220"><a href="#cb5-220" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(CAINC30)</span>
<span id="cb5-221"><a href="#cb5-221" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-222"><a href="#cb5-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-223"><a href="#cb5-223" aria-hidden="true" tabindex="-1"></a>CAINC30 <span class="ot">&lt;-</span> <span class="fu">load_CAINC30_data</span>()</span>
<span id="cb5-224"><a href="#cb5-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-225"><a href="#cb5-225" aria-hidden="true" tabindex="-1"></a><span class="co">#' Load and process BEA CAINC91 data for Connecticut counties (2001–2023)</span></span>
<span id="cb5-226"><a href="#cb5-226" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb5-227"><a href="#cb5-227" aria-hidden="true" tabindex="-1"></a><span class="co">#' Downloads, processes, and returns the CAINC91 dataset from the U.S. Bureau of Economic Analysis.</span></span>
<span id="cb5-228"><a href="#cb5-228" aria-hidden="true" tabindex="-1"></a><span class="co">#' If the processed file is already saved locally, it loads it directly from disk.</span></span>
<span id="cb5-229"><a href="#cb5-229" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb5-230"><a href="#cb5-230" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A cleaned tibble with income flow adjustments by county and year.</span></span>
<span id="cb5-231"><a href="#cb5-231" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb5-232"><a href="#cb5-232" aria-hidden="true" tabindex="-1"></a><span class="co">#' df &lt;- load_CAINC91_data()</span></span>
<span id="cb5-233"><a href="#cb5-233" aria-hidden="true" tabindex="-1"></a>load_CAINC91_data <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb5-234"><a href="#cb5-234" aria-hidden="true" tabindex="-1"></a>  target_dir <span class="ot">&lt;-</span> <span class="st">"data/individual_report/CAINC91"</span></span>
<span id="cb5-235"><a href="#cb5-235" aria-hidden="true" tabindex="-1"></a>  f_name <span class="ot">&lt;-</span> <span class="st">"CAINC91_CT_2001_2023.csv"</span></span>
<span id="cb5-236"><a href="#cb5-236" aria-hidden="true" tabindex="-1"></a>  f_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, f_name)</span>
<span id="cb5-237"><a href="#cb5-237" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-238"><a href="#cb5-238" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(target_dir)) <span class="fu">dir.create</span>(target_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-239"><a href="#cb5-239" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-240"><a href="#cb5-240" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(f_path)) {</span>
<span id="cb5-241"><a href="#cb5-241" aria-hidden="true" tabindex="-1"></a>    zip_url <span class="ot">&lt;-</span> <span class="st">"https://apps.bea.gov/regional/zip/CAINC91.zip"</span></span>
<span id="cb5-242"><a href="#cb5-242" aria-hidden="true" tabindex="-1"></a>    zip_f_name <span class="ot">&lt;-</span> <span class="fu">basename</span>(zip_url)</span>
<span id="cb5-243"><a href="#cb5-243" aria-hidden="true" tabindex="-1"></a>    zip_f_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, zip_f_name)</span>
<span id="cb5-244"><a href="#cb5-244" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-245"><a href="#cb5-245" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(zip_f_path)) {</span>
<span id="cb5-246"><a href="#cb5-246" aria-hidden="true" tabindex="-1"></a>      <span class="fu">download.file</span>(zip_url, zip_f_path)</span>
<span id="cb5-247"><a href="#cb5-247" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-248"><a href="#cb5-248" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-249"><a href="#cb5-249" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unzip</span>(zip_f_path, <span class="at">exdir =</span> target_dir)</span>
<span id="cb5-250"><a href="#cb5-250" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-251"><a href="#cb5-251" aria-hidden="true" tabindex="-1"></a>    keep_files <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, <span class="fu">c</span>(</span>
<span id="cb5-252"><a href="#cb5-252" aria-hidden="true" tabindex="-1"></a>      <span class="st">"CAINC91_CT_1990_2023.csv"</span>,</span>
<span id="cb5-253"><a href="#cb5-253" aria-hidden="true" tabindex="-1"></a>      <span class="st">"CAINC91__Footnotes.html"</span>,</span>
<span id="cb5-254"><a href="#cb5-254" aria-hidden="true" tabindex="-1"></a>      <span class="st">"CAINC91__definition.xml"</span></span>
<span id="cb5-255"><a href="#cb5-255" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb5-256"><a href="#cb5-256" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-257"><a href="#cb5-257" aria-hidden="true" tabindex="-1"></a>    extracted_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(target_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-258"><a href="#cb5-258" aria-hidden="true" tabindex="-1"></a>    <span class="fu">file.remove</span>(<span class="fu">setdiff</span>(extracted_files, keep_files))</span>
<span id="cb5-259"><a href="#cb5-259" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-260"><a href="#cb5-260" aria-hidden="true" tabindex="-1"></a>    CAINC91 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">file.path</span>(target_dir, <span class="st">"CAINC91_CT_1990_2023.csv"</span>), <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-261"><a href="#cb5-261" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span>TableName, <span class="sc">-</span>GeoFIPS, <span class="sc">-</span>Region, <span class="sc">-</span>LineCode, <span class="sc">-</span>IndustryClassification) <span class="sc">|&gt;</span></span>
<span id="cb5-262"><a href="#cb5-262" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">unit =</span> Unit, <span class="at">amount_type =</span> Description) <span class="sc">|&gt;</span></span>
<span id="cb5-263"><a href="#cb5-263" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">county =</span> <span class="fu">str_split</span>(GeoName, <span class="st">", "</span>, <span class="at">simplify =</span> <span class="cn">TRUE</span>)[, <span class="dv">1</span>]) <span class="sc">|&gt;</span></span>
<span id="cb5-264"><a href="#cb5-264" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pivot_longer</span>(<span class="sc">-</span><span class="fu">c</span>(GeoName, amount_type, unit, county), <span class="at">names_to =</span> <span class="st">"year"</span>, <span class="at">values_to =</span> <span class="st">"amount"</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-265"><a href="#cb5-265" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb5-266"><a href="#cb5-266" aria-hidden="true" tabindex="-1"></a>        <span class="at">year =</span> <span class="fu">as.numeric</span>(<span class="fu">str_remove</span>(year, <span class="st">"^X"</span>)),</span>
<span id="cb5-267"><a href="#cb5-267" aria-hidden="true" tabindex="-1"></a>        <span class="at">amount =</span> <span class="fu">as.numeric</span>(amount)</span>
<span id="cb5-268"><a href="#cb5-268" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb5-269"><a href="#cb5-269" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(amount), year <span class="sc">&gt;=</span> <span class="dv">2001</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-270"><a href="#cb5-270" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span>GeoName) <span class="sc">|&gt;</span></span>
<span id="cb5-271"><a href="#cb5-271" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">amount =</span> <span class="fu">if_else</span>(unit <span class="sc">==</span> <span class="st">"Thousands of dollars"</span>, amount <span class="sc">*</span> <span class="dv">1000</span>, amount)) <span class="sc">|&gt;</span></span>
<span id="cb5-272"><a href="#cb5-272" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pivot_wider</span>(<span class="at">id_cols =</span> <span class="sc">-</span>unit, <span class="at">names_from =</span> amount_type, <span class="at">values_from =</span> amount) <span class="sc">|&gt;</span></span>
<span id="cb5-273"><a href="#cb5-273" aria-hidden="true" tabindex="-1"></a>      <span class="fu">clean_names</span>()</span>
<span id="cb5-274"><a href="#cb5-274" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-275"><a href="#cb5-275" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(CAINC91, f_path)</span>
<span id="cb5-276"><a href="#cb5-276" aria-hidden="true" tabindex="-1"></a>    <span class="fu">file.remove</span>(<span class="fu">file.path</span>(target_dir, <span class="st">"CAINC91_CT_1990_2023.csv"</span>))</span>
<span id="cb5-277"><a href="#cb5-277" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb5-278"><a href="#cb5-278" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Reading existing data from CSV..."</span>)</span>
<span id="cb5-279"><a href="#cb5-279" aria-hidden="true" tabindex="-1"></a>    CAINC91 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(f_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-280"><a href="#cb5-280" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-281"><a href="#cb5-281" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-282"><a href="#cb5-282" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(CAINC91)</span>
<span id="cb5-283"><a href="#cb5-283" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-284"><a href="#cb5-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-285"><a href="#cb5-285" aria-hidden="true" tabindex="-1"></a>CAINC91 <span class="ot">&lt;-</span> <span class="fu">load_CAINC91_data</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="unemployment" class="level2">
<h2 class="anchored" data-anchor-id="unemployment">Unemployment</h2>
<p>Monthly local area (LA) unemployment data is reported to the <a href="https://www.bls.gov/">U.S. Bureau of Labor Statistics (BLS)</a> and published on their website<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a>. I used this dataset to help answer my subquestion, since unemployment rates are a core indicator of economic health. I initially attempted to access this data using R, but several limitations with R’s API tools, particularly unhelpful error messages, made it impractical for this task. In contrast, Python offered tools that allowed me to efficiently query and process a high number of series with clearer error diagnostics. For these reasons, I chose to use Python for downloading and managing the BLS unemployment data.</p>
<p>To ensure that an appropriate Python environment is set up for for the task of downloading the files using the BLS API, I defined the function <code>ensure_python_ready()</code> which creates and activates a suitable virtual environment.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Ensure Python Environment and Required Packages are Available</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' Checks if Python is installed on the system. If not found, it stops execution.</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' Creates a virtual environment named 'bls_py_env' if it doesn't already exist.</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' Checks for specified Python packages within the environment and installs any missing ones.</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param packages A character vector of Python package names to check and install. Defaults to c("pandas", "requests").</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return NULL. Throws an error if Python is not found.</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="co">#' ensure_python_ready()</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="co">#' ensure_python_ready(packages = c("pandas", "requests", "beautifulsoup4"))</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>ensure_python_ready <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">packages =</span> <span class="fu">c</span>(<span class="st">"pandas"</span>, <span class="st">"requests"</span>)) {</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">Sys.which</span>(<span class="st">"python"</span>) <span class="sc">==</span> <span class="st">""</span>) {</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Python is not available on this system."</span>)</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Creating and activating virtual environment</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>  venv_dir <span class="ot">&lt;-</span> <span class="st">"bls_py_env"</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(venv_dir)) {</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">system</span>(<span class="fu">sprintf</span>(<span class="st">"python -m venv %s"</span>, venv_dir))</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>  py_exec <span class="ot">&lt;-</span> <span class="fu">file.path</span>(venv_dir, <span class="st">"bin"</span>, <span class="st">"python"</span>)</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Checking for packages, and installing them if not available.</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (pkg <span class="cf">in</span> packages) {</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">system</span>(<span class="fu">sprintf</span>(<span class="st">"python -c </span><span class="sc">\"</span><span class="st">import %s</span><span class="sc">\"</span><span class="st">"</span>, pkg),</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>               <span class="at">ignore.stdout =</span> <span class="cn">TRUE</span>, <span class="at">ignore.stderr =</span> <span class="cn">TRUE</span>) <span class="sc">!=</span> <span class="dv">0</span>) {</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Installing missing Python package: %s</span><span class="sc">\n</span><span class="st">"</span>, pkg))</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>      <span class="fu">system</span>(<span class="fu">sprintf</span>(<span class="st">"python -m pip install %s"</span>, pkg))</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>In order for the following Python script to work, <a href="https://download.bls.gov/pub/time.series/la/la.series">this file</a> containing LA series titles and descriptions must be manually saved to the <code>data/</code> directory<a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a>. This is because the BLS server blocks automated requests to this file. Therefore, I create an R function that places a system call to the Python script if a local copy of the data set is not available.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Load BLS Data, Downloading with Python Script if Needed</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' Checks if the BLS data CSV file exists locally. If not, it:</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Ensures the required Python environment and packages are available,</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Downloads the series list file if missing,</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Runs a Python script (`bls_api.py`) to download and generate the BLS data CSV,</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Validates the output file creation.</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' Finally, reads the CSV into an R tibble and returns it.</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A tibble containing BLS data.</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="co">#' bls_data &lt;- load_bls_data()</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="co">#' head(bls_data)</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>load_bls_data <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>  f_path <span class="ot">&lt;-</span> <span class="st">"data/individual_report/bls_data.csv"</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if file exists</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(f_path)) {</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"File not found. Running Python script to download BLS data..."</span>)</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure file containing series names exists</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    la_series_file <span class="ot">&lt;-</span> <span class="st">"data/individual_report/la.series.txt"</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(la_series_file)) {</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>      url <span class="ot">&lt;-</span> <span class="st">"https://download.bls.gov/pub/time.series/la/la.series"</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="fu">paste</span>(<span class="st">"LA series list file not found. Go to"</span>,url,<span class="st">"and save the file as la.series.txt to data/"</span>))</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ensure_python_ready</span>(<span class="at">packages =</span> <span class="fu">c</span>(<span class="st">"pandas"</span>,<span class="st">"requests"</span>,<span class="st">"bs4"</span>, <span class="st">"lxml"</span>))</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># System call to run Python script</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">system</span>(<span class="st">"python bls_api.py"</span>, <span class="at">intern =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Optionally re-check file</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(f_path)) {</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">"Python script failed to produce the expected file."</span>)</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Load the CSV</span></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>  bls_data <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(f_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(bls_data)</span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>BLS_LABOR <span class="ot">&lt;-</span> <span class="fu">load_bls_data</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The Python script used to download the data is shown below.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> bs4 <span class="im">import</span> BeautifulSoup</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>api_key <span class="op">=</span> <span class="st">"27f5cf21548149728333c3831176e3e6"</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Define file paths</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>csv_file <span class="op">=</span> Path(<span class="st">"data/individual_report/bls_data.csv"</span>)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>la_series_file <span class="op">=</span> Path(<span class="st">"data/individual_report/la.series.txt"</span>)</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(<span class="st">'data'</span>):</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    os.makedirs(os.path.dirname(local_path), exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>la_series <span class="op">=</span> pd.read_csv(la_series_file, sep<span class="op">=</span><span class="st">"</span><span class="ch">\t</span><span class="st">"</span>)</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i,column <span class="kw">in</span> <span class="bu">enumerate</span>(la_series.columns.tolist()):</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    la_series.rename(columns<span class="op">=</span>{column: column.strip()}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>la_series <span class="op">=</span> la_series.assign(series_id<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"series_id"</span>].<span class="bu">str</span>.strip())</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>ct_towns <span class="op">=</span> la_series[la_series[<span class="st">'series_title'</span>].<span class="bu">str</span>.contains(<span class="st">"town, CT"</span>, case<span class="op">=</span><span class="va">False</span>, na<span class="op">=</span><span class="va">False</span>)][</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"series_id"</span>, <span class="st">"series_title"</span>]</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Select series IDs to pull</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>series_ids <span class="op">=</span> ct_towns[<span class="st">"series_id"</span>].tolist()</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_bls_data_chunk(series_chunk, startyear, endyear, api_key):</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>    url <span class="op">=</span> <span class="st">"https://api.bls.gov/publicAPI/v2/timeseries/data/"</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>    payload <span class="op">=</span> {</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>        <span class="st">"seriesid"</span>: series_chunk,</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>        <span class="st">"startyear"</span>: <span class="bu">str</span>(startyear),</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>        <span class="st">"endyear"</span>: <span class="bu">str</span>(endyear),</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>        <span class="st">"registrationKey"</span>: api_key</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> requests.post(url, headers<span class="op">=</span>{<span class="st">"Content-Type"</span>: <span class="st">"application/json"</span>}, data<span class="op">=</span>json.dumps(payload))</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> response.status_code <span class="op">!=</span> <span class="dv">200</span>:</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"API request failed:"</span>, response.text)</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>        json_data <span class="op">=</span> response.json()</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> json.JSONDecodeError:</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Invalid JSON response."</span>)</span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">"message"</span> <span class="kw">in</span> json_data:</span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"BLS API message:"</span>, <span class="st">"; "</span>.join(json_data[<span class="st">"message"</span>]))</span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">"Results"</span> <span class="kw">not</span> <span class="kw">in</span> json_data <span class="kw">or</span> <span class="st">"series"</span> <span class="kw">not</span> <span class="kw">in</span> json_data[<span class="st">"Results"</span>]:</span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"'series' not found in API response."</span>)</span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a>    series_data <span class="op">=</span> []</span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> series <span class="kw">in</span> json_data[<span class="st">"Results"</span>][<span class="st">"series"</span>]:</span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>        data_rows <span class="op">=</span> series.get(<span class="st">"data"</span>, [])</span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> data_rows:</span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>            df <span class="op">=</span> pd.DataFrame([</span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a>                {k: v <span class="cf">for</span> k, v <span class="kw">in</span> row.items() <span class="cf">if</span> k <span class="op">!=</span> <span class="st">"footnotes"</span>}</span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> row <span class="kw">in</span> data_rows</span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a>            ])</span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>            df[<span class="st">"series_id"</span>] <span class="op">=</span> series[<span class="st">"seriesID"</span>]</span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a>            series_data.append(df)</span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> series_data:</span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.concat(series_data, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a><span class="co"># Request data in chunks and year ranges</span></span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a>all_data <span class="op">=</span> []</span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a>intervals <span class="op">=</span> [(<span class="dv">2001</span>, <span class="dv">2020</span>), (<span class="dv">2021</span>, <span class="dv">2023</span>)]</span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a>chunk_size <span class="op">=</span> <span class="dv">50</span></span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a>series_chunks <span class="op">=</span> [series_ids[i:i <span class="op">+</span> chunk_size] <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(series_ids), chunk_size)]</span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> startyear, endyear <span class="kw">in</span> intervals:</span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> chunk <span class="kw">in</span> series_chunks:</span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Requesting </span><span class="sc">{</span><span class="bu">len</span>(chunk)<span class="sc">}</span><span class="ss"> series from </span><span class="sc">{</span>startyear<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>endyear<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a>        time.sleep(<span class="dv">1</span>)</span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a>            chunk_data <span class="op">=</span> get_bls_data_chunk(chunk, startyear, endyear, api_key)</span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> chunk_data <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a>                all_data.append(chunk_data)</span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"Error retrieving data:"</span>, e)</span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-92"><a href="#cb8-92" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine and clean all data</span></span>
<span id="cb8-93"><a href="#cb8-93" aria-hidden="true" tabindex="-1"></a>BLS_LABOR <span class="op">=</span> pd.concat(all_data, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb8-94"><a href="#cb8-94" aria-hidden="true" tabindex="-1"></a>BLS_LABOR <span class="op">=</span> BLS_LABOR.merge(ct_towns, on<span class="op">=</span><span class="st">"series_id"</span>, how<span class="op">=</span><span class="st">"inner"</span>)</span>
<span id="cb8-95"><a href="#cb8-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-96"><a href="#cb8-96" aria-hidden="true" tabindex="-1"></a><span class="co"># Data cleaning and formatting</span></span>
<span id="cb8-97"><a href="#cb8-97" aria-hidden="true" tabindex="-1"></a>BLS_LABOR[<span class="st">"year"</span>] <span class="op">=</span> BLS_LABOR[<span class="st">"year"</span>].astype(<span class="bu">int</span>)</span>
<span id="cb8-98"><a href="#cb8-98" aria-hidden="true" tabindex="-1"></a>BLS_LABOR[<span class="st">"value"</span>] <span class="op">=</span> pd.to_numeric(BLS_LABOR[<span class="st">"value"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb8-99"><a href="#cb8-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-100"><a href="#cb8-100" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract values</span></span>
<span id="cb8-101"><a href="#cb8-101" aria-hidden="true" tabindex="-1"></a>BLS_LABOR[<span class="st">"value_type"</span>] <span class="op">=</span> BLS_LABOR[<span class="st">"series_title"</span>].<span class="bu">str</span>.extract(<span class="vs">r"^([^:]+)"</span>)</span>
<span id="cb8-102"><a href="#cb8-102" aria-hidden="true" tabindex="-1"></a>BLS_LABOR[<span class="st">"town"</span>] <span class="op">=</span> BLS_LABOR[<span class="st">"series_title"</span>].<span class="bu">str</span>.extract(</span>
<span id="cb8-103"><a href="#cb8-103" aria-hidden="true" tabindex="-1"></a>    <span class="vs">r": (.*?)(?= (?:city/town|town|city|borough/town), CT)"</span></span>
<span id="cb8-104"><a href="#cb8-104" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-105"><a href="#cb8-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-106"><a href="#cb8-106" aria-hidden="true" tabindex="-1"></a>BLS_LABOR[<span class="st">"town"</span>] <span class="op">=</span> BLS_LABOR[<span class="st">"town"</span>].replace({<span class="st">"Milford (consolidated)"</span>: <span class="st">"Milford"</span>})</span>
<span id="cb8-107"><a href="#cb8-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-108"><a href="#cb8-108" aria-hidden="true" tabindex="-1"></a><span class="co"># Add month number</span></span>
<span id="cb8-109"><a href="#cb8-109" aria-hidden="true" tabindex="-1"></a>month_map <span class="op">=</span> {name: i <span class="cf">for</span> i, name <span class="kw">in</span> <span class="bu">enumerate</span>([</span>
<span id="cb8-110"><a href="#cb8-110" aria-hidden="true" tabindex="-1"></a>    <span class="st">'January'</span>, <span class="st">'February'</span>, <span class="st">'March'</span>, <span class="st">'April'</span>, <span class="st">'May'</span>, <span class="st">'June'</span>,</span>
<span id="cb8-111"><a href="#cb8-111" aria-hidden="true" tabindex="-1"></a>    <span class="st">'July'</span>, <span class="st">'August'</span>, <span class="st">'September'</span>, <span class="st">'October'</span>, <span class="st">'November'</span>, <span class="st">'December'</span>], <span class="dv">1</span>)}</span>
<span id="cb8-112"><a href="#cb8-112" aria-hidden="true" tabindex="-1"></a>BLS_LABOR[<span class="st">"month_number"</span>] <span class="op">=</span> BLS_LABOR[<span class="st">"periodName"</span>].<span class="bu">map</span>(month_map)</span>
<span id="cb8-113"><a href="#cb8-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-114"><a href="#cb8-114" aria-hidden="true" tabindex="-1"></a><span class="co"># Pivot the data</span></span>
<span id="cb8-115"><a href="#cb8-115" aria-hidden="true" tabindex="-1"></a>BLS_LABOR <span class="op">=</span> BLS_LABOR.pivot_table(</span>
<span id="cb8-116"><a href="#cb8-116" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span>[<span class="st">"year"</span>, <span class="st">"month_number"</span>, <span class="st">"town"</span>], </span>
<span id="cb8-117"><a href="#cb8-117" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span><span class="st">"value_type"</span>, </span>
<span id="cb8-118"><a href="#cb8-118" aria-hidden="true" tabindex="-1"></a>    values<span class="op">=</span><span class="st">"value"</span>, </span>
<span id="cb8-119"><a href="#cb8-119" aria-hidden="true" tabindex="-1"></a>    aggfunc<span class="op">=</span><span class="st">"first"</span></span>
<span id="cb8-120"><a href="#cb8-120" aria-hidden="true" tabindex="-1"></a>).reset_index()</span>
<span id="cb8-121"><a href="#cb8-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-122"><a href="#cb8-122" aria-hidden="true" tabindex="-1"></a><span class="co"># Rename columns</span></span>
<span id="cb8-123"><a href="#cb8-123" aria-hidden="true" tabindex="-1"></a>BLS_LABOR <span class="op">=</span> BLS_LABOR.rename(columns<span class="op">=</span>{</span>
<span id="cb8-124"><a href="#cb8-124" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Unemployment Rate"</span>: <span class="st">"unemployment_rate"</span>,</span>
<span id="cb8-125"><a href="#cb8-125" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Unemployment"</span>: <span class="st">"unemployment"</span>,</span>
<span id="cb8-126"><a href="#cb8-126" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Employment"</span>: <span class="st">"employment"</span>,</span>
<span id="cb8-127"><a href="#cb8-127" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Labor Force"</span>: <span class="st">"labor_force"</span></span>
<span id="cb8-128"><a href="#cb8-128" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb8-129"><a href="#cb8-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-130"><a href="#cb8-130" aria-hidden="true" tabindex="-1"></a><span class="co"># Download CT Town &lt;- County mapping</span></span>
<span id="cb8-131"><a href="#cb8-131" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">"https://libguides.ctstatelibrary.org/cttowns"</span></span>
<span id="cb8-132"><a href="#cb8-132" aria-hidden="true" tabindex="-1"></a>soup <span class="op">=</span> BeautifulSoup(requests.get(url).content, <span class="st">"html.parser"</span>)</span>
<span id="cb8-133"><a href="#cb8-133" aria-hidden="true" tabindex="-1"></a>tables <span class="op">=</span> pd.read_html(<span class="bu">str</span>(soup))</span>
<span id="cb8-134"><a href="#cb8-134" aria-hidden="true" tabindex="-1"></a>ct_towns_counties <span class="op">=</span> tables[<span class="dv">0</span>]</span>
<span id="cb8-135"><a href="#cb8-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-136"><a href="#cb8-136" aria-hidden="true" tabindex="-1"></a><span class="co"># Clean header and rows</span></span>
<span id="cb8-137"><a href="#cb8-137" aria-hidden="true" tabindex="-1"></a>ct_towns_counties.columns <span class="op">=</span> ct_towns_counties.iloc[<span class="dv">0</span>]</span>
<span id="cb8-138"><a href="#cb8-138" aria-hidden="true" tabindex="-1"></a>ct_towns_counties <span class="op">=</span> ct_towns_counties.drop(index<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb8-139"><a href="#cb8-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-140"><a href="#cb8-140" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge county data</span></span>
<span id="cb8-141"><a href="#cb8-141" aria-hidden="true" tabindex="-1"></a>BLS_LABOR <span class="op">=</span> BLS_LABOR.merge(</span>
<span id="cb8-142"><a href="#cb8-142" aria-hidden="true" tabindex="-1"></a>    ct_towns_counties[[<span class="st">"Town name"</span>, <span class="st">"County"</span>]],</span>
<span id="cb8-143"><a href="#cb8-143" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"left"</span>, left_on<span class="op">=</span><span class="st">"town"</span>, right_on<span class="op">=</span><span class="st">"Town name"</span></span>
<span id="cb8-144"><a href="#cb8-144" aria-hidden="true" tabindex="-1"></a>).rename(columns<span class="op">=</span>{<span class="st">"County"</span>: <span class="st">"county"</span>}).drop(columns<span class="op">=</span>[<span class="st">"Town name"</span>])</span>
<span id="cb8-145"><a href="#cb8-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-146"><a href="#cb8-146" aria-hidden="true" tabindex="-1"></a><span class="co"># Save to CSV</span></span>
<span id="cb8-147"><a href="#cb8-147" aria-hidden="true" tabindex="-1"></a>csv_file.parent.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb8-148"><a href="#cb8-148" aria-hidden="true" tabindex="-1"></a>BLS_LABOR.to_csv(csv_file, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="municipal-financial-indicators" class="level2">
<h2 class="anchored" data-anchor-id="municipal-financial-indicators">Municipal Financial Indicators</h2>
<p>Besides providing the Real Estate Sales data set, the CT OPM publishes a comprehensive collection of municipal financial data for all 169 towns in Connecticut<a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a>. These datasets are highly detailed and include annual town-level information on total taxes collected, total revenues, total expenditures, fund balances, among other fiscal indicators. This data set is particularly useful for examining trends in local government revenue, spending priorities, and financial stability.</p>
<p>Since the CT OPM stores some of its older data in Microsoft Access database (MDB) files, I needed to use the <code>mdbtools</code> utility to read these files on a non-Windows system<a href="#fn10" class="footnote-ref" id="fnref10" role="doc-noteref"><sup>10</sup></a>. To streamline this process, I wrote a helper function, <code>ensure_mdbtools()</code>, which checks for the presence of <code>mdbtools</code> and installs it if necessary. This ensures that the required tooling is available before attempting to import any of the data. The code for <code>ensure_mdbtools()</code> is presented below.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Ensure mdbtools is installed on the system</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' Checks if the `mdb-export` command from the `mdbtools` package is available.</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' If not found, attempts to install `mdbtools` using Homebrew on macOS.</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' Stops execution with an error if Homebrew is not installed or installation fails.</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' Invisibly returns `NULL`. Side effect is installing `mdbtools` if needed.</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="co">#' \dontrun{</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="co">#' ensure_mdbtools()</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="co">#' }</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>ensure_mdbtools <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if mdb-export is already available</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">system</span>(<span class="st">"which mdb-export"</span>, <span class="at">ignore.stdout =</span> <span class="cn">TRUE</span>, <span class="at">ignore.stderr =</span> <span class="cn">TRUE</span>) <span class="sc">!=</span> <span class="dv">0</span>) {</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"mdbtools not found. Attempting to install via Homebrew..."</span>)</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if Homebrew is installed</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">system</span>(<span class="st">"which brew"</span>, <span class="at">ignore.stdout =</span> <span class="cn">TRUE</span>, <span class="at">ignore.stderr =</span> <span class="cn">TRUE</span>) <span class="sc">!=</span> <span class="dv">0</span>) {</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">"Unable to install mdbtools: Homebrew is not installed."</span>)</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Try installing mdbtools</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    install_status <span class="ot">&lt;-</span> <span class="fu">system</span>(<span class="st">"brew install mdbtools"</span>)</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (install_status <span class="sc">!=</span> <span class="dv">0</span>) {</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">"Failed to install mdbtools using Homebrew."</span>)</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"mdbtools successfully installed."</span>)</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"mdbtools is already installed."</span>)</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Once <code>mdbtools</code> has been installed, I can download the data and access the information in the MDB files. The code for downloading and merging the municipal fiscal indicators datafiles is included below.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Load Connecticut Municipal Fiscal Indicators Data (2014-2022)</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' Downloads and processes municipal fiscal data from the Connecticut open data portal</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' if a local CSV file does not already exist. The function:</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Ensures the target directory exists,</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Loads necessary R scripts and packages,</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Fetches data via API call (limited to 2000 records),</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Cleans and formats the data, including town name fixes and joining county info,</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Converts relevant columns to numeric types,</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Filters out statewide aggregates,</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Saves the cleaned data locally as a CSV for future use,</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Otherwise loads data directly from the local CSV file.</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A tibble with municipal fiscal indicators data for CT towns (2014-2022).</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="co">#' ct_mfi &lt;- load_MFI_2014_2022_data()</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="co">#' head(ct_mfi)</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>load_MFI_2014_2022_data <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>  target_dir <span class="ot">&lt;-</span> <span class="st">"data/individual_report/2014-2022"</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>  file_name  <span class="ot">&lt;-</span> <span class="st">"ct_municipal_fiscal_indicators_2014_2022.csv"</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>  file_path  <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, file_name)</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create directory if it doesn't exist</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(target_dir)) {</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(target_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Download and process data if file doesn't exist</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(file_path)) {</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>    base_url <span class="ot">&lt;-</span> <span class="st">"https://data.ct.gov/resource/ej6f-y2wf.json"</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>    full_url <span class="ot">&lt;-</span> <span class="fu">paste0</span>(base_url, <span class="st">"?$limit=2000"</span>)</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>    response <span class="ot">&lt;-</span> <span class="fu">GET</span>(full_url)</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>    raw_data <span class="ot">&lt;-</span> <span class="fu">fromJSON</span>(<span class="fu">content</span>(response, <span class="at">as =</span> <span class="st">"text"</span>))</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load town mapping</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>    town_mapping <span class="ot">&lt;-</span> <span class="fu">load_ct_town_mapping</span>()</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clean and join data</span></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>    cleaned_data <span class="ot">&lt;-</span> raw_data <span class="sc">|&gt;</span></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>        <span class="at">town =</span> <span class="fu">str_to_title</span>(town),</span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>        <span class="at">town =</span> <span class="fu">case_when</span>(</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>          town <span class="sc">==</span> <span class="st">"Groton (City)"</span> <span class="sc">~</span> <span class="st">"Groton"</span>,</span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>          <span class="cn">TRUE</span> <span class="sc">~</span> town</span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>      <span class="fu">left_join</span>(</span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>        town_mapping <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="st">`</span><span class="at">Town name</span><span class="st">`</span>, County),</span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"town"</span> <span class="ot">=</span> <span class="st">"Town name"</span>)</span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>        <span class="at">property_tax_revenues =</span> <span class="fu">as.numeric</span>(property_tax_revenues),</span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>        <span class="at">fiscal_year_end =</span> <span class="fu">as.integer</span>(fiscal_year_end),</span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>        <span class="fu">across</span>(</span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a>          <span class="fu">where</span>(<span class="sc">~</span> <span class="fu">is.character</span>(.) <span class="sc">&amp;&amp;</span> <span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(<span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(.))))),</span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a>          as.numeric</span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(town <span class="sc">!=</span> <span class="st">"Statewide"</span>)</span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(cleaned_data, file_path)</span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a>    ct_revenue_data <span class="ot">&lt;-</span> cleaned_data</span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Reading existing data from CSV..."</span>)</span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a>    ct_revenue_data <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(file_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(ct_revenue_data)</span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true" tabindex="-1"></a><span class="co">#' Load and Process CT Municipal Fiscal Indicators (2003–2007)</span></span>
<span id="cb10-76"><a href="#cb10-76" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-77"><a href="#cb10-77" aria-hidden="true" tabindex="-1"></a><span class="co">#' Downloads, extracts, cleans, and processes Connecticut municipal fiscal indicator data</span></span>
<span id="cb10-78"><a href="#cb10-78" aria-hidden="true" tabindex="-1"></a><span class="co">#' from 2003 to 2007. This includes:</span></span>
<span id="cb10-79"><a href="#cb10-79" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Downloading and extracting data from a Microsoft Access database (.mdb)</span></span>
<span id="cb10-80"><a href="#cb10-80" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Parsing multiple related datasets (FISCIN, NetGL, ACMR)</span></span>
<span id="cb10-81"><a href="#cb10-81" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Cleaning and harmonizing town names</span></span>
<span id="cb10-82"><a href="#cb10-82" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Merging fiscal data, mill rates, and grand lists</span></span>
<span id="cb10-83"><a href="#cb10-83" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Estimating property tax revenues</span></span>
<span id="cb10-84"><a href="#cb10-84" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Joining with county-level town mapping</span></span>
<span id="cb10-85"><a href="#cb10-85" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-86"><a href="#cb10-86" aria-hidden="true" tabindex="-1"></a><span class="co">#' The final dataset is cached locally as a CSV to avoid repeated downloads and processing.</span></span>
<span id="cb10-87"><a href="#cb10-87" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-88"><a href="#cb10-88" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A cleaned `data.frame` (tibble) containing fiscal indicators from 2003–2007,</span></span>
<span id="cb10-89"><a href="#cb10-89" aria-hidden="true" tabindex="-1"></a><span class="co">#' including town name, county, net grand list, mill rate, estimated property tax revenue,</span></span>
<span id="cb10-90"><a href="#cb10-90" aria-hidden="true" tabindex="-1"></a><span class="co">#' Moody's bond ratings, population, and other selected fiscal variables.</span></span>
<span id="cb10-91"><a href="#cb10-91" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-92"><a href="#cb10-92" aria-hidden="true" tabindex="-1"></a><span class="co">#' @note Requires `mdbtools` to be installed on the system (via Homebrew on macOS).</span></span>
<span id="cb10-93"><a href="#cb10-93" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-94"><a href="#cb10-94" aria-hidden="true" tabindex="-1"></a><span class="co">#' @import dplyr readr stringr purrr tidyr</span></span>
<span id="cb10-95"><a href="#cb10-95" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb10-96"><a href="#cb10-96" aria-hidden="true" tabindex="-1"></a>load_MFI_2003_2007_data <span class="ot">&lt;-</span> <span class="cf">function</span>(){</span>
<span id="cb10-97"><a href="#cb10-97" aria-hidden="true" tabindex="-1"></a>  target_dir <span class="ot">&lt;-</span> <span class="st">'data/individual_report/2003-2007'</span></span>
<span id="cb10-98"><a href="#cb10-98" aria-hidden="true" tabindex="-1"></a>  f_name <span class="ot">&lt;-</span> <span class="st">"ct_municipal_fiscal_indicators_2003_2007.csv"</span></span>
<span id="cb10-99"><a href="#cb10-99" aria-hidden="true" tabindex="-1"></a>  f_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, f_name)</span>
<span id="cb10-100"><a href="#cb10-100" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-101"><a href="#cb10-101" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(target_dir)){</span>
<span id="cb10-102"><a href="#cb10-102" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(target_dir, <span class="at">recursive=</span><span class="cn">TRUE</span>)</span>
<span id="cb10-103"><a href="#cb10-103" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-104"><a href="#cb10-104" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-105"><a href="#cb10-105" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(f_path)){</span>
<span id="cb10-106"><a href="#cb10-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-107"><a href="#cb10-107" aria-hidden="true" tabindex="-1"></a>    mdb_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, <span class="st">"2003-2007.mdb"</span>)</span>
<span id="cb10-108"><a href="#cb10-108" aria-hidden="true" tabindex="-1"></a>    output_dir <span class="ot">&lt;-</span> target_dir</span>
<span id="cb10-109"><a href="#cb10-109" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(mdb_file)){</span>
<span id="cb10-110"><a href="#cb10-110" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Define the URL</span></span>
<span id="cb10-111"><a href="#cb10-111" aria-hidden="true" tabindex="-1"></a>      <span class="fu">download.file</span>(<span class="st">"https://data.ct.gov/download/psxm-7fts/application%2Fx-msaccess"</span>, <span class="at">destfile =</span> mdb_file)</span>
<span id="cb10-112"><a href="#cb10-112" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-113"><a href="#cb10-113" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-114"><a href="#cb10-114" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ensure_mdbtools</span>()</span>
<span id="cb10-115"><a href="#cb10-115" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-116"><a href="#cb10-116" aria-hidden="true" tabindex="-1"></a>    <span class="co"># List all table names in the MDB file</span></span>
<span id="cb10-117"><a href="#cb10-117" aria-hidden="true" tabindex="-1"></a>    tables <span class="ot">&lt;-</span> <span class="fu">system</span>(<span class="fu">paste</span>(<span class="st">"mdb-tables -1"</span>, <span class="fu">shQuote</span>(mdb_file)), <span class="at">intern =</span> <span class="cn">TRUE</span>)</span>
<span id="cb10-118"><a href="#cb10-118" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-119"><a href="#cb10-119" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Loop through each table and export to CSV</span></span>
<span id="cb10-120"><a href="#cb10-120" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (table_name <span class="cf">in</span> tables) {</span>
<span id="cb10-121"><a href="#cb10-121" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Clean up table name for file output (e.g., replace spaces with underscores)</span></span>
<span id="cb10-122"><a href="#cb10-122" aria-hidden="true" tabindex="-1"></a>      output_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(output_dir, <span class="fu">paste0</span>(<span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">"_"</span>, table_name), <span class="st">".csv"</span>))</span>
<span id="cb10-123"><a href="#cb10-123" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb10-124"><a href="#cb10-124" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Construct and run the export command</span></span>
<span id="cb10-125"><a href="#cb10-125" aria-hidden="true" tabindex="-1"></a>      cmd <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"mdb-export"</span>, <span class="fu">shQuote</span>(mdb_file), <span class="fu">shQuote</span>(table_name), <span class="st">"&gt;"</span>, <span class="fu">shQuote</span>(output_file))</span>
<span id="cb10-126"><a href="#cb10-126" aria-hidden="true" tabindex="-1"></a>      <span class="fu">system</span>(cmd)</span>
<span id="cb10-127"><a href="#cb10-127" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-128"><a href="#cb10-128" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-129"><a href="#cb10-129" aria-hidden="true" tabindex="-1"></a>    all_fiscin <span class="ot">=</span> <span class="fu">data.frame</span>()</span>
<span id="cb10-130"><a href="#cb10-130" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-131"><a href="#cb10-131" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialize empty data frame</span></span>
<span id="cb10-132"><a href="#cb10-132" aria-hidden="true" tabindex="-1"></a>    all_fiscin <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb10-133"><a href="#cb10-133" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-134"><a href="#cb10-134" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Read and combine all FISCIN files</span></span>
<span id="cb10-135"><a href="#cb10-135" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (y <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>) {</span>
<span id="cb10-136"><a href="#cb10-136" aria-hidden="true" tabindex="-1"></a>      df <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">file.path</span>(target_dir, <span class="fu">paste0</span>(<span class="st">"FISCIN0"</span>, y, <span class="st">".csv"</span>)), <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-137"><a href="#cb10-137" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rename_with</span>(str_to_lower)</span>
<span id="cb10-138"><a href="#cb10-138" aria-hidden="true" tabindex="-1"></a>      all_fiscin <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(all_fiscin, df)</span>
<span id="cb10-139"><a href="#cb10-139" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-140"><a href="#cb10-140" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-141"><a href="#cb10-141" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute coalesced columns outside mutate</span></span>
<span id="cb10-142"><a href="#cb10-142" aria-hidden="true" tabindex="-1"></a>    moodys_bond_rating <span class="ot">&lt;-</span> <span class="fu">coalesce</span>(<span class="sc">!!!</span><span class="fu">select</span>(all_fiscin, <span class="fu">starts_with</span>(<span class="st">"moody's_bond_ratings_july_200"</span>)))</span>
<span id="cb10-143"><a href="#cb10-143" aria-hidden="true" tabindex="-1"></a>    population <span class="ot">&lt;-</span> <span class="fu">coalesce</span>(<span class="sc">!!!</span><span class="fu">select</span>(all_fiscin, <span class="fu">matches</span>(<span class="st">"^</span><span class="sc">\\</span><span class="st">d{4} population$"</span>)))</span>
<span id="cb10-144"><a href="#cb10-144" aria-hidden="true" tabindex="-1"></a>    tanf_recipients <span class="ot">&lt;-</span> <span class="fu">coalesce</span>(<span class="sc">!!!</span><span class="fu">select</span>(all_fiscin, <span class="fu">starts_with</span>(<span class="st">"tanf"</span>)))</span>
<span id="cb10-145"><a href="#cb10-145" aria-hidden="true" tabindex="-1"></a>    acglfy <span class="ot">&lt;-</span> <span class="fu">coalesce</span>(<span class="sc">!!!</span><span class="fu">select</span>(all_fiscin, <span class="fu">starts_with</span>(<span class="st">"acglfy"</span>)))</span>
<span id="cb10-146"><a href="#cb10-146" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-147"><a href="#cb10-147" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Final transformation</span></span>
<span id="cb10-148"><a href="#cb10-148" aria-hidden="true" tabindex="-1"></a>    all_fiscin <span class="ot">&lt;-</span> all_fiscin <span class="sc">|&gt;</span></span>
<span id="cb10-149"><a href="#cb10-149" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb10-150"><a href="#cb10-150" aria-hidden="true" tabindex="-1"></a>        <span class="at">municipality =</span> <span class="fu">str_to_title</span>(municipality),</span>
<span id="cb10-151"><a href="#cb10-151" aria-hidden="true" tabindex="-1"></a>        <span class="at">moodys_bond_rating =</span> moodys_bond_rating,</span>
<span id="cb10-152"><a href="#cb10-152" aria-hidden="true" tabindex="-1"></a>        <span class="at">population =</span> population,</span>
<span id="cb10-153"><a href="#cb10-153" aria-hidden="true" tabindex="-1"></a>        <span class="at">tanf_recipients =</span> tanf_recipients,</span>
<span id="cb10-154"><a href="#cb10-154" aria-hidden="true" tabindex="-1"></a>        <span class="at">acglfy =</span> acglfy</span>
<span id="cb10-155"><a href="#cb10-155" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb10-156"><a href="#cb10-156" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(</span>
<span id="cb10-157"><a href="#cb10-157" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span><span class="fu">matches</span>(<span class="st">"moody's_bond_ratings_july_200"</span>),</span>
<span id="cb10-158"><a href="#cb10-158" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span><span class="fu">matches</span>(<span class="st">"^</span><span class="sc">\\</span><span class="st">d{4} population$"</span>),</span>
<span id="cb10-159"><a href="#cb10-159" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span><span class="fu">matches</span>(<span class="st">"^acglfy0"</span>),</span>
<span id="cb10-160"><a href="#cb10-160" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span><span class="fu">matches</span>(<span class="st">"^tanf0"</span>)</span>
<span id="cb10-161"><a href="#cb10-161" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb10-162"><a href="#cb10-162" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename_with</span>(<span class="sc">~</span> .x <span class="sc">|&gt;</span></span>
<span id="cb10-163"><a href="#cb10-163" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">str_replace_all</span>(<span class="st">" "</span>, <span class="st">"_"</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-164"><a href="#cb10-164" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">str_replace_all</span>(<span class="st">"[^A-Za-z0-9_]"</span>, <span class="st">""</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-165"><a href="#cb10-165" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">str_replace_all</span>(<span class="st">"__"</span>, <span class="st">"_"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb10-166"><a href="#cb10-166" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">town =</span> municipality)</span>
<span id="cb10-167"><a href="#cb10-167" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-168"><a href="#cb10-168" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-169"><a href="#cb10-169" aria-hidden="true" tabindex="-1"></a>    all_gls <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb10-170"><a href="#cb10-170" aria-hidden="true" tabindex="-1"></a>    all_acmrs <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb10-171"><a href="#cb10-171" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-172"><a href="#cb10-172" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (year <span class="cf">in</span> <span class="dv">2003</span><span class="sc">:</span><span class="dv">2007</span>) {</span>
<span id="cb10-173"><a href="#cb10-173" aria-hidden="true" tabindex="-1"></a>      acmr_file_path <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"data/2003-2007/ACMR_"</span>, year, <span class="st">"_GL_Year.csv"</span>)</span>
<span id="cb10-174"><a href="#cb10-174" aria-hidden="true" tabindex="-1"></a>      gl_file_path <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"data/2003-2007/NetGL"</span>, year, <span class="st">".csv"</span>)</span>
<span id="cb10-175"><a href="#cb10-175" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (year <span class="sc">==</span> <span class="dv">2004</span>){</span>
<span id="cb10-176"><a href="#cb10-176" aria-hidden="true" tabindex="-1"></a>        gl_file_path <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"data/2003-2007/NetGL_"</span>, year, <span class="st">".csv"</span>)</span>
<span id="cb10-177"><a href="#cb10-177" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb10-178"><a href="#cb10-178" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb10-179"><a href="#cb10-179" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (year <span class="sc">!=</span> <span class="dv">2007</span>){</span>
<span id="cb10-180"><a href="#cb10-180" aria-hidden="true" tabindex="-1"></a>        df1 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(gl_file_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) </span>
<span id="cb10-181"><a href="#cb10-181" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-182"><a href="#cb10-182" aria-hidden="true" tabindex="-1"></a>        df1 <span class="ot">&lt;-</span> df1 <span class="sc">|&gt;</span></span>
<span id="cb10-183"><a href="#cb10-183" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(<span class="at">gl_year =</span> year) <span class="sc">|&gt;</span> </span>
<span id="cb10-184"><a href="#cb10-184" aria-hidden="true" tabindex="-1"></a>          <span class="fu">rename_with</span>(</span>
<span id="cb10-185"><a href="#cb10-185" aria-hidden="true" tabindex="-1"></a>            <span class="sc">~</span> <span class="fu">str_replace</span>(., <span class="st">"Net Grand List.*"</span>, <span class="fu">paste0</span>(<span class="st">"Net Grand List - "</span>, year, <span class="st">" GL Year"</span>)),</span>
<span id="cb10-186"><a href="#cb10-186" aria-hidden="true" tabindex="-1"></a>            <span class="fu">matches</span>(<span class="st">"Net Grand List"</span>)</span>
<span id="cb10-187"><a href="#cb10-187" aria-hidden="true" tabindex="-1"></a>          ) <span class="sc">|&gt;</span></span>
<span id="cb10-188"><a href="#cb10-188" aria-hidden="true" tabindex="-1"></a>          <span class="fu">pivot_longer</span>(</span>
<span id="cb10-189"><a href="#cb10-189" aria-hidden="true" tabindex="-1"></a>            <span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"Net Grand List"</span>),</span>
<span id="cb10-190"><a href="#cb10-190" aria-hidden="true" tabindex="-1"></a>            <span class="at">names_to =</span> <span class="st">"gl_year_label"</span>,</span>
<span id="cb10-191"><a href="#cb10-191" aria-hidden="true" tabindex="-1"></a>            <span class="at">values_to =</span> <span class="st">"net_grand_list"</span></span>
<span id="cb10-192"><a href="#cb10-192" aria-hidden="true" tabindex="-1"></a>          ) <span class="sc">|&gt;</span></span>
<span id="cb10-193"><a href="#cb10-193" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(</span>
<span id="cb10-194"><a href="#cb10-194" aria-hidden="true" tabindex="-1"></a>            <span class="at">gl_year =</span> <span class="fu">as.integer</span>(<span class="fu">str_extract</span>(gl_year_label, <span class="st">"</span><span class="sc">\\</span><span class="st">d{4}"</span>))</span>
<span id="cb10-195"><a href="#cb10-195" aria-hidden="true" tabindex="-1"></a>          ) <span class="sc">|&gt;</span></span>
<span id="cb10-196"><a href="#cb10-196" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(net_grand_list))</span>
<span id="cb10-197"><a href="#cb10-197" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-198"><a href="#cb10-198" aria-hidden="true" tabindex="-1"></a>        all_gls <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(all_gls, df1)</span>
<span id="cb10-199"><a href="#cb10-199" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb10-200"><a href="#cb10-200" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb10-201"><a href="#cb10-201" aria-hidden="true" tabindex="-1"></a>      df2 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(acmr_file_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb10-202"><a href="#cb10-202" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb10-203"><a href="#cb10-203" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (year <span class="sc">==</span> <span class="dv">2003</span>){</span>
<span id="cb10-204"><a href="#cb10-204" aria-hidden="true" tabindex="-1"></a>        df2_long <span class="ot">&lt;-</span> df2 <span class="sc">|&gt;</span></span>
<span id="cb10-205"><a href="#cb10-205" aria-hidden="true" tabindex="-1"></a>          <span class="fu">pivot_longer</span>(</span>
<span id="cb10-206"><a href="#cb10-206" aria-hidden="true" tabindex="-1"></a>            <span class="at">cols =</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Millrate FY 2004-2005</span><span class="st">`</span>, <span class="st">`</span><span class="at">FY 2003-04 Millrate</span><span class="st">`</span>),</span>
<span id="cb10-207"><a href="#cb10-207" aria-hidden="true" tabindex="-1"></a>            <span class="at">names_to =</span> <span class="st">"year"</span>,</span>
<span id="cb10-208"><a href="#cb10-208" aria-hidden="true" tabindex="-1"></a>            <span class="at">values_to =</span> <span class="st">"millrate"</span></span>
<span id="cb10-209"><a href="#cb10-209" aria-hidden="true" tabindex="-1"></a>          ) <span class="sc">|&gt;</span></span>
<span id="cb10-210"><a href="#cb10-210" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(</span>
<span id="cb10-211"><a href="#cb10-211" aria-hidden="true" tabindex="-1"></a>            <span class="at">year =</span> <span class="fu">case_when</span>(</span>
<span id="cb10-212"><a href="#cb10-212" aria-hidden="true" tabindex="-1"></a>              year <span class="sc">==</span> <span class="st">"Millrate FY 2004-2005"</span> <span class="sc">~</span> <span class="dv">2004</span>,</span>
<span id="cb10-213"><a href="#cb10-213" aria-hidden="true" tabindex="-1"></a>              year <span class="sc">==</span> <span class="st">"FY 2003-04 Millrate"</span> <span class="sc">~</span> <span class="dv">2003</span></span>
<span id="cb10-214"><a href="#cb10-214" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb10-215"><a href="#cb10-215" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb10-216"><a href="#cb10-216" aria-hidden="true" tabindex="-1"></a>        all_acmrs <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(all_acmrs, df2_long)</span>
<span id="cb10-217"><a href="#cb10-217" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span>{</span>
<span id="cb10-218"><a href="#cb10-218" aria-hidden="true" tabindex="-1"></a>        df2 <span class="ot">&lt;-</span> df2 <span class="sc">|&gt;</span></span>
<span id="cb10-219"><a href="#cb10-219" aria-hidden="true" tabindex="-1"></a>          <span class="fu">rename</span>(<span class="at">millrate =</span> <span class="fu">matches</span>(<span class="st">"Mil"</span>))</span>
<span id="cb10-220"><a href="#cb10-220" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-221"><a href="#cb10-221" aria-hidden="true" tabindex="-1"></a>        year_col <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"Year"</span>, <span class="fu">names</span>(df2), <span class="at">value =</span> <span class="cn">TRUE</span>)</span>
<span id="cb10-222"><a href="#cb10-222" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-223"><a href="#cb10-223" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">length</span>(year_col) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb10-224"><a href="#cb10-224" aria-hidden="true" tabindex="-1"></a>          df2 <span class="ot">&lt;-</span> df2 <span class="sc">|&gt;</span></span>
<span id="cb10-225"><a href="#cb10-225" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mutate</span>(<span class="at">year =</span> year) </span>
<span id="cb10-226"><a href="#cb10-226" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb10-227"><a href="#cb10-227" aria-hidden="true" tabindex="-1"></a>          df2 <span class="ot">&lt;-</span> df2 <span class="sc">|&gt;</span></span>
<span id="cb10-228"><a href="#cb10-228" aria-hidden="true" tabindex="-1"></a>            <span class="fu">rename_with</span>(<span class="sc">~</span> <span class="st">"year"</span>, <span class="at">.cols =</span> <span class="fu">all_of</span>(year_col[<span class="dv">1</span>]))</span>
<span id="cb10-229"><a href="#cb10-229" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb10-230"><a href="#cb10-230" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-231"><a href="#cb10-231" aria-hidden="true" tabindex="-1"></a>        all_acmrs <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(all_acmrs, df2)</span>
<span id="cb10-232"><a href="#cb10-232" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb10-233"><a href="#cb10-233" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-234"><a href="#cb10-234" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-235"><a href="#cb10-235" aria-hidden="true" tabindex="-1"></a>    all_gls <span class="ot">&lt;-</span></span>
<span id="cb10-236"><a href="#cb10-236" aria-hidden="true" tabindex="-1"></a>      all_gls <span class="sc">|&gt;</span></span>
<span id="cb10-237"><a href="#cb10-237" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span>gl_year_label) <span class="sc">|&gt;</span></span>
<span id="cb10-238"><a href="#cb10-238" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(</span>
<span id="cb10-239"><a href="#cb10-239" aria-hidden="true" tabindex="-1"></a>        <span class="at">town =</span> Municipality,</span>
<span id="cb10-240"><a href="#cb10-240" aria-hidden="true" tabindex="-1"></a>        <span class="at">comptroller_town_code =</span> <span class="st">`</span><span class="at">Comptroller Town Code</span><span class="st">`</span>,</span>
<span id="cb10-241"><a href="#cb10-241" aria-hidden="true" tabindex="-1"></a>        <span class="at">comments =</span> Comments,</span>
<span id="cb10-242"><a href="#cb10-242" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb10-243"><a href="#cb10-243" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb10-244"><a href="#cb10-244" aria-hidden="true" tabindex="-1"></a>        <span class="at">town =</span> <span class="fu">str_to_title</span>(town),</span>
<span id="cb10-245"><a href="#cb10-245" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb10-246"><a href="#cb10-246" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-247"><a href="#cb10-247" aria-hidden="true" tabindex="-1"></a>    all_acmrs <span class="ot">&lt;-</span></span>
<span id="cb10-248"><a href="#cb10-248" aria-hidden="true" tabindex="-1"></a>      all_acmrs <span class="sc">|&gt;</span></span>
<span id="cb10-249"><a href="#cb10-249" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(</span>
<span id="cb10-250"><a href="#cb10-250" aria-hidden="true" tabindex="-1"></a>        <span class="at">town =</span> Municipality</span>
<span id="cb10-251"><a href="#cb10-251" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb10-252"><a href="#cb10-252" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb10-253"><a href="#cb10-253" aria-hidden="true" tabindex="-1"></a>        <span class="at">town =</span> <span class="fu">str_to_title</span>(town),</span>
<span id="cb10-254"><a href="#cb10-254" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb10-255"><a href="#cb10-255" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-256"><a href="#cb10-256" aria-hidden="true" tabindex="-1"></a>    ct_towns_counties <span class="ot">&lt;-</span> <span class="fu">load_ct_town_mapping</span>()</span>
<span id="cb10-257"><a href="#cb10-257" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-258"><a href="#cb10-258" aria-hidden="true" tabindex="-1"></a>    final <span class="ot">&lt;-</span> <span class="fu">inner_join</span>(</span>
<span id="cb10-259"><a href="#cb10-259" aria-hidden="true" tabindex="-1"></a>      all_gls, all_acmrs, <span class="fu">join_by</span>(town <span class="sc">==</span> town, gl_year <span class="sc">==</span> year)</span>
<span id="cb10-260"><a href="#cb10-260" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> <span class="fu">mutate</span>(</span>
<span id="cb10-261"><a href="#cb10-261" aria-hidden="true" tabindex="-1"></a>      <span class="at">property_tax_revenue =</span> (millrate<span class="sc">/</span><span class="dv">1000</span>) <span class="sc">*</span> net_grand_list</span>
<span id="cb10-262"><a href="#cb10-262" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> <span class="fu">rename</span>(<span class="at">year =</span> gl_year) <span class="sc">|&gt;</span></span>
<span id="cb10-263"><a href="#cb10-263" aria-hidden="true" tabindex="-1"></a>      <span class="fu">inner_join</span>(all_fiscin, <span class="fu">join_by</span>(town <span class="sc">==</span> town, year <span class="sc">==</span> fisc_year_end )) <span class="sc">|&gt;</span></span>
<span id="cb10-264"><a href="#cb10-264" aria-hidden="true" tabindex="-1"></a>      <span class="fu">inner_join</span>(ct_towns_counties <span class="sc">|&gt;</span> <span class="fu">rename</span>(<span class="at">county =</span> County) <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="st">"Town name"</span>, county), <span class="fu">join_by</span>(town <span class="sc">==</span> <span class="st">"Town name"</span>))</span>
<span id="cb10-265"><a href="#cb10-265" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-266"><a href="#cb10-266" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(final, f_path)</span>
<span id="cb10-267"><a href="#cb10-267" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span>{</span>
<span id="cb10-268"><a href="#cb10-268" aria-hidden="true" tabindex="-1"></a>    final <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(f_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb10-269"><a href="#cb10-269" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-270"><a href="#cb10-270" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(final)</span>
<span id="cb10-271"><a href="#cb10-271" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-272"><a href="#cb10-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-273"><a href="#cb10-273" aria-hidden="true" tabindex="-1"></a><span class="co">#' Load Connecticut Municipal Fiscal Indicators Data (2007-2011)</span></span>
<span id="cb10-274"><a href="#cb10-274" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-275"><a href="#cb10-275" aria-hidden="true" tabindex="-1"></a><span class="co">#' This function downloads, extracts, processes, and merges municipal fiscal data for</span></span>
<span id="cb10-276"><a href="#cb10-276" aria-hidden="true" tabindex="-1"></a><span class="co">#' Connecticut towns from 2007 to 2011. It handles the Microsoft Access database file (.mdb),</span></span>
<span id="cb10-277"><a href="#cb10-277" aria-hidden="true" tabindex="-1"></a><span class="co">#' exports its tables to CSV files using `mdbtools`, reads and cleans specific fiscal indicator</span></span>
<span id="cb10-278"><a href="#cb10-278" aria-hidden="true" tabindex="-1"></a><span class="co">#' CSVs, and combines these with net grand list and mill rate data.</span></span>
<span id="cb10-279"><a href="#cb10-279" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-280"><a href="#cb10-280" aria-hidden="true" tabindex="-1"></a><span class="co">#' If the processed CSV summary file already exists locally, it loads and returns it directly.</span></span>
<span id="cb10-281"><a href="#cb10-281" aria-hidden="true" tabindex="-1"></a><span class="co">#' Otherwise, it downloads the MDB file, extracts tables, processes and merges relevant data,</span></span>
<span id="cb10-282"><a href="#cb10-282" aria-hidden="true" tabindex="-1"></a><span class="co">#' and saves the combined data for future use.</span></span>
<span id="cb10-283"><a href="#cb10-283" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-284"><a href="#cb10-284" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A tibble containing merged fiscal, tax, and municipal data for Connecticut towns from 2007-2011,</span></span>
<span id="cb10-285"><a href="#cb10-285" aria-hidden="true" tabindex="-1"></a><span class="co">#' with columns including town, year, property tax revenue, population, Moody's bond rating,</span></span>
<span id="cb10-286"><a href="#cb10-286" aria-hidden="true" tabindex="-1"></a><span class="co">#' and other fiscal indicators.</span></span>
<span id="cb10-287"><a href="#cb10-287" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-288"><a href="#cb10-288" aria-hidden="true" tabindex="-1"></a><span class="co">#' @details</span></span>
<span id="cb10-289"><a href="#cb10-289" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Requires `mdbtools` installed and available in the system PATH for exporting Access tables.</span></span>
<span id="cb10-290"><a href="#cb10-290" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Downloads data from the Connecticut Open Data portal if necessary.</span></span>
<span id="cb10-291"><a href="#cb10-291" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Uses `dplyr` and `tidyverse` functions for data manipulation.</span></span>
<span id="cb10-292"><a href="#cb10-292" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Cleans column names and consolidates yearly variables into single columns.</span></span>
<span id="cb10-293"><a href="#cb10-293" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Joins town-level fiscal indicators with tax and county data.</span></span>
<span id="cb10-294"><a href="#cb10-294" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-295"><a href="#cb10-295" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom readr read_csv write_csv</span></span>
<span id="cb10-296"><a href="#cb10-296" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom dplyr rename_with mutate select rename inner_join bind_rows filter</span></span>
<span id="cb10-297"><a href="#cb10-297" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom stringr str_to_lower str_to_title str_replace_all str_extract</span></span>
<span id="cb10-298"><a href="#cb10-298" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom tidyr pivot_longer</span></span>
<span id="cb10-299"><a href="#cb10-299" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-300"><a href="#cb10-300" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb10-301"><a href="#cb10-301" aria-hidden="true" tabindex="-1"></a><span class="co">#' \dontrun{</span></span>
<span id="cb10-302"><a href="#cb10-302" aria-hidden="true" tabindex="-1"></a><span class="co">#' fiscal_data &lt;- load_MFI_2007_2011_data()</span></span>
<span id="cb10-303"><a href="#cb10-303" aria-hidden="true" tabindex="-1"></a><span class="co">#' head(fiscal_data)</span></span>
<span id="cb10-304"><a href="#cb10-304" aria-hidden="true" tabindex="-1"></a><span class="co">#' }</span></span>
<span id="cb10-305"><a href="#cb10-305" aria-hidden="true" tabindex="-1"></a>load_MFI_2007_2011_data <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb10-306"><a href="#cb10-306" aria-hidden="true" tabindex="-1"></a>  target_dir <span class="ot">&lt;-</span> <span class="st">'data/individual_report/2007-2011'</span></span>
<span id="cb10-307"><a href="#cb10-307" aria-hidden="true" tabindex="-1"></a>  f_name <span class="ot">&lt;-</span> <span class="st">"ct_municipal_fiscal_indicators_2007_2011.csv"</span></span>
<span id="cb10-308"><a href="#cb10-308" aria-hidden="true" tabindex="-1"></a>  f_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, f_name)</span>
<span id="cb10-309"><a href="#cb10-309" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-310"><a href="#cb10-310" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(target_dir)) {</span>
<span id="cb10-311"><a href="#cb10-311" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(target_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb10-312"><a href="#cb10-312" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-313"><a href="#cb10-313" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-314"><a href="#cb10-314" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(f_path)) {</span>
<span id="cb10-315"><a href="#cb10-315" aria-hidden="true" tabindex="-1"></a>    mdb_fname <span class="ot">&lt;-</span> <span class="st">"2007-2011.mdb"</span></span>
<span id="cb10-316"><a href="#cb10-316" aria-hidden="true" tabindex="-1"></a>    mdb_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, mdb_fname)</span>
<span id="cb10-317"><a href="#cb10-317" aria-hidden="true" tabindex="-1"></a>    output_dir <span class="ot">&lt;-</span> target_dir</span>
<span id="cb10-318"><a href="#cb10-318" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-319"><a href="#cb10-319" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(mdb_file)){</span>
<span id="cb10-320"><a href="#cb10-320" aria-hidden="true" tabindex="-1"></a>      <span class="fu">download.file</span>(</span>
<span id="cb10-321"><a href="#cb10-321" aria-hidden="true" tabindex="-1"></a>        <span class="st">"https://data.ct.gov/download/vwi6-xdyb/application%2Fx-msaccess"</span>,</span>
<span id="cb10-322"><a href="#cb10-322" aria-hidden="true" tabindex="-1"></a>        <span class="at">destfile =</span> <span class="fu">file.path</span>(target_dir, mdb_fname)</span>
<span id="cb10-323"><a href="#cb10-323" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb10-324"><a href="#cb10-324" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-325"><a href="#cb10-325" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-326"><a href="#cb10-326" aria-hidden="true" tabindex="-1"></a>    tables <span class="ot">&lt;-</span> <span class="fu">system</span>(<span class="fu">paste</span>(<span class="st">"mdb-tables -1"</span>, <span class="fu">shQuote</span>(mdb_file)), <span class="at">intern =</span> <span class="cn">TRUE</span>)</span>
<span id="cb10-327"><a href="#cb10-327" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-328"><a href="#cb10-328" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (table_name <span class="cf">in</span> tables) {</span>
<span id="cb10-329"><a href="#cb10-329" aria-hidden="true" tabindex="-1"></a>      output_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(output_dir, <span class="fu">paste0</span>(<span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">"_"</span>, table_name), <span class="st">".csv"</span>))</span>
<span id="cb10-330"><a href="#cb10-330" aria-hidden="true" tabindex="-1"></a>      cmd <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"mdb-export"</span>, <span class="fu">shQuote</span>(mdb_file), <span class="fu">shQuote</span>(table_name), <span class="st">"&gt;"</span>, <span class="fu">shQuote</span>(output_file))</span>
<span id="cb10-331"><a href="#cb10-331" aria-hidden="true" tabindex="-1"></a>      <span class="fu">system</span>(cmd)</span>
<span id="cb10-332"><a href="#cb10-332" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-333"><a href="#cb10-333" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-334"><a href="#cb10-334" aria-hidden="true" tabindex="-1"></a>    all_fiscin <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb10-335"><a href="#cb10-335" aria-hidden="true" tabindex="-1"></a>    all_fiscin <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(<span class="dv">8</span><span class="sc">:</span><span class="dv">11</span>, <span class="sc">~</span> {</span>
<span id="cb10-336"><a href="#cb10-336" aria-hidden="true" tabindex="-1"></a>      <span class="fu">read_csv</span>(<span class="fu">file.path</span>(target_dir, <span class="fu">paste0</span>(<span class="st">"FISCIN"</span>, <span class="fu">sprintf</span>(<span class="st">"%02d"</span>, .x), <span class="st">".csv"</span>)), <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-337"><a href="#cb10-337" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rename_with</span>(str_to_lower)</span>
<span id="cb10-338"><a href="#cb10-338" aria-hidden="true" tabindex="-1"></a>    }) <span class="sc">|&gt;</span></span>
<span id="cb10-339"><a href="#cb10-339" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb10-340"><a href="#cb10-340" aria-hidden="true" tabindex="-1"></a>        <span class="at">population =</span> <span class="fu">coalesce</span>(<span class="st">`</span><span class="at">2011 population</span><span class="st">`</span>, <span class="st">`</span><span class="at">2010 population</span><span class="st">`</span>, <span class="st">`</span><span class="at">2009 population</span><span class="st">`</span>, <span class="st">`</span><span class="at">2008 population</span><span class="st">`</span>),</span>
<span id="cb10-341"><a href="#cb10-341" aria-hidden="true" tabindex="-1"></a>        <span class="at">moodys_bond_rating =</span> <span class="fu">coalesce</span>(<span class="st">`</span><span class="at">moody's_bond_ratings_july2011</span><span class="st">`</span>, <span class="st">`</span><span class="at">moody's_bond_ratings_july2010</span><span class="st">`</span>, <span class="st">`</span><span class="at">moody's_bond_ratings_july2009</span><span class="st">`</span>, <span class="st">`</span><span class="at">moody's_bond_ratings_july_2008</span><span class="st">`</span>),</span>
<span id="cb10-342"><a href="#cb10-342" aria-hidden="true" tabindex="-1"></a>        <span class="at">acglfy =</span> <span class="fu">coalesce</span>(acglfy11, acglfy10, acglfy09, acglfy08),</span>
<span id="cb10-343"><a href="#cb10-343" aria-hidden="true" tabindex="-1"></a>        <span class="at">tanf_recipients =</span> <span class="fu">coalesce</span>(<span class="st">`</span><span class="at">tanf11 recipients</span><span class="st">`</span>, <span class="st">`</span><span class="at">tanf10 recipients</span><span class="st">`</span>, <span class="st">`</span><span class="at">tanf09 recipients</span><span class="st">`</span>, <span class="st">`</span><span class="at">tanf08 recipients</span><span class="st">`</span>)</span>
<span id="cb10-344"><a href="#cb10-344" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb10-345"><a href="#cb10-345" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(</span>
<span id="cb10-346"><a href="#cb10-346" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span><span class="fu">matches</span>(<span class="st">"moody's_bond_ratings_july_200"</span>),</span>
<span id="cb10-347"><a href="#cb10-347" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span><span class="fu">matches</span>(<span class="st">"moody's_bond_ratings_july20"</span>),</span>
<span id="cb10-348"><a href="#cb10-348" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span><span class="st">"2011 population"</span>, <span class="sc">-</span><span class="st">"2010 population"</span>, <span class="sc">-</span><span class="st">"2009 population"</span>, <span class="sc">-</span><span class="st">"2008 population"</span>,</span>
<span id="cb10-349"><a href="#cb10-349" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span><span class="fu">matches</span>(<span class="st">"acglfy0"</span>), <span class="sc">-</span><span class="fu">matches</span>(<span class="st">"acglfy1"</span>),</span>
<span id="cb10-350"><a href="#cb10-350" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span><span class="fu">matches</span>(<span class="st">"tanf0"</span>), <span class="sc">-</span><span class="fu">matches</span>(<span class="st">"tanf1"</span>)</span>
<span id="cb10-351"><a href="#cb10-351" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb10-352"><a href="#cb10-352" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename_with</span>(<span class="sc">~</span> .x <span class="sc">|&gt;</span></span>
<span id="cb10-353"><a href="#cb10-353" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">str_replace_all</span>(<span class="st">" "</span>, <span class="st">"_"</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-354"><a href="#cb10-354" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">str_replace_all</span>(<span class="st">"[^A-Za-z0-9_]"</span>, <span class="st">""</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-355"><a href="#cb10-355" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">str_replace_all</span>(<span class="st">"__"</span>, <span class="st">"_"</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-356"><a href="#cb10-356" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">str_replace_all</span>(<span class="st">"2011_"</span>, <span class="st">""</span>)) <span class="sc">|&gt;</span></span>
<span id="cb10-357"><a href="#cb10-357" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">town =</span> municipality) <span class="sc">|&gt;</span></span>
<span id="cb10-358"><a href="#cb10-358" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">town =</span> <span class="fu">str_to_title</span>(town))</span>
<span id="cb10-359"><a href="#cb10-359" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-360"><a href="#cb10-360" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-361"><a href="#cb10-361" aria-hidden="true" tabindex="-1"></a>    all_gls <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb10-362"><a href="#cb10-362" aria-hidden="true" tabindex="-1"></a>    all_acmrs <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb10-363"><a href="#cb10-363" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-364"><a href="#cb10-364" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (year <span class="cf">in</span> <span class="dv">2007</span><span class="sc">:</span><span class="dv">2011</span>) {</span>
<span id="cb10-365"><a href="#cb10-365" aria-hidden="true" tabindex="-1"></a>      gl_file_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, <span class="fu">paste0</span>(<span class="st">"NetGL"</span>, year, <span class="st">".csv"</span>))</span>
<span id="cb10-366"><a href="#cb10-366" aria-hidden="true" tabindex="-1"></a>      acmr_file_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, <span class="fu">paste0</span>(<span class="st">"ACMR_"</span>, year, <span class="st">"_GL_Year.csv"</span>))</span>
<span id="cb10-367"><a href="#cb10-367" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb10-368"><a href="#cb10-368" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (year <span class="sc">&lt;=</span> <span class="dv">2008</span>) {</span>
<span id="cb10-369"><a href="#cb10-369" aria-hidden="true" tabindex="-1"></a>        df1 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">file.path</span>(target_dir, <span class="st">"NGL_2003-08_GL_Years.csv"</span>), <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-370"><a href="#cb10-370" aria-hidden="true" tabindex="-1"></a>          <span class="fu">select</span>(Municipality, Numbered, <span class="fu">matches</span>(<span class="fu">paste0</span>(year, <span class="st">" NGL"</span>))) <span class="sc">|&gt;</span></span>
<span id="cb10-371"><a href="#cb10-371" aria-hidden="true" tabindex="-1"></a>          <span class="fu">rename</span>(<span class="at">net_grand_list =</span> <span class="fu">matches</span>(<span class="fu">paste0</span>(year, <span class="st">" NGL"</span>))) <span class="sc">|&gt;</span></span>
<span id="cb10-372"><a href="#cb10-372" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(<span class="at">year =</span> year)</span>
<span id="cb10-373"><a href="#cb10-373" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">file.exists</span>(gl_file_path)) {</span>
<span id="cb10-374"><a href="#cb10-374" aria-hidden="true" tabindex="-1"></a>        df1 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(gl_file_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-375"><a href="#cb10-375" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(<span class="at">gl_year =</span> year) <span class="sc">|&gt;</span></span>
<span id="cb10-376"><a href="#cb10-376" aria-hidden="true" tabindex="-1"></a>          <span class="fu">rename_with</span>(</span>
<span id="cb10-377"><a href="#cb10-377" aria-hidden="true" tabindex="-1"></a>            <span class="sc">~</span> <span class="fu">str_replace</span>(., <span class="st">"Net Grand List.*"</span>, <span class="fu">paste0</span>(<span class="st">"Net Grand List - "</span>, year, <span class="st">" GL Year"</span>)),</span>
<span id="cb10-378"><a href="#cb10-378" aria-hidden="true" tabindex="-1"></a>            <span class="fu">matches</span>(<span class="st">"Net Grand List"</span>)</span>
<span id="cb10-379"><a href="#cb10-379" aria-hidden="true" tabindex="-1"></a>          ) <span class="sc">|&gt;</span></span>
<span id="cb10-380"><a href="#cb10-380" aria-hidden="true" tabindex="-1"></a>          <span class="fu">pivot_longer</span>(</span>
<span id="cb10-381"><a href="#cb10-381" aria-hidden="true" tabindex="-1"></a>            <span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"Net Grand List"</span>),</span>
<span id="cb10-382"><a href="#cb10-382" aria-hidden="true" tabindex="-1"></a>            <span class="at">names_to =</span> <span class="st">"gl_year_label"</span>,</span>
<span id="cb10-383"><a href="#cb10-383" aria-hidden="true" tabindex="-1"></a>            <span class="at">values_to =</span> <span class="st">"net_grand_list"</span></span>
<span id="cb10-384"><a href="#cb10-384" aria-hidden="true" tabindex="-1"></a>          ) <span class="sc">|&gt;</span></span>
<span id="cb10-385"><a href="#cb10-385" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(<span class="at">gl_year =</span> <span class="fu">as.integer</span>(<span class="fu">str_extract</span>(gl_year_label, <span class="st">"</span><span class="sc">\\</span><span class="st">d{4}"</span>))) <span class="sc">|&gt;</span></span>
<span id="cb10-386"><a href="#cb10-386" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(net_grand_list))</span>
<span id="cb10-387"><a href="#cb10-387" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb10-388"><a href="#cb10-388" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb10-389"><a href="#cb10-389" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"df1"</span>)) {</span>
<span id="cb10-390"><a href="#cb10-390" aria-hidden="true" tabindex="-1"></a>        all_gls <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(all_gls, df1 <span class="sc">|&gt;</span> <span class="fu">rename_with</span>(tolower))</span>
<span id="cb10-391"><a href="#cb10-391" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rm</span>(df1)</span>
<span id="cb10-392"><a href="#cb10-392" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb10-393"><a href="#cb10-393" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb10-394"><a href="#cb10-394" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">file.exists</span>(acmr_file_path)) {</span>
<span id="cb10-395"><a href="#cb10-395" aria-hidden="true" tabindex="-1"></a>        df2 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(acmr_file_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-396"><a href="#cb10-396" aria-hidden="true" tabindex="-1"></a>          <span class="fu">rename_with</span>(<span class="sc">~</span> <span class="st">"millrate"</span>, <span class="at">.cols =</span> <span class="fu">matches</span>(<span class="st">"Mil Rates|Mill Rates"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb10-397"><a href="#cb10-397" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(<span class="at">year =</span> year)</span>
<span id="cb10-398"><a href="#cb10-398" aria-hidden="true" tabindex="-1"></a>        all_acmrs <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(all_acmrs, df2 <span class="sc">|&gt;</span> <span class="fu">rename_with</span>(tolower))</span>
<span id="cb10-399"><a href="#cb10-399" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb10-400"><a href="#cb10-400" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-401"><a href="#cb10-401" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-402"><a href="#cb10-402" aria-hidden="true" tabindex="-1"></a>    all_gls <span class="ot">&lt;-</span> all_gls <span class="sc">|&gt;</span></span>
<span id="cb10-403"><a href="#cb10-403" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">if_else</span>(<span class="sc">!</span><span class="fu">is.na</span>(gl_year), gl_year, year)) <span class="sc">|&gt;</span></span>
<span id="cb10-404"><a href="#cb10-404" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(gl_year_label, gl_year)) <span class="sc">|&gt;</span></span>
<span id="cb10-405"><a href="#cb10-405" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">town =</span> municipality) <span class="sc">|&gt;</span></span>
<span id="cb10-406"><a href="#cb10-406" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">town =</span> <span class="fu">str_to_title</span>(town))</span>
<span id="cb10-407"><a href="#cb10-407" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-408"><a href="#cb10-408" aria-hidden="true" tabindex="-1"></a>    all_acmrs <span class="ot">&lt;-</span> all_acmrs <span class="sc">|&gt;</span></span>
<span id="cb10-409"><a href="#cb10-409" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">town =</span> municipality) <span class="sc">|&gt;</span></span>
<span id="cb10-410"><a href="#cb10-410" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">town =</span> <span class="fu">str_to_title</span>(town))</span>
<span id="cb10-411"><a href="#cb10-411" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-412"><a href="#cb10-412" aria-hidden="true" tabindex="-1"></a>    ct_towns_counties <span class="ot">&lt;-</span> <span class="fu">load_ct_town_mapping</span>()</span>
<span id="cb10-413"><a href="#cb10-413" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-414"><a href="#cb10-414" aria-hidden="true" tabindex="-1"></a>    final <span class="ot">&lt;-</span> <span class="fu">inner_join</span>(all_gls, all_acmrs, <span class="fu">join_by</span>(town <span class="sc">==</span> town, year <span class="sc">==</span> year)) <span class="sc">|&gt;</span></span>
<span id="cb10-415"><a href="#cb10-415" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">property_tax_revenue =</span> (millrate <span class="sc">/</span> <span class="dv">1000</span>) <span class="sc">*</span> net_grand_list) <span class="sc">|&gt;</span></span>
<span id="cb10-416"><a href="#cb10-416" aria-hidden="true" tabindex="-1"></a>      <span class="fu">inner_join</span>(all_fiscin, <span class="fu">join_by</span>(town <span class="sc">==</span> town, year <span class="sc">==</span> fisc_year_end)) <span class="sc">|&gt;</span></span>
<span id="cb10-417"><a href="#cb10-417" aria-hidden="true" tabindex="-1"></a>      <span class="fu">inner_join</span>(ct_towns_counties <span class="sc">|&gt;</span> <span class="fu">rename</span>(<span class="at">county =</span> County) <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="st">"Town name"</span>, county), <span class="fu">join_by</span>(town <span class="sc">==</span> <span class="st">"Town name"</span>))</span>
<span id="cb10-418"><a href="#cb10-418" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-419"><a href="#cb10-419" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(final, f_path)</span>
<span id="cb10-420"><a href="#cb10-420" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb10-421"><a href="#cb10-421" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Reading existing data from CSV..."</span>)</span>
<span id="cb10-422"><a href="#cb10-422" aria-hidden="true" tabindex="-1"></a>    final <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(f_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb10-423"><a href="#cb10-423" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-424"><a href="#cb10-424" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-425"><a href="#cb10-425" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(final)</span>
<span id="cb10-426"><a href="#cb10-426" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-427"><a href="#cb10-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-428"><a href="#cb10-428" aria-hidden="true" tabindex="-1"></a><span class="co">#' Load and Clean CT Municipal Fiscal Indicators (2007–2012)</span></span>
<span id="cb10-429"><a href="#cb10-429" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-430"><a href="#cb10-430" aria-hidden="true" tabindex="-1"></a><span class="co">#' This function downloads, cleans, and formats Connecticut municipal fiscal indicators data</span></span>
<span id="cb10-431"><a href="#cb10-431" aria-hidden="true" tabindex="-1"></a><span class="co">#' for the years 2007 to 2012 from a public JSON API provided by the state. It saves the</span></span>
<span id="cb10-432"><a href="#cb10-432" aria-hidden="true" tabindex="-1"></a><span class="co">#' cleaned data to disk to avoid redundant downloads and processing in future runs.</span></span>
<span id="cb10-433"><a href="#cb10-433" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-434"><a href="#cb10-434" aria-hidden="true" tabindex="-1"></a><span class="co">#' Steps performed:</span></span>
<span id="cb10-435"><a href="#cb10-435" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Downloads JSON data if a local CSV file does not already exist.</span></span>
<span id="cb10-436"><a href="#cb10-436" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Cleans non-numeric fields and coerces them into numeric types.</span></span>
<span id="cb10-437"><a href="#cb10-437" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Standardizes town names and joins them with county mapping data.</span></span>
<span id="cb10-438"><a href="#cb10-438" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Calculates derived variables (e.g., property tax revenues).</span></span>
<span id="cb10-439"><a href="#cb10-439" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Filters out aggregate rows (e.g., "Statewide").</span></span>
<span id="cb10-440"><a href="#cb10-440" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Saves the cleaned data to a CSV file for future use.</span></span>
<span id="cb10-441"><a href="#cb10-441" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-442"><a href="#cb10-442" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A cleaned and joined data.frame (tibble) containing fiscal indicators</span></span>
<span id="cb10-443"><a href="#cb10-443" aria-hidden="true" tabindex="-1"></a><span class="co">#' for CT municipalities, including town, county, fiscal year, and tax data.</span></span>
<span id="cb10-444"><a href="#cb10-444" aria-hidden="true" tabindex="-1"></a><span class="co">#' @import dplyr, readr, httr, jsonlite, stringr</span></span>
<span id="cb10-445"><a href="#cb10-445" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb10-446"><a href="#cb10-446" aria-hidden="true" tabindex="-1"></a>load_MFI_2007_2012_data <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb10-447"><a href="#cb10-447" aria-hidden="true" tabindex="-1"></a>  target_dir <span class="ot">&lt;-</span> <span class="st">'data/individual_report/2007-2012'</span></span>
<span id="cb10-448"><a href="#cb10-448" aria-hidden="true" tabindex="-1"></a>  f_name <span class="ot">&lt;-</span> <span class="st">"ct_municipal_fiscal_indicators_2007_2012.csv"</span></span>
<span id="cb10-449"><a href="#cb10-449" aria-hidden="true" tabindex="-1"></a>  f_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, f_name)</span>
<span id="cb10-450"><a href="#cb10-450" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-451"><a href="#cb10-451" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(target_dir)) {</span>
<span id="cb10-452"><a href="#cb10-452" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(target_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb10-453"><a href="#cb10-453" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-454"><a href="#cb10-454" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-455"><a href="#cb10-455" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(f_path)) {</span>
<span id="cb10-456"><a href="#cb10-456" aria-hidden="true" tabindex="-1"></a>    clean_numeric <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb10-457"><a href="#cb10-457" aria-hidden="true" tabindex="-1"></a>      x <span class="sc">|&gt;</span></span>
<span id="cb10-458"><a href="#cb10-458" aria-hidden="true" tabindex="-1"></a>        <span class="fu">str_replace_all</span>(<span class="st">"[^0-9.-]"</span>, <span class="st">""</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-459"><a href="#cb10-459" aria-hidden="true" tabindex="-1"></a>        <span class="fu">as.numeric</span>()</span>
<span id="cb10-460"><a href="#cb10-460" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-461"><a href="#cb10-461" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-462"><a href="#cb10-462" aria-hidden="true" tabindex="-1"></a>    base_url <span class="ot">&lt;-</span> <span class="st">"https://data.ct.gov/resource/h7h2-manp.json"</span></span>
<span id="cb10-463"><a href="#cb10-463" aria-hidden="true" tabindex="-1"></a>    full_url <span class="ot">&lt;-</span> <span class="fu">paste0</span>(base_url, <span class="st">"?$limit=2000"</span>)</span>
<span id="cb10-464"><a href="#cb10-464" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-465"><a href="#cb10-465" aria-hidden="true" tabindex="-1"></a>    response <span class="ot">&lt;-</span> <span class="fu">GET</span>(full_url)</span>
<span id="cb10-466"><a href="#cb10-466" aria-hidden="true" tabindex="-1"></a>    ct_revenue_data <span class="ot">&lt;-</span> jsonlite<span class="sc">::</span><span class="fu">fromJSON</span>(<span class="fu">content</span>(response, <span class="at">as =</span> <span class="st">"text"</span>)) <span class="sc">|&gt;</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb10-467"><a href="#cb10-467" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-468"><a href="#cb10-468" aria-hidden="true" tabindex="-1"></a>    ct_towns_counties <span class="ot">&lt;-</span> <span class="fu">load_ct_town_mapping</span>()</span>
<span id="cb10-469"><a href="#cb10-469" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-470"><a href="#cb10-470" aria-hidden="true" tabindex="-1"></a>    ct_revenue_data <span class="ot">&lt;-</span> ct_revenue_data <span class="sc">|&gt;</span></span>
<span id="cb10-471"><a href="#cb10-471" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb10-472"><a href="#cb10-472" aria-hidden="true" tabindex="-1"></a>        <span class="at">town =</span> <span class="fu">str_to_title</span>(municipality),</span>
<span id="cb10-473"><a href="#cb10-473" aria-hidden="true" tabindex="-1"></a>        <span class="at">town =</span> <span class="fu">if_else</span>(town <span class="sc">==</span> <span class="st">"Groton (City Of)"</span>, <span class="st">"Groton"</span>, town)</span>
<span id="cb10-474"><a href="#cb10-474" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb10-475"><a href="#cb10-475" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span>municipality) <span class="sc">|&gt;</span></span>
<span id="cb10-476"><a href="#cb10-476" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb10-477"><a href="#cb10-477" aria-hidden="true" tabindex="-1"></a>        <span class="at">fisc_year_end =</span> <span class="fu">str_trim</span>(fisc_year_end),</span>
<span id="cb10-478"><a href="#cb10-478" aria-hidden="true" tabindex="-1"></a>        <span class="at">fiscal_year_end =</span> <span class="fu">as.double</span>(fisc_year_end)</span>
<span id="cb10-479"><a href="#cb10-479" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb10-480"><a href="#cb10-480" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span>fisc_year_end) <span class="sc">|&gt;</span></span>
<span id="cb10-481"><a href="#cb10-481" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb10-482"><a href="#cb10-482" aria-hidden="true" tabindex="-1"></a>        <span class="fu">across</span>(</span>
<span id="cb10-483"><a href="#cb10-483" aria-hidden="true" tabindex="-1"></a>          <span class="at">.cols =</span> <span class="sc">-</span><span class="fu">c</span>(fiscal_year_end, town, initials, county_identifier),</span>
<span id="cb10-484"><a href="#cb10-484" aria-hidden="true" tabindex="-1"></a>          <span class="at">.fns =</span> <span class="sc">~</span> {</span>
<span id="cb10-485"><a href="#cb10-485" aria-hidden="true" tabindex="-1"></a>            num_check <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(.))</span>
<span id="cb10-486"><a href="#cb10-486" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(<span class="fu">is.na</span>(num_check))) <span class="fu">clean_numeric</span>(.) <span class="cf">else</span> .</span>
<span id="cb10-487"><a href="#cb10-487" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb10-488"><a href="#cb10-488" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb10-489"><a href="#cb10-489" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb10-490"><a href="#cb10-490" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb10-491"><a href="#cb10-491" aria-hidden="true" tabindex="-1"></a>        <span class="at">property_tax_revenues =</span> <span class="fu">as.numeric</span>(egl) <span class="sc">*</span> (<span class="fu">as.numeric</span>(acmr) <span class="sc">/</span> <span class="dv">1000</span>)</span>
<span id="cb10-492"><a href="#cb10-492" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb10-493"><a href="#cb10-493" aria-hidden="true" tabindex="-1"></a>      <span class="fu">left_join</span>(</span>
<span id="cb10-494"><a href="#cb10-494" aria-hidden="true" tabindex="-1"></a>        ct_towns_counties <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="st">`</span><span class="at">Town name</span><span class="st">`</span>, County),</span>
<span id="cb10-495"><a href="#cb10-495" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"town"</span> <span class="ot">=</span> <span class="st">"Town name"</span>)</span>
<span id="cb10-496"><a href="#cb10-496" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb10-497"><a href="#cb10-497" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb10-498"><a href="#cb10-498" aria-hidden="true" tabindex="-1"></a>        <span class="fu">across</span>(</span>
<span id="cb10-499"><a href="#cb10-499" aria-hidden="true" tabindex="-1"></a>          <span class="fu">where</span>(<span class="sc">~</span> <span class="fu">is.character</span>(.) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">anyNA</span>(<span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(.)))),</span>
<span id="cb10-500"><a href="#cb10-500" aria-hidden="true" tabindex="-1"></a>          <span class="sc">~</span> <span class="fu">as.numeric</span>(.)</span>
<span id="cb10-501"><a href="#cb10-501" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb10-502"><a href="#cb10-502" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb10-503"><a href="#cb10-503" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(town <span class="sc">!=</span> <span class="st">"Statewide"</span>)</span>
<span id="cb10-504"><a href="#cb10-504" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-505"><a href="#cb10-505" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(ct_revenue_data, f_path)</span>
<span id="cb10-506"><a href="#cb10-506" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb10-507"><a href="#cb10-507" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Reading existing data from CSV..."</span>)</span>
<span id="cb10-508"><a href="#cb10-508" aria-hidden="true" tabindex="-1"></a>    ct_revenue_data <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(f_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb10-509"><a href="#cb10-509" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-510"><a href="#cb10-510" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-511"><a href="#cb10-511" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(ct_revenue_data)</span>
<span id="cb10-512"><a href="#cb10-512" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-513"><a href="#cb10-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-514"><a href="#cb10-514" aria-hidden="true" tabindex="-1"></a><span class="co">#' Load and Process CT Municipal Fiscal Indicators (2011–2015)</span></span>
<span id="cb10-515"><a href="#cb10-515" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-516"><a href="#cb10-516" aria-hidden="true" tabindex="-1"></a><span class="co">#' This function downloads, extracts, and processes Connecticut municipal fiscal indicators data</span></span>
<span id="cb10-517"><a href="#cb10-517" aria-hidden="true" tabindex="-1"></a><span class="co">#' for the years 2011–2015. The data is retrieved from a ZIP archive containing an Access (.mdb) database.</span></span>
<span id="cb10-518"><a href="#cb10-518" aria-hidden="true" tabindex="-1"></a><span class="co">#' It extracts multiple tables, merges key indicators (e.g., population, TANF recipients, Moody's bond ratings,</span></span>
<span id="cb10-519"><a href="#cb10-519" aria-hidden="true" tabindex="-1"></a><span class="co">#' net assets), and computes derived metrics such as property tax revenue. The processed dataset is saved</span></span>
<span id="cb10-520"><a href="#cb10-520" aria-hidden="true" tabindex="-1"></a><span class="co">#' as a CSV file for future use to avoid repeated downloading and processing.</span></span>
<span id="cb10-521"><a href="#cb10-521" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-522"><a href="#cb10-522" aria-hidden="true" tabindex="-1"></a><span class="co">#' Processing steps include:</span></span>
<span id="cb10-523"><a href="#cb10-523" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Downloading and unzipping MDB archive from a public data portal if not already present</span></span>
<span id="cb10-524"><a href="#cb10-524" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Extracting all tables from the Access database using mdb-tools</span></span>
<span id="cb10-525"><a href="#cb10-525" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Cleaning and combining fiscal data (FISCIN tables from 2010–2015)</span></span>
<span id="cb10-526"><a href="#cb10-526" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Combining Net Grand List and mill rate (ACMR) tables from 2009–2015</span></span>
<span id="cb10-527"><a href="#cb10-527" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Computing `property_tax_revenue` from Net Grand List and mill rate</span></span>
<span id="cb10-528"><a href="#cb10-528" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Standardizing and coalescing fiscal year and town-level indicators</span></span>
<span id="cb10-529"><a href="#cb10-529" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Merging with a town-to-county mapping dataset</span></span>
<span id="cb10-530"><a href="#cb10-530" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-531"><a href="#cb10-531" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A cleaned and joined `data.frame` (tibble) containing town-level fiscal, demographic, and revenue data</span></span>
<span id="cb10-532"><a href="#cb10-532" aria-hidden="true" tabindex="-1"></a><span class="co">#'         for CT municipalities from 2011 to 2015, including columns such as `town`, `year`, `population`,</span></span>
<span id="cb10-533"><a href="#cb10-533" aria-hidden="true" tabindex="-1"></a><span class="co">#'         `net_grand_list`, `millrate`, `property_tax_revenue`, `moodys_bond_rating`, `tanf_recipients`, and `county`.</span></span>
<span id="cb10-534"><a href="#cb10-534" aria-hidden="true" tabindex="-1"></a><span class="co">#' @import dplyr, readr, tidyr, stringr</span></span>
<span id="cb10-535"><a href="#cb10-535" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb10-536"><a href="#cb10-536" aria-hidden="true" tabindex="-1"></a>load_MFI_2011_2015_data <span class="ot">&lt;-</span> <span class="cf">function</span>(){</span>
<span id="cb10-537"><a href="#cb10-537" aria-hidden="true" tabindex="-1"></a>  target_dir <span class="ot">&lt;-</span> <span class="st">'data/individual_report/2011-2015'</span></span>
<span id="cb10-538"><a href="#cb10-538" aria-hidden="true" tabindex="-1"></a>  f_name <span class="ot">&lt;-</span> <span class="st">"ct_municipal_fiscal_indicators_2011_2015.csv"</span></span>
<span id="cb10-539"><a href="#cb10-539" aria-hidden="true" tabindex="-1"></a>  f_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, f_name)</span>
<span id="cb10-540"><a href="#cb10-540" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-541"><a href="#cb10-541" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(target_dir)){</span>
<span id="cb10-542"><a href="#cb10-542" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(target_dir, <span class="at">recursive=</span><span class="cn">TRUE</span>)</span>
<span id="cb10-543"><a href="#cb10-543" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-544"><a href="#cb10-544" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-545"><a href="#cb10-545" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(f_path)){</span>
<span id="cb10-546"><a href="#cb10-546" aria-hidden="true" tabindex="-1"></a>    mdb_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, <span class="st">"MuniFiscalIndicators_11_15.mdb"</span>)</span>
<span id="cb10-547"><a href="#cb10-547" aria-hidden="true" tabindex="-1"></a>    output_dir <span class="ot">&lt;-</span> target_dir</span>
<span id="cb10-548"><a href="#cb10-548" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-549"><a href="#cb10-549" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(<span class="fu">file.path</span>(target_dir, <span class="st">"2011-2015.zip"</span>))){</span>
<span id="cb10-550"><a href="#cb10-550" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Define the URL</span></span>
<span id="cb10-551"><a href="#cb10-551" aria-hidden="true" tabindex="-1"></a>      <span class="fu">download.file</span>(<span class="st">"https://data.ct.gov/download/uij9-wzqw/application%2Fzip"</span>, <span class="at">destfile =</span> <span class="fu">file.path</span>(target_dir, <span class="st">"2011-2015.zip"</span>))</span>
<span id="cb10-552"><a href="#cb10-552" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-553"><a href="#cb10-553" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-554"><a href="#cb10-554" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unzip</span>(<span class="fu">file.path</span>(target_dir, <span class="st">"2011-2015.zip"</span>),<span class="at">exdir =</span> <span class="fu">file.path</span>(target_dir))</span>
<span id="cb10-555"><a href="#cb10-555" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-556"><a href="#cb10-556" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ensure_mdbtools</span>()</span>
<span id="cb10-557"><a href="#cb10-557" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-558"><a href="#cb10-558" aria-hidden="true" tabindex="-1"></a>    <span class="co"># List all table names in the MDB file</span></span>
<span id="cb10-559"><a href="#cb10-559" aria-hidden="true" tabindex="-1"></a>    tables <span class="ot">&lt;-</span> <span class="fu">system</span>(<span class="fu">paste</span>(<span class="st">"mdb-tables -1"</span>, <span class="fu">shQuote</span>(mdb_file)), <span class="at">intern =</span> <span class="cn">TRUE</span>)</span>
<span id="cb10-560"><a href="#cb10-560" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-561"><a href="#cb10-561" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Loop through each table and export to CSV</span></span>
<span id="cb10-562"><a href="#cb10-562" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (table_name <span class="cf">in</span> tables) {</span>
<span id="cb10-563"><a href="#cb10-563" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Clean up table name for file output (e.g., replace spaces with underscores)</span></span>
<span id="cb10-564"><a href="#cb10-564" aria-hidden="true" tabindex="-1"></a>      output_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(output_dir, <span class="fu">paste0</span>(<span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">"_"</span>, table_name), <span class="st">".csv"</span>))</span>
<span id="cb10-565"><a href="#cb10-565" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb10-566"><a href="#cb10-566" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Construct and run the export command</span></span>
<span id="cb10-567"><a href="#cb10-567" aria-hidden="true" tabindex="-1"></a>      cmd <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"mdb-export"</span>, <span class="fu">shQuote</span>(mdb_file), <span class="fu">shQuote</span>(table_name), <span class="st">"&gt;"</span>, <span class="fu">shQuote</span>(output_file))</span>
<span id="cb10-568"><a href="#cb10-568" aria-hidden="true" tabindex="-1"></a>      <span class="fu">system</span>(cmd)</span>
<span id="cb10-569"><a href="#cb10-569" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-570"><a href="#cb10-570" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-571"><a href="#cb10-571" aria-hidden="true" tabindex="-1"></a>    all_fiscin <span class="ot">=</span> <span class="fu">data.frame</span>()</span>
<span id="cb10-572"><a href="#cb10-572" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-573"><a href="#cb10-573" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (y <span class="cf">in</span> <span class="dv">10</span><span class="sc">:</span><span class="dv">15</span>){</span>
<span id="cb10-574"><a href="#cb10-574" aria-hidden="true" tabindex="-1"></a>      fiscin_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir,<span class="fu">paste0</span>(<span class="st">"FISCIN"</span>,<span class="fu">sprintf</span>(<span class="st">"%02d"</span>, y),<span class="st">".csv"</span>))</span>
<span id="cb10-575"><a href="#cb10-575" aria-hidden="true" tabindex="-1"></a>      df <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(fiscin_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-576"><a href="#cb10-576" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rename_with</span>(str_to_lower)</span>
<span id="cb10-577"><a href="#cb10-577" aria-hidden="true" tabindex="-1"></a>      all_fiscin <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(all_fiscin, df)</span>
<span id="cb10-578"><a href="#cb10-578" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-579"><a href="#cb10-579" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-580"><a href="#cb10-580" aria-hidden="true" tabindex="-1"></a>    all_fiscin <span class="ot">&lt;-</span> </span>
<span id="cb10-581"><a href="#cb10-581" aria-hidden="true" tabindex="-1"></a>      all_fiscin <span class="sc">|&gt;</span></span>
<span id="cb10-582"><a href="#cb10-582" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb10-583"><a href="#cb10-583" aria-hidden="true" tabindex="-1"></a>        <span class="at">population =</span> <span class="fu">coalesce</span>(</span>
<span id="cb10-584"><a href="#cb10-584" aria-hidden="true" tabindex="-1"></a>          <span class="st">`</span><span class="at">2015 population</span><span class="st">`</span>, <span class="st">`</span><span class="at">2014 population</span><span class="st">`</span>, <span class="st">`</span><span class="at">2013 population</span><span class="st">`</span>, <span class="st">`</span><span class="at">2012 population</span><span class="st">`</span>,</span>
<span id="cb10-585"><a href="#cb10-585" aria-hidden="true" tabindex="-1"></a>          <span class="st">`</span><span class="at">2011 population</span><span class="st">`</span>, <span class="st">`</span><span class="at">2010 population</span><span class="st">`</span></span>
<span id="cb10-586"><a href="#cb10-586" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb10-587"><a href="#cb10-587" aria-hidden="true" tabindex="-1"></a>        <span class="at">moodys_bond_rating =</span> <span class="fu">coalesce</span>(</span>
<span id="cb10-588"><a href="#cb10-588" aria-hidden="true" tabindex="-1"></a>          <span class="st">`</span><span class="at">moody's_bond_ratings_nov_2016</span><span class="st">`</span>, <span class="st">`</span><span class="at">moody's_bond_ratings_july_2015</span><span class="st">`</span>,</span>
<span id="cb10-589"><a href="#cb10-589" aria-hidden="true" tabindex="-1"></a>          <span class="st">`</span><span class="at">moody's_bond_ratings_dec_2014</span><span class="st">`</span>, <span class="st">`</span><span class="at">moody's_bond_ratings_july_2014</span><span class="st">`</span>,</span>
<span id="cb10-590"><a href="#cb10-590" aria-hidden="true" tabindex="-1"></a>          <span class="st">`</span><span class="at">moody's_bond_ratings_july_2013</span><span class="st">`</span>, <span class="st">`</span><span class="at">moody's_bond_ratings_july2012</span><span class="st">`</span>,</span>
<span id="cb10-591"><a href="#cb10-591" aria-hidden="true" tabindex="-1"></a>          <span class="st">`</span><span class="at">moody's_bond_ratings_july2011</span><span class="st">`</span>, <span class="st">`</span><span class="at">moody's_bond_ratings_july2010</span><span class="st">`</span></span>
<span id="cb10-592"><a href="#cb10-592" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb10-593"><a href="#cb10-593" aria-hidden="true" tabindex="-1"></a>        <span class="at">acglfy =</span> <span class="fu">coalesce</span>(acglfy15, acglfy14, acglfy13, acglfy12, acglfy11, acglfy10),</span>
<span id="cb10-594"><a href="#cb10-594" aria-hidden="true" tabindex="-1"></a>        <span class="at">tanf_recipients =</span> <span class="fu">coalesce</span>(</span>
<span id="cb10-595"><a href="#cb10-595" aria-hidden="true" tabindex="-1"></a>          <span class="st">`</span><span class="at">tanf15 recipients</span><span class="st">`</span>, <span class="st">`</span><span class="at">tanf14 recipients</span><span class="st">`</span>, <span class="st">`</span><span class="at">tanf13 recipients</span><span class="st">`</span>, <span class="st">`</span><span class="at">tanf12 recipients</span><span class="st">`</span>,</span>
<span id="cb10-596"><a href="#cb10-596" aria-hidden="true" tabindex="-1"></a>          <span class="st">`</span><span class="at">tanf11 recipients</span><span class="st">`</span>, <span class="st">`</span><span class="at">tanf10 recipients</span><span class="st">`</span></span>
<span id="cb10-597"><a href="#cb10-597" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb10-598"><a href="#cb10-598" aria-hidden="true" tabindex="-1"></a>        <span class="at">net_assets =</span> <span class="fu">coalesce</span>(<span class="st">`</span><span class="at">total net assets</span><span class="st">`</span>, <span class="st">`</span><span class="at">total net position</span><span class="st">`</span>),</span>
<span id="cb10-599"><a href="#cb10-599" aria-hidden="true" tabindex="-1"></a>        <span class="at">change_in_net_assets =</span> <span class="fu">coalesce</span>(<span class="st">`</span><span class="at">change in net assets</span><span class="st">`</span>, <span class="st">`</span><span class="at">change in net position</span><span class="st">`</span>),</span>
<span id="cb10-600"><a href="#cb10-600" aria-hidden="true" tabindex="-1"></a>        <span class="at">unrestricted_net =</span> <span class="fu">coalesce</span>(<span class="st">`</span><span class="at">unrestricted net assets</span><span class="st">`</span>, <span class="st">`</span><span class="at">unrestricted net position</span><span class="st">`</span>),</span>
<span id="cb10-601"><a href="#cb10-601" aria-hidden="true" tabindex="-1"></a>        <span class="at">invested_in_capital =</span> <span class="fu">coalesce</span>(</span>
<span id="cb10-602"><a href="#cb10-602" aria-hidden="true" tabindex="-1"></a>          <span class="st">`</span><span class="at">invested in capital assets net of related debt</span><span class="st">`</span>,</span>
<span id="cb10-603"><a href="#cb10-603" aria-hidden="true" tabindex="-1"></a>          <span class="st">`</span><span class="at">net investment in capital assets</span><span class="st">`</span></span>
<span id="cb10-604"><a href="#cb10-604" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb10-605"><a href="#cb10-605" aria-hidden="true" tabindex="-1"></a>        <span class="at">restatement =</span> <span class="fu">coalesce</span>(</span>
<span id="cb10-606"><a href="#cb10-606" aria-hidden="true" tabindex="-1"></a>          <span class="st">`</span><span class="at">restatement (y or n)</span><span class="st">`</span>,</span>
<span id="cb10-607"><a href="#cb10-607" aria-hidden="true" tabindex="-1"></a>          <span class="st">`</span><span class="at">restatement of fund balance (y or n)</span><span class="st">`</span></span>
<span id="cb10-608"><a href="#cb10-608" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb10-609"><a href="#cb10-609" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb10-610"><a href="#cb10-610" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(</span>
<span id="cb10-611"><a href="#cb10-611" aria-hidden="true" tabindex="-1"></a>        <span class="fu">matches</span>(<span class="st">"^20</span><span class="sc">\\</span><span class="st">d{2} population$"</span>),</span>
<span id="cb10-612"><a href="#cb10-612" aria-hidden="true" tabindex="-1"></a>        <span class="fu">matches</span>(<span class="st">"moody's_bond_ratings"</span>),</span>
<span id="cb10-613"><a href="#cb10-613" aria-hidden="true" tabindex="-1"></a>        <span class="fu">matches</span>(<span class="st">"^acglfy</span><span class="sc">\\</span><span class="st">d{2}$"</span>),</span>
<span id="cb10-614"><a href="#cb10-614" aria-hidden="true" tabindex="-1"></a>        <span class="fu">matches</span>(<span class="st">"^tanf</span><span class="sc">\\</span><span class="st">d{2} recipients$"</span>),</span>
<span id="cb10-615"><a href="#cb10-615" aria-hidden="true" tabindex="-1"></a>        <span class="st">"total net assets"</span>, <span class="st">"total net position"</span>,</span>
<span id="cb10-616"><a href="#cb10-616" aria-hidden="true" tabindex="-1"></a>        <span class="st">"change in net assets"</span>, <span class="st">"change in net position"</span>,</span>
<span id="cb10-617"><a href="#cb10-617" aria-hidden="true" tabindex="-1"></a>        <span class="st">"unrestricted net assets"</span>, <span class="st">"unrestricted net position"</span>,</span>
<span id="cb10-618"><a href="#cb10-618" aria-hidden="true" tabindex="-1"></a>        <span class="st">"invested in capital assets net of related debt"</span>, <span class="st">"net investment in capital assets"</span>,</span>
<span id="cb10-619"><a href="#cb10-619" aria-hidden="true" tabindex="-1"></a>        <span class="st">"restatement (y or n)"</span>, <span class="st">"restatement of fund balance (y or n)"</span></span>
<span id="cb10-620"><a href="#cb10-620" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb10-621"><a href="#cb10-621" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span> </span>
<span id="cb10-622"><a href="#cb10-622" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename_with</span>(<span class="sc">~</span> .x <span class="sc">|&gt;</span></span>
<span id="cb10-623"><a href="#cb10-623" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">str_replace_all</span>(<span class="st">" "</span>, <span class="st">"_"</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-624"><a href="#cb10-624" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">str_replace_all</span>(<span class="st">"[^A-Za-z0-9_]"</span>, <span class="st">""</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-625"><a href="#cb10-625" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">str_replace_all</span>(<span class="st">"__"</span>, <span class="st">"_"</span>)</span>
<span id="cb10-626"><a href="#cb10-626" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span> </span>
<span id="cb10-627"><a href="#cb10-627" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">town =</span> municipality) <span class="sc">|&gt;</span></span>
<span id="cb10-628"><a href="#cb10-628" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb10-629"><a href="#cb10-629" aria-hidden="true" tabindex="-1"></a>        <span class="at">town =</span> <span class="fu">str_to_title</span>(town),</span>
<span id="cb10-630"><a href="#cb10-630" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb10-631"><a href="#cb10-631" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-632"><a href="#cb10-632" aria-hidden="true" tabindex="-1"></a>    all_gls <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb10-633"><a href="#cb10-633" aria-hidden="true" tabindex="-1"></a>    all_acmrs <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb10-634"><a href="#cb10-634" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-635"><a href="#cb10-635" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (year <span class="cf">in</span> <span class="fu">c</span>(<span class="dv">2009</span><span class="sc">:</span><span class="dv">2015</span>)){</span>
<span id="cb10-636"><a href="#cb10-636" aria-hidden="true" tabindex="-1"></a>      gl_file_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, <span class="fu">paste0</span>(<span class="st">"NetGL"</span>, year, <span class="st">".csv"</span>))</span>
<span id="cb10-637"><a href="#cb10-637" aria-hidden="true" tabindex="-1"></a>      acmr_file_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, <span class="fu">paste0</span>(<span class="st">"ACMR_"</span>, year, <span class="st">"_GL_Year.csv"</span>))</span>
<span id="cb10-638"><a href="#cb10-638" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb10-639"><a href="#cb10-639" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">file.exists</span>(gl_file_path)){</span>
<span id="cb10-640"><a href="#cb10-640" aria-hidden="true" tabindex="-1"></a>        df1 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(gl_file_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-641"><a href="#cb10-641" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(<span class="at">gl_year =</span> year) <span class="sc">|&gt;</span> </span>
<span id="cb10-642"><a href="#cb10-642" aria-hidden="true" tabindex="-1"></a>          <span class="fu">rename_with</span>(</span>
<span id="cb10-643"><a href="#cb10-643" aria-hidden="true" tabindex="-1"></a>            <span class="sc">~</span> <span class="fu">str_replace</span>(., <span class="st">"Net Grand List.*"</span>, <span class="fu">paste0</span>(<span class="st">"Net Grand List - "</span>, year, <span class="st">" GL Year"</span>)),</span>
<span id="cb10-644"><a href="#cb10-644" aria-hidden="true" tabindex="-1"></a>            <span class="fu">matches</span>(<span class="st">"Net Grand List"</span>)</span>
<span id="cb10-645"><a href="#cb10-645" aria-hidden="true" tabindex="-1"></a>          ) <span class="sc">|&gt;</span></span>
<span id="cb10-646"><a href="#cb10-646" aria-hidden="true" tabindex="-1"></a>          <span class="fu">pivot_longer</span>(</span>
<span id="cb10-647"><a href="#cb10-647" aria-hidden="true" tabindex="-1"></a>            <span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"Net Grand List"</span>),</span>
<span id="cb10-648"><a href="#cb10-648" aria-hidden="true" tabindex="-1"></a>            <span class="at">names_to =</span> <span class="st">"gl_year_label"</span>,</span>
<span id="cb10-649"><a href="#cb10-649" aria-hidden="true" tabindex="-1"></a>            <span class="at">values_to =</span> <span class="st">"net_grand_list"</span></span>
<span id="cb10-650"><a href="#cb10-650" aria-hidden="true" tabindex="-1"></a>          ) <span class="sc">|&gt;</span></span>
<span id="cb10-651"><a href="#cb10-651" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(</span>
<span id="cb10-652"><a href="#cb10-652" aria-hidden="true" tabindex="-1"></a>            <span class="at">gl_year =</span> <span class="fu">as.integer</span>(<span class="fu">str_extract</span>(gl_year_label, <span class="st">"</span><span class="sc">\\</span><span class="st">d{4}"</span>))</span>
<span id="cb10-653"><a href="#cb10-653" aria-hidden="true" tabindex="-1"></a>          ) <span class="sc">|&gt;</span></span>
<span id="cb10-654"><a href="#cb10-654" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(net_grand_list))</span>
<span id="cb10-655"><a href="#cb10-655" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb10-656"><a href="#cb10-656" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb10-657"><a href="#cb10-657" aria-hidden="true" tabindex="-1"></a>      all_gls <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(all_gls, df1 <span class="sc">|&gt;</span> <span class="fu">rename_with</span>(tolower))</span>
<span id="cb10-658"><a href="#cb10-658" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb10-659"><a href="#cb10-659" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">file.exists</span>(acmr_file_path)){</span>
<span id="cb10-660"><a href="#cb10-660" aria-hidden="true" tabindex="-1"></a>        df2 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(acmr_file_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) </span>
<span id="cb10-661"><a href="#cb10-661" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-662"><a href="#cb10-662" aria-hidden="true" tabindex="-1"></a>        df2 <span class="ot">&lt;-</span> df2 <span class="sc">|&gt;</span></span>
<span id="cb10-663"><a href="#cb10-663" aria-hidden="true" tabindex="-1"></a>          <span class="fu">rename</span>(<span class="at">millrate =</span> <span class="fu">matches</span>(<span class="st">"Mil"</span>))</span>
<span id="cb10-664"><a href="#cb10-664" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-665"><a href="#cb10-665" aria-hidden="true" tabindex="-1"></a>        year_col <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"Year"</span>, <span class="fu">names</span>(df2), <span class="at">value =</span> <span class="cn">TRUE</span>)</span>
<span id="cb10-666"><a href="#cb10-666" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-667"><a href="#cb10-667" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">length</span>(year_col) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb10-668"><a href="#cb10-668" aria-hidden="true" tabindex="-1"></a>          df2 <span class="ot">&lt;-</span> df2 <span class="sc">|&gt;</span></span>
<span id="cb10-669"><a href="#cb10-669" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mutate</span>(<span class="at">year =</span> year) </span>
<span id="cb10-670"><a href="#cb10-670" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb10-671"><a href="#cb10-671" aria-hidden="true" tabindex="-1"></a>          df2 <span class="ot">&lt;-</span> df2 <span class="sc">|&gt;</span></span>
<span id="cb10-672"><a href="#cb10-672" aria-hidden="true" tabindex="-1"></a>            <span class="fu">rename_with</span>(<span class="sc">~</span> <span class="st">"year"</span>, <span class="at">.cols =</span> <span class="fu">all_of</span>(year_col[<span class="dv">1</span>]))</span>
<span id="cb10-673"><a href="#cb10-673" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb10-674"><a href="#cb10-674" aria-hidden="true" tabindex="-1"></a>        all_acmrs <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(all_acmrs, df2)</span>
<span id="cb10-675"><a href="#cb10-675" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-676"><a href="#cb10-676" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb10-677"><a href="#cb10-677" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-678"><a href="#cb10-678" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-679"><a href="#cb10-679" aria-hidden="true" tabindex="-1"></a>    all_gls <span class="ot">&lt;-</span></span>
<span id="cb10-680"><a href="#cb10-680" aria-hidden="true" tabindex="-1"></a>      all_gls <span class="sc">|&gt;</span></span>
<span id="cb10-681"><a href="#cb10-681" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">case_when</span>(</span>
<span id="cb10-682"><a href="#cb10-682" aria-hidden="true" tabindex="-1"></a>        <span class="sc">!</span><span class="fu">is.na</span>(gl_year) <span class="sc">~</span> gl_year,</span>
<span id="cb10-683"><a href="#cb10-683" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> year</span>
<span id="cb10-684"><a href="#cb10-684" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb10-685"><a href="#cb10-685" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb10-686"><a href="#cb10-686" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(gl_year_label, gl_year)) <span class="sc">|&gt;</span></span>
<span id="cb10-687"><a href="#cb10-687" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(</span>
<span id="cb10-688"><a href="#cb10-688" aria-hidden="true" tabindex="-1"></a>        <span class="at">town =</span> municipality,</span>
<span id="cb10-689"><a href="#cb10-689" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb10-690"><a href="#cb10-690" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb10-691"><a href="#cb10-691" aria-hidden="true" tabindex="-1"></a>        <span class="at">town =</span> <span class="fu">str_to_title</span>(town),</span>
<span id="cb10-692"><a href="#cb10-692" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb10-693"><a href="#cb10-693" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-694"><a href="#cb10-694" aria-hidden="true" tabindex="-1"></a>    all_acmrs <span class="ot">&lt;-</span></span>
<span id="cb10-695"><a href="#cb10-695" aria-hidden="true" tabindex="-1"></a>      all_acmrs <span class="sc">|&gt;</span> </span>
<span id="cb10-696"><a href="#cb10-696" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">millrate =</span> <span class="fu">case_when</span>(</span>
<span id="cb10-697"><a href="#cb10-697" aria-hidden="true" tabindex="-1"></a>        <span class="fu">is.na</span>(millrate) <span class="sc">~</span> <span class="fu">coalesce</span>(millrate1,millrate2, millrate3),</span>
<span id="cb10-698"><a href="#cb10-698" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> millrate</span>
<span id="cb10-699"><a href="#cb10-699" aria-hidden="true" tabindex="-1"></a>      ))</span>
<span id="cb10-700"><a href="#cb10-700" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-701"><a href="#cb10-701" aria-hidden="true" tabindex="-1"></a>    all_acmrs <span class="ot">&lt;-</span></span>
<span id="cb10-702"><a href="#cb10-702" aria-hidden="true" tabindex="-1"></a>      all_acmrs <span class="sc">|&gt;</span></span>
<span id="cb10-703"><a href="#cb10-703" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(</span>
<span id="cb10-704"><a href="#cb10-704" aria-hidden="true" tabindex="-1"></a>        <span class="at">town =</span> Municipality</span>
<span id="cb10-705"><a href="#cb10-705" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb10-706"><a href="#cb10-706" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb10-707"><a href="#cb10-707" aria-hidden="true" tabindex="-1"></a>        <span class="at">town =</span> <span class="fu">str_to_title</span>(town),</span>
<span id="cb10-708"><a href="#cb10-708" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb10-709"><a href="#cb10-709" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-710"><a href="#cb10-710" aria-hidden="true" tabindex="-1"></a>    ct_towns_counties <span class="ot">&lt;-</span> <span class="fu">load_ct_town_mapping</span>()</span>
<span id="cb10-711"><a href="#cb10-711" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-712"><a href="#cb10-712" aria-hidden="true" tabindex="-1"></a>    final <span class="ot">&lt;-</span> <span class="fu">inner_join</span>(</span>
<span id="cb10-713"><a href="#cb10-713" aria-hidden="true" tabindex="-1"></a>      all_gls, all_acmrs, <span class="fu">join_by</span>(town <span class="sc">==</span> town, year <span class="sc">==</span> year)</span>
<span id="cb10-714"><a href="#cb10-714" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> <span class="fu">mutate</span>(</span>
<span id="cb10-715"><a href="#cb10-715" aria-hidden="true" tabindex="-1"></a>      <span class="at">property_tax_revenue =</span> (millrate<span class="sc">/</span><span class="dv">1000</span>) <span class="sc">*</span> net_grand_list</span>
<span id="cb10-716"><a href="#cb10-716" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb10-717"><a href="#cb10-717" aria-hidden="true" tabindex="-1"></a>      <span class="fu">inner_join</span>(all_fiscin, <span class="fu">join_by</span>(town <span class="sc">==</span> town, year <span class="sc">==</span> fisc_year_end )) <span class="sc">|&gt;</span></span>
<span id="cb10-718"><a href="#cb10-718" aria-hidden="true" tabindex="-1"></a>      <span class="fu">inner_join</span>(ct_towns_counties <span class="sc">|&gt;</span> <span class="fu">rename</span>(<span class="at">county =</span> County) <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="st">"Town name"</span>, county), <span class="fu">join_by</span>(town <span class="sc">==</span> <span class="st">"Town name"</span>))</span>
<span id="cb10-719"><a href="#cb10-719" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-720"><a href="#cb10-720" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(final, f_path)</span>
<span id="cb10-721"><a href="#cb10-721" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span>{</span>
<span id="cb10-722"><a href="#cb10-722" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Reading existing data from CSV..."</span>)</span>
<span id="cb10-723"><a href="#cb10-723" aria-hidden="true" tabindex="-1"></a>    final <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(f_path,, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb10-724"><a href="#cb10-724" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-725"><a href="#cb10-725" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(final)</span>
<span id="cb10-726"><a href="#cb10-726" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-727"><a href="#cb10-727" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-728"><a href="#cb10-728" aria-hidden="true" tabindex="-1"></a><span class="co">#' Load and Consolidate CT Municipal Fiscal Revenue Data (2003–2022)</span></span>
<span id="cb10-729"><a href="#cb10-729" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-730"><a href="#cb10-730" aria-hidden="true" tabindex="-1"></a><span class="co">#' This function loads, cleans, and merges Connecticut municipal fiscal indicators data</span></span>
<span id="cb10-731"><a href="#cb10-731" aria-hidden="true" tabindex="-1"></a><span class="co">#' from multiple overlapping sources spanning the years 2003 to 2022. If the consolidated</span></span>
<span id="cb10-732"><a href="#cb10-732" aria-hidden="true" tabindex="-1"></a><span class="co">#' dataset is not already cached locally, it triggers the loading of five different MFI</span></span>
<span id="cb10-733"><a href="#cb10-733" aria-hidden="true" tabindex="-1"></a><span class="co">#' (Municipal Fiscal Indicators) datasets, coalesces overlapping columns, and standardizes</span></span>
<span id="cb10-734"><a href="#cb10-734" aria-hidden="true" tabindex="-1"></a><span class="co">#' key fiscal metrics across years and data formats.</span></span>
<span id="cb10-735"><a href="#cb10-735" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-736"><a href="#cb10-736" aria-hidden="true" tabindex="-1"></a><span class="co">#' Data sources:</span></span>
<span id="cb10-737"><a href="#cb10-737" aria-hidden="true" tabindex="-1"></a><span class="co">#' - 2003–2007</span></span>
<span id="cb10-738"><a href="#cb10-738" aria-hidden="true" tabindex="-1"></a><span class="co">#' - 2007–2011</span></span>
<span id="cb10-739"><a href="#cb10-739" aria-hidden="true" tabindex="-1"></a><span class="co">#' - 2007–2012</span></span>
<span id="cb10-740"><a href="#cb10-740" aria-hidden="true" tabindex="-1"></a><span class="co">#' - 2011–2015</span></span>
<span id="cb10-741"><a href="#cb10-741" aria-hidden="true" tabindex="-1"></a><span class="co">#' - 2014–2022</span></span>
<span id="cb10-742"><a href="#cb10-742" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-743"><a href="#cb10-743" aria-hidden="true" tabindex="-1"></a><span class="co">#' Cleaning operations include:</span></span>
<span id="cb10-744"><a href="#cb10-744" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Column name normalization using `janitor::clean_names`</span></span>
<span id="cb10-745"><a href="#cb10-745" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Coalescing duplicate columns for common metrics (e.g., tax rates, population, revenues)</span></span>
<span id="cb10-746"><a href="#cb10-746" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Renaming columns for consistency across years and sources</span></span>
<span id="cb10-747"><a href="#cb10-747" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Removing superseded or redundant columns</span></span>
<span id="cb10-748"><a href="#cb10-748" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Saving the cleaned and unified dataset as a CSV file to avoid redundant computation</span></span>
<span id="cb10-749"><a href="#cb10-749" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-750"><a href="#cb10-750" aria-hidden="true" tabindex="-1"></a><span class="co">#' Key output variables include: `year`, `town`, `property_tax_revenues`, `millrate`,</span></span>
<span id="cb10-751"><a href="#cb10-751" aria-hidden="true" tabindex="-1"></a><span class="co">#' `total_fund_balance`, `education_expenditures`, `school_enrollment_average`, `population`,</span></span>
<span id="cb10-752"><a href="#cb10-752" aria-hidden="true" tabindex="-1"></a><span class="co">#' `equalized_net_grand_list`, `moodys_bond_rating`, `restatement_y_or_n`, `unemployment_annual_average`,</span></span>
<span id="cb10-753"><a href="#cb10-753" aria-hidden="true" tabindex="-1"></a><span class="co">#' `invested_in_capital_assets_net_of_related_debt`, among others.</span></span>
<span id="cb10-754"><a href="#cb10-754" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb10-755"><a href="#cb10-755" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A cleaned and standardized `data.frame` (tibble) of Connecticut municipal revenue data</span></span>
<span id="cb10-756"><a href="#cb10-756" aria-hidden="true" tabindex="-1"></a><span class="co">#'         from 2003 to 2022, merged from multiple historical sources and enriched with unified fiscal indicators.</span></span>
<span id="cb10-757"><a href="#cb10-757" aria-hidden="true" tabindex="-1"></a><span class="co">#' @import dplyr, readr, janitor</span></span>
<span id="cb10-758"><a href="#cb10-758" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb10-759"><a href="#cb10-759" aria-hidden="true" tabindex="-1"></a>load_revenue_data <span class="ot">&lt;-</span> <span class="cf">function</span>(){</span>
<span id="cb10-760"><a href="#cb10-760" aria-hidden="true" tabindex="-1"></a>  target_dir <span class="ot">&lt;-</span> <span class="st">'data/individual_report'</span></span>
<span id="cb10-761"><a href="#cb10-761" aria-hidden="true" tabindex="-1"></a>  f_name <span class="ot">&lt;-</span> <span class="st">"MUNICIPAL_FISCAL_INDICATORS_CT_2003_2022.csv"</span></span>
<span id="cb10-762"><a href="#cb10-762" aria-hidden="true" tabindex="-1"></a>  f_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, f_name)</span>
<span id="cb10-763"><a href="#cb10-763" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-764"><a href="#cb10-764" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(target_dir)){</span>
<span id="cb10-765"><a href="#cb10-765" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(target_dir, <span class="at">recursive=</span><span class="cn">TRUE</span>)</span>
<span id="cb10-766"><a href="#cb10-766" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-767"><a href="#cb10-767" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-768"><a href="#cb10-768" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(f_path)){</span>
<span id="cb10-769"><a href="#cb10-769" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-770"><a href="#cb10-770" aria-hidden="true" tabindex="-1"></a>    CT_REVENUE_2014_2022 <span class="ot">&lt;-</span> <span class="fu">load_MFI_2014_2022_data</span>() <span class="sc">|&gt;</span> <span class="fu">clean_names</span>()</span>
<span id="cb10-771"><a href="#cb10-771" aria-hidden="true" tabindex="-1"></a>    CT_REVENUE_2003_2007 <span class="ot">&lt;-</span> <span class="fu">load_MFI_2003_2007_data</span>() <span class="sc">|&gt;</span> <span class="fu">clean_names</span>()</span>
<span id="cb10-772"><a href="#cb10-772" aria-hidden="true" tabindex="-1"></a>    CT_REVENUE_2007_2011 <span class="ot">&lt;-</span> <span class="fu">load_MFI_2007_2011_data</span>() <span class="sc">|&gt;</span> <span class="fu">clean_names</span>()</span>
<span id="cb10-773"><a href="#cb10-773" aria-hidden="true" tabindex="-1"></a>    CT_REVENUE_2007_2012 <span class="ot">&lt;-</span> <span class="fu">load_MFI_2007_2012_data</span>() <span class="sc">|&gt;</span> <span class="fu">clean_names</span>()</span>
<span id="cb10-774"><a href="#cb10-774" aria-hidden="true" tabindex="-1"></a>    CT_REVENUE_2011_2015 <span class="ot">&lt;-</span> <span class="fu">load_MFI_2011_2015_data</span>() <span class="sc">|&gt;</span> <span class="fu">clean_names</span>()</span>
<span id="cb10-775"><a href="#cb10-775" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-776"><a href="#cb10-776" aria-hidden="true" tabindex="-1"></a>    CT_REVENUE <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(CT_REVENUE_2014_2022, CT_REVENUE_2003_2007, CT_REVENUE_2007_2011, CT_REVENUE_2007_2012, CT_REVENUE_2011_2015)</span>
<span id="cb10-777"><a href="#cb10-777" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-778"><a href="#cb10-778" aria-hidden="true" tabindex="-1"></a>    CT_REVENUE <span class="ot">&lt;-</span> </span>
<span id="cb10-779"><a href="#cb10-779" aria-hidden="true" tabindex="-1"></a>      CT_REVENUE <span class="sc">|&gt;</span> </span>
<span id="cb10-780"><a href="#cb10-780" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb10-781"><a href="#cb10-781" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Taxes</span></span>
<span id="cb10-782"><a href="#cb10-782" aria-hidden="true" tabindex="-1"></a>        <span class="at">current_year_adjusted_tax =</span> <span class="fu">coalesce</span>(current_year_adjusted_tax, curr_year_adjusted_taxes_collectible),</span>
<span id="cb10-783"><a href="#cb10-783" aria-hidden="true" tabindex="-1"></a>        <span class="at">current_year_tax_collection =</span> <span class="fu">coalesce</span>(current_year_tax_collection, curr_year_tax_collection_rate),</span>
<span id="cb10-784"><a href="#cb10-784" aria-hidden="true" tabindex="-1"></a>        <span class="at">property_tax_revenues =</span> <span class="fu">coalesce</span>(property_tax_revenues, property_tax_revenue),</span>
<span id="cb10-785"><a href="#cb10-785" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-786"><a href="#cb10-786" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fund balances</span></span>
<span id="cb10-787"><a href="#cb10-787" aria-hidden="true" tabindex="-1"></a>        <span class="at">assigned =</span> <span class="fu">coalesce</span>(assigned, assigned_fund_bal),</span>
<span id="cb10-788"><a href="#cb10-788" aria-hidden="true" tabindex="-1"></a>        <span class="at">committed =</span> <span class="fu">coalesce</span>(committed, committed_fund_bal),</span>
<span id="cb10-789"><a href="#cb10-789" aria-hidden="true" tabindex="-1"></a>        <span class="at">design_fund_bal =</span> <span class="fu">coalesce</span>(design_fund_bal),</span>
<span id="cb10-790"><a href="#cb10-790" aria-hidden="true" tabindex="-1"></a>        <span class="at">nonspendable =</span> <span class="fu">coalesce</span>(nonspendable, nonspendable_fund_bal),</span>
<span id="cb10-791"><a href="#cb10-791" aria-hidden="true" tabindex="-1"></a>        <span class="at">restricted =</span> <span class="fu">coalesce</span>(restricted, restricted_fund_bal),</span>
<span id="cb10-792"><a href="#cb10-792" aria-hidden="true" tabindex="-1"></a>        <span class="at">total_fund_balance =</span> <span class="fu">coalesce</span>(total_fund_balance, total_fund_bal),</span>
<span id="cb10-793"><a href="#cb10-793" aria-hidden="true" tabindex="-1"></a>        <span class="at">unassigned =</span> <span class="fu">coalesce</span>(unassigned, unassigned_fund_bal),</span>
<span id="cb10-794"><a href="#cb10-794" aria-hidden="true" tabindex="-1"></a>        <span class="at">unrestricted =</span> <span class="fu">coalesce</span>(unrestricted_fund_bal),</span>
<span id="cb10-795"><a href="#cb10-795" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-796"><a href="#cb10-796" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Revenues &amp; transfers</span></span>
<span id="cb10-797"><a href="#cb10-797" aria-hidden="true" tabindex="-1"></a>        <span class="at">total_revenues =</span> <span class="fu">coalesce</span>(total_revenues, total_revenue),</span>
<span id="cb10-798"><a href="#cb10-798" aria-hidden="true" tabindex="-1"></a>        <span class="at">total_revenues_and_other =</span> <span class="fu">coalesce</span>(total_revenues_and_other),</span>
<span id="cb10-799"><a href="#cb10-799" aria-hidden="true" tabindex="-1"></a>        <span class="at">intergovernmental_revenues =</span> <span class="fu">coalesce</span>(intergovernmental_revenues, inter_gov_rev),</span>
<span id="cb10-800"><a href="#cb10-800" aria-hidden="true" tabindex="-1"></a>        <span class="at">total_transfers_in_from_other =</span> <span class="fu">coalesce</span>(total_transfers_in_from_other, total_trans_from_genl_fund),</span>
<span id="cb10-801"><a href="#cb10-801" aria-hidden="true" tabindex="-1"></a>        <span class="at">total_transfers_out_to_other =</span> <span class="fu">coalesce</span>(total_transfers_out_to_other, total_trans_to_genl_fund),</span>
<span id="cb10-802"><a href="#cb10-802" aria-hidden="true" tabindex="-1"></a>        <span class="at">millrate =</span> <span class="fu">coalesce</span>(millrate, millrate1, millrate2, millrate3),</span>
<span id="cb10-803"><a href="#cb10-803" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-804"><a href="#cb10-804" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Expenditures</span></span>
<span id="cb10-805"><a href="#cb10-805" aria-hidden="true" tabindex="-1"></a>        <span class="at">education_expenditures =</span> <span class="fu">coalesce</span>(education_expenditures, education),</span>
<span id="cb10-806"><a href="#cb10-806" aria-hidden="true" tabindex="-1"></a>        <span class="at">total_net_assets =</span> <span class="fu">coalesce</span>(net_assets,total_net_assets),</span>
<span id="cb10-807"><a href="#cb10-807" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-808"><a href="#cb10-808" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Enrollment / population</span></span>
<span id="cb10-809"><a href="#cb10-809" aria-hidden="true" tabindex="-1"></a>        <span class="at">school_enrollment_average =</span> <span class="fu">coalesce</span>(school_enrollment_average, enrollmt),</span>
<span id="cb10-810"><a href="#cb10-810" aria-hidden="true" tabindex="-1"></a>        <span class="at">population =</span> <span class="fu">coalesce</span>(population, population_state_dept_of_public_health),</span>
<span id="cb10-811"><a href="#cb10-811" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-812"><a href="#cb10-812" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Labor</span></span>
<span id="cb10-813"><a href="#cb10-813" aria-hidden="true" tabindex="-1"></a>        <span class="at">unemployment_annual_average =</span> <span class="fu">coalesce</span>(unemployment_annual_average, empl),</span>
<span id="cb10-814"><a href="#cb10-814" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-815"><a href="#cb10-815" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Equalized values</span></span>
<span id="cb10-816"><a href="#cb10-816" aria-hidden="true" tabindex="-1"></a>        <span class="at">equalized_net_grand_list =</span> <span class="fu">coalesce</span>(equalized_net_grand_list, egl),</span>
<span id="cb10-817"><a href="#cb10-817" aria-hidden="true" tabindex="-1"></a>        <span class="at">equalized_mill_rate =</span> <span class="fu">coalesce</span>(equalized_mill_rate, acmr),</span>
<span id="cb10-818"><a href="#cb10-818" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-819"><a href="#cb10-819" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Net assets / liabilities</span></span>
<span id="cb10-820"><a href="#cb10-820" aria-hidden="true" tabindex="-1"></a>        <span class="at">invested_in_capital_assets_net_of_related_debt =</span> <span class="fu">coalesce</span>(invested_in_capital_assets_net_of_related_debt, invested_in_capital),</span>
<span id="cb10-821"><a href="#cb10-821" aria-hidden="true" tabindex="-1"></a>        <span class="at">unrestricted_net_assets =</span> <span class="fu">coalesce</span>(unrestricted_net_assets, unrestricted_net),</span>
<span id="cb10-822"><a href="#cb10-822" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-823"><a href="#cb10-823" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Moody's ratings</span></span>
<span id="cb10-824"><a href="#cb10-824" aria-hidden="true" tabindex="-1"></a>        <span class="at">moodys_bond_rating =</span> <span class="fu">coalesce</span>(moodys_bond_rating, moody_s_bond_ratings, bond_rating_moodys_as_of),</span>
<span id="cb10-825"><a href="#cb10-825" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-826"><a href="#cb10-826" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Restatement flag</span></span>
<span id="cb10-827"><a href="#cb10-827" aria-hidden="true" tabindex="-1"></a>        <span class="at">restatement_y_or_n =</span> <span class="fu">coalesce</span>(restatement_y_or_n, restatement),</span>
<span id="cb10-828"><a href="#cb10-828" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-829"><a href="#cb10-829" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Misc</span></span>
<span id="cb10-830"><a href="#cb10-830" aria-hidden="true" tabindex="-1"></a>        <span class="at">year =</span> <span class="fu">coalesce</span>(year, fiscal_year_end),</span>
<span id="cb10-831"><a href="#cb10-831" aria-hidden="true" tabindex="-1"></a>        <span class="at">comments =</span> <span class="fu">coalesce</span>(comments, comments_2, comments_a, comments_b),</span>
<span id="cb10-832"><a href="#cb10-832" aria-hidden="true" tabindex="-1"></a>        <span class="at">tax_code =</span> <span class="fu">coalesce</span>(tax_code, town_code, comptroller_town_code, comptroller_town_code_x, comptroller_town_code_y)</span>
<span id="cb10-833"><a href="#cb10-833" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-834"><a href="#cb10-834" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb10-835"><a href="#cb10-835" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(</span>
<span id="cb10-836"><a href="#cb10-836" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>curr_year_adjusted_taxes_collectible,</span>
<span id="cb10-837"><a href="#cb10-837" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>curr_year_tax_collection_rate,</span>
<span id="cb10-838"><a href="#cb10-838" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>property_tax_revenue,</span>
<span id="cb10-839"><a href="#cb10-839" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>assigned_fund_bal,</span>
<span id="cb10-840"><a href="#cb10-840" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>committed_fund_bal,</span>
<span id="cb10-841"><a href="#cb10-841" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>nonspendable_fund_bal,</span>
<span id="cb10-842"><a href="#cb10-842" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>restricted_fund_bal,</span>
<span id="cb10-843"><a href="#cb10-843" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>total_fund_bal,</span>
<span id="cb10-844"><a href="#cb10-844" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>unassigned_fund_bal,</span>
<span id="cb10-845"><a href="#cb10-845" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>unrestricted_fund_bal,</span>
<span id="cb10-846"><a href="#cb10-846" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>total_revenue,</span>
<span id="cb10-847"><a href="#cb10-847" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>inter_gov_rev,</span>
<span id="cb10-848"><a href="#cb10-848" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>total_trans_from_genl_fund,</span>
<span id="cb10-849"><a href="#cb10-849" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>total_trans_to_genl_fund,</span>
<span id="cb10-850"><a href="#cb10-850" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>millrate1,</span>
<span id="cb10-851"><a href="#cb10-851" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>millrate2,</span>
<span id="cb10-852"><a href="#cb10-852" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>millrate3,</span>
<span id="cb10-853"><a href="#cb10-853" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>education,</span>
<span id="cb10-854"><a href="#cb10-854" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>enrollmt,</span>
<span id="cb10-855"><a href="#cb10-855" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>empl,</span>
<span id="cb10-856"><a href="#cb10-856" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>egl,</span>
<span id="cb10-857"><a href="#cb10-857" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>acmr,</span>
<span id="cb10-858"><a href="#cb10-858" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>invested_in_capital,</span>
<span id="cb10-859"><a href="#cb10-859" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>unrestricted_net,</span>
<span id="cb10-860"><a href="#cb10-860" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>moody_s_bond_ratings,</span>
<span id="cb10-861"><a href="#cb10-861" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>restatement, </span>
<span id="cb10-862"><a href="#cb10-862" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>fiscal_year_end,</span>
<span id="cb10-863"><a href="#cb10-863" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>bond_rating_moodys_as_of,</span>
<span id="cb10-864"><a href="#cb10-864" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>population_state_dept_of_public_health,</span>
<span id="cb10-865"><a href="#cb10-865" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>comments_2, <span class="sc">-</span>comments_a, <span class="sc">-</span>comments_b,</span>
<span id="cb10-866"><a href="#cb10-866" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>comptroller_town_code_x, <span class="sc">-</span>comptroller_town_code_y,</span>
<span id="cb10-867"><a href="#cb10-867" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>town_code, <span class="sc">-</span>comptroller_town_code, <span class="sc">-</span>county_identifier,</span>
<span id="cb10-868"><a href="#cb10-868" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>numbered_x, <span class="sc">-</span>numbered_y, <span class="sc">-</span>numbered,<span class="sc">-</span>net_assets</span>
<span id="cb10-869"><a href="#cb10-869" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb10-870"><a href="#cb10-870" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-871"><a href="#cb10-871" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(CT_REVENUE, f_path)</span>
<span id="cb10-872"><a href="#cb10-872" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-873"><a href="#cb10-873" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span>{</span>
<span id="cb10-874"><a href="#cb10-874" aria-hidden="true" tabindex="-1"></a>    CT_REVENUE <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(f_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb10-875"><a href="#cb10-875" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-876"><a href="#cb10-876" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(CT_REVENUE)</span>
<span id="cb10-877"><a href="#cb10-877" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-878"><a href="#cb10-878" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-879"><a href="#cb10-879" aria-hidden="true" tabindex="-1"></a>CT_REVENUE <span class="ot">&lt;-</span> <span class="fu">load_revenue_data</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="merging" class="level1">
<h1>Merging</h1>
<p>Because the economic data spans multiple geographic units (e.g., county, town, and property level), I needed to standardize the level of geographic aggregation across datasets. County was the most consistent and broadly shared geographic unit, so I aggregated datasets as needed to the county level. This allowed me to create a unified data frame containing the fiscal data, as shown in the code below.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>CT_ECONOMY <span class="ot">&lt;-</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  CAGDP2 <span class="sc">|&gt;</span> </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    industry_desc <span class="sc">==</span> <span class="st">"All industry total"</span>,</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    county <span class="sc">!=</span> <span class="st">"Connecticut"</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(CAINC1 <span class="sc">|&gt;</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>              <span class="fu">filter</span>(county <span class="sc">!=</span> <span class="st">"Connecticut"</span>),</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>            <span class="fu">join_by</span>(</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>              year <span class="sc">==</span> year,</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>              county <span class="sc">==</span> county)) <span class="sc">|&gt;</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(CAINC4 <span class="sc">|&gt;</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>              <span class="fu">filter</span>(county <span class="sc">!=</span> <span class="st">"Connecticut"</span>), </span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>             <span class="fu">join_by</span>(year <span class="sc">==</span> year, </span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>                     county <span class="sc">==</span> county, </span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>                     population <span class="sc">==</span> population, </span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>                     per_capita_personal_income <span class="sc">==</span> per_capita_personal_income)) <span class="sc">|&gt;</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(CAINC30 <span class="sc">|&gt;</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>              <span class="fu">filter</span>(county <span class="sc">!=</span> <span class="st">"Connecticut"</span>), </span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>             <span class="fu">join_by</span>(year <span class="sc">==</span> year, </span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>                     county <span class="sc">==</span> county, </span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>                     population <span class="sc">==</span> population)) <span class="sc">|&gt;</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(CAINC91,</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>             <span class="fu">join_by</span>(year <span class="sc">==</span> year,</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>                     county <span class="sc">==</span> county)) <span class="sc">|&gt;</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(CT_REVENUE <span class="sc">|&gt;</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>              <span class="fu">group_by</span>(</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>                county, year</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>                ) <span class="sc">|&gt;</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>              <span class="fu">summarize</span>(</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>                <span class="fu">across</span>(<span class="fu">c</span>(</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"equalized_net_grand_list"</span>,<span class="st">"current_year_adjusted_tax"</span>,</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"property_tax_revenues"</span>, <span class="st">"intergovernmental_revenues"</span>,</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"total_revenues"</span>,<span class="st">"total_transfers_in_from_other"</span>,</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"total_revenues_and_other"</span>,<span class="st">"education_expenditures"</span>,</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"operating_expenditures"</span>, <span class="st">"total_expenditures"</span>,<span class="st">"total_transfers_out_to_other"</span>,</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"total_expenditures_and_other"</span>,<span class="st">"net_change_in_fund_balance"</span>,</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"nonspendable"</span>,<span class="st">"restricted"</span>,<span class="st">"committed"</span>,<span class="st">"assigned"</span>,<span class="st">"unassigned"</span>,</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"total_fund_balance"</span>,<span class="st">"net_pension_liability"</span>,<span class="st">"net_opeb_liability"</span>,</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"bonded_long_term_debt"</span>,<span class="st">"annual_debt_service"</span>,<span class="st">"tax_rev"</span>,</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"debt_service"</span>,<span class="st">"other_financing_sources"</span>,</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"operating_surplus_deficit_including_sources_and_uses"</span>,</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"rsd_debt"</span>,<span class="st">"town_bonded_long_term_debt"</span>,<span class="st">"total_bonded_long_term_debt_rsd_town"</span>,</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"reserv_fund_bal"</span>,<span class="st">"design_fund_bal"</span>,<span class="st">"unreserved_fund_bal"</span>,</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"fund_equity_enterprise"</span>, <span class="st">"fund_equity_internal_service"</span>,</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"curr_year_taxes_collected"</span>,<span class="st">"total_adjusted_taxes_collectible"</span>,</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"total_taxes_collected"</span>,<span class="st">"overal_total_tax_collection_rate"</span>,</span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"area_lmt"</span>,<span class="st">"invested_in_capital_assets_net_of_related_debt"</span>,</span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"unrestricted_net_assets"</span>, <span class="st">"total_net_assets"</span>,</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"change_in_net_assets"</span>,<span class="st">"population"</span>,<span class="st">"tanf_recipients"</span>,</span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"acglfy"</span>,<span class="st">"onbehalf_payments_obp_teachers_retirement_plan"</span>,</span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"obp_allocation_from_pob_contribution"</span>,<span class="st">"unrestricted"</span>,</span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"total_net_pension_liability"</span></span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>                ), <span class="sc">~</span> <span class="fu">sum</span>(.x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>                <span class="fu">across</span>(<span class="fu">c</span>(<span class="st">"school_enrollment_average"</span>,<span class="st">"unemployment_annual_average"</span>,</span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"equalized_mill_rate"</span>,<span class="st">"mill_rate_real_estate_personal"</span>,</span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"mill_rate_motor_vehicle"</span>,<span class="st">"current_year_tax_collection"</span>,</span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"total_taxes_collected_as"</span>,<span class="st">"millrate"</span></span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a>                ), <span class="sc">~</span> <span class="fu">median</span>(.x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>                <span class="fu">across</span>(<span class="fu">c</span>(<span class="st">"tax_code"</span>,</span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"municipality_fips"</span>, <span class="st">"municipality_fips_geoid"</span>,</span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"moodys_bond_rating"</span>,</span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a>                ), <span class="sc">~</span> <span class="fu">first</span>(.x))</span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a>              )</span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a>            ,</span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a>             <span class="fu">join_by</span>(</span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a>               year <span class="sc">==</span> year,</span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a>               county <span class="sc">==</span> county</span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a>               )</span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a>            ) <span class="sc">|&gt;</span></span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(BLS_LABOR <span class="sc">|&gt;</span></span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a>              <span class="fu">group_by</span>(county, year) <span class="sc">|&gt;</span></span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a>              <span class="fu">summarize</span>(</span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a>                <span class="at">unemployment_rate =</span> <span class="fu">median</span>(unemployment_rate),</span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a>                <span class="at">unemployment =</span> <span class="fu">median</span>(unemployment)</span>
<span id="cb11-77"><a href="#cb11-77" aria-hidden="true" tabindex="-1"></a>                ), <span class="fu">join_by</span>(year <span class="sc">==</span> year, county <span class="sc">==</span> county))</span>
<span id="cb11-78"><a href="#cb11-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-79"><a href="#cb11-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-80"><a href="#cb11-80" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify .x and .y columns</span></span>
<span id="cb11-81"><a href="#cb11-81" aria-hidden="true" tabindex="-1"></a>x_vars <span class="ot">&lt;-</span> <span class="fu">names</span>(CT_ECONOMY)[<span class="fu">grepl</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">.x$"</span>, <span class="fu">names</span>(CT_ECONOMY))]</span>
<span id="cb11-82"><a href="#cb11-82" aria-hidden="true" tabindex="-1"></a>y_vars <span class="ot">&lt;-</span> <span class="fu">names</span>(CT_ECONOMY)[<span class="fu">grepl</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">.y$"</span>, <span class="fu">names</span>(CT_ECONOMY))]</span>
<span id="cb11-83"><a href="#cb11-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-84"><a href="#cb11-84" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through matching pairs</span></span>
<span id="cb11-85"><a href="#cb11-85" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (x <span class="cf">in</span> x_vars) {</span>
<span id="cb11-86"><a href="#cb11-86" aria-hidden="true" tabindex="-1"></a>  base <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">.x$"</span>, <span class="st">""</span>, x)</span>
<span id="cb11-87"><a href="#cb11-87" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">paste0</span>(base, <span class="st">".y"</span>)</span>
<span id="cb11-88"><a href="#cb11-88" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-89"><a href="#cb11-89" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (y <span class="sc">%in%</span> y_vars) {</span>
<span id="cb11-90"><a href="#cb11-90" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Coerce both to character for comparison</span></span>
<span id="cb11-91"><a href="#cb11-91" aria-hidden="true" tabindex="-1"></a>    x_vals <span class="ot">&lt;-</span> <span class="fu">as.character</span>(CT_ECONOMY[[x]])</span>
<span id="cb11-92"><a href="#cb11-92" aria-hidden="true" tabindex="-1"></a>    y_vals <span class="ot">&lt;-</span> <span class="fu">as.character</span>(CT_ECONOMY[[y]])</span>
<span id="cb11-93"><a href="#cb11-93" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-94"><a href="#cb11-94" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compare, handling NA</span></span>
<span id="cb11-95"><a href="#cb11-95" aria-hidden="true" tabindex="-1"></a>    same_vals <span class="ot">&lt;-</span> (x_vals <span class="sc">==</span> y_vals) <span class="sc">|</span> (<span class="fu">is.na</span>(x_vals) <span class="sc">&amp;</span> <span class="fu">is.na</span>(y_vals))</span>
<span id="cb11-96"><a href="#cb11-96" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-97"><a href="#cb11-97" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">all</span>(same_vals, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb11-98"><a href="#cb11-98" aria-hidden="true" tabindex="-1"></a>      <span class="co"># If all values are the same, keep one and drop the other</span></span>
<span id="cb11-99"><a href="#cb11-99" aria-hidden="true" tabindex="-1"></a>      CT_ECONOMY[[base]] <span class="ot">&lt;-</span> CT_ECONOMY[[x]]</span>
<span id="cb11-100"><a href="#cb11-100" aria-hidden="true" tabindex="-1"></a>      CT_ECONOMY[[x]] <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb11-101"><a href="#cb11-101" aria-hidden="true" tabindex="-1"></a>      CT_ECONOMY[[y]] <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb11-102"><a href="#cb11-102" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb11-103"><a href="#cb11-103" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-104"><a href="#cb11-104" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-105"><a href="#cb11-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-106"><a href="#cb11-106" aria-hidden="true" tabindex="-1"></a>CT_ECONOMY <span class="ot">&lt;-</span> </span>
<span id="cb11-107"><a href="#cb11-107" aria-hidden="true" tabindex="-1"></a>  CT_ECONOMY <span class="sc">|&gt;</span></span>
<span id="cb11-108"><a href="#cb11-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">population =</span> <span class="fu">coalesce</span>(<span class="st">`</span><span class="at">population.x</span><span class="st">`</span>, <span class="st">`</span><span class="at">population.y</span><span class="st">`</span>)) <span class="sc">|&gt;</span></span>
<span id="cb11-109"><a href="#cb11-109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(<span class="st">"population.x"</span>,<span class="st">"population.y"</span>)) <span class="sc">|&gt;</span> <span class="fu">clean_names</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Then I added the real estate sales data, as reproduced in the code below.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>CT_SALES_SUMMARY <span class="ot">&lt;-</span> </span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  CT_SALES <span class="sc">|&gt;</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year_recorded, county) <span class="sc">|&gt;</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">median_sale_price =</span> <span class="fu">median</span>(sale_amount, <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">median_sales_ratio =</span> <span class="fu">median</span>(sales_ratio, <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">sum_sale_price =</span> <span class="fu">sum</span>(sale_amount, <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">most_common_property_type =</span> property_type[<span class="fu">which.max</span>(<span class="fu">tabulate</span>(<span class="fu">match</span>(property_type, <span class="fu">unique</span>(property_type))))],</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>CT_SALES_ECONOMY <span class="ot">&lt;-</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>  CT_SALES_SUMMARY <span class="sc">|&gt;</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(CT_ECONOMY, </span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>             <span class="fu">join_by</span>(<span class="st">"county"</span> <span class="sc">==</span> <span class="st">"county"</span>, <span class="st">"year_recorded"</span> <span class="sc">==</span> <span class="st">"year"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">log_median_sale_price =</span> <span class="fu">log</span>(median_sale_price, <span class="at">base =</span> <span class="dv">10</span>),</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">sqrt_median_sale_price =</span> <span class="fu">sqrt</span>(median_sale_price),</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">inv_median_sale_price =</span> <span class="dv">1</span><span class="sc">/</span>median_sale_price,</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">per_capita_gdp =</span> gdp <span class="sc">/</span> population,</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">per_capita_property_tax_revenues =</span> property_tax_revenues <span class="sc">/</span> population,</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">per_capita_ui_comp =</span> unemployment_insurance_compensation <span class="sc">/</span> population,</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">per_capita_farm_income =</span> farm_income<span class="sc">/</span>population,</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">per_capita_employer_contributions_soc_ins =</span> employer_contributions_for_government_social_insurance <span class="sc">/</span> population,</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">per_capita_wages_and_salaries =</span> wages_and_salaries <span class="sc">/</span> population,</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">per_capita_proprietors_income =</span> proprietors_income <span class="sc">/</span> population,</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">per_capita_annual_debt_service =</span> annual_debt_service <span class="sc">/</span> population,</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">per_capita_dividends_proportion =</span> ((per_capita_dividends_interest_and_rent <span class="sc">*</span> population) <span class="sc">/</span> personal_income) <span class="sc">/</span> population,</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">dividends_proportion =</span> ((per_capita_dividends_interest_and_rent <span class="sc">*</span> population) <span class="sc">/</span> personal_income),</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">per_capita_farm_proportion =</span> (farm_income <span class="sc">/</span> personal_income) <span class="sc">/</span> population,</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">farm_proportion =</span> (farm_income <span class="sc">/</span> personal_income),</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">retirement_proportion =</span> (retirement_and_other <span class="sc">/</span> personal_income),</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">per_capita_wage_salary_proportion =</span> (wages_and_salaries <span class="sc">/</span> personal_income) <span class="sc">/</span> population,</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">wage_salary_proportion =</span> (wages_and_salaries <span class="sc">/</span> personal_income),</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">ui_comp_proportion =</span> (unemployment_insurance_compensation <span class="sc">/</span> personal_income),</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">proprietors_income_proportion =</span> proprietors_income <span class="sc">/</span> personal_income</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Finally, I wanted to add county population classifications to the merged dataset to include it as a categorical predictor in the modeling portion of the analysis. I accomplished that with the following code.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>quantiles <span class="ot">&lt;-</span> <span class="fu">quantile</span>(CT_SALES_ECONOMY<span class="sc">$</span>population, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.33</span>, <span class="fl">0.66</span>), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>CT_SALES_ECONOMY <span class="ot">&lt;-</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  CT_SALES_ECONOMY <span class="sc">|&gt;</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">population_class =</span> <span class="fu">case_when</span>(</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>      population <span class="sc">&lt;</span> quantiles[[<span class="dv">1</span>]] <span class="sc">~</span> <span class="st">"small"</span>,</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>      population <span class="sc">&gt;=</span> quantiles[[<span class="dv">1</span>]] <span class="sc">&amp;</span> population <span class="sc">&lt;</span> quantiles[[<span class="dv">2</span>]] <span class="sc">~</span> <span class="st">"medium"</span>,</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>      population <span class="sc">&gt;=</span> quantiles[[<span class="dv">2</span>]] <span class="sc">~</span> <span class="st">"large"</span>,</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="cn">NA_character_</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="main-statistical-analysis" class="level1">
<h1>Main Statistical Analysis</h1>
<p>My goal was to build a random forest model that explains as much variance in median sales price (Y) as possible using a set of economic predictors. To do this, I broke the broad concept of “the economy” into three core dimensions of economic strength, and selected 11 predictors which fit into the delineated categories.</p>
<table class="caption-top table">
<colgroup>
<col style="width: 21%">
<col style="width: 78%">
</colgroup>
<thead>
<tr class="header">
<th><strong>Economic Dimension</strong></th>
<th><strong>Associated Variables</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Government Capacity &amp; Fiscal Health</strong></td>
<td>Per Capita GDP, Per Capita Property Tax Revenues, Per Capita Annual Debt Service</td>
</tr>
<tr class="even">
<td><strong>Labor Market Conditions</strong></td>
<td>Unemployment Rate, Unemployment Insurance Compensation Proportion</td>
</tr>
<tr class="odd">
<td><strong>Household Income</strong></td>
<td>Per Capita Income, Dividends Proportion, Farm Proportion, Retirement Proportion, Wage and Salary Proportion, Proprietors’ Income Proportion</td>
</tr>
</tbody>
</table>
<p>I define the predictor and response variables in the lines of code below.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>NUMERIC_PREDICTORS <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"per_capita_gdp"</span>,</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"per_capita_property_tax_revenues"</span>,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"unemployment_rate"</span>,</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"per_capita_personal_income"</span>,</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"per_capita_annual_debt_service"</span>,</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"dividends_proportion"</span>,</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"farm_proportion"</span>,</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"retirement_proportion"</span>,</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"wage_salary_proportion"</span>,</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ui_comp_proportion"</span>,</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"proprietors_income_proportion"</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>FACTOR_PREDICTORS <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"population_class"</span>)</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>RESPONSE <span class="ot">&lt;-</span> <span class="st">"median_sale_price"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="box-cox-transformations" class="level2">
<h2 class="anchored" data-anchor-id="box-cox-transformations">Box-Cox Transformations</h2>
<p>First, I applied the Box-Cox transformation to the predictor variables to address potential violations of the normality assumption in the data. This method helps stabilize variance and makes the data more normally distributed, improving model performance. The code used for this transformation is shown below.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Transform Features for Modeling</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' This function prepares a dataset for modeling by:</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Removing rows with missing values in the response or predictor variables</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Estimating Box-Cox transformation parameters for numeric predictors</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Applying Box-Cox transformations to the numeric predictors</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Applying a specified transformation to the response variable</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Returning a data frame with transformed predictors and response</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param data A data frame containing at least the predictors and a response column.</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="co">#'             Uses globally defined `NUMERIC_PREDICTORS` and `RESPONSE`.</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A cleaned and transformed data frame ready for modeling.</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom car powerTransform</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom purrr map2_dfc</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom dplyr filter if_all mutate bind_cols</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>transform_features <span class="ot">&lt;-</span> <span class="cf">function</span>(data) {</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>  numeric_predictors <span class="ot">&lt;-</span> NUMERIC_PREDICTORS</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>  factor_predictors <span class="ot">&lt;-</span> FACTOR_PREDICTORS</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove rows with missing values in predictors or response</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>  data_clean <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(median_sale_price)) <span class="sc">|&gt;</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="fu">if_all</span>(<span class="fu">all_of</span>(<span class="fu">c</span>(numeric_predictors, factor_predictors)), <span class="sc">~</span> <span class="sc">!</span><span class="fu">is.na</span>(.)))</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Estimate Box-Cox lambdas for numeric predictors</span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>  bc_model <span class="ot">&lt;-</span> <span class="fu">powerTransform</span>(data_clean[numeric_predictors])</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Box-Cox Lambda Table:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">summary</span>(bc_model))</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"######################</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>  lambdas <span class="ot">&lt;-</span> bc_model<span class="sc">$</span>lambda</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Apply Box-Cox transformation to numeric predictors</span></span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>  bc_transformed <span class="ot">&lt;-</span> <span class="fu">map2_dfc</span>(data_clean[numeric_predictors], lambdas, <span class="cf">function</span>(x, lambda) {</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (lambda <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">log</span>(x) <span class="cf">else</span> (x<span class="sc">^</span>lambda <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">/</span> lambda</span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(bc_transformed) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"bc_transformed_"</span>, numeric_predictors)</span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Transform the response variable</span></span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>  data_clean <span class="ot">&lt;-</span> data_clean <span class="sc">|&gt;</span></span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">response =</span> <span class="fu">case_when</span>(</span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>      RESPONSE <span class="sc">==</span> <span class="st">"log_median_sale_price"</span> <span class="sc">~</span> log_median_sale_price,</span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>      RESPONSE <span class="sc">==</span> <span class="st">"sqrt_median_sale_price"</span> <span class="sc">~</span> sqrt_median_sale_price,</span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>      RESPONSE <span class="sc">==</span> <span class="st">"inv_median_sale_price"</span> <span class="sc">~</span> inv_median_sale_price,</span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> median_sale_price</span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Combine transformed predictors, factors, and response</span></span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a>  final_data <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(</span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a>    data_clean[factor_predictors],</span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a>    bc_transformed,</span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">response =</span> data_clean<span class="sc">$</span>response</span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(final_data)</span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The estimated Box-Cox <span class="math inline">\(\lambda\)</span> values for each predictor are summarized in the table below:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Predictor</th>
<th>Est Power</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Per Capita GDP</td>
<td>-0.4589</td>
</tr>
<tr class="even">
<td>Per Capita Property Tax Revenues</td>
<td>1.6948</td>
</tr>
<tr class="odd">
<td>Unemployment Rate</td>
<td>-0.2257</td>
</tr>
<tr class="even">
<td>Per Capita Personal Income</td>
<td>-0.0226</td>
</tr>
<tr class="odd">
<td>Per Capita Annual Debt Service</td>
<td>0.7702</td>
</tr>
<tr class="even">
<td>Dividends Proportion</td>
<td>-1.4057</td>
</tr>
<tr class="odd">
<td>Farm Proportion</td>
<td>0.1607</td>
</tr>
<tr class="even">
<td>Retirement Proportion</td>
<td>0.4059</td>
</tr>
<tr class="odd">
<td>Wage and Salary Proportion</td>
<td>-0.4699</td>
</tr>
<tr class="even">
<td>Unemployment Insurance Proportion</td>
<td>-0.1981</td>
</tr>
<tr class="odd">
<td>Proprietors’ Income Proportion</td>
<td>-0.1797</td>
</tr>
</tbody>
</table>
<p>Two likelihood ratio tests were conducted to evaluate the necessity and appropriateness of these transformations. The first test compared the fitted <span class="math inline">\(\lambda\)</span> values to the null hypothesis that all <span class="math inline">\(\lambda\)</span> equal zero. The test statistic (LRT = 85.21, df = 11) produced a highly significant p-value (p <span class="math inline">\(\approx\)</span> 1.44e-13), indicating that the estimated <span class="math inline">\(\lambda\)</span> values differ significantly from zero and that a pure log transformation is not sufficient for all predictors. The second test compared the fitted <span class="math inline">\(\lambda\)</span> values to the hypothesis that <span class="math inline">\(\lambda=1\)</span> for all of the predictors. This test was also highly significant (LRT = 383.71, df = 11, p &lt; 2.22e<span class="math inline">\(^{-16}\)</span>), confirming that the predictors require transformation to improve model fit.</p>
<p>Together, these tests support the use of the Box-Cox method with the estimated <span class="math inline">\(\lambda\)</span> rather than defaulting to no transformation or simple log transformations.</p>
</section>
<section id="correlation-matrix" class="level2">
<h2 class="anchored" data-anchor-id="correlation-matrix">Correlation Matrix</h2>
<p>Next, I calculated the correlation matrix, and identified predictors with correlations &gt; 0.8. The following pairs were identified as highly correlated:</p>
<ul>
<li>Box-Cox transformed per capita property tax_revenues and Box-Cox transformed per capita personal income (<span class="math inline">\(r = 0.97\)</span>)</li>
<li>Box-Cox transformed per capita GDP and Box-Cox transformed per capita annual debt service (<span class="math inline">\(r = 0.80\)</span>)</li>
<li>Box-Cox transformed per capita_property_tax_revenues and Box-Cox transformed per capita annual debt service (<span class="math inline">\(r = 0.83\)</span>)</li>
<li>Box-Cox transformed dividends proportion and Box-Cox transformed retirement proportion (<span class="math inline">\(r = -0.83\)</span>)</li>
</ul>
<p>After examining scatterplots of these pairs, I determined that the variables provide distinct information despite high correlation, and decided to retain all predictors. The code for the correlation check is in <code>run_rf_pipeline()</code>, which I will define later.</p>
</section>
<section id="backwards-elimination" class="level2">
<h2 class="anchored" data-anchor-id="backwards-elimination">Backwards Elimination</h2>
<p>After examining the correlation matrix, I fit a random forest model using the selected predictors. I then applied a backward elimination algorithm that iteratively removes the least important predictor, as determined by the percentage increase in mean squared error. The implementation of this process is shown in the code below.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Perform backward elimination for random forest model predictors</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' This function iteratively fits random forest models, starting with all specified predictors,</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' and at each step removes the least important predictor based on "%IncMSE" importance measure.</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' The process continues until a minimum number of predictors (`min_vars`) is reached.</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param data A data frame containing the response variable and predictors.</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param response A string specifying the name of the response variable in `data`.</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param predictors A character vector of predictor variable names to include initially.</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param min_vars An integer specifying the minimum number of predictors to keep (default is 2).</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param ntree Number of trees to grow in the random forest (default is 5000).</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param verbose Logical; if TRUE, prints progress messages during elimination (default TRUE).</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A list of model performance results for each iteration. Each list element contains:</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="co">#' \itemize{</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \item \code{predictors}: the set of predictors used in the model</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \item \code{var_explained}: percent variance explained by the model on training data</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \item \code{mse}: mean squared error of the model</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \item \code{importance}: variable importance scores (%IncMSE) for each predictor</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="co">#' }</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a><span class="co">#' \dontrun{</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a><span class="co">#' results &lt;- backward_elimination_rf(</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a><span class="co">#'   data = mydata,</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a><span class="co">#'   response = "target_variable",</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a><span class="co">#'   predictors = c("var1", "var2", "var3"),</span></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a><span class="co">#'   min_vars = 2,</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a><span class="co">#'   ntree = 1000</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a><span class="co">#' )</span></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a><span class="co">#' }</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>backward_elimination_rf <span class="ot">&lt;-</span> <span class="cf">function</span>(data, response, predictors, <span class="at">min_vars =</span> <span class="dv">4</span>, <span class="at">ntree =</span> <span class="dv">5000</span>, <span class="at">verbose =</span> <span class="cn">TRUE</span>) {</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>  current_predictors <span class="ot">&lt;-</span> predictors</span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> (<span class="fu">length</span>(current_predictors) <span class="sc">&gt;=</span> min_vars) {</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Build formula</span></span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>    formula <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(<span class="st">"response ~"</span>, <span class="fu">paste</span>(current_predictors, <span class="at">collapse =</span> <span class="st">" + "</span>)))</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Train model</span></span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>    rf_model <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(formula, <span class="at">data =</span> data, <span class="at">importance =</span> <span class="cn">TRUE</span>, <span class="at">ntree =</span> ntree)</span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Store performance</span></span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>    model_perf <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>      <span class="at">predictors =</span> current_predictors,</span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>      <span class="at">var_explained =</span> rf_model<span class="sc">$</span>rsq[<span class="fu">length</span>(rf_model<span class="sc">$</span>rsq)] <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>      <span class="at">mse =</span> rf_model<span class="sc">$</span>mse[<span class="fu">length</span>(rf_model<span class="sc">$</span>mse)],</span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>      <span class="at">importance =</span> <span class="fu">importance</span>(rf_model)[, <span class="st">"%IncMSE"</span>]</span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>    results[[<span class="fu">length</span>(results) <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">&lt;-</span> model_perf</span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (verbose) {</span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Variables:"</span>, <span class="fu">paste</span>(current_predictors, <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\t</span><span class="st">% Var Explained:"</span>, <span class="fu">round</span>(model_perf<span class="sc">$</span>var_explained, <span class="dv">2</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Drop least important predictor</span></span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(current_predictors) <span class="sc">&gt;</span> min_vars) {</span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>      least_important <span class="ot">&lt;-</span> <span class="fu">names</span>(<span class="fu">which.min</span>(model_perf<span class="sc">$</span>importance))</span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a>      current_predictors <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(current_predictors, least_important)</span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span></span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results)</span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="model-validation" class="level2">
<h2 class="anchored" data-anchor-id="model-validation">Model Validation</h2>
<p>I used several diagnostic tools to assess the performance and reliability of the final random forest model.</p>
<section id="coefficient-of-determination" class="level3">
<h3 class="anchored" data-anchor-id="coefficient-of-determination">Coefficient of Determination</h3>
<p>After selecting the final model through backward elimination, I fit the model to a 70/30 train-test split to evaluate its performance. I calculated the test set <span class="math inline">\(R^2\)</span> and RMSE to measure how well the model generalizes to unseen data. This was done using the function below.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Fit Random Forest Model with Train-Test Split and Evaluate Performance</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' Splits the data into training (70%) and testing (30%) sets, fits a random forest model on the training set,</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' and evaluates performance on the test set. Returns the fitted model, predictions, performance metrics, and variable importance.</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param data Data frame containing the response and predictor variables.</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param formula A formula object specifying the model (e.g., response ~ predictors).</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A list containing:</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="co">#' \item{model}{The fitted random forest model object.}</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="co">#' \item{r_squared}{R-squared value on the test data.}</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="co">#' \item{rmse}{Root Mean Squared Error on the test data.}</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="co">#' \item{predictions}{Predicted values on the test data.}</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="co">#' \item{test_data}{The subset of data used as the test set.}</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="co">#' \item{importance}{Variable importance scores from the fitted model.}</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>fit_rf_model <span class="ot">&lt;-</span> <span class="cf">function</span>(data, formula) {</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(SEED)</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>  sample_size <span class="ot">&lt;-</span> <span class="fu">floor</span>(<span class="fl">0.7</span> <span class="sc">*</span> <span class="fu">nrow</span>(data))</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>  train_idx <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">seq_len</span>(<span class="fu">nrow</span>(data)), <span class="at">size =</span> sample_size)</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>  train_data <span class="ot">&lt;-</span> data[train_idx, ]</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>  test_data <span class="ot">&lt;-</span> data[<span class="sc">-</span>train_idx, ]</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(formula, <span class="at">data =</span> train_data, <span class="at">ntree =</span> <span class="dv">500</span>, <span class="at">importance =</span> <span class="cn">TRUE</span>)</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>  predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, <span class="at">newdata =</span> test_data)</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>  r_squared <span class="ot">&lt;-</span> <span class="fu">cor</span>(predictions, test_data<span class="sc">$</span>response)<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>  rmse <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>((predictions <span class="sc">-</span> test_data<span class="sc">$</span>response)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">model =</span> model, <span class="at">r_squared =</span> r_squared, <span class="at">rmse =</span> rmse, <span class="at">predictions =</span> predictions, <span class="at">test_data =</span> test_data, <span class="at">importance =</span> model<span class="sc">$</span>importance)</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>In this analysis, the test set <span class="math inline">\(R^2 = 0.8981\)</span>, and the RMSE = 18661.07. This indicates that the final random forest model explains approximately 89.8% of the variance in median real estate sale prices on unseen data. The relatively low RMSE suggests that the typical prediction error is within a reasonable range, given the scale of home prices in Connecticut.</p>
</section>
<section id="residual-plots" class="level3">
<h3 class="anchored" data-anchor-id="residual-plots">Residual Plots</h3>
<p><img src="figs/median_sale_price/residuals_vs_predicted_plot.png" class="img-fluid"> A good model should show residuals randomly scattered around zero, with no clear patterns or heteroscedasticity. In this residuals vs.&nbsp;predicted values plot, the residuals appear roughly centered around zero, suggesting that the model is not systematically over- or under-predicting.</p>
<p>The main pipeline function, <code>run_rf_pipeline()</code>, for the complete statistical analysis–from Box-Cox transformations to model diagnostics–and its associated helper functions are found in the code below:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Print Summary and Diagnostics for a Random Forest Model</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' Displays the model formula, transformed predictor variable names, a summary of the random forest model,</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' variable importance scores, and generates a variable importance plot.</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param rf_model A fitted random forest model object.</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param formula The formula object used to fit the model.</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param data Data frame containing the transformed predictor variables.</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return None (prints output and plot to console).</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>inspect_rf_model <span class="ot">&lt;-</span> <span class="cf">function</span>(rf_model, formula, data) {</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Model formula used:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(formula)</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Transformed predictor variables:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">colnames</span>(data))</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Random Forest Summary:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(rf_model)</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Variable Importance:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">importance</span>(rf_model))</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">varImpPlot</span>(rf_model, <span class="at">main =</span> <span class="st">"Variable Importance Plot"</span>)</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a><span class="co">#' Plot Predicted vs Actual Values and Residuals, Save Plots to File</span></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a><span class="co">#' Generates and saves scatter plots of predicted vs actual values and residuals vs predicted values for a random forest model.</span></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a><span class="co">#' Also prints the plots to the console.</span></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param predictions Numeric vector of predicted values from the model.</span></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param actuals Numeric vector of actual observed values.</span></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param save_dir Character string specifying the directory path to save the plots. Default is "figs/RESPONSE".</span></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return Numeric vector of residuals (actuals - predictions).</span></span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>plot_rf_results <span class="ot">&lt;-</span> <span class="cf">function</span>(predictions, actuals, <span class="at">save_dir =</span> <span class="fu">file.path</span>(<span class="st">"figs"</span>,RESPONSE)) {</span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">predicted =</span> predictions, <span class="at">actual =</span> actuals)</span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>residuals <span class="ot">&lt;-</span> df<span class="sc">$</span>actual <span class="sc">-</span> df<span class="sc">$</span>predicted</span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create directory if it doesn't exist</span></span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="fu">file.path</span>(save_dir))) {</span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(save_dir)</span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Predicted vs Actual plot</span></span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>  p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">x =</span> actual, <span class="at">y =</span> predicted)) <span class="sc">+</span></span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_abline</span>(<span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Predicted vs Actual"</span>, <span class="at">x =</span> <span class="st">"Actual"</span>, <span class="at">y =</span> <span class="st">"Predicted"</span>)</span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Residuals vs Predicted plot</span></span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a>  p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">x =</span> predicted, <span class="at">y =</span> residuals)) <span class="sc">+</span></span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">color =</span> <span class="st">"darkgreen"</span>) <span class="sc">+</span></span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Residuals vs Predicted"</span>, <span class="at">x =</span> <span class="st">"Predicted"</span>, <span class="at">y =</span> <span class="st">"Residuals"</span>)</span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Save plots to the specified directory with descriptive names</span></span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="fu">file.path</span>(save_dir, <span class="st">"predicted_vs_actual_plot.png"</span>), p1, <span class="at">width =</span> <span class="dv">8</span>, <span class="at">height =</span> <span class="dv">6</span>)</span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="fu">file.path</span>(save_dir, <span class="st">"residuals_vs_predicted_plot.png"</span>), p2, <span class="at">width =</span> <span class="dv">8</span>, <span class="at">height =</span> <span class="dv">6</span>)</span>
<span id="cb18-65"><a href="#cb18-65" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-66"><a href="#cb18-66" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Print both plots</span></span>
<span id="cb18-67"><a href="#cb18-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(p1)</span>
<span id="cb18-68"><a href="#cb18-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(p2)</span>
<span id="cb18-69"><a href="#cb18-69" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-70"><a href="#cb18-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df<span class="sc">$</span>residuals)</span>
<span id="cb18-71"><a href="#cb18-71" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-72"><a href="#cb18-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-73"><a href="#cb18-73" aria-hidden="true" tabindex="-1"></a><span class="co">#' Plot Residuals vs Each Predictor Variable, Save Plots to File</span></span>
<span id="cb18-74"><a href="#cb18-74" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb18-75"><a href="#cb18-75" aria-hidden="true" tabindex="-1"></a><span class="co">#' Creates and saves scatter plots showing residuals against each predictor variable to help diagnose model fit.</span></span>
<span id="cb18-76"><a href="#cb18-76" aria-hidden="true" tabindex="-1"></a><span class="co">#' Prints each plot to the console.</span></span>
<span id="cb18-77"><a href="#cb18-77" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb18-78"><a href="#cb18-78" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param predictions Numeric vector of predicted values from the model.</span></span>
<span id="cb18-79"><a href="#cb18-79" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param actuals Numeric vector of actual observed values.</span></span>
<span id="cb18-80"><a href="#cb18-80" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param data Data frame containing the predictor variables.</span></span>
<span id="cb18-81"><a href="#cb18-81" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param predictors Character vector of predictor variable names to plot residuals against.</span></span>
<span id="cb18-82"><a href="#cb18-82" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param save_dir Character string specifying the directory path to save the plots. Default is "figs".</span></span>
<span id="cb18-83"><a href="#cb18-83" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb18-84"><a href="#cb18-84" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return None (invisible NULL).</span></span>
<span id="cb18-85"><a href="#cb18-85" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb18-86"><a href="#cb18-86" aria-hidden="true" tabindex="-1"></a>plot_residuals_vs_predictors <span class="ot">&lt;-</span> <span class="cf">function</span>(predictions, actuals, data, predictors, <span class="at">save_dir =</span> <span class="st">"figs"</span>) {</span>
<span id="cb18-87"><a href="#cb18-87" aria-hidden="true" tabindex="-1"></a>  residuals <span class="ot">&lt;-</span> actuals <span class="sc">-</span> predictions</span>
<span id="cb18-88"><a href="#cb18-88" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">residuals =</span> residuals)</span>
<span id="cb18-89"><a href="#cb18-89" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">cbind</span>(df, data[, predictors, <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb18-90"><a href="#cb18-90" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-91"><a href="#cb18-91" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create directory if it doesn't exist</span></span>
<span id="cb18-92"><a href="#cb18-92" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(save_dir)) {</span>
<span id="cb18-93"><a href="#cb18-93" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(save_dir)</span>
<span id="cb18-94"><a href="#cb18-94" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb18-95"><a href="#cb18-95" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-96"><a href="#cb18-96" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (predictor <span class="cf">in</span> predictors) {</span>
<span id="cb18-97"><a href="#cb18-97" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes_string</span>(<span class="at">x =</span> predictor, <span class="at">y =</span> <span class="st">"residuals"</span>)) <span class="sc">+</span></span>
<span id="cb18-98"><a href="#cb18-98" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">color =</span> <span class="st">"purple"</span>) <span class="sc">+</span></span>
<span id="cb18-99"><a href="#cb18-99" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb18-100"><a href="#cb18-100" aria-hidden="true" tabindex="-1"></a>      <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste</span>(<span class="st">"Residuals vs"</span>, predictor),</span>
<span id="cb18-101"><a href="#cb18-101" aria-hidden="true" tabindex="-1"></a>           <span class="at">x =</span> predictor, <span class="at">y =</span> <span class="st">"Residuals"</span>) <span class="sc">+</span></span>
<span id="cb18-102"><a href="#cb18-102" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_minimal</span>()</span>
<span id="cb18-103"><a href="#cb18-103" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-104"><a href="#cb18-104" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggsave</span>(<span class="fu">file.path</span>(save_dir, RESPONSE, <span class="fu">paste0</span>(<span class="st">"residuals_vs_"</span>, predictor, <span class="st">".png"</span>)),</span>
<span id="cb18-105"><a href="#cb18-105" aria-hidden="true" tabindex="-1"></a>           p, <span class="at">width =</span> <span class="dv">8</span>, <span class="at">height =</span> <span class="dv">6</span>)</span>
<span id="cb18-106"><a href="#cb18-106" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-107"><a href="#cb18-107" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(p)</span>
<span id="cb18-108"><a href="#cb18-108" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb18-109"><a href="#cb18-109" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-110"><a href="#cb18-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-111"><a href="#cb18-111" aria-hidden="true" tabindex="-1"></a><span class="co">#' Run Full Random Forest Modeling Pipeline with Backward Elimination and Diagnostics</span></span>
<span id="cb18-112"><a href="#cb18-112" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb18-113"><a href="#cb18-113" aria-hidden="true" tabindex="-1"></a><span class="co">#' Executes the entire modeling workflow on the provided dataset, including:</span></span>
<span id="cb18-114"><a href="#cb18-114" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Filtering and transforming features</span></span>
<span id="cb18-115"><a href="#cb18-115" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Correlation check and optional variable removal</span></span>
<span id="cb18-116"><a href="#cb18-116" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Random forest modeling with backward elimination based on variable importance (%IncMSE)</span></span>
<span id="cb18-117"><a href="#cb18-117" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Selection of best model balancing explained variance and parsimony</span></span>
<span id="cb18-118"><a href="#cb18-118" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Model fitting and performance evaluation on test data</span></span>
<span id="cb18-119"><a href="#cb18-119" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Generation and saving of partial dependence plots</span></span>
<span id="cb18-120"><a href="#cb18-120" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Plotting residual diagnostics and saving results</span></span>
<span id="cb18-121"><a href="#cb18-121" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb18-122"><a href="#cb18-122" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param data Data frame containing the input data, including response and predictor variables.</span></span>
<span id="cb18-123"><a href="#cb18-123" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb18-124"><a href="#cb18-124" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A list containing:</span></span>
<span id="cb18-125"><a href="#cb18-125" aria-hidden="true" tabindex="-1"></a><span class="co">#' \item{model}{The final fitted random forest model object.}</span></span>
<span id="cb18-126"><a href="#cb18-126" aria-hidden="true" tabindex="-1"></a><span class="co">#' \item{outliers}{Data frame of test set observations with large residuals (absolute residual &gt; 0.3).}</span></span>
<span id="cb18-127"><a href="#cb18-127" aria-hidden="true" tabindex="-1"></a><span class="co">#' \item{backward_results}{List of results from the backward elimination process.}</span></span>
<span id="cb18-128"><a href="#cb18-128" aria-hidden="true" tabindex="-1"></a><span class="co">#' \item{importance}{Variable importance scores from the final model.}</span></span>
<span id="cb18-129"><a href="#cb18-129" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb18-130"><a href="#cb18-130" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb18-131"><a href="#cb18-131" aria-hidden="true" tabindex="-1"></a>run_rf_pipeline <span class="ot">&lt;-</span> <span class="cf">function</span>(data) {</span>
<span id="cb18-132"><a href="#cb18-132" aria-hidden="true" tabindex="-1"></a>  corr_threshold <span class="ot">&lt;-</span> CORR_THRESHOLD</span>
<span id="cb18-133"><a href="#cb18-133" aria-hidden="true" tabindex="-1"></a>  numeric_predictors <span class="ot">&lt;-</span> NUMERIC_PREDICTORS</span>
<span id="cb18-134"><a href="#cb18-134" aria-hidden="true" tabindex="-1"></a>  factor_predictors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"population_class"</span>)</span>
<span id="cb18-135"><a href="#cb18-135" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-136"><a href="#cb18-136" aria-hidden="true" tabindex="-1"></a>  clean_data <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span></span>
<span id="cb18-137"><a href="#cb18-137" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(</span>
<span id="cb18-138"><a href="#cb18-138" aria-hidden="true" tabindex="-1"></a>      <span class="fu">if_all</span>(<span class="fu">all_of</span>(numeric_predictors), <span class="sc">~</span> <span class="sc">!</span><span class="fu">is.na</span>(.) <span class="sc">&amp;</span> . <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb18-139"><a href="#cb18-139" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb18-140"><a href="#cb18-140" aria-hidden="true" tabindex="-1"></a>    <span class="fu">transform_features</span>() <span class="sc">|&gt;</span></span>
<span id="cb18-141"><a href="#cb18-141" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(</span>
<span id="cb18-142"><a href="#cb18-142" aria-hidden="true" tabindex="-1"></a>      response,</span>
<span id="cb18-143"><a href="#cb18-143" aria-hidden="true" tabindex="-1"></a>      <span class="fu">all_of</span>(<span class="fu">paste0</span>(<span class="st">"bc_transformed_"</span>, numeric_predictors)),</span>
<span id="cb18-144"><a href="#cb18-144" aria-hidden="true" tabindex="-1"></a>      <span class="fu">all_of</span>(factor_predictors)</span>
<span id="cb18-145"><a href="#cb18-145" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb18-146"><a href="#cb18-146" aria-hidden="true" tabindex="-1"></a>    <span class="fu">na.omit</span>()</span>
<span id="cb18-147"><a href="#cb18-147" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-148"><a href="#cb18-148" aria-hidden="true" tabindex="-1"></a>  predictors <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">paste0</span>(<span class="st">"bc_transformed_"</span>, numeric_predictors), <span class="st">"population_class"</span>)</span>
<span id="cb18-149"><a href="#cb18-149" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-150"><a href="#cb18-150" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- CORRELATION CHECK ---</span></span>
<span id="cb18-151"><a href="#cb18-151" aria-hidden="true" tabindex="-1"></a>  numeric_data <span class="ot">&lt;-</span> clean_data <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="fu">all_of</span>(<span class="fu">paste0</span>(<span class="st">"bc_transformed_"</span>, numeric_predictors)))</span>
<span id="cb18-152"><a href="#cb18-152" aria-hidden="true" tabindex="-1"></a>  cor_matrix <span class="ot">&lt;-</span> <span class="fu">cor</span>(numeric_data)</span>
<span id="cb18-153"><a href="#cb18-153" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-154"><a href="#cb18-154" aria-hidden="true" tabindex="-1"></a>  high_corr_pairs <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">abs</span>(cor_matrix) <span class="sc">&gt;</span> corr_threshold <span class="sc">&amp;</span> <span class="fu">upper.tri</span>(cor_matrix), <span class="at">arr.ind =</span> <span class="cn">TRUE</span>)</span>
<span id="cb18-155"><a href="#cb18-155" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-156"><a href="#cb18-156" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(high_corr_pairs) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb18-157"><a href="#cb18-157" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Highly correlated predictors found:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb18-158"><a href="#cb18-158" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(high_corr_pairs))) {</span>
<span id="cb18-159"><a href="#cb18-159" aria-hidden="true" tabindex="-1"></a>      var1 <span class="ot">&lt;-</span> <span class="fu">rownames</span>(cor_matrix)[high_corr_pairs[i, <span class="dv">1</span>]]</span>
<span id="cb18-160"><a href="#cb18-160" aria-hidden="true" tabindex="-1"></a>      var2 <span class="ot">&lt;-</span> <span class="fu">colnames</span>(cor_matrix)[high_corr_pairs[i, <span class="dv">2</span>]]</span>
<span id="cb18-161"><a href="#cb18-161" aria-hidden="true" tabindex="-1"></a>      corr_val <span class="ot">&lt;-</span> cor_matrix[high_corr_pairs[i, <span class="dv">1</span>], high_corr_pairs[i, <span class="dv">2</span>]]</span>
<span id="cb18-162"><a href="#cb18-162" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  - %s and %s (cor = %.2f)</span><span class="sc">\n</span><span class="st">"</span>, var1, var2, corr_val))</span>
<span id="cb18-163"><a href="#cb18-163" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb18-164"><a href="#cb18-164" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-165"><a href="#cb18-165" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Consider dropping one variable from each highly correlated pair.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb18-166"><a href="#cb18-166" aria-hidden="true" tabindex="-1"></a>    drop_vars <span class="ot">&lt;-</span> <span class="fu">readline</span>(<span class="at">prompt =</span> <span class="st">"Enter comma-separated variables to drop (or press Enter to skip): "</span>)</span>
<span id="cb18-167"><a href="#cb18-167" aria-hidden="true" tabindex="-1"></a>    drop_vars <span class="ot">&lt;-</span> <span class="fu">trimws</span>(<span class="fu">strsplit</span>(drop_vars, <span class="st">","</span>)[[<span class="dv">1</span>]])</span>
<span id="cb18-168"><a href="#cb18-168" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-169"><a href="#cb18-169" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(drop_vars) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> <span class="fu">any</span>(<span class="fu">nzchar</span>(drop_vars))){</span>
<span id="cb18-170"><a href="#cb18-170" aria-hidden="true" tabindex="-1"></a>      predictors <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(predictors, drop_vars)</span>
<span id="cb18-171"><a href="#cb18-171" aria-hidden="true" tabindex="-1"></a>      clean_data <span class="ot">&lt;-</span> clean_data <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span><span class="fu">all_of</span>(drop_vars))</span>
<span id="cb18-172"><a href="#cb18-172" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb18-173"><a href="#cb18-173" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb18-174"><a href="#cb18-174" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"No highly correlated predictor pairs found above the threshold.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb18-175"><a href="#cb18-175" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb18-176"><a href="#cb18-176" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Run backward elimination</span></span>
<span id="cb18-177"><a href="#cb18-177" aria-hidden="true" tabindex="-1"></a>  elim_results <span class="ot">&lt;-</span> <span class="fu">backward_elimination_rf</span>(</span>
<span id="cb18-178"><a href="#cb18-178" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> clean_data,</span>
<span id="cb18-179"><a href="#cb18-179" aria-hidden="true" tabindex="-1"></a>    <span class="at">response =</span> RESPONSE,</span>
<span id="cb18-180"><a href="#cb18-180" aria-hidden="true" tabindex="-1"></a>    <span class="at">predictors =</span> predictors,</span>
<span id="cb18-181"><a href="#cb18-181" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_vars =</span> <span class="dv">3</span>,</span>
<span id="cb18-182"><a href="#cb18-182" aria-hidden="true" tabindex="-1"></a>    <span class="at">ntree =</span> <span class="dv">5000</span>,</span>
<span id="cb18-183"><a href="#cb18-183" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="cn">TRUE</span></span>
<span id="cb18-184"><a href="#cb18-184" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb18-185"><a href="#cb18-185" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-186"><a href="#cb18-186" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Choose the best model: prioritize high var_explained and fewest predictors</span></span>
<span id="cb18-187"><a href="#cb18-187" aria-hidden="true" tabindex="-1"></a>  best_model_idx <span class="ot">&lt;-</span> <span class="fu">which.max</span>(<span class="fu">map_dbl</span>(elim_results, <span class="st">"var_explained"</span>))</span>
<span id="cb18-188"><a href="#cb18-188" aria-hidden="true" tabindex="-1"></a>  best_model <span class="ot">&lt;-</span> elim_results[[best_model_idx]]</span>
<span id="cb18-189"><a href="#cb18-189" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-190"><a href="#cb18-190" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If there are multiple models with the same variance explained, choose the one with fewer predictors</span></span>
<span id="cb18-191"><a href="#cb18-191" aria-hidden="true" tabindex="-1"></a>  best_model_with_fewest_predictors <span class="ot">&lt;-</span> best_model</span>
<span id="cb18-192"><a href="#cb18-192" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(elim_results)) {</span>
<span id="cb18-193"><a href="#cb18-193" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (elim_results[[i]]<span class="sc">$</span>var_explained <span class="sc">==</span> best_model<span class="sc">$</span>var_explained) {</span>
<span id="cb18-194"><a href="#cb18-194" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">length</span>(elim_results[[i]]<span class="sc">$</span>predictors) <span class="sc">&lt;</span> <span class="fu">length</span>(best_model<span class="sc">$</span>predictors)) {</span>
<span id="cb18-195"><a href="#cb18-195" aria-hidden="true" tabindex="-1"></a>        best_model_with_fewest_predictors <span class="ot">&lt;-</span> elim_results[[i]]</span>
<span id="cb18-196"><a href="#cb18-196" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb18-197"><a href="#cb18-197" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb18-198"><a href="#cb18-198" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb18-199"><a href="#cb18-199" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-200"><a href="#cb18-200" aria-hidden="true" tabindex="-1"></a>  final_predictors <span class="ot">&lt;-</span> best_model_with_fewest_predictors<span class="sc">$</span>predictors</span>
<span id="cb18-201"><a href="#cb18-201" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-202"><a href="#cb18-202" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Final predictors used:"</span>, <span class="fu">paste</span>(final_predictors, <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb18-203"><a href="#cb18-203" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-204"><a href="#cb18-204" aria-hidden="true" tabindex="-1"></a>  formula <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(<span class="st">"response ~"</span>, <span class="fu">paste</span>(final_predictors, <span class="at">collapse =</span> <span class="st">" + "</span>)))</span>
<span id="cb18-205"><a href="#cb18-205" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-206"><a href="#cb18-206" aria-hidden="true" tabindex="-1"></a>  rf_results <span class="ot">&lt;-</span> <span class="fu">fit_rf_model</span>(clean_data, formula)</span>
<span id="cb18-207"><a href="#cb18-207" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-208"><a href="#cb18-208" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Test R-squared:"</span>, <span class="fu">round</span>(rf_results<span class="sc">$</span>r_squared, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb18-209"><a href="#cb18-209" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Test RMSE:"</span>, <span class="fu">round</span>(rf_results<span class="sc">$</span>rmse, <span class="dv">2</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb18-210"><a href="#cb18-210" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-211"><a href="#cb18-211" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Partial Dependence Plot for retirement proportion ---</span></span>
<span id="cb18-212"><a href="#cb18-212" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-213"><a href="#cb18-213" aria-hidden="true" tabindex="-1"></a>  <span class="co"># List of variables you want to include in the grid</span></span>
<span id="cb18-214"><a href="#cb18-214" aria-hidden="true" tabindex="-1"></a>  top_vars <span class="ot">&lt;-</span> <span class="fu">rownames</span>(<span class="fu">as.data.frame</span>(<span class="fu">importance</span>(rf_results<span class="sc">$</span>model, <span class="at">type =</span> <span class="dv">1</span>)))</span>
<span id="cb18-215"><a href="#cb18-215" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-216"><a href="#cb18-216" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create PDPs for each variable and combine them</span></span>
<span id="cb18-217"><a href="#cb18-217" aria-hidden="true" tabindex="-1"></a>  pdp_list <span class="ot">&lt;-</span> <span class="fu">map</span>(top_vars, <span class="cf">function</span>(var) {</span>
<span id="cb18-218"><a href="#cb18-218" aria-hidden="true" tabindex="-1"></a>    pd <span class="ot">&lt;-</span> pdp<span class="sc">::</span><span class="fu">partial</span>(</span>
<span id="cb18-219"><a href="#cb18-219" aria-hidden="true" tabindex="-1"></a>      <span class="at">object =</span> rf_results<span class="sc">$</span>model,</span>
<span id="cb18-220"><a href="#cb18-220" aria-hidden="true" tabindex="-1"></a>      <span class="at">pred.var =</span> var,</span>
<span id="cb18-221"><a href="#cb18-221" aria-hidden="true" tabindex="-1"></a>      <span class="at">train =</span> clean_data <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="fu">all_of</span>(top_vars),response),</span>
<span id="cb18-222"><a href="#cb18-222" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot =</span> <span class="cn">FALSE</span></span>
<span id="cb18-223"><a href="#cb18-223" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-224"><a href="#cb18-224" aria-hidden="true" tabindex="-1"></a>    pd<span class="sc">$</span>variable <span class="ot">&lt;-</span> var</span>
<span id="cb18-225"><a href="#cb18-225" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(pd)</span>
<span id="cb18-226"><a href="#cb18-226" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb18-227"><a href="#cb18-227" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-228"><a href="#cb18-228" aria-hidden="true" tabindex="-1"></a>  pdp_df <span class="ot">=</span> <span class="fu">data.frame</span>()</span>
<span id="cb18-229"><a href="#cb18-229" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (list_item <span class="cf">in</span> pdp_list){</span>
<span id="cb18-230"><a href="#cb18-230" aria-hidden="true" tabindex="-1"></a>    df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(list_item)</span>
<span id="cb18-231"><a href="#cb18-231" aria-hidden="true" tabindex="-1"></a>    pred <span class="ot">&lt;-</span> </span>
<span id="cb18-232"><a href="#cb18-232" aria-hidden="true" tabindex="-1"></a>      df <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">"bc_transformed"</span>)) <span class="sc">|&gt;</span> <span class="fu">colnames</span>()</span>
<span id="cb18-233"><a href="#cb18-233" aria-hidden="true" tabindex="-1"></a>    df <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span> </span>
<span id="cb18-234"><a href="#cb18-234" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">x =</span> pred)</span>
<span id="cb18-235"><a href="#cb18-235" aria-hidden="true" tabindex="-1"></a>    pdp_df <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(pdp_df, df)</span>
<span id="cb18-236"><a href="#cb18-236" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb18-237"><a href="#cb18-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-238"><a href="#cb18-238" aria-hidden="true" tabindex="-1"></a>  pdp_df <span class="ot">&lt;-</span> pdp_df <span class="sc">|&gt;</span></span>
<span id="cb18-239"><a href="#cb18-239" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb18-240"><a href="#cb18-240" aria-hidden="true" tabindex="-1"></a>      <span class="at">variable =</span> variable <span class="sc">|&gt;</span> </span>
<span id="cb18-241"><a href="#cb18-241" aria-hidden="true" tabindex="-1"></a>        <span class="fu">str_remove</span>(<span class="st">"bc_transformed_"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb18-242"><a href="#cb18-242" aria-hidden="true" tabindex="-1"></a>        <span class="fu">str_replace_all</span>(<span class="st">"_"</span>, <span class="st">" "</span>) <span class="sc">|&gt;</span> </span>
<span id="cb18-243"><a href="#cb18-243" aria-hidden="true" tabindex="-1"></a>        <span class="fu">str_to_sentence</span>() <span class="sc">|&gt;</span> </span>
<span id="cb18-244"><a href="#cb18-244" aria-hidden="true" tabindex="-1"></a>        <span class="fu">str_replace</span>(<span class="st">"gdp"</span>, <span class="st">"GDP"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb18-245"><a href="#cb18-245" aria-hidden="true" tabindex="-1"></a>        <span class="fu">str_replace</span>(<span class="st">"proportion"</span>, <span class="st">"income (%)"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb18-246"><a href="#cb18-246" aria-hidden="true" tabindex="-1"></a>        <span class="fu">str_replace</span>(<span class="st">"Per capita"</span>, <span class="st">"Per-capita"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb18-247"><a href="#cb18-247" aria-hidden="true" tabindex="-1"></a>        <span class="fu">str_replace</span>(<span class="st">"Wage salary"</span>, <span class="st">"Wages and salary"</span>)</span>
<span id="cb18-248"><a href="#cb18-248" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-249"><a href="#cb18-249" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-250"><a href="#cb18-250" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot using facet_wrap</span></span>
<span id="cb18-251"><a href="#cb18-251" aria-hidden="true" tabindex="-1"></a>  pdp_plot_grid <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(pdp_df, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> yhat <span class="sc">/</span> <span class="dv">1000</span>)) <span class="sc">+</span> </span>
<span id="cb18-252"><a href="#cb18-252" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"steelblue"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb18-253"><a href="#cb18-253" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span> variable, <span class="at">scales =</span> <span class="st">"free_x"</span>) <span class="sc">+</span></span>
<span id="cb18-254"><a href="#cb18-254" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb18-255"><a href="#cb18-255" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Predictor Value (transformed)"</span>,</span>
<span id="cb18-256"><a href="#cb18-256" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Predicted Median Sale Price ($K)"</span>, </span>
<span id="cb18-257"><a href="#cb18-257" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Partial Dependence Plots"</span></span>
<span id="cb18-258"><a href="#cb18-258" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb18-259"><a href="#cb18-259" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> <span class="fu">label_dollar</span>(<span class="at">suffix =</span> <span class="st">"K"</span>, <span class="at">prefix =</span> <span class="st">"$"</span>, <span class="at">accuracy =</span> <span class="dv">1</span>)) <span class="sc">+</span> </span>
<span id="cb18-260"><a href="#cb18-260" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span>
<span id="cb18-261"><a href="#cb18-261" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-262"><a href="#cb18-262" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Save the grid plot</span></span>
<span id="cb18-263"><a href="#cb18-263" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="st">"figs/pdp_grid.png"</span>, pdp_plot_grid, <span class="at">width =</span> <span class="dv">10</span>, <span class="at">height =</span> <span class="dv">6</span>)</span>
<span id="cb18-264"><a href="#cb18-264" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-265"><a href="#cb18-265" aria-hidden="true" tabindex="-1"></a>  residuals <span class="ot">&lt;-</span> <span class="fu">plot_rf_results</span>(rf_results<span class="sc">$</span>predictions, rf_results<span class="sc">$</span>test_data<span class="sc">$</span>response)</span>
<span id="cb18-266"><a href="#cb18-266" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-267"><a href="#cb18-267" aria-hidden="true" tabindex="-1"></a>  outliers <span class="ot">&lt;-</span> rf_results<span class="sc">$</span>test_data[<span class="fu">abs</span>(residuals) <span class="sc">&gt;</span> <span class="fl">0.3</span>, ]</span>
<span id="cb18-268"><a href="#cb18-268" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-269"><a href="#cb18-269" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inspect_rf_model</span>(rf_results<span class="sc">$</span>model, formula, clean_data)</span>
<span id="cb18-270"><a href="#cb18-270" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-271"><a href="#cb18-271" aria-hidden="true" tabindex="-1"></a>  residuals <span class="ot">&lt;-</span> <span class="fu">plot_rf_results</span>(rf_results<span class="sc">$</span>predictions, rf_results<span class="sc">$</span>test_data<span class="sc">$</span>response)</span>
<span id="cb18-272"><a href="#cb18-272" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-273"><a href="#cb18-273" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot residuals vs each predictor</span></span>
<span id="cb18-274"><a href="#cb18-274" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_residuals_vs_predictors</span>(</span>
<span id="cb18-275"><a href="#cb18-275" aria-hidden="true" tabindex="-1"></a>    <span class="at">predictions =</span> rf_results<span class="sc">$</span>predictions,</span>
<span id="cb18-276"><a href="#cb18-276" aria-hidden="true" tabindex="-1"></a>    <span class="at">actuals =</span> rf_results<span class="sc">$</span>test_data<span class="sc">$</span>response,</span>
<span id="cb18-277"><a href="#cb18-277" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> rf_results<span class="sc">$</span>test_data,</span>
<span id="cb18-278"><a href="#cb18-278" aria-hidden="true" tabindex="-1"></a>    <span class="at">predictors =</span> final_predictors,</span>
<span id="cb18-279"><a href="#cb18-279" aria-hidden="true" tabindex="-1"></a>    <span class="at">save_dir =</span> <span class="st">"figs"</span></span>
<span id="cb18-280"><a href="#cb18-280" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb18-281"><a href="#cb18-281" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-282"><a href="#cb18-282" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">model =</span> rf_results<span class="sc">$</span>model, <span class="at">outliers =</span> outliers, <span class="at">backward_results =</span> elim_results, <span class="at">importance =</span> rf_results<span class="sc">$</span>importance))</span>
<span id="cb18-283"><a href="#cb18-283" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The final model is:</p>
<pre><code>Random Forest Summary:

Call:
 randomForest(formula = formula, data = train_data, ntree = 500,      importance = TRUE) 
               Type of random forest: regression
                     Number of trees: 500
No. of variables tried at each split: 2

          Mean of squared residuals: 735163952
                    % Var explained: 85.77

Variable Importance:
                                                  %IncMSE IncNodePurity
bc_transformed_per_capita_property_tax_revenues 12.503693   48364055442
bc_transformed_per_capita_personal_income       13.373119   47956084292
bc_transformed_per_capita_annual_debt_service   10.253276   34566690121
bc_transformed_dividends_proportion             10.267172   42577015458
bc_transformed_retirement_proportion            11.088946   47134800132
bc_transformed_ui_comp_proportion                7.364885   11584204293
bc_transformed_proprietors_income_proportion     6.634609   20111304578</code></pre>
</section>
</section>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<p>Overall, the model diagnostics suggest that the final random forest model performs well in predicting median real estate sales prices across Connecticut counties. The high test set <span class="math inline">\(R^2\)</span> value and relatively low RMSE indicate strong predictive power and a good fit to the data. The residuals plot shows no major patterns or systematic bias, leading me to the conclusion that the model’s errors are fairly random. These findings support the conclusion that county-level economic indicators are significant predictors of housing market outcomes. In particular, variables related to income levels, fiscal health, and employment conditions show strong correlations with real estate prices and shape property values across the state.</p>
<p>That said, the analysis is subject to a few limitations. Aggregating data to the county level considerably reduced the sample size and limited the model’s ability to detect more granular patterns. Additionally, missing values in the original datasets required exclusion of certain observations, further reducing the sample size and potentially decreasing the robustness of the model. Future work could benefit from more detailed, town-level data and a wider temporal range to capture economic dynamics over time.</p>


<!-- -->


</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" data-line-spacing="2" role="list">
<div id="ref-ct_mfi_2003_2007" class="csl-entry" role="listitem">
Connecticut Office of Policy and Management. (2008). <em>Municipal fiscal indicators 2003–2007</em>. <a href="https://data.ct.gov/dataset/Municipal-Fiscal-Indicators-2003-2007/psxm-7fts">https://data.ct.gov/dataset/Municipal-Fiscal-Indicators-2003-2007/psxm-7fts</a>
</div>
<div id="ref-ct_mfi_2007_2011" class="csl-entry" role="listitem">
Connecticut Office of Policy and Management. (2012). <em>Municipal fiscal indicators 2007–2011</em>. <a href="https://data.ct.gov/dataset/Municipal-Fiscal-Indicators-2007-2011/vwi6-xdyb">https://data.ct.gov/dataset/Municipal-Fiscal-Indicators-2007-2011/vwi6-xdyb</a>
</div>
<div id="ref-ct_mfi_2007_2012" class="csl-entry" role="listitem">
Connecticut Office of Policy and Management. (2013). <em>Municipal fiscal indicators 2007–2012</em>. <a href="https://data.ct.gov/dataset/Municipal-Fiscal-Indicators-2008-2012/9dwj-2peu">https://data.ct.gov/dataset/Municipal-Fiscal-Indicators-2008-2012/9dwj-2peu</a>
</div>
<div id="ref-ct_mfi_2011_2015" class="csl-entry" role="listitem">
Connecticut Office of Policy and Management. (2016). <em>Municipal fiscal indicators 2011–2015</em>. <a href="https://data.ct.gov/Government/Municipal-Fiscal-Indicators-2011-2015-MS-Access-da/uij9-wzqw">https://data.ct.gov/Government/Municipal-Fiscal-Indicators-2011-2015-MS-Access-da/uij9-wzqw</a>
</div>
<div id="ref-ctrealesales2025" class="csl-entry" role="listitem">
Connecticut Office of Policy and Management. (n.d.). <em>Real estate sales listings</em>. <a href="https://portal.ct.gov/OPM/IGPP/Publications/Real-Estate-Sales-Listing">https://portal.ct.gov/OPM/IGPP/Publications/Real-Estate-Sales-Listing</a>
</div>
<div id="ref-cttowns2025" class="csl-entry" role="listitem">
Connecticut State Library. (n.d.). <em>Connecticut towns and counties</em>. <a href="https://libguides.ctstatelibrary.org/cttowns">https://libguides.ctstatelibrary.org/cttowns</a>
</div>
<div id="ref-pathlib" class="csl-entry" role="listitem">
Foundation, P. S. (2023a). <em>Pathlib — object-oriented filesystem paths</em>. <a href="https://docs.python.org/3/library/pathlib.html">https://docs.python.org/3/library/pathlib.html</a>
</div>
<div id="ref-python" class="csl-entry" role="listitem">
Foundation, P. S. (2023b). <em>Python language reference, version 3.x</em>. <a href="https://www.python.org/">https://www.python.org/</a>
</div>
<div id="ref-mdbtools" class="csl-entry" role="listitem">
mdbtools contributors. (n.d.). <em>Mdbtools</em>. <a href="https://github.com/mdbtools/mdbtools" class="uri">https://github.com/mdbtools/mdbtools</a>.
</div>
<div id="ref-baseR" class="csl-entry" role="listitem">
R Core Team. (2025). <em>R: A language and environment for statistical computing</em>. R Foundation for Statistical Computing. <a href="https://www.R-project.org/">https://www.R-project.org/</a>
</div>
<div id="ref-requests" class="csl-entry" role="listitem">
Reitz, K., &amp; contributors. (2023). <em>Requests: HTTP for humans</em>. <a href="https://requests.readthedocs.io/">https://requests.readthedocs.io/</a>
</div>
<div id="ref-beautifulsoup4" class="csl-entry" role="listitem">
Richardson, L., &amp; contributors. (2023). <em>Beautiful soup documentation</em>. <a href="https://www.crummy.com/software/BeautifulSoup/bs4/doc/">https://www.crummy.com/software/BeautifulSoup/bs4/doc/</a>
</div>
<div id="ref-ct_mfi_2024" class="csl-entry" role="listitem">
State of Connecticut, O. of P., &amp; Management. (2024). <em>Municipal fiscal indicators, fiscal years ended 2014–2022</em>. State of Connecticut. <a href="https://data.ct.gov/Local-Government/Municipal-Fiscal-Indicators-Individual-Town-Data-2/ej6f-y2wf/about_data">https://data.ct.gov/Local-Government/Municipal-Fiscal-Indicators-Individual-Town-Data-2/ej6f-y2wf/about_data</a>
</div>
<div id="ref-car" class="csl-entry" role="listitem">
Team, R. C., &amp; worldwide, contributors. (2025a). <em>Car: An r package</em>. <a href="https://CRAN.R-project.org/package=car">https://CRAN.R-project.org/package=car</a>
</div>
<div id="ref-dplyr" class="csl-entry" role="listitem">
Team, R. C., &amp; worldwide, contributors. (2025b). <em>Dplyr: An r package</em>. <a href="https://CRAN.R-project.org/package=dplyr">https://CRAN.R-project.org/package=dplyr</a>
</div>
<div id="ref-httr" class="csl-entry" role="listitem">
Team, R. C., &amp; worldwide, contributors. (2025c). <em>Httr: An r package</em>. <a href="https://CRAN.R-project.org/package=httr">https://CRAN.R-project.org/package=httr</a>
</div>
<div id="ref-janitor" class="csl-entry" role="listitem">
Team, R. C., &amp; worldwide, contributors. (2025d). <em>Janitor: An r package</em>. <a href="https://CRAN.R-project.org/package=janitor">https://CRAN.R-project.org/package=janitor</a>
</div>
<div id="ref-jsonlite" class="csl-entry" role="listitem">
Team, R. C., &amp; worldwide, contributors. (2025e). <em>Jsonlite: An r package</em>. <a href="https://CRAN.R-project.org/package=jsonlite">https://CRAN.R-project.org/package=jsonlite</a>
</div>
<div id="ref-lubridate" class="csl-entry" role="listitem">
Team, R. C., &amp; worldwide, contributors. (2025f). <em>Lubridate: An r package</em>. <a href="https://CRAN.R-project.org/package=lubridate">https://CRAN.R-project.org/package=lubridate</a>
</div>
<div id="ref-purrr" class="csl-entry" role="listitem">
Team, R. C., &amp; worldwide, contributors. (2025g). <em>Purrr: An r package</em>. <a href="https://CRAN.R-project.org/package=purrr">https://CRAN.R-project.org/package=purrr</a>
</div>
<div id="ref-randomForest" class="csl-entry" role="listitem">
Team, R. C., &amp; worldwide, contributors. (2025h). <em>randomForest: An r package</em>. <a href="https://CRAN.R-project.org/package=randomForest">https://CRAN.R-project.org/package=randomForest</a>
</div>
<div id="ref-readr" class="csl-entry" role="listitem">
Team, R. C., &amp; worldwide, contributors. (2025i). <em>Readr: An r package</em>. <a href="https://CRAN.R-project.org/package=readr">https://CRAN.R-project.org/package=readr</a>
</div>
<div id="ref-rvest" class="csl-entry" role="listitem">
Team, R. C., &amp; worldwide, contributors. (2025j). <em>Rvest: An r package</em>. <a href="https://CRAN.R-project.org/package=rvest">https://CRAN.R-project.org/package=rvest</a>
</div>
<div id="ref-scales" class="csl-entry" role="listitem">
Team, R. C., &amp; worldwide, contributors. (2025k). <em>Scales: An r package</em>. <a href="https://CRAN.R-project.org/package=scales">https://CRAN.R-project.org/package=scales</a>
</div>
<div id="ref-stringr" class="csl-entry" role="listitem">
Team, R. C., &amp; worldwide, contributors. (2025l). <em>Stringr: An r package</em>. <a href="https://CRAN.R-project.org/package=stringr">https://CRAN.R-project.org/package=stringr</a>
</div>
<div id="ref-tidyr" class="csl-entry" role="listitem">
Team, R. C., &amp; worldwide, contributors. (2025m). <em>Tidyr: An r package</em>. <a href="https://CRAN.R-project.org/package=tidyr">https://CRAN.R-project.org/package=tidyr</a>
</div>
<div id="ref-tidyverse" class="csl-entry" role="listitem">
Team, R. C., &amp; worldwide, contributors. (2025n). <em>Tidyverse: An r package</em>. <a href="https://CRAN.R-project.org/package=tidyverse">https://CRAN.R-project.org/package=tidyverse</a>
</div>
<div id="ref-pandas" class="csl-entry" role="listitem">
team, T. pandas development. (2023). <em>Pandas: Powerful data structures for data analysis, time series, and statistics</em>. <a href="https://pandas.pydata.org/">https://pandas.pydata.org/</a>
</div>
<div id="ref-beagdp2023" class="csl-entry" role="listitem">
U.S. Bureau of Economic Analysis. (2023a). <em>Gross domestic product by county, metro, and other areas</em>. <a href="https://www.bea.gov/data/gdp/gdp-county-metro-and-other-areas">https://www.bea.gov/data/gdp/gdp-county-metro-and-other-areas</a>
</div>
<div id="ref-bea_personal_income_2023" class="csl-entry" role="listitem">
U.S. Bureau of Economic Analysis. (2023b). <em>Personal income by county, metro, and other areas</em>. <a href="https://www.bea.gov/data/income-saving/personal-income-county-metro-and-other-areas">https://www.bea.gov/data/income-saving/personal-income-county-metro-and-other-areas</a>
</div>
<div id="ref-bls_local_area_unemployment" class="csl-entry" role="listitem">
U.S. Bureau of Labor Statistics. (2025). <em>Local area unemployment statistics (LAUS)</em>. <a href="https://www.bls.gov/lau/" class="uri">https://www.bls.gov/lau/</a>.
</div>
<div id="ref-bls_laus_series" class="csl-entry" role="listitem">
U.S. Bureau of Labor Statistics. (n.d.). <em>Local area unemployment statistics (LAUS): Series ID listing</em>. <a href="https://download.bls.gov/pub/time.series/la/la.series" class="uri">https://download.bls.gov/pub/time.series/la/la.series</a>.
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p><span class="citation" data-cites="baseR">R Core Team (<a href="#ref-baseR" role="doc-biblioref">2025</a>)</span>; <span class="citation" data-cites="readr">Team &amp; worldwide (<a href="#ref-readr" role="doc-biblioref">2025i</a>)</span>; <span class="citation" data-cites="dplyr">Team &amp; worldwide (<a href="#ref-dplyr" role="doc-biblioref">2025b</a>)</span>; <span class="citation" data-cites="stringr">Team &amp; worldwide (<a href="#ref-stringr" role="doc-biblioref">2025l</a>)</span>; <span class="citation" data-cites="rvest">Team &amp; worldwide (<a href="#ref-rvest" role="doc-biblioref">2025j</a>)</span>; <span class="citation" data-cites="httr">Team &amp; worldwide (<a href="#ref-httr" role="doc-biblioref">2025c</a>)</span>; <span class="citation" data-cites="jsonlite">Team &amp; worldwide (<a href="#ref-jsonlite" role="doc-biblioref">2025e</a>)</span>; <span class="citation" data-cites="lubridate">Team &amp; worldwide (<a href="#ref-lubridate" role="doc-biblioref">2025f</a>)</span>; <span class="citation" data-cites="tidyr">Team &amp; worldwide (<a href="#ref-tidyr" role="doc-biblioref">2025m</a>)</span>; <span class="citation" data-cites="janitor">Team &amp; worldwide (<a href="#ref-janitor" role="doc-biblioref">2025d</a>)</span>; <span class="citation" data-cites="purrr">Team &amp; worldwide (<a href="#ref-purrr" role="doc-biblioref">2025g</a>)</span>; <span class="citation" data-cites="tidyverse">Team &amp; worldwide (<a href="#ref-tidyverse" role="doc-biblioref">2025n</a>)</span>; <span class="citation" data-cites="car">Team &amp; worldwide (<a href="#ref-car" role="doc-biblioref">2025a</a>)</span>; <span class="citation" data-cites="randomForest">Team &amp; worldwide (<a href="#ref-randomForest" role="doc-biblioref">2025h</a>)</span>; <span class="citation" data-cites="scales">Team &amp; worldwide (<a href="#ref-scales" role="doc-biblioref">2025k</a>)</span><a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p><span class="citation" data-cites="python">Foundation (<a href="#ref-python" role="doc-biblioref">2023b</a>)</span>; <span class="citation" data-cites="pandas">team (<a href="#ref-pandas" role="doc-biblioref">2023</a>)</span>; <span class="citation" data-cites="requests">Reitz &amp; contributors (<a href="#ref-requests" role="doc-biblioref">2023</a>)</span>; <span class="citation" data-cites="beautifulsoup4">Richardson &amp; contributors (<a href="#ref-beautifulsoup4" role="doc-biblioref">2023</a>)</span>; <span class="citation" data-cites="pathlib">Foundation (<a href="#ref-pathlib" role="doc-biblioref">2023a</a>)</span><a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p><span class="citation" data-cites="cttowns2025">Connecticut State Library (<a href="#ref-cttowns2025" role="doc-biblioref">n.d.</a>)</span><a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p><span class="citation" data-cites="ctrealesales2025">Connecticut Office of Policy and Management (<a href="#ref-ctrealesales2025" role="doc-biblioref">n.d.</a>)</span><a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p><span class="citation" data-cites="beagdp2023">U.S. Bureau of Economic Analysis (<a href="#ref-beagdp2023" role="doc-biblioref">2023a</a>)</span><a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"><p><span class="citation" data-cites="bea_personal_income_2023">U.S. Bureau of Economic Analysis (<a href="#ref-bea_personal_income_2023" role="doc-biblioref">2023b</a>)</span><a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7"><p><span class="citation" data-cites="bls_local_area_unemployment">U.S. Bureau of Labor Statistics (<a href="#ref-bls_local_area_unemployment" role="doc-biblioref">2025</a>)</span><a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn8"><p><span class="citation" data-cites="bls_laus_series">U.S. Bureau of Labor Statistics (<a href="#ref-bls_laus_series" role="doc-biblioref">n.d.</a>)</span><a href="#fnref8" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn9"><p><span class="citation" data-cites="ct_mfi_2024">State of Connecticut &amp; Management (<a href="#ref-ct_mfi_2024" role="doc-biblioref">2024</a>)</span>;<span class="citation" data-cites="ct_mfi_2003_2007">Connecticut Office of Policy and Management (<a href="#ref-ct_mfi_2003_2007" role="doc-biblioref">2008</a>)</span>;<span class="citation" data-cites="ct_mfi_2007_2011">Connecticut Office of Policy and Management (<a href="#ref-ct_mfi_2007_2011" role="doc-biblioref">2012</a>)</span>;<span class="citation" data-cites="ct_mfi_2007_2012">Connecticut Office of Policy and Management (<a href="#ref-ct_mfi_2007_2012" role="doc-biblioref">2013</a>)</span>;<span class="citation" data-cites="ct_mfi_2011_2015">Connecticut Office of Policy and Management (<a href="#ref-ct_mfi_2011_2015" role="doc-biblioref">2016</a>)</span><a href="#fnref9" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn10"><p><span class="citation" data-cites="mdbtools">mdbtools contributors (<a href="#ref-mdbtools" role="doc-biblioref">n.d.</a>)</span><a href="#fnref10" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/jlopez-6\.github\.io\/STA9750-2025-SPRING\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb20" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Money Talks: Connecticut's Real Estate Market"</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> "Exploring the Economic Drivers of Housing Prices Using Machine Learning"</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span><span class="co"> </span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="co">  html: </span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-location: right</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="co">    number-sections: false</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-depth: 3</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="co">  eval: false</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a><span class="co">  echo: true</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="co">  message: false</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="co">  warning: false</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a><span class="an">bibliography:</span><span class="co"> individual_report_ref.bib</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a><span class="an">csl:</span><span class="co"> apa.csl</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a><span class="fu"># Introduction</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>This work is part of a final course project, where my teammates, <span class="co">[</span><span class="ot">Craig</span><span class="co">](https://allcr.github.io/STA9750-2025-SPRING/about.html)</span>, and  <span class="co">[</span><span class="ot">Hong</span><span class="co">](https://hongzhuang1.github.io/STA9750-2025-SPRING/)</span>, and I explored what factors drive real estate prices in Connecticut. To narrow down such a broad question, we split it into three subquestions, each focused on a key meta-factor: the local economy, <span class="co">[</span><span class="ot">education quality</span><span class="co">]()</span>, and <span class="co">[</span><span class="ot">public transit accessibility</span><span class="co">]()</span>. I was randomly assigned the question: How strongly does Connecticut's real estate market correlate with economic growth? To answer it, I built a random forest model that predicts the median sale price of a home in Connecticut using county-level economic indicators. This page documents the technical details of the analysis, including data acquisition, cleaning, exploratory data analysis, and the modeling process. It provides reproducible code snippets and explanations to illustrate how the random forest model was developed and evaluated using county-level economic data.</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>The analysis in this project was completed with R and selected packages^<span class="co">[</span><span class="ot">@baseR; @readr; @dplyr; @stringr; @rvest; @httr; @jsonlite; @lubridate; @tidyr; @janitor; @purrr; @tidyverse; @car; @randomForest; @scales</span><span class="co">]</span>, and with Python and selected packages^<span class="co">[</span><span class="ot">@python; @pandas; @requests; @beautifulsoup4; @pathlib</span><span class="co">]</span>.</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a><span class="fu"># Data Acquisition</span></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>The data acquisition part of this project gave me a chance to put into practice the responsible data intake skills we covered in class and applied in Mini-Projects <span class="co">[</span><span class="ot">03</span><span class="co">](https://jlopez-6.github.io/STA9750-2025-SPRING/mp03.html)</span> and <span class="co">[</span><span class="ot">04</span><span class="co">](https://jlopez-6.github.io/STA9750-2025-SPRING/mp04.html)</span>. As usual, the process began with loading the necessary packages and setting some global constants. To make the setup cleaner, I wrote a helper function, <span class="in">`load_if_needed()`</span> that installs and loads the R packages used in this analysis.</span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a><span class="co">#' Load a package, installing it if necessary.</span></span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param pkg A character string naming the package to load.</span></span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return Invisibly returns TRUE if the package is successfully loaded.</span></span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a><span class="co">#' load_if_needed("dplyr")</span></span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>load_if_needed <span class="ot">&lt;-</span> <span class="cf">function</span>(pkg) {</span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(pkg, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">install.packages</span>(pkg)</span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">suppressPackageStartupMessages</span>(<span class="fu">library</span>(pkg, <span class="at">character.only =</span> <span class="cn">TRUE</span>))</span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a>PACKAGES <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"readr"</span>, <span class="st">"dplyr"</span>, <span class="st">"stringr"</span>, <span class="st">"rvest"</span>, <span class="st">"httr"</span>, <span class="st">"jsonlite"</span>,</span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a>              <span class="st">"lubridate"</span>, <span class="st">"tidyr"</span>, <span class="st">"janitor"</span>, <span class="st">"purrr"</span>, <span class="st">"tidyverse"</span>, <span class="st">"car"</span>,</span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a>              <span class="st">"randomForest"</span>, <span class="st">"scales"</span>)</span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(PACKAGES, load_if_needed)</span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-54"><a href="#cb20-54" aria-hidden="true" tabindex="-1"></a>SEED <span class="ot">&lt;-</span> <span class="dv">1747187262</span> </span>
<span id="cb20-55"><a href="#cb20-55" aria-hidden="true" tabindex="-1"></a>CORR_THRESHOLD <span class="ot">&lt;-</span> <span class="fl">0.8</span></span>
<span id="cb20-56"><a href="#cb20-56" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-57"><a href="#cb20-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-58"><a href="#cb20-58" aria-hidden="true" tabindex="-1"></a><span class="fu">## Connecticut Town-to-County Mapping</span></span>
<span id="cb20-59"><a href="#cb20-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-60"><a href="#cb20-60" aria-hidden="true" tabindex="-1"></a>While downloading and cleaning up the various datasets, I noticed that many of the town-level sources didn’t include the county each town belonged to. To fix this, I pulled in the <span class="co">[</span><span class="ot">Connecticut State Library’s</span><span class="co">](https://portal.ct.gov/csl?language=en_US)</span> online list of Connecticut Towns &amp; Counties^<span class="co">[</span><span class="ot">@cttowns2025</span><span class="co">]</span>. This dataset includes all 169 towns, their corresponding counties, year of incorporation, and parent town. I used the code below to download it and merge the county information into the relevant datasets.</span>
<span id="cb20-61"><a href="#cb20-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-64"><a href="#cb20-64" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb20-65"><a href="#cb20-65" aria-hidden="true" tabindex="-1"></a><span class="co">#' Load or download Connecticut town-to-county mapping.</span></span>
<span id="cb20-66"><a href="#cb20-66" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-67"><a href="#cb20-67" aria-hidden="true" tabindex="-1"></a><span class="co">#' Downloads a table mapping Connecticut towns to counties from the Connecticut State Library</span></span>
<span id="cb20-68"><a href="#cb20-68" aria-hidden="true" tabindex="-1"></a><span class="co">#' website if it doesn't already exist locally. Saves the table as a CSV for reuse.</span></span>
<span id="cb20-69"><a href="#cb20-69" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-70"><a href="#cb20-70" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A data frame with town and county mappings.</span></span>
<span id="cb20-71"><a href="#cb20-71" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb20-72"><a href="#cb20-72" aria-hidden="true" tabindex="-1"></a><span class="co">#' ct_towns &lt;- load_ct_town_mapping()</span></span>
<span id="cb20-73"><a href="#cb20-73" aria-hidden="true" tabindex="-1"></a>load_ct_town_mapping <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb20-74"><a href="#cb20-74" aria-hidden="true" tabindex="-1"></a>  target_dir <span class="ot">&lt;-</span> <span class="st">"data/individual_report"</span></span>
<span id="cb20-75"><a href="#cb20-75" aria-hidden="true" tabindex="-1"></a>  f_name <span class="ot">&lt;-</span> <span class="st">"ct_towns.csv"</span></span>
<span id="cb20-76"><a href="#cb20-76" aria-hidden="true" tabindex="-1"></a>  file_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, f_name)</span>
<span id="cb20-77"><a href="#cb20-77" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-78"><a href="#cb20-78" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(target_dir)) {</span>
<span id="cb20-79"><a href="#cb20-79" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(target_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-80"><a href="#cb20-80" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-81"><a href="#cb20-81" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-82"><a href="#cb20-82" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(file_path)) {</span>
<span id="cb20-83"><a href="#cb20-83" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Download CT Town &lt;- County mapping</span></span>
<span id="cb20-84"><a href="#cb20-84" aria-hidden="true" tabindex="-1"></a>    url <span class="ot">&lt;-</span> <span class="st">"https://libguides.ctstatelibrary.org/cttowns"</span></span>
<span id="cb20-85"><a href="#cb20-85" aria-hidden="true" tabindex="-1"></a>    webpage <span class="ot">&lt;-</span> <span class="fu">read_html</span>(url)</span>
<span id="cb20-86"><a href="#cb20-86" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-87"><a href="#cb20-87" aria-hidden="true" tabindex="-1"></a>    tables <span class="ot">&lt;-</span> <span class="fu">html_table</span>(webpage, <span class="at">fill =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-88"><a href="#cb20-88" aria-hidden="true" tabindex="-1"></a>    ct_towns_counties <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(tables[[<span class="dv">1</span>]])</span>
<span id="cb20-89"><a href="#cb20-89" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-90"><a href="#cb20-90" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set first row as column names and remove it from data</span></span>
<span id="cb20-91"><a href="#cb20-91" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(ct_towns_counties) <span class="ot">&lt;-</span> ct_towns_counties[<span class="dv">1</span>, ]</span>
<span id="cb20-92"><a href="#cb20-92" aria-hidden="true" tabindex="-1"></a>    ct_towns_counties <span class="ot">&lt;-</span> ct_towns_counties[<span class="sc">-</span><span class="dv">1</span>, ]</span>
<span id="cb20-93"><a href="#cb20-93" aria-hidden="true" tabindex="-1"></a>    <span class="fu">row.names</span>(ct_towns_counties) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb20-94"><a href="#cb20-94" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-95"><a href="#cb20-95" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(ct_towns_counties, file_path)</span>
<span id="cb20-96"><a href="#cb20-96" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb20-97"><a href="#cb20-97" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Reading existing data from CSV..."</span>)</span>
<span id="cb20-98"><a href="#cb20-98" aria-hidden="true" tabindex="-1"></a>    ct_towns_counties <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(file_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb20-99"><a href="#cb20-99" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-100"><a href="#cb20-100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(ct_towns_counties)</span>
<span id="cb20-101"><a href="#cb20-101" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-102"><a href="#cb20-102" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-103"><a href="#cb20-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-104"><a href="#cb20-104" aria-hidden="true" tabindex="-1"></a><span class="fu">## Connecticut Real Estate Sales </span></span>
<span id="cb20-105"><a href="#cb20-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-106"><a href="#cb20-106" aria-hidden="true" tabindex="-1"></a>The Connecticut Real Estate Sales data set contained sales information about all real estate transactions greater than $2,000 between October 1, 2001 and September 30, 2022. This comprehensive data set was compiled and published by <span class="co">[</span><span class="ot">Connecticut's Office of Policy and Management</span><span class="co">](https://portal.ct.gov/opm)</span> (CT OPM)^<span class="co">[</span><span class="ot">@ctrealesales2025</span><span class="co">]</span>. </span>
<span id="cb20-107"><a href="#cb20-107" aria-hidden="true" tabindex="-1"></a>With over 1.09 million records and 20 attributes per transaction, the dats set includes information on the sale amount, the sales ratio, and the property's assessed value for each transaction. This data set is valuable for researchers looking to explore the spatio-temporal dynamics of Connecticut's real estate market. The code used to download this data set is included below.</span>
<span id="cb20-108"><a href="#cb20-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-109"><a href="#cb20-109" aria-hidden="true" tabindex="-1"></a><span class="in">``` {r}</span></span>
<span id="cb20-110"><a href="#cb20-110" aria-hidden="true" tabindex="-1"></a><span class="in">#' Load and clean Connecticut real estate sales data.</span></span>
<span id="cb20-111"><a href="#cb20-111" aria-hidden="true" tabindex="-1"></a><span class="in">#'</span></span>
<span id="cb20-112"><a href="#cb20-112" aria-hidden="true" tabindex="-1"></a><span class="in">#' Downloads, processes, and saves Connecticut real estate sales data from the CT Open Data portal.</span></span>
<span id="cb20-113"><a href="#cb20-113" aria-hidden="true" tabindex="-1"></a><span class="in">#' If a cleaned version already exists locally, it is loaded directly. Otherwise, the function:</span></span>
<span id="cb20-114"><a href="#cb20-114" aria-hidden="true" tabindex="-1"></a><span class="in">#' - Downloads raw data (if not already downloaded)</span></span>
<span id="cb20-115"><a href="#cb20-115" aria-hidden="true" tabindex="-1"></a><span class="in">#' - Cleans and filters the dataset (e.g., removes duplicates, fixes town names, parses dates)</span></span>
<span id="cb20-116"><a href="#cb20-116" aria-hidden="true" tabindex="-1"></a><span class="in">#' - Merges with town-to-county mapping</span></span>
<span id="cb20-117"><a href="#cb20-117" aria-hidden="true" tabindex="-1"></a><span class="in">#' - Saves the cleaned data for future use</span></span>
<span id="cb20-118"><a href="#cb20-118" aria-hidden="true" tabindex="-1"></a><span class="in">#'</span></span>
<span id="cb20-119"><a href="#cb20-119" aria-hidden="true" tabindex="-1"></a><span class="in">#' @return A cleaned data frame of real estate sales in Connecticut from 2001–2022.</span></span>
<span id="cb20-120"><a href="#cb20-120" aria-hidden="true" tabindex="-1"></a><span class="in">#' @examples</span></span>
<span id="cb20-121"><a href="#cb20-121" aria-hidden="true" tabindex="-1"></a><span class="in">#' ct_sales &lt;- load_ct_sales()</span></span>
<span id="cb20-122"><a href="#cb20-122" aria-hidden="true" tabindex="-1"></a><span class="in">load_ct_sales &lt;- function() {</span></span>
<span id="cb20-123"><a href="#cb20-123" aria-hidden="true" tabindex="-1"></a><span class="in">  target_dir &lt;- "/Users/jocelylopez/CT-HousingLens/data/individual_report"</span></span>
<span id="cb20-124"><a href="#cb20-124" aria-hidden="true" tabindex="-1"></a><span class="in">  raw_file &lt;- file.path(target_dir, "CT_SALES_raw.csv")</span></span>
<span id="cb20-125"><a href="#cb20-125" aria-hidden="true" tabindex="-1"></a><span class="in">  clean_file &lt;- file.path(target_dir, "Real_Estate_Sales_2001-2022_GL.csv")</span></span>
<span id="cb20-126"><a href="#cb20-126" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb20-127"><a href="#cb20-127" aria-hidden="true" tabindex="-1"></a><span class="in">  if (!dir.exists(target_dir)){dir.create(target_dir, recursive = TRUE)}</span></span>
<span id="cb20-128"><a href="#cb20-128" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb20-129"><a href="#cb20-129" aria-hidden="true" tabindex="-1"></a><span class="in">  if (!file.exists(clean_file)) {</span></span>
<span id="cb20-130"><a href="#cb20-130" aria-hidden="true" tabindex="-1"></a><span class="in">    # Download raw data if needed</span></span>
<span id="cb20-131"><a href="#cb20-131" aria-hidden="true" tabindex="-1"></a><span class="in">    if (!file.exists(raw_file)) {</span></span>
<span id="cb20-132"><a href="#cb20-132" aria-hidden="true" tabindex="-1"></a><span class="in">      base_url &lt;- "https://data.ct.gov/resource/5mzw-sjtu.json"</span></span>
<span id="cb20-133"><a href="#cb20-133" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb20-134"><a href="#cb20-134" aria-hidden="true" tabindex="-1"></a><span class="in">      # Since there is a request limit on the API, I will find the count of data</span></span>
<span id="cb20-135"><a href="#cb20-135" aria-hidden="true" tabindex="-1"></a><span class="in">      # points so I can override the default limit. </span></span>
<span id="cb20-136"><a href="#cb20-136" aria-hidden="true" tabindex="-1"></a><span class="in">      query &lt;- "SELECT COUNT(*)"</span></span>
<span id="cb20-137"><a href="#cb20-137" aria-hidden="true" tabindex="-1"></a><span class="in">      encoded_query &lt;- URLencode(query, reserved = TRUE)</span></span>
<span id="cb20-138"><a href="#cb20-138" aria-hidden="true" tabindex="-1"></a><span class="in">      count_query &lt;- paste0(base_url, "?$query=", encoded_query)</span></span>
<span id="cb20-139"><a href="#cb20-139" aria-hidden="true" tabindex="-1"></a><span class="in">      response &lt;- GET(count_query)</span></span>
<span id="cb20-140"><a href="#cb20-140" aria-hidden="true" tabindex="-1"></a><span class="in">      count_data &lt;- fromJSON(content(response, as = "text"))</span></span>
<span id="cb20-141"><a href="#cb20-141" aria-hidden="true" tabindex="-1"></a><span class="in">      total_count &lt;- as.integer(count_data$COUNT[1])</span></span>
<span id="cb20-142"><a href="#cb20-142" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb20-143"><a href="#cb20-143" aria-hidden="true" tabindex="-1"></a><span class="in">      base_url &lt;- paste0(base_url,"?$limit=", total_count)</span></span>
<span id="cb20-144"><a href="#cb20-144" aria-hidden="true" tabindex="-1"></a><span class="in">      response &lt;- GET(base_url)</span></span>
<span id="cb20-145"><a href="#cb20-145" aria-hidden="true" tabindex="-1"></a><span class="in">      CT_SALES &lt;- fromJSON(content(response, as = "text")) |&gt; select(-geo_coordinates) #removing geo_coordinates because it's nested...</span></span>
<span id="cb20-146"><a href="#cb20-146" aria-hidden="true" tabindex="-1"></a><span class="in">      write_csv(as.data.frame(CT_SALES), raw_file)</span></span>
<span id="cb20-147"><a href="#cb20-147" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb20-148"><a href="#cb20-148" aria-hidden="true" tabindex="-1"></a><span class="in">    } else {</span></span>
<span id="cb20-149"><a href="#cb20-149" aria-hidden="true" tabindex="-1"></a><span class="in">      CT_SALES &lt;- read_csv(raw_file, show_col_types = FALSE)</span></span>
<span id="cb20-150"><a href="#cb20-150" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb20-151"><a href="#cb20-151" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb20-152"><a href="#cb20-152" aria-hidden="true" tabindex="-1"></a><span class="in">    # Clean data</span></span>
<span id="cb20-153"><a href="#cb20-153" aria-hidden="true" tabindex="-1"></a><span class="in">    ct_sales &lt;- CT_SALES |&gt;</span></span>
<span id="cb20-154"><a href="#cb20-154" aria-hidden="true" tabindex="-1"></a><span class="in">      rename(</span></span>
<span id="cb20-155"><a href="#cb20-155" aria-hidden="true" tabindex="-1"></a><span class="in">        serial_number = serialnumber,</span></span>
<span id="cb20-156"><a href="#cb20-156" aria-hidden="true" tabindex="-1"></a><span class="in">        list_year = listyear,</span></span>
<span id="cb20-157"><a href="#cb20-157" aria-hidden="true" tabindex="-1"></a><span class="in">        date_recorded = daterecorded,</span></span>
<span id="cb20-158"><a href="#cb20-158" aria-hidden="true" tabindex="-1"></a><span class="in">        address = address,</span></span>
<span id="cb20-159"><a href="#cb20-159" aria-hidden="true" tabindex="-1"></a><span class="in">        assessed_value = assessedvalue,</span></span>
<span id="cb20-160"><a href="#cb20-160" aria-hidden="true" tabindex="-1"></a><span class="in">        sale_amount = saleamount,</span></span>
<span id="cb20-161"><a href="#cb20-161" aria-hidden="true" tabindex="-1"></a><span class="in">        sales_ratio = salesratio,</span></span>
<span id="cb20-162"><a href="#cb20-162" aria-hidden="true" tabindex="-1"></a><span class="in">        property_type = propertytype,</span></span>
<span id="cb20-163"><a href="#cb20-163" aria-hidden="true" tabindex="-1"></a><span class="in">        residential_type = residentialtype,</span></span>
<span id="cb20-164"><a href="#cb20-164" aria-hidden="true" tabindex="-1"></a><span class="in">        non_use_code = nonusecode,</span></span>
<span id="cb20-165"><a href="#cb20-165" aria-hidden="true" tabindex="-1"></a><span class="in">        assessor_remarks = remarks,</span></span>
<span id="cb20-166"><a href="#cb20-166" aria-hidden="true" tabindex="-1"></a><span class="in">        opm_remarks = opm_remarks</span></span>
<span id="cb20-167"><a href="#cb20-167" aria-hidden="true" tabindex="-1"></a><span class="in">      ) |&gt;</span></span>
<span id="cb20-168"><a href="#cb20-168" aria-hidden="true" tabindex="-1"></a><span class="in">      filter(!is.na(date_recorded), sale_amount &gt;= 2000) |&gt;</span></span>
<span id="cb20-169"><a href="#cb20-169" aria-hidden="true" tabindex="-1"></a><span class="in">      mutate(</span></span>
<span id="cb20-170"><a href="#cb20-170" aria-hidden="true" tabindex="-1"></a><span class="in">        town = if_else(town == "***Unknown***", "East Hampton", town),</span></span>
<span id="cb20-171"><a href="#cb20-171" aria-hidden="true" tabindex="-1"></a><span class="in">        address = str_to_title(address),</span></span>
<span id="cb20-172"><a href="#cb20-172" aria-hidden="true" tabindex="-1"></a><span class="in">        year_recorded = year(date_recorded),</span></span>
<span id="cb20-173"><a href="#cb20-173" aria-hidden="true" tabindex="-1"></a><span class="in">        month_recorded = month(date_recorded),</span></span>
<span id="cb20-174"><a href="#cb20-174" aria-hidden="true" tabindex="-1"></a><span class="in">        day_recorded = day(date_recorded)</span></span>
<span id="cb20-175"><a href="#cb20-175" aria-hidden="true" tabindex="-1"></a><span class="in">      ) |&gt;</span></span>
<span id="cb20-176"><a href="#cb20-176" aria-hidden="true" tabindex="-1"></a><span class="in">      mutate(across(where(~ is.character(.) &amp;&amp; all(!is.na(suppressWarnings(as.numeric(.))))), as.numeric)) |&gt;</span></span>
<span id="cb20-177"><a href="#cb20-177" aria-hidden="true" tabindex="-1"></a><span class="in">      filter(year_recorded &gt;= 2001)</span></span>
<span id="cb20-178"><a href="#cb20-178" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb20-179"><a href="#cb20-179" aria-hidden="true" tabindex="-1"></a><span class="in">    # Join town-county mapping</span></span>
<span id="cb20-180"><a href="#cb20-180" aria-hidden="true" tabindex="-1"></a><span class="in">    ct_towns_counties &lt;- load_ct_town_mapping()</span></span>
<span id="cb20-181"><a href="#cb20-181" aria-hidden="true" tabindex="-1"></a><span class="in">    ct_sales &lt;- ct_sales |&gt;</span></span>
<span id="cb20-182"><a href="#cb20-182" aria-hidden="true" tabindex="-1"></a><span class="in">      left_join(select(ct_towns_counties, "Town name", County), by = c("town" = "Town name")) |&gt;</span></span>
<span id="cb20-183"><a href="#cb20-183" aria-hidden="true" tabindex="-1"></a><span class="in">      rename(county = County)</span></span>
<span id="cb20-184"><a href="#cb20-184" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb20-185"><a href="#cb20-185" aria-hidden="true" tabindex="-1"></a><span class="in">    # Filter out problematic or non-residential records</span></span>
<span id="cb20-186"><a href="#cb20-186" aria-hidden="true" tabindex="-1"></a><span class="in">    is_concerning &lt;- function(text) {</span></span>
<span id="cb20-187"><a href="#cb20-187" aria-hidden="true" tabindex="-1"></a><span class="in">      str_detect(text, regex("duplicate|incorrect|wrong|error|missing|gas station", ignore_case = TRUE))</span></span>
<span id="cb20-188"><a href="#cb20-188" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb20-189"><a href="#cb20-189" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb20-190"><a href="#cb20-190" aria-hidden="true" tabindex="-1"></a><span class="in">    to_remove &lt;- ct_sales |&gt; filter(is_concerning(opm_remarks))</span></span>
<span id="cb20-191"><a href="#cb20-191" aria-hidden="true" tabindex="-1"></a><span class="in">    ct_sales &lt;- ct_sales |&gt; anti_join(to_remove, by = c("serial_number", "address"))</span></span>
<span id="cb20-192"><a href="#cb20-192" aria-hidden="true" tabindex="-1"></a><span class="in">    ct_sales &lt;- ct_sales |&gt; filter(!non_use_code %in% c("20 - Cemetery"), sale_amount &gt; 0)</span></span>
<span id="cb20-193"><a href="#cb20-193" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb20-194"><a href="#cb20-194" aria-hidden="true" tabindex="-1"></a><span class="in">    # Add unique ID</span></span>
<span id="cb20-195"><a href="#cb20-195" aria-hidden="true" tabindex="-1"></a><span class="in">    ct_sales &lt;- ct_sales |&gt; mutate(id = paste(address, town, property_type))</span></span>
<span id="cb20-196"><a href="#cb20-196" aria-hidden="true" tabindex="-1"></a><span class="in">    write_csv(as.data.frame(ct_sales), clean_file)</span></span>
<span id="cb20-197"><a href="#cb20-197" aria-hidden="true" tabindex="-1"></a><span class="in">    # Optional: file.remove(raw_file)</span></span>
<span id="cb20-198"><a href="#cb20-198" aria-hidden="true" tabindex="-1"></a><span class="in">  } else {</span></span>
<span id="cb20-199"><a href="#cb20-199" aria-hidden="true" tabindex="-1"></a><span class="in">    message("Reading existing data from CSV...")</span></span>
<span id="cb20-200"><a href="#cb20-200" aria-hidden="true" tabindex="-1"></a><span class="in">    ct_sales &lt;- read_csv(clean_file, show_col_types = FALSE)</span></span>
<span id="cb20-201"><a href="#cb20-201" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb20-202"><a href="#cb20-202" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb20-203"><a href="#cb20-203" aria-hidden="true" tabindex="-1"></a><span class="in">  return(ct_sales)</span></span>
<span id="cb20-204"><a href="#cb20-204" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb20-205"><a href="#cb20-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-206"><a href="#cb20-206" aria-hidden="true" tabindex="-1"></a><span class="in">CT_SALES &lt;- load_ct_sales()</span></span>
<span id="cb20-207"><a href="#cb20-207" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-208"><a href="#cb20-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-209"><a href="#cb20-209" aria-hidden="true" tabindex="-1"></a><span class="fu">## GDP by County</span></span>
<span id="cb20-210"><a href="#cb20-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-211"><a href="#cb20-211" aria-hidden="true" tabindex="-1"></a>The <span class="co">[</span><span class="ot">U.S. Bureau of Economic Analysis (BEA)</span><span class="co">](https://bea.gov)</span> publishes annual county-level GDP estimates by industry for every state^<span class="co">[</span><span class="ot">@beagdp2023</span><span class="co">]</span>. The Connecticut file covers all 8 counties from 2001 to 2023. When paired with the real estate sales data, this dataset makes it possible to explore how local GDP relates to housing prices. I downloaded it using the code below.</span>
<span id="cb20-212"><a href="#cb20-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-213"><a href="#cb20-213" aria-hidden="true" tabindex="-1"></a><span class="in">``` {r}</span></span>
<span id="cb20-214"><a href="#cb20-214" aria-hidden="true" tabindex="-1"></a><span class="in">#' Load and process BEA County-level GDP data (CAGDP2) for Connecticut (2001–2023).</span></span>
<span id="cb20-215"><a href="#cb20-215" aria-hidden="true" tabindex="-1"></a><span class="in">#'</span></span>
<span id="cb20-216"><a href="#cb20-216" aria-hidden="true" tabindex="-1"></a><span class="in">#' Downloads and processes GDP data if not already saved locally. </span></span>
<span id="cb20-217"><a href="#cb20-217" aria-hidden="true" tabindex="-1"></a><span class="in">#' Cleans and reshapes the dataset into tidy format.</span></span>
<span id="cb20-218"><a href="#cb20-218" aria-hidden="true" tabindex="-1"></a><span class="in">#'</span></span>
<span id="cb20-219"><a href="#cb20-219" aria-hidden="true" tabindex="-1"></a><span class="in">#' @return A cleaned tibble with columns: county, industry_class, industry_desc, year, and gdp.</span></span>
<span id="cb20-220"><a href="#cb20-220" aria-hidden="true" tabindex="-1"></a><span class="in">load_CAGDP2_data &lt;- function() {</span></span>
<span id="cb20-221"><a href="#cb20-221" aria-hidden="true" tabindex="-1"></a><span class="in">  target_dir &lt;- "data/individual_report/CAGDP2"</span></span>
<span id="cb20-222"><a href="#cb20-222" aria-hidden="true" tabindex="-1"></a><span class="in">  f_name &lt;- "CAGDP2_CT_2001_2023.csv"</span></span>
<span id="cb20-223"><a href="#cb20-223" aria-hidden="true" tabindex="-1"></a><span class="in">  f_path &lt;- file.path(target_dir, f_name)</span></span>
<span id="cb20-224"><a href="#cb20-224" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb20-225"><a href="#cb20-225" aria-hidden="true" tabindex="-1"></a><span class="in">  if (!dir.exists(target_dir)) {</span></span>
<span id="cb20-226"><a href="#cb20-226" aria-hidden="true" tabindex="-1"></a><span class="in">    dir.create(target_dir, recursive = TRUE)</span></span>
<span id="cb20-227"><a href="#cb20-227" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb20-228"><a href="#cb20-228" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb20-229"><a href="#cb20-229" aria-hidden="true" tabindex="-1"></a><span class="in">  if (!file.exists(f_path)) {</span></span>
<span id="cb20-230"><a href="#cb20-230" aria-hidden="true" tabindex="-1"></a><span class="in">    zip_url &lt;- "https://apps.bea.gov/regional/zip/CAGDP2.zip"</span></span>
<span id="cb20-231"><a href="#cb20-231" aria-hidden="true" tabindex="-1"></a><span class="in">    zip_f_name &lt;- basename(zip_url)</span></span>
<span id="cb20-232"><a href="#cb20-232" aria-hidden="true" tabindex="-1"></a><span class="in">    zip_f_path &lt;- file.path(target_dir, zip_f_name)</span></span>
<span id="cb20-233"><a href="#cb20-233" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb20-234"><a href="#cb20-234" aria-hidden="true" tabindex="-1"></a><span class="in">    # Download zip if not already there</span></span>
<span id="cb20-235"><a href="#cb20-235" aria-hidden="true" tabindex="-1"></a><span class="in">    if (!file.exists(zip_f_path)) {</span></span>
<span id="cb20-236"><a href="#cb20-236" aria-hidden="true" tabindex="-1"></a><span class="in">      download.file(zip_url, zip_f_path)</span></span>
<span id="cb20-237"><a href="#cb20-237" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb20-238"><a href="#cb20-238" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb20-239"><a href="#cb20-239" aria-hidden="true" tabindex="-1"></a><span class="in">    # Unzip contents</span></span>
<span id="cb20-240"><a href="#cb20-240" aria-hidden="true" tabindex="-1"></a><span class="in">    unzip(zip_f_path, exdir = target_dir)</span></span>
<span id="cb20-241"><a href="#cb20-241" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb20-242"><a href="#cb20-242" aria-hidden="true" tabindex="-1"></a><span class="in">    # Keep only relevant files</span></span>
<span id="cb20-243"><a href="#cb20-243" aria-hidden="true" tabindex="-1"></a><span class="in">    keep_files &lt;- file.path(target_dir, c(</span></span>
<span id="cb20-244"><a href="#cb20-244" aria-hidden="true" tabindex="-1"></a><span class="in">      "CAGDP2_CT_2001_2023.csv",</span></span>
<span id="cb20-245"><a href="#cb20-245" aria-hidden="true" tabindex="-1"></a><span class="in">      "CAGDP2__Footnotes.html",</span></span>
<span id="cb20-246"><a href="#cb20-246" aria-hidden="true" tabindex="-1"></a><span class="in">      "CAGDP2__definition.xml"</span></span>
<span id="cb20-247"><a href="#cb20-247" aria-hidden="true" tabindex="-1"></a><span class="in">    ))</span></span>
<span id="cb20-248"><a href="#cb20-248" aria-hidden="true" tabindex="-1"></a><span class="in">    all_files &lt;- list.files(target_dir, recursive = TRUE, full.names = TRUE)</span></span>
<span id="cb20-249"><a href="#cb20-249" aria-hidden="true" tabindex="-1"></a><span class="in">    file.remove(setdiff(all_files, keep_files))</span></span>
<span id="cb20-250"><a href="#cb20-250" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb20-251"><a href="#cb20-251" aria-hidden="true" tabindex="-1"></a><span class="in">    # Read and clean data</span></span>
<span id="cb20-252"><a href="#cb20-252" aria-hidden="true" tabindex="-1"></a><span class="in">    CAGDP2 &lt;- read_csv(f_path, show_col_types = FALSE) |&gt;</span></span>
<span id="cb20-253"><a href="#cb20-253" aria-hidden="true" tabindex="-1"></a><span class="in">      select(-c(TableName, GeoFIPS, Region, LineCode)) |&gt;</span></span>
<span id="cb20-254"><a href="#cb20-254" aria-hidden="true" tabindex="-1"></a><span class="in">      rename(unit = Unit, industry_desc = Description) |&gt;</span></span>
<span id="cb20-255"><a href="#cb20-255" aria-hidden="true" tabindex="-1"></a><span class="in">      mutate(county = str_split(GeoName, ", ", simplify = TRUE)[, 1]) |&gt;</span></span>
<span id="cb20-256"><a href="#cb20-256" aria-hidden="true" tabindex="-1"></a><span class="in">      pivot_longer(</span></span>
<span id="cb20-257"><a href="#cb20-257" aria-hidden="true" tabindex="-1"></a><span class="in">        -c(GeoName, IndustryClassification, industry_desc, unit, county),</span></span>
<span id="cb20-258"><a href="#cb20-258" aria-hidden="true" tabindex="-1"></a><span class="in">        names_to = "year",</span></span>
<span id="cb20-259"><a href="#cb20-259" aria-hidden="true" tabindex="-1"></a><span class="in">        values_to = "gdp"</span></span>
<span id="cb20-260"><a href="#cb20-260" aria-hidden="true" tabindex="-1"></a><span class="in">      ) |&gt;</span></span>
<span id="cb20-261"><a href="#cb20-261" aria-hidden="true" tabindex="-1"></a><span class="in">      mutate(</span></span>
<span id="cb20-262"><a href="#cb20-262" aria-hidden="true" tabindex="-1"></a><span class="in">        year = as.numeric(str_remove(year, "^X")),</span></span>
<span id="cb20-263"><a href="#cb20-263" aria-hidden="true" tabindex="-1"></a><span class="in">        gdp = as.numeric(gdp) * 1000</span></span>
<span id="cb20-264"><a href="#cb20-264" aria-hidden="true" tabindex="-1"></a><span class="in">      ) |&gt;</span></span>
<span id="cb20-265"><a href="#cb20-265" aria-hidden="true" tabindex="-1"></a><span class="in">      filter(!is.na(gdp)) |&gt;</span></span>
<span id="cb20-266"><a href="#cb20-266" aria-hidden="true" tabindex="-1"></a><span class="in">      select(-GeoName, -unit) |&gt;</span></span>
<span id="cb20-267"><a href="#cb20-267" aria-hidden="true" tabindex="-1"></a><span class="in">      rename(industry_class = IndustryClassification)</span></span>
<span id="cb20-268"><a href="#cb20-268" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb20-269"><a href="#cb20-269" aria-hidden="true" tabindex="-1"></a><span class="in">    write_csv(CAGDP2, f_path)</span></span>
<span id="cb20-270"><a href="#cb20-270" aria-hidden="true" tabindex="-1"></a><span class="in">  } else {</span></span>
<span id="cb20-271"><a href="#cb20-271" aria-hidden="true" tabindex="-1"></a><span class="in">    message("Reading existing data from CSV...")</span></span>
<span id="cb20-272"><a href="#cb20-272" aria-hidden="true" tabindex="-1"></a><span class="in">    CAGDP2 &lt;- read_csv(f_path, show_col_types = FALSE)</span></span>
<span id="cb20-273"><a href="#cb20-273" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb20-274"><a href="#cb20-274" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb20-275"><a href="#cb20-275" aria-hidden="true" tabindex="-1"></a><span class="in">  return(CAGDP2)</span></span>
<span id="cb20-276"><a href="#cb20-276" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb20-277"><a href="#cb20-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-278"><a href="#cb20-278" aria-hidden="true" tabindex="-1"></a><span class="in">CAGDP2 &lt;- load_CAGDP2_data()</span></span>
<span id="cb20-279"><a href="#cb20-279" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-280"><a href="#cb20-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-281"><a href="#cb20-281" aria-hidden="true" tabindex="-1"></a><span class="fu">## Income by County</span></span>
<span id="cb20-282"><a href="#cb20-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-283"><a href="#cb20-283" aria-hidden="true" tabindex="-1"></a>In addition to GDP, the BEA publishes various data sets containing information on personal income^<span class="co">[</span><span class="ot">@bea_personal_income_2023</span><span class="co">]</span>. For this project, I used four of them: CAINC1, CAINC4, CAINC30, and CAINC91. Respectively, these files provide annual county-level data on total personal income, income and employment by major component, economic profiles, and gross earnings flows. Including these in the analysis brings in a fuller picture of personal income as a factor that could shape Connecticut’s real estate market. The code I used to download them is below.</span>
<span id="cb20-284"><a href="#cb20-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-287"><a href="#cb20-287" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb20-288"><a href="#cb20-288" aria-hidden="true" tabindex="-1"></a><span class="co">#' Load and process BEA County-level Income Data (CAINC1) for Connecticut (2001–2023).</span></span>
<span id="cb20-289"><a href="#cb20-289" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-290"><a href="#cb20-290" aria-hidden="true" tabindex="-1"></a><span class="co">#' Downloads and processes personal income data if not already saved locally. </span></span>
<span id="cb20-291"><a href="#cb20-291" aria-hidden="true" tabindex="-1"></a><span class="co">#' Cleans, reshapes, and standardizes the dataset into a tidy format with one row per county-year.</span></span>
<span id="cb20-292"><a href="#cb20-292" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-293"><a href="#cb20-293" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A cleaned tibble with columns: county, year, personal_income, population, per_capita_income.</span></span>
<span id="cb20-294"><a href="#cb20-294" aria-hidden="true" tabindex="-1"></a>load_CAINC1_data <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb20-295"><a href="#cb20-295" aria-hidden="true" tabindex="-1"></a>  target_dir <span class="ot">&lt;-</span> <span class="st">"data/individual_report/CAINC1"</span></span>
<span id="cb20-296"><a href="#cb20-296" aria-hidden="true" tabindex="-1"></a>  f_name <span class="ot">&lt;-</span> <span class="st">"CAINC1_CT_2001_2023.csv"</span></span>
<span id="cb20-297"><a href="#cb20-297" aria-hidden="true" tabindex="-1"></a>  f_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, f_name)</span>
<span id="cb20-298"><a href="#cb20-298" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-299"><a href="#cb20-299" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(target_dir)) {</span>
<span id="cb20-300"><a href="#cb20-300" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(target_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-301"><a href="#cb20-301" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-302"><a href="#cb20-302" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-303"><a href="#cb20-303" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(f_path)) {</span>
<span id="cb20-304"><a href="#cb20-304" aria-hidden="true" tabindex="-1"></a>    zip_url <span class="ot">&lt;-</span> <span class="st">"https://apps.bea.gov/regional/zip/CAINC1.zip"</span></span>
<span id="cb20-305"><a href="#cb20-305" aria-hidden="true" tabindex="-1"></a>    zip_f_name <span class="ot">&lt;-</span> <span class="fu">basename</span>(zip_url)</span>
<span id="cb20-306"><a href="#cb20-306" aria-hidden="true" tabindex="-1"></a>    zip_f_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, zip_f_name)</span>
<span id="cb20-307"><a href="#cb20-307" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-308"><a href="#cb20-308" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(zip_f_path)) {</span>
<span id="cb20-309"><a href="#cb20-309" aria-hidden="true" tabindex="-1"></a>      <span class="fu">download.file</span>(zip_url, zip_f_path)</span>
<span id="cb20-310"><a href="#cb20-310" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-311"><a href="#cb20-311" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-312"><a href="#cb20-312" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unzip</span>(zip_f_path, <span class="at">exdir =</span> target_dir)</span>
<span id="cb20-313"><a href="#cb20-313" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-314"><a href="#cb20-314" aria-hidden="true" tabindex="-1"></a>    keep_files <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, <span class="fu">c</span>(</span>
<span id="cb20-315"><a href="#cb20-315" aria-hidden="true" tabindex="-1"></a>      <span class="st">"CAINC1_CT_1969_2023.csv"</span>,</span>
<span id="cb20-316"><a href="#cb20-316" aria-hidden="true" tabindex="-1"></a>      <span class="st">"CAINC1__Footnotes.html"</span>,</span>
<span id="cb20-317"><a href="#cb20-317" aria-hidden="true" tabindex="-1"></a>      <span class="st">"CAINC1__definition.xml"</span></span>
<span id="cb20-318"><a href="#cb20-318" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb20-319"><a href="#cb20-319" aria-hidden="true" tabindex="-1"></a>    extracted_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(target_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-320"><a href="#cb20-320" aria-hidden="true" tabindex="-1"></a>    <span class="fu">file.remove</span>(<span class="fu">setdiff</span>(extracted_files, keep_files))</span>
<span id="cb20-321"><a href="#cb20-321" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-322"><a href="#cb20-322" aria-hidden="true" tabindex="-1"></a>    CAINC1 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">file.path</span>(target_dir, <span class="st">"CAINC1_CT_1969_2023.csv"</span>), <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-323"><a href="#cb20-323" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(TableName, GeoFIPS, Region, LineCode, IndustryClassification)) <span class="sc">|&gt;</span></span>
<span id="cb20-324"><a href="#cb20-324" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">unit =</span> Unit, <span class="at">metric_desc =</span> Description) <span class="sc">|&gt;</span></span>
<span id="cb20-325"><a href="#cb20-325" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">county =</span> <span class="fu">str_split</span>(GeoName, <span class="st">", "</span>, <span class="at">simplify =</span> <span class="cn">TRUE</span>)[, <span class="dv">1</span>]) <span class="sc">|&gt;</span></span>
<span id="cb20-326"><a href="#cb20-326" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pivot_longer</span>(</span>
<span id="cb20-327"><a href="#cb20-327" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span><span class="fu">c</span>(GeoName, metric_desc, unit, county),</span>
<span id="cb20-328"><a href="#cb20-328" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_to =</span> <span class="st">"year"</span>,</span>
<span id="cb20-329"><a href="#cb20-329" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_to =</span> <span class="st">"metric_value"</span></span>
<span id="cb20-330"><a href="#cb20-330" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb20-331"><a href="#cb20-331" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb20-332"><a href="#cb20-332" aria-hidden="true" tabindex="-1"></a>        <span class="at">year =</span> <span class="fu">as.numeric</span>(<span class="fu">str_remove</span>(year, <span class="st">"^X"</span>)),</span>
<span id="cb20-333"><a href="#cb20-333" aria-hidden="true" tabindex="-1"></a>        <span class="at">metric_value =</span> <span class="fu">as.numeric</span>(metric_value)</span>
<span id="cb20-334"><a href="#cb20-334" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb20-335"><a href="#cb20-335" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(metric_value)) <span class="sc">|&gt;</span></span>
<span id="cb20-336"><a href="#cb20-336" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb20-337"><a href="#cb20-337" aria-hidden="true" tabindex="-1"></a>        <span class="at">metric_value =</span> <span class="fu">case_when</span>(</span>
<span id="cb20-338"><a href="#cb20-338" aria-hidden="true" tabindex="-1"></a>          metric_desc <span class="sc">==</span> <span class="st">"Personal income (thousands of dollars)"</span> <span class="sc">~</span> metric_value <span class="sc">*</span> <span class="dv">1000</span>,</span>
<span id="cb20-339"><a href="#cb20-339" aria-hidden="true" tabindex="-1"></a>          <span class="cn">TRUE</span> <span class="sc">~</span> metric_value</span>
<span id="cb20-340"><a href="#cb20-340" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb20-341"><a href="#cb20-341" aria-hidden="true" tabindex="-1"></a>        <span class="at">metric_desc =</span> <span class="fu">case_when</span>(</span>
<span id="cb20-342"><a href="#cb20-342" aria-hidden="true" tabindex="-1"></a>          metric_desc <span class="sc">==</span> <span class="st">"Personal income (thousands of dollars)"</span> <span class="sc">~</span> <span class="st">"Personal income"</span>,</span>
<span id="cb20-343"><a href="#cb20-343" aria-hidden="true" tabindex="-1"></a>          metric_desc <span class="sc">==</span> <span class="st">"Population (persons) 1/"</span> <span class="sc">~</span> <span class="st">"Population"</span>,</span>
<span id="cb20-344"><a href="#cb20-344" aria-hidden="true" tabindex="-1"></a>          metric_desc <span class="sc">==</span> <span class="st">"Per capita personal income (dollars) 2/"</span> <span class="sc">~</span> <span class="st">"Per capita personal income"</span>,</span>
<span id="cb20-345"><a href="#cb20-345" aria-hidden="true" tabindex="-1"></a>          <span class="cn">TRUE</span> <span class="sc">~</span> metric_desc</span>
<span id="cb20-346"><a href="#cb20-346" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb20-347"><a href="#cb20-347" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb20-348"><a href="#cb20-348" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(year <span class="sc">&gt;=</span> <span class="dv">2001</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-349"><a href="#cb20-349" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pivot_wider</span>(</span>
<span id="cb20-350"><a href="#cb20-350" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>unit,</span>
<span id="cb20-351"><a href="#cb20-351" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_from =</span> metric_desc,</span>
<span id="cb20-352"><a href="#cb20-352" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_from =</span> metric_value</span>
<span id="cb20-353"><a href="#cb20-353" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span> </span>
<span id="cb20-354"><a href="#cb20-354" aria-hidden="true" tabindex="-1"></a>      <span class="fu">clean_names</span>() <span class="sc">|&gt;</span></span>
<span id="cb20-355"><a href="#cb20-355" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(county, year, personal_income, population, per_capita_personal_income)</span>
<span id="cb20-356"><a href="#cb20-356" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-357"><a href="#cb20-357" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(CAINC1, f_path)</span>
<span id="cb20-358"><a href="#cb20-358" aria-hidden="true" tabindex="-1"></a>    <span class="fu">file.remove</span>(<span class="fu">file.path</span>(target_dir, <span class="st">"CAINC1_CT_1969_2023.csv"</span>))</span>
<span id="cb20-359"><a href="#cb20-359" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb20-360"><a href="#cb20-360" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Reading existing data from CSV..."</span>)</span>
<span id="cb20-361"><a href="#cb20-361" aria-hidden="true" tabindex="-1"></a>    CAINC1 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(f_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb20-362"><a href="#cb20-362" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-363"><a href="#cb20-363" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-364"><a href="#cb20-364" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(CAINC1)</span>
<span id="cb20-365"><a href="#cb20-365" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-366"><a href="#cb20-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-367"><a href="#cb20-367" aria-hidden="true" tabindex="-1"></a>CAINC1 <span class="ot">&lt;-</span> <span class="fu">load_CAINC1_data</span>()</span>
<span id="cb20-368"><a href="#cb20-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-369"><a href="#cb20-369" aria-hidden="true" tabindex="-1"></a><span class="co">#' Load and process BEA County-level Detailed Income Data (CAINC4) for Connecticut (2001–2023).</span></span>
<span id="cb20-370"><a href="#cb20-370" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-371"><a href="#cb20-371" aria-hidden="true" tabindex="-1"></a><span class="co">#' Downloads and processes detailed personal income data if not already saved locally.</span></span>
<span id="cb20-372"><a href="#cb20-372" aria-hidden="true" tabindex="-1"></a><span class="co">#' Cleans, reshapes, and standardizes the dataset into a tidy format with one row per county-year.</span></span>
<span id="cb20-373"><a href="#cb20-373" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-374"><a href="#cb20-374" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A cleaned tibble with county-level income and earnings components from 2001–2023.</span></span>
<span id="cb20-375"><a href="#cb20-375" aria-hidden="true" tabindex="-1"></a>load_CAINC4_data <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb20-376"><a href="#cb20-376" aria-hidden="true" tabindex="-1"></a>  target_dir <span class="ot">&lt;-</span> <span class="st">"data/individual_report/CAINC4"</span></span>
<span id="cb20-377"><a href="#cb20-377" aria-hidden="true" tabindex="-1"></a>  f_name <span class="ot">&lt;-</span> <span class="st">"CAINC4_CT_2001_2023.csv"</span></span>
<span id="cb20-378"><a href="#cb20-378" aria-hidden="true" tabindex="-1"></a>  f_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, f_name)</span>
<span id="cb20-379"><a href="#cb20-379" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-380"><a href="#cb20-380" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(target_dir)) {</span>
<span id="cb20-381"><a href="#cb20-381" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(target_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-382"><a href="#cb20-382" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-383"><a href="#cb20-383" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-384"><a href="#cb20-384" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(f_path)) {</span>
<span id="cb20-385"><a href="#cb20-385" aria-hidden="true" tabindex="-1"></a>    zip_url <span class="ot">&lt;-</span> <span class="st">"https://apps.bea.gov/regional/zip/CAINC4.zip"</span></span>
<span id="cb20-386"><a href="#cb20-386" aria-hidden="true" tabindex="-1"></a>    zip_f_name <span class="ot">&lt;-</span> <span class="fu">basename</span>(zip_url)</span>
<span id="cb20-387"><a href="#cb20-387" aria-hidden="true" tabindex="-1"></a>    zip_f_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, zip_f_name)</span>
<span id="cb20-388"><a href="#cb20-388" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-389"><a href="#cb20-389" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(zip_f_path)) {</span>
<span id="cb20-390"><a href="#cb20-390" aria-hidden="true" tabindex="-1"></a>      <span class="fu">download.file</span>(zip_url, zip_f_path)</span>
<span id="cb20-391"><a href="#cb20-391" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-392"><a href="#cb20-392" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-393"><a href="#cb20-393" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unzip</span>(zip_f_path, <span class="at">exdir =</span> target_dir)</span>
<span id="cb20-394"><a href="#cb20-394" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-395"><a href="#cb20-395" aria-hidden="true" tabindex="-1"></a>    keep_files <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, <span class="fu">c</span>(</span>
<span id="cb20-396"><a href="#cb20-396" aria-hidden="true" tabindex="-1"></a>      <span class="st">"CAINC4_CT_1969_2023.csv"</span>,</span>
<span id="cb20-397"><a href="#cb20-397" aria-hidden="true" tabindex="-1"></a>      <span class="st">"CAINC4__Footnotes.html"</span>,</span>
<span id="cb20-398"><a href="#cb20-398" aria-hidden="true" tabindex="-1"></a>      <span class="st">"CAINC4__definition.xml"</span></span>
<span id="cb20-399"><a href="#cb20-399" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb20-400"><a href="#cb20-400" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-401"><a href="#cb20-401" aria-hidden="true" tabindex="-1"></a>    extracted_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(target_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-402"><a href="#cb20-402" aria-hidden="true" tabindex="-1"></a>    <span class="fu">file.remove</span>(<span class="fu">setdiff</span>(extracted_files, keep_files))</span>
<span id="cb20-403"><a href="#cb20-403" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-404"><a href="#cb20-404" aria-hidden="true" tabindex="-1"></a>    CAINC4 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">file.path</span>(target_dir, <span class="st">"CAINC4_CT_1969_2023.csv"</span>), <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-405"><a href="#cb20-405" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(TableName, GeoFIPS, Region, LineCode, IndustryClassification)) <span class="sc">|&gt;</span></span>
<span id="cb20-406"><a href="#cb20-406" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">unit =</span> Unit, <span class="at">amount_type =</span> Description) <span class="sc">|&gt;</span></span>
<span id="cb20-407"><a href="#cb20-407" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">county =</span> <span class="fu">str_split</span>(GeoName, <span class="st">", "</span>, <span class="at">simplify =</span> <span class="cn">TRUE</span>)[, <span class="dv">1</span>]) <span class="sc">|&gt;</span></span>
<span id="cb20-408"><a href="#cb20-408" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pivot_longer</span>(</span>
<span id="cb20-409"><a href="#cb20-409" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span><span class="fu">c</span>(GeoName, amount_type, unit, county),</span>
<span id="cb20-410"><a href="#cb20-410" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_to =</span> <span class="st">"year"</span>,</span>
<span id="cb20-411"><a href="#cb20-411" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_to =</span> <span class="st">"amount"</span></span>
<span id="cb20-412"><a href="#cb20-412" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb20-413"><a href="#cb20-413" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb20-414"><a href="#cb20-414" aria-hidden="true" tabindex="-1"></a>        <span class="at">year =</span> <span class="fu">as.numeric</span>(<span class="fu">str_remove</span>(year, <span class="st">"^X"</span>)),</span>
<span id="cb20-415"><a href="#cb20-415" aria-hidden="true" tabindex="-1"></a>        <span class="at">amount =</span> <span class="fu">as.numeric</span>(amount)</span>
<span id="cb20-416"><a href="#cb20-416" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb20-417"><a href="#cb20-417" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(amount), year <span class="sc">&gt;=</span> <span class="dv">2001</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-418"><a href="#cb20-418" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span>GeoName) <span class="sc">|&gt;</span></span>
<span id="cb20-419"><a href="#cb20-419" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">amount =</span> <span class="fu">if_else</span>(unit <span class="sc">==</span> <span class="st">"Thousands of dollars"</span>, amount <span class="sc">*</span> <span class="dv">1000</span>, amount)) <span class="sc">|&gt;</span></span>
<span id="cb20-420"><a href="#cb20-420" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pivot_wider</span>(</span>
<span id="cb20-421"><a href="#cb20-421" aria-hidden="true" tabindex="-1"></a>        <span class="at">id_cols =</span> <span class="sc">-</span>unit,</span>
<span id="cb20-422"><a href="#cb20-422" aria-hidden="true" tabindex="-1"></a>        <span class="at">names_from =</span> amount_type,</span>
<span id="cb20-423"><a href="#cb20-423" aria-hidden="true" tabindex="-1"></a>        <span class="at">values_from =</span> amount</span>
<span id="cb20-424"><a href="#cb20-424" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span> </span>
<span id="cb20-425"><a href="#cb20-425" aria-hidden="true" tabindex="-1"></a>      <span class="fu">clean_names</span>() <span class="sc">|&gt;</span></span>
<span id="cb20-426"><a href="#cb20-426" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename_with</span>(<span class="sc">~</span> . <span class="sc">|&gt;</span> </span>
<span id="cb20-427"><a href="#cb20-427" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">str_remove_all</span>(<span class="st">"_[0-9]+"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb20-428"><a href="#cb20-428" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">str_remove_all</span>(<span class="st">"_thousands_of_dollars"</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-429"><a href="#cb20-429" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">str_remove_all</span>(<span class="st">"_dollars"</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-430"><a href="#cb20-430" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">str_remove_all</span>(<span class="st">"_persons"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb20-431"><a href="#cb20-431" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.list), <span class="sc">~</span> <span class="fu">sapply</span>(., <span class="st">`</span><span class="at">[</span><span class="st">`</span>, <span class="dv">1</span>))) <span class="sc">|&gt;</span></span>
<span id="cb20-432"><a href="#cb20-432" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="sc">-</span>county, as.double))</span>
<span id="cb20-433"><a href="#cb20-433" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-434"><a href="#cb20-434" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(CAINC4, f_path)</span>
<span id="cb20-435"><a href="#cb20-435" aria-hidden="true" tabindex="-1"></a>    <span class="fu">file.remove</span>(<span class="fu">file.path</span>(target_dir, <span class="st">"CAINC4_CT_1969_2023.csv"</span>))</span>
<span id="cb20-436"><a href="#cb20-436" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb20-437"><a href="#cb20-437" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Reading existing data from CSV..."</span>)</span>
<span id="cb20-438"><a href="#cb20-438" aria-hidden="true" tabindex="-1"></a>    CAINC4 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(f_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb20-439"><a href="#cb20-439" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-440"><a href="#cb20-440" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-441"><a href="#cb20-441" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(CAINC4)</span>
<span id="cb20-442"><a href="#cb20-442" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-443"><a href="#cb20-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-444"><a href="#cb20-444" aria-hidden="true" tabindex="-1"></a>CAINC4 <span class="ot">&lt;-</span> <span class="fu">load_CAINC4_data</span>()</span>
<span id="cb20-445"><a href="#cb20-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-446"><a href="#cb20-446" aria-hidden="true" tabindex="-1"></a><span class="co">#' Load and process BEA CAINC30 data for Connecticut counties (2001–2023)</span></span>
<span id="cb20-447"><a href="#cb20-447" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-448"><a href="#cb20-448" aria-hidden="true" tabindex="-1"></a><span class="co">#' Downloads, processes, and returns the CAINC30 dataset from the U.S. Bureau of Economic Analysis.</span></span>
<span id="cb20-449"><a href="#cb20-449" aria-hidden="true" tabindex="-1"></a><span class="co">#' If the processed file is already present locally, it reads from that instead.</span></span>
<span id="cb20-450"><a href="#cb20-450" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-451"><a href="#cb20-451" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A cleaned tibble containing annual income and population data by county.</span></span>
<span id="cb20-452"><a href="#cb20-452" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb20-453"><a href="#cb20-453" aria-hidden="true" tabindex="-1"></a><span class="co">#' df &lt;- load_CAINC30_data()</span></span>
<span id="cb20-454"><a href="#cb20-454" aria-hidden="true" tabindex="-1"></a>load_CAINC30_data <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb20-455"><a href="#cb20-455" aria-hidden="true" tabindex="-1"></a>  target_dir <span class="ot">&lt;-</span> <span class="st">"data/individual_report/CAINC30"</span></span>
<span id="cb20-456"><a href="#cb20-456" aria-hidden="true" tabindex="-1"></a>  f_name <span class="ot">&lt;-</span> <span class="st">"CAINC30_CT_2001_2023.csv"</span></span>
<span id="cb20-457"><a href="#cb20-457" aria-hidden="true" tabindex="-1"></a>  f_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, f_name)</span>
<span id="cb20-458"><a href="#cb20-458" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-459"><a href="#cb20-459" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(target_dir)) <span class="fu">dir.create</span>(target_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-460"><a href="#cb20-460" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-461"><a href="#cb20-461" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(f_path)) {</span>
<span id="cb20-462"><a href="#cb20-462" aria-hidden="true" tabindex="-1"></a>    zip_url <span class="ot">&lt;-</span> <span class="st">"https://apps.bea.gov/regional/zip/CAINC30.zip"</span></span>
<span id="cb20-463"><a href="#cb20-463" aria-hidden="true" tabindex="-1"></a>    zip_f_name <span class="ot">&lt;-</span> <span class="fu">basename</span>(zip_url)</span>
<span id="cb20-464"><a href="#cb20-464" aria-hidden="true" tabindex="-1"></a>    zip_f_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, zip_f_name)</span>
<span id="cb20-465"><a href="#cb20-465" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-466"><a href="#cb20-466" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(zip_f_path)) {</span>
<span id="cb20-467"><a href="#cb20-467" aria-hidden="true" tabindex="-1"></a>      <span class="fu">download.file</span>(zip_url, zip_f_path)</span>
<span id="cb20-468"><a href="#cb20-468" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-469"><a href="#cb20-469" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-470"><a href="#cb20-470" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unzip</span>(zip_f_path, <span class="at">exdir =</span> target_dir)</span>
<span id="cb20-471"><a href="#cb20-471" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-472"><a href="#cb20-472" aria-hidden="true" tabindex="-1"></a>    keep_files <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, <span class="fu">c</span>(</span>
<span id="cb20-473"><a href="#cb20-473" aria-hidden="true" tabindex="-1"></a>      <span class="st">"CAINC30_CT_1969_2023.csv"</span>,</span>
<span id="cb20-474"><a href="#cb20-474" aria-hidden="true" tabindex="-1"></a>      <span class="st">"CAINC30__Footnotes.html"</span>,</span>
<span id="cb20-475"><a href="#cb20-475" aria-hidden="true" tabindex="-1"></a>      <span class="st">"CAINC30__definition.xml"</span></span>
<span id="cb20-476"><a href="#cb20-476" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb20-477"><a href="#cb20-477" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-478"><a href="#cb20-478" aria-hidden="true" tabindex="-1"></a>    extracted_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(target_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-479"><a href="#cb20-479" aria-hidden="true" tabindex="-1"></a>    <span class="fu">file.remove</span>(<span class="fu">setdiff</span>(extracted_files, keep_files))</span>
<span id="cb20-480"><a href="#cb20-480" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-481"><a href="#cb20-481" aria-hidden="true" tabindex="-1"></a>    CAINC30 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">file.path</span>(target_dir, <span class="st">"CAINC30_CT_1969_2023.csv"</span>), <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-482"><a href="#cb20-482" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span>TableName, <span class="sc">-</span>GeoFIPS, <span class="sc">-</span>Region, <span class="sc">-</span>LineCode, <span class="sc">-</span>IndustryClassification) <span class="sc">|&gt;</span></span>
<span id="cb20-483"><a href="#cb20-483" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">unit =</span> Unit, <span class="at">amount_type =</span> Description) <span class="sc">|&gt;</span></span>
<span id="cb20-484"><a href="#cb20-484" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">county =</span> <span class="fu">str_split</span>(GeoName, <span class="st">", "</span>, <span class="at">simplify =</span> <span class="cn">TRUE</span>)[, <span class="dv">1</span>]) <span class="sc">|&gt;</span></span>
<span id="cb20-485"><a href="#cb20-485" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pivot_longer</span>(<span class="sc">-</span><span class="fu">c</span>(GeoName, amount_type, unit, county), <span class="at">names_to =</span> <span class="st">"year"</span>, <span class="at">values_to =</span> <span class="st">"amount"</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-486"><a href="#cb20-486" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb20-487"><a href="#cb20-487" aria-hidden="true" tabindex="-1"></a>        <span class="at">year =</span> <span class="fu">as.numeric</span>(<span class="fu">str_remove</span>(year, <span class="st">"^X"</span>)),</span>
<span id="cb20-488"><a href="#cb20-488" aria-hidden="true" tabindex="-1"></a>        <span class="at">amount =</span> <span class="fu">as.numeric</span>(amount)</span>
<span id="cb20-489"><a href="#cb20-489" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb20-490"><a href="#cb20-490" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(amount), year <span class="sc">&gt;=</span> <span class="dv">2001</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-491"><a href="#cb20-491" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span>GeoName) <span class="sc">|&gt;</span></span>
<span id="cb20-492"><a href="#cb20-492" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">amount =</span> <span class="fu">if_else</span>(unit <span class="sc">==</span> <span class="st">"Thousands of dollars"</span>, amount <span class="sc">*</span> <span class="dv">1000</span>, amount)) <span class="sc">|&gt;</span></span>
<span id="cb20-493"><a href="#cb20-493" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pivot_wider</span>(<span class="at">id_cols =</span> <span class="sc">-</span>unit, <span class="at">names_from =</span> amount_type, <span class="at">values_from =</span> amount) <span class="sc">|&gt;</span></span>
<span id="cb20-494"><a href="#cb20-494" aria-hidden="true" tabindex="-1"></a>      <span class="fu">clean_names</span>() <span class="sc">|&gt;</span></span>
<span id="cb20-495"><a href="#cb20-495" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename_with</span>(<span class="sc">~</span> . <span class="sc">|&gt;</span></span>
<span id="cb20-496"><a href="#cb20-496" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">str_remove_all</span>(<span class="st">"_[0-9]+"</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-497"><a href="#cb20-497" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">str_remove_all</span>(<span class="st">"_thousands_of_dollars"</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-498"><a href="#cb20-498" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">str_remove_all</span>(<span class="st">"_dollars"</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-499"><a href="#cb20-499" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">str_remove_all</span>(<span class="st">"_persons"</span>))</span>
<span id="cb20-500"><a href="#cb20-500" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-501"><a href="#cb20-501" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(CAINC30, f_path)</span>
<span id="cb20-502"><a href="#cb20-502" aria-hidden="true" tabindex="-1"></a>    <span class="fu">file.remove</span>(<span class="fu">file.path</span>(target_dir, <span class="st">"CAINC30_CT_1969_2023.csv"</span>))</span>
<span id="cb20-503"><a href="#cb20-503" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb20-504"><a href="#cb20-504" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Reading existing data from CSV..."</span>)</span>
<span id="cb20-505"><a href="#cb20-505" aria-hidden="true" tabindex="-1"></a>    CAINC30 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(f_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb20-506"><a href="#cb20-506" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-507"><a href="#cb20-507" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(CAINC30)</span>
<span id="cb20-508"><a href="#cb20-508" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-509"><a href="#cb20-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-510"><a href="#cb20-510" aria-hidden="true" tabindex="-1"></a>CAINC30 <span class="ot">&lt;-</span> <span class="fu">load_CAINC30_data</span>()</span>
<span id="cb20-511"><a href="#cb20-511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-512"><a href="#cb20-512" aria-hidden="true" tabindex="-1"></a><span class="co">#' Load and process BEA CAINC91 data for Connecticut counties (2001–2023)</span></span>
<span id="cb20-513"><a href="#cb20-513" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-514"><a href="#cb20-514" aria-hidden="true" tabindex="-1"></a><span class="co">#' Downloads, processes, and returns the CAINC91 dataset from the U.S. Bureau of Economic Analysis.</span></span>
<span id="cb20-515"><a href="#cb20-515" aria-hidden="true" tabindex="-1"></a><span class="co">#' If the processed file is already saved locally, it loads it directly from disk.</span></span>
<span id="cb20-516"><a href="#cb20-516" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-517"><a href="#cb20-517" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A cleaned tibble with income flow adjustments by county and year.</span></span>
<span id="cb20-518"><a href="#cb20-518" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb20-519"><a href="#cb20-519" aria-hidden="true" tabindex="-1"></a><span class="co">#' df &lt;- load_CAINC91_data()</span></span>
<span id="cb20-520"><a href="#cb20-520" aria-hidden="true" tabindex="-1"></a>load_CAINC91_data <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb20-521"><a href="#cb20-521" aria-hidden="true" tabindex="-1"></a>  target_dir <span class="ot">&lt;-</span> <span class="st">"data/individual_report/CAINC91"</span></span>
<span id="cb20-522"><a href="#cb20-522" aria-hidden="true" tabindex="-1"></a>  f_name <span class="ot">&lt;-</span> <span class="st">"CAINC91_CT_2001_2023.csv"</span></span>
<span id="cb20-523"><a href="#cb20-523" aria-hidden="true" tabindex="-1"></a>  f_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, f_name)</span>
<span id="cb20-524"><a href="#cb20-524" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-525"><a href="#cb20-525" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(target_dir)) <span class="fu">dir.create</span>(target_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-526"><a href="#cb20-526" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-527"><a href="#cb20-527" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(f_path)) {</span>
<span id="cb20-528"><a href="#cb20-528" aria-hidden="true" tabindex="-1"></a>    zip_url <span class="ot">&lt;-</span> <span class="st">"https://apps.bea.gov/regional/zip/CAINC91.zip"</span></span>
<span id="cb20-529"><a href="#cb20-529" aria-hidden="true" tabindex="-1"></a>    zip_f_name <span class="ot">&lt;-</span> <span class="fu">basename</span>(zip_url)</span>
<span id="cb20-530"><a href="#cb20-530" aria-hidden="true" tabindex="-1"></a>    zip_f_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, zip_f_name)</span>
<span id="cb20-531"><a href="#cb20-531" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-532"><a href="#cb20-532" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(zip_f_path)) {</span>
<span id="cb20-533"><a href="#cb20-533" aria-hidden="true" tabindex="-1"></a>      <span class="fu">download.file</span>(zip_url, zip_f_path)</span>
<span id="cb20-534"><a href="#cb20-534" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-535"><a href="#cb20-535" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-536"><a href="#cb20-536" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unzip</span>(zip_f_path, <span class="at">exdir =</span> target_dir)</span>
<span id="cb20-537"><a href="#cb20-537" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-538"><a href="#cb20-538" aria-hidden="true" tabindex="-1"></a>    keep_files <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, <span class="fu">c</span>(</span>
<span id="cb20-539"><a href="#cb20-539" aria-hidden="true" tabindex="-1"></a>      <span class="st">"CAINC91_CT_1990_2023.csv"</span>,</span>
<span id="cb20-540"><a href="#cb20-540" aria-hidden="true" tabindex="-1"></a>      <span class="st">"CAINC91__Footnotes.html"</span>,</span>
<span id="cb20-541"><a href="#cb20-541" aria-hidden="true" tabindex="-1"></a>      <span class="st">"CAINC91__definition.xml"</span></span>
<span id="cb20-542"><a href="#cb20-542" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb20-543"><a href="#cb20-543" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-544"><a href="#cb20-544" aria-hidden="true" tabindex="-1"></a>    extracted_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(target_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-545"><a href="#cb20-545" aria-hidden="true" tabindex="-1"></a>    <span class="fu">file.remove</span>(<span class="fu">setdiff</span>(extracted_files, keep_files))</span>
<span id="cb20-546"><a href="#cb20-546" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-547"><a href="#cb20-547" aria-hidden="true" tabindex="-1"></a>    CAINC91 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">file.path</span>(target_dir, <span class="st">"CAINC91_CT_1990_2023.csv"</span>), <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-548"><a href="#cb20-548" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span>TableName, <span class="sc">-</span>GeoFIPS, <span class="sc">-</span>Region, <span class="sc">-</span>LineCode, <span class="sc">-</span>IndustryClassification) <span class="sc">|&gt;</span></span>
<span id="cb20-549"><a href="#cb20-549" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">unit =</span> Unit, <span class="at">amount_type =</span> Description) <span class="sc">|&gt;</span></span>
<span id="cb20-550"><a href="#cb20-550" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">county =</span> <span class="fu">str_split</span>(GeoName, <span class="st">", "</span>, <span class="at">simplify =</span> <span class="cn">TRUE</span>)[, <span class="dv">1</span>]) <span class="sc">|&gt;</span></span>
<span id="cb20-551"><a href="#cb20-551" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pivot_longer</span>(<span class="sc">-</span><span class="fu">c</span>(GeoName, amount_type, unit, county), <span class="at">names_to =</span> <span class="st">"year"</span>, <span class="at">values_to =</span> <span class="st">"amount"</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-552"><a href="#cb20-552" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb20-553"><a href="#cb20-553" aria-hidden="true" tabindex="-1"></a>        <span class="at">year =</span> <span class="fu">as.numeric</span>(<span class="fu">str_remove</span>(year, <span class="st">"^X"</span>)),</span>
<span id="cb20-554"><a href="#cb20-554" aria-hidden="true" tabindex="-1"></a>        <span class="at">amount =</span> <span class="fu">as.numeric</span>(amount)</span>
<span id="cb20-555"><a href="#cb20-555" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb20-556"><a href="#cb20-556" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(amount), year <span class="sc">&gt;=</span> <span class="dv">2001</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-557"><a href="#cb20-557" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span>GeoName) <span class="sc">|&gt;</span></span>
<span id="cb20-558"><a href="#cb20-558" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">amount =</span> <span class="fu">if_else</span>(unit <span class="sc">==</span> <span class="st">"Thousands of dollars"</span>, amount <span class="sc">*</span> <span class="dv">1000</span>, amount)) <span class="sc">|&gt;</span></span>
<span id="cb20-559"><a href="#cb20-559" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pivot_wider</span>(<span class="at">id_cols =</span> <span class="sc">-</span>unit, <span class="at">names_from =</span> amount_type, <span class="at">values_from =</span> amount) <span class="sc">|&gt;</span></span>
<span id="cb20-560"><a href="#cb20-560" aria-hidden="true" tabindex="-1"></a>      <span class="fu">clean_names</span>()</span>
<span id="cb20-561"><a href="#cb20-561" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-562"><a href="#cb20-562" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(CAINC91, f_path)</span>
<span id="cb20-563"><a href="#cb20-563" aria-hidden="true" tabindex="-1"></a>    <span class="fu">file.remove</span>(<span class="fu">file.path</span>(target_dir, <span class="st">"CAINC91_CT_1990_2023.csv"</span>))</span>
<span id="cb20-564"><a href="#cb20-564" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb20-565"><a href="#cb20-565" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Reading existing data from CSV..."</span>)</span>
<span id="cb20-566"><a href="#cb20-566" aria-hidden="true" tabindex="-1"></a>    CAINC91 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(f_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb20-567"><a href="#cb20-567" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-568"><a href="#cb20-568" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-569"><a href="#cb20-569" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(CAINC91)</span>
<span id="cb20-570"><a href="#cb20-570" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-571"><a href="#cb20-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-572"><a href="#cb20-572" aria-hidden="true" tabindex="-1"></a>CAINC91 <span class="ot">&lt;-</span> <span class="fu">load_CAINC91_data</span>()</span>
<span id="cb20-573"><a href="#cb20-573" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-574"><a href="#cb20-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-575"><a href="#cb20-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-576"><a href="#cb20-576" aria-hidden="true" tabindex="-1"></a><span class="fu">## Unemployment</span></span>
<span id="cb20-577"><a href="#cb20-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-578"><a href="#cb20-578" aria-hidden="true" tabindex="-1"></a>Monthly local area (LA) unemployment data is reported to the <span class="co">[</span><span class="ot">U.S. Bureau of Labor Statistics (BLS)</span><span class="co">](https://www.bls.gov/)</span> and published on their website^<span class="co">[</span><span class="ot">@bls_local_area_unemployment</span><span class="co">]</span>. I used this dataset to help answer my subquestion, since unemployment rates are a core indicator of economic health. I initially attempted to access this data using R, but several limitations with R’s API tools, particularly unhelpful error messages, made it impractical for this task. In contrast, Python offered tools that allowed me to efficiently query and process a high number of series with clearer error diagnostics. For these reasons, I chose to use Python for downloading and managing the BLS unemployment data.</span>
<span id="cb20-579"><a href="#cb20-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-580"><a href="#cb20-580" aria-hidden="true" tabindex="-1"></a>To ensure that an appropriate Python environment is set up for for the task of downloading the files using the BLS API, I defined the function <span class="in">`ensure_python_ready()`</span> which creates and activates a suitable virtual environment.</span>
<span id="cb20-583"><a href="#cb20-583" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb20-584"><a href="#cb20-584" aria-hidden="true" tabindex="-1"></a><span class="co">#' Ensure Python Environment and Required Packages are Available</span></span>
<span id="cb20-585"><a href="#cb20-585" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-586"><a href="#cb20-586" aria-hidden="true" tabindex="-1"></a><span class="co">#' Checks if Python is installed on the system. If not found, it stops execution.</span></span>
<span id="cb20-587"><a href="#cb20-587" aria-hidden="true" tabindex="-1"></a><span class="co">#' Creates a virtual environment named 'bls_py_env' if it doesn't already exist.</span></span>
<span id="cb20-588"><a href="#cb20-588" aria-hidden="true" tabindex="-1"></a><span class="co">#' Checks for specified Python packages within the environment and installs any missing ones.</span></span>
<span id="cb20-589"><a href="#cb20-589" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-590"><a href="#cb20-590" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param packages A character vector of Python package names to check and install. Defaults to c("pandas", "requests").</span></span>
<span id="cb20-591"><a href="#cb20-591" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-592"><a href="#cb20-592" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return NULL. Throws an error if Python is not found.</span></span>
<span id="cb20-593"><a href="#cb20-593" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb20-594"><a href="#cb20-594" aria-hidden="true" tabindex="-1"></a><span class="co">#' ensure_python_ready()</span></span>
<span id="cb20-595"><a href="#cb20-595" aria-hidden="true" tabindex="-1"></a><span class="co">#' ensure_python_ready(packages = c("pandas", "requests", "beautifulsoup4"))</span></span>
<span id="cb20-596"><a href="#cb20-596" aria-hidden="true" tabindex="-1"></a>ensure_python_ready <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">packages =</span> <span class="fu">c</span>(<span class="st">"pandas"</span>, <span class="st">"requests"</span>)) {</span>
<span id="cb20-597"><a href="#cb20-597" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">Sys.which</span>(<span class="st">"python"</span>) <span class="sc">==</span> <span class="st">""</span>) {</span>
<span id="cb20-598"><a href="#cb20-598" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Python is not available on this system."</span>)</span>
<span id="cb20-599"><a href="#cb20-599" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-600"><a href="#cb20-600" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-601"><a href="#cb20-601" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Creating and activating virtual environment</span></span>
<span id="cb20-602"><a href="#cb20-602" aria-hidden="true" tabindex="-1"></a>  venv_dir <span class="ot">&lt;-</span> <span class="st">"bls_py_env"</span></span>
<span id="cb20-603"><a href="#cb20-603" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(venv_dir)) {</span>
<span id="cb20-604"><a href="#cb20-604" aria-hidden="true" tabindex="-1"></a>    <span class="fu">system</span>(<span class="fu">sprintf</span>(<span class="st">"python -m venv %s"</span>, venv_dir))</span>
<span id="cb20-605"><a href="#cb20-605" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-606"><a href="#cb20-606" aria-hidden="true" tabindex="-1"></a>  py_exec <span class="ot">&lt;-</span> <span class="fu">file.path</span>(venv_dir, <span class="st">"bin"</span>, <span class="st">"python"</span>)</span>
<span id="cb20-607"><a href="#cb20-607" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-608"><a href="#cb20-608" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Checking for packages, and installing them if not available.</span></span>
<span id="cb20-609"><a href="#cb20-609" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (pkg <span class="cf">in</span> packages) {</span>
<span id="cb20-610"><a href="#cb20-610" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">system</span>(<span class="fu">sprintf</span>(<span class="st">"python -c </span><span class="sc">\"</span><span class="st">import %s</span><span class="sc">\"</span><span class="st">"</span>, pkg),</span>
<span id="cb20-611"><a href="#cb20-611" aria-hidden="true" tabindex="-1"></a>               <span class="at">ignore.stdout =</span> <span class="cn">TRUE</span>, <span class="at">ignore.stderr =</span> <span class="cn">TRUE</span>) <span class="sc">!=</span> <span class="dv">0</span>) {</span>
<span id="cb20-612"><a href="#cb20-612" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Installing missing Python package: %s</span><span class="sc">\n</span><span class="st">"</span>, pkg))</span>
<span id="cb20-613"><a href="#cb20-613" aria-hidden="true" tabindex="-1"></a>      <span class="fu">system</span>(<span class="fu">sprintf</span>(<span class="st">"python -m pip install %s"</span>, pkg))</span>
<span id="cb20-614"><a href="#cb20-614" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-615"><a href="#cb20-615" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-616"><a href="#cb20-616" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-617"><a href="#cb20-617" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-618"><a href="#cb20-618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-619"><a href="#cb20-619" aria-hidden="true" tabindex="-1"></a>In order for the following Python script to work, <span class="co">[</span><span class="ot">this file</span><span class="co">](https://download.bls.gov/pub/time.series/la/la.series)</span> containing LA series titles and descriptions must be manually saved to the <span class="in">`data/`</span> directory^<span class="co">[</span><span class="ot">@bls_laus_series</span><span class="co">]</span>. This is because the BLS server blocks automated requests to this file. Therefore, I create an R function that places a system call to the Python script if a local copy of the data set is not available.</span>
<span id="cb20-622"><a href="#cb20-622" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb20-623"><a href="#cb20-623" aria-hidden="true" tabindex="-1"></a><span class="co">#' Load BLS Data, Downloading with Python Script if Needed</span></span>
<span id="cb20-624"><a href="#cb20-624" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-625"><a href="#cb20-625" aria-hidden="true" tabindex="-1"></a><span class="co">#' Checks if the BLS data CSV file exists locally. If not, it:</span></span>
<span id="cb20-626"><a href="#cb20-626" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Ensures the required Python environment and packages are available,</span></span>
<span id="cb20-627"><a href="#cb20-627" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Downloads the series list file if missing,</span></span>
<span id="cb20-628"><a href="#cb20-628" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Runs a Python script (`bls_api.py`) to download and generate the BLS data CSV,</span></span>
<span id="cb20-629"><a href="#cb20-629" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Validates the output file creation.</span></span>
<span id="cb20-630"><a href="#cb20-630" aria-hidden="true" tabindex="-1"></a><span class="co">#' Finally, reads the CSV into an R tibble and returns it.</span></span>
<span id="cb20-631"><a href="#cb20-631" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-632"><a href="#cb20-632" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A tibble containing BLS data.</span></span>
<span id="cb20-633"><a href="#cb20-633" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb20-634"><a href="#cb20-634" aria-hidden="true" tabindex="-1"></a><span class="co">#' bls_data &lt;- load_bls_data()</span></span>
<span id="cb20-635"><a href="#cb20-635" aria-hidden="true" tabindex="-1"></a><span class="co">#' head(bls_data)</span></span>
<span id="cb20-636"><a href="#cb20-636" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb20-637"><a href="#cb20-637" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb20-638"><a href="#cb20-638" aria-hidden="true" tabindex="-1"></a>load_bls_data <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb20-639"><a href="#cb20-639" aria-hidden="true" tabindex="-1"></a>  f_path <span class="ot">&lt;-</span> <span class="st">"data/individual_report/bls_data.csv"</span></span>
<span id="cb20-640"><a href="#cb20-640" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-641"><a href="#cb20-641" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if file exists</span></span>
<span id="cb20-642"><a href="#cb20-642" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(f_path)) {</span>
<span id="cb20-643"><a href="#cb20-643" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"File not found. Running Python script to download BLS data..."</span>)</span>
<span id="cb20-644"><a href="#cb20-644" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-645"><a href="#cb20-645" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure file containing series names exists</span></span>
<span id="cb20-646"><a href="#cb20-646" aria-hidden="true" tabindex="-1"></a>    la_series_file <span class="ot">&lt;-</span> <span class="st">"data/individual_report/la.series.txt"</span></span>
<span id="cb20-647"><a href="#cb20-647" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-648"><a href="#cb20-648" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(la_series_file)) {</span>
<span id="cb20-649"><a href="#cb20-649" aria-hidden="true" tabindex="-1"></a>      url <span class="ot">&lt;-</span> <span class="st">"https://download.bls.gov/pub/time.series/la/la.series"</span></span>
<span id="cb20-650"><a href="#cb20-650" aria-hidden="true" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="fu">paste</span>(<span class="st">"LA series list file not found. Go to"</span>,url,<span class="st">"and save the file as la.series.txt to data/"</span>))</span>
<span id="cb20-651"><a href="#cb20-651" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-652"><a href="#cb20-652" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-653"><a href="#cb20-653" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ensure_python_ready</span>(<span class="at">packages =</span> <span class="fu">c</span>(<span class="st">"pandas"</span>,<span class="st">"requests"</span>,<span class="st">"bs4"</span>, <span class="st">"lxml"</span>))</span>
<span id="cb20-654"><a href="#cb20-654" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-655"><a href="#cb20-655" aria-hidden="true" tabindex="-1"></a>    <span class="co"># System call to run Python script</span></span>
<span id="cb20-656"><a href="#cb20-656" aria-hidden="true" tabindex="-1"></a>    <span class="fu">system</span>(<span class="st">"python bls_api.py"</span>, <span class="at">intern =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-657"><a href="#cb20-657" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-658"><a href="#cb20-658" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Optionally re-check file</span></span>
<span id="cb20-659"><a href="#cb20-659" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(f_path)) {</span>
<span id="cb20-660"><a href="#cb20-660" aria-hidden="true" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">"Python script failed to produce the expected file."</span>)</span>
<span id="cb20-661"><a href="#cb20-661" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-662"><a href="#cb20-662" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-663"><a href="#cb20-663" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-664"><a href="#cb20-664" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Load the CSV</span></span>
<span id="cb20-665"><a href="#cb20-665" aria-hidden="true" tabindex="-1"></a>  bls_data <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(f_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb20-666"><a href="#cb20-666" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(bls_data)</span>
<span id="cb20-667"><a href="#cb20-667" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-668"><a href="#cb20-668" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-669"><a href="#cb20-669" aria-hidden="true" tabindex="-1"></a>BLS_LABOR <span class="ot">&lt;-</span> <span class="fu">load_bls_data</span>()</span>
<span id="cb20-670"><a href="#cb20-670" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-671"><a href="#cb20-671" aria-hidden="true" tabindex="-1"></a>The Python script used to download the data is shown below.</span>
<span id="cb20-674"><a href="#cb20-674" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb20-675"><a href="#cb20-675" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb20-676"><a href="#cb20-676" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb20-677"><a href="#cb20-677" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb20-678"><a href="#cb20-678" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb20-679"><a href="#cb20-679" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb20-680"><a href="#cb20-680" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> bs4 <span class="im">import</span> BeautifulSoup</span>
<span id="cb20-681"><a href="#cb20-681" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb20-682"><a href="#cb20-682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-683"><a href="#cb20-683" aria-hidden="true" tabindex="-1"></a>api_key <span class="op">=</span> <span class="st">"27f5cf21548149728333c3831176e3e6"</span></span>
<span id="cb20-684"><a href="#cb20-684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-685"><a href="#cb20-685" aria-hidden="true" tabindex="-1"></a><span class="co"># Define file paths</span></span>
<span id="cb20-686"><a href="#cb20-686" aria-hidden="true" tabindex="-1"></a>csv_file <span class="op">=</span> Path(<span class="st">"data/individual_report/bls_data.csv"</span>)</span>
<span id="cb20-687"><a href="#cb20-687" aria-hidden="true" tabindex="-1"></a>la_series_file <span class="op">=</span> Path(<span class="st">"data/individual_report/la.series.txt"</span>)</span>
<span id="cb20-688"><a href="#cb20-688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-689"><a href="#cb20-689" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(<span class="st">'data'</span>):</span>
<span id="cb20-690"><a href="#cb20-690" aria-hidden="true" tabindex="-1"></a>    os.makedirs(os.path.dirname(local_path), exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb20-691"><a href="#cb20-691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-692"><a href="#cb20-692" aria-hidden="true" tabindex="-1"></a>la_series <span class="op">=</span> pd.read_csv(la_series_file, sep<span class="op">=</span><span class="st">"</span><span class="ch">\t</span><span class="st">"</span>)</span>
<span id="cb20-693"><a href="#cb20-693" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i,column <span class="kw">in</span> <span class="bu">enumerate</span>(la_series.columns.tolist()):</span>
<span id="cb20-694"><a href="#cb20-694" aria-hidden="true" tabindex="-1"></a>    la_series.rename(columns<span class="op">=</span>{column: column.strip()}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb20-695"><a href="#cb20-695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-696"><a href="#cb20-696" aria-hidden="true" tabindex="-1"></a>la_series <span class="op">=</span> la_series.assign(series_id<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"series_id"</span>].<span class="bu">str</span>.strip())</span>
<span id="cb20-697"><a href="#cb20-697" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-698"><a href="#cb20-698" aria-hidden="true" tabindex="-1"></a>ct_towns <span class="op">=</span> la_series[la_series[<span class="st">'series_title'</span>].<span class="bu">str</span>.contains(<span class="st">"town, CT"</span>, case<span class="op">=</span><span class="va">False</span>, na<span class="op">=</span><span class="va">False</span>)][</span>
<span id="cb20-699"><a href="#cb20-699" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"series_id"</span>, <span class="st">"series_title"</span>]</span>
<span id="cb20-700"><a href="#cb20-700" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb20-701"><a href="#cb20-701" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-702"><a href="#cb20-702" aria-hidden="true" tabindex="-1"></a><span class="co"># Select series IDs to pull</span></span>
<span id="cb20-703"><a href="#cb20-703" aria-hidden="true" tabindex="-1"></a>series_ids <span class="op">=</span> ct_towns[<span class="st">"series_id"</span>].tolist()</span>
<span id="cb20-704"><a href="#cb20-704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-705"><a href="#cb20-705" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_bls_data_chunk(series_chunk, startyear, endyear, api_key):</span>
<span id="cb20-706"><a href="#cb20-706" aria-hidden="true" tabindex="-1"></a>    url <span class="op">=</span> <span class="st">"https://api.bls.gov/publicAPI/v2/timeseries/data/"</span></span>
<span id="cb20-707"><a href="#cb20-707" aria-hidden="true" tabindex="-1"></a>    payload <span class="op">=</span> {</span>
<span id="cb20-708"><a href="#cb20-708" aria-hidden="true" tabindex="-1"></a>        <span class="st">"seriesid"</span>: series_chunk,</span>
<span id="cb20-709"><a href="#cb20-709" aria-hidden="true" tabindex="-1"></a>        <span class="st">"startyear"</span>: <span class="bu">str</span>(startyear),</span>
<span id="cb20-710"><a href="#cb20-710" aria-hidden="true" tabindex="-1"></a>        <span class="st">"endyear"</span>: <span class="bu">str</span>(endyear),</span>
<span id="cb20-711"><a href="#cb20-711" aria-hidden="true" tabindex="-1"></a>        <span class="st">"registrationKey"</span>: api_key</span>
<span id="cb20-712"><a href="#cb20-712" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-713"><a href="#cb20-713" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-714"><a href="#cb20-714" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> requests.post(url, headers<span class="op">=</span>{<span class="st">"Content-Type"</span>: <span class="st">"application/json"</span>}, data<span class="op">=</span>json.dumps(payload))</span>
<span id="cb20-715"><a href="#cb20-715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-716"><a href="#cb20-716" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> response.status_code <span class="op">!=</span> <span class="dv">200</span>:</span>
<span id="cb20-717"><a href="#cb20-717" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"API request failed:"</span>, response.text)</span>
<span id="cb20-718"><a href="#cb20-718" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb20-719"><a href="#cb20-719" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-720"><a href="#cb20-720" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb20-721"><a href="#cb20-721" aria-hidden="true" tabindex="-1"></a>        json_data <span class="op">=</span> response.json()</span>
<span id="cb20-722"><a href="#cb20-722" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> json.JSONDecodeError:</span>
<span id="cb20-723"><a href="#cb20-723" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Invalid JSON response."</span>)</span>
<span id="cb20-724"><a href="#cb20-724" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb20-725"><a href="#cb20-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-726"><a href="#cb20-726" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">"message"</span> <span class="kw">in</span> json_data:</span>
<span id="cb20-727"><a href="#cb20-727" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"BLS API message:"</span>, <span class="st">"; "</span>.join(json_data[<span class="st">"message"</span>]))</span>
<span id="cb20-728"><a href="#cb20-728" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-729"><a href="#cb20-729" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">"Results"</span> <span class="kw">not</span> <span class="kw">in</span> json_data <span class="kw">or</span> <span class="st">"series"</span> <span class="kw">not</span> <span class="kw">in</span> json_data[<span class="st">"Results"</span>]:</span>
<span id="cb20-730"><a href="#cb20-730" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"'series' not found in API response."</span>)</span>
<span id="cb20-731"><a href="#cb20-731" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb20-732"><a href="#cb20-732" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-733"><a href="#cb20-733" aria-hidden="true" tabindex="-1"></a>    series_data <span class="op">=</span> []</span>
<span id="cb20-734"><a href="#cb20-734" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> series <span class="kw">in</span> json_data[<span class="st">"Results"</span>][<span class="st">"series"</span>]:</span>
<span id="cb20-735"><a href="#cb20-735" aria-hidden="true" tabindex="-1"></a>        data_rows <span class="op">=</span> series.get(<span class="st">"data"</span>, [])</span>
<span id="cb20-736"><a href="#cb20-736" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> data_rows:</span>
<span id="cb20-737"><a href="#cb20-737" aria-hidden="true" tabindex="-1"></a>            df <span class="op">=</span> pd.DataFrame([</span>
<span id="cb20-738"><a href="#cb20-738" aria-hidden="true" tabindex="-1"></a>                {k: v <span class="cf">for</span> k, v <span class="kw">in</span> row.items() <span class="cf">if</span> k <span class="op">!=</span> <span class="st">"footnotes"</span>}</span>
<span id="cb20-739"><a href="#cb20-739" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> row <span class="kw">in</span> data_rows</span>
<span id="cb20-740"><a href="#cb20-740" aria-hidden="true" tabindex="-1"></a>            ])</span>
<span id="cb20-741"><a href="#cb20-741" aria-hidden="true" tabindex="-1"></a>            df[<span class="st">"series_id"</span>] <span class="op">=</span> series[<span class="st">"seriesID"</span>]</span>
<span id="cb20-742"><a href="#cb20-742" aria-hidden="true" tabindex="-1"></a>            series_data.append(df)</span>
<span id="cb20-743"><a href="#cb20-743" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-744"><a href="#cb20-744" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> series_data:</span>
<span id="cb20-745"><a href="#cb20-745" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.concat(series_data, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb20-746"><a href="#cb20-746" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb20-747"><a href="#cb20-747" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-748"><a href="#cb20-748" aria-hidden="true" tabindex="-1"></a><span class="co"># Request data in chunks and year ranges</span></span>
<span id="cb20-749"><a href="#cb20-749" aria-hidden="true" tabindex="-1"></a>all_data <span class="op">=</span> []</span>
<span id="cb20-750"><a href="#cb20-750" aria-hidden="true" tabindex="-1"></a>intervals <span class="op">=</span> [(<span class="dv">2001</span>, <span class="dv">2020</span>), (<span class="dv">2021</span>, <span class="dv">2023</span>)]</span>
<span id="cb20-751"><a href="#cb20-751" aria-hidden="true" tabindex="-1"></a>chunk_size <span class="op">=</span> <span class="dv">50</span></span>
<span id="cb20-752"><a href="#cb20-752" aria-hidden="true" tabindex="-1"></a>series_chunks <span class="op">=</span> [series_ids[i:i <span class="op">+</span> chunk_size] <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(series_ids), chunk_size)]</span>
<span id="cb20-753"><a href="#cb20-753" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-754"><a href="#cb20-754" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> startyear, endyear <span class="kw">in</span> intervals:</span>
<span id="cb20-755"><a href="#cb20-755" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> chunk <span class="kw">in</span> series_chunks:</span>
<span id="cb20-756"><a href="#cb20-756" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Requesting </span><span class="sc">{</span><span class="bu">len</span>(chunk)<span class="sc">}</span><span class="ss"> series from </span><span class="sc">{</span>startyear<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>endyear<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb20-757"><a href="#cb20-757" aria-hidden="true" tabindex="-1"></a>        time.sleep(<span class="dv">1</span>)</span>
<span id="cb20-758"><a href="#cb20-758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-759"><a href="#cb20-759" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb20-760"><a href="#cb20-760" aria-hidden="true" tabindex="-1"></a>            chunk_data <span class="op">=</span> get_bls_data_chunk(chunk, startyear, endyear, api_key)</span>
<span id="cb20-761"><a href="#cb20-761" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> chunk_data <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb20-762"><a href="#cb20-762" aria-hidden="true" tabindex="-1"></a>                all_data.append(chunk_data)</span>
<span id="cb20-763"><a href="#cb20-763" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb20-764"><a href="#cb20-764" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"Error retrieving data:"</span>, e)</span>
<span id="cb20-765"><a href="#cb20-765" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-766"><a href="#cb20-766" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine and clean all data</span></span>
<span id="cb20-767"><a href="#cb20-767" aria-hidden="true" tabindex="-1"></a>BLS_LABOR <span class="op">=</span> pd.concat(all_data, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb20-768"><a href="#cb20-768" aria-hidden="true" tabindex="-1"></a>BLS_LABOR <span class="op">=</span> BLS_LABOR.merge(ct_towns, on<span class="op">=</span><span class="st">"series_id"</span>, how<span class="op">=</span><span class="st">"inner"</span>)</span>
<span id="cb20-769"><a href="#cb20-769" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-770"><a href="#cb20-770" aria-hidden="true" tabindex="-1"></a><span class="co"># Data cleaning and formatting</span></span>
<span id="cb20-771"><a href="#cb20-771" aria-hidden="true" tabindex="-1"></a>BLS_LABOR[<span class="st">"year"</span>] <span class="op">=</span> BLS_LABOR[<span class="st">"year"</span>].astype(<span class="bu">int</span>)</span>
<span id="cb20-772"><a href="#cb20-772" aria-hidden="true" tabindex="-1"></a>BLS_LABOR[<span class="st">"value"</span>] <span class="op">=</span> pd.to_numeric(BLS_LABOR[<span class="st">"value"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb20-773"><a href="#cb20-773" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-774"><a href="#cb20-774" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract values</span></span>
<span id="cb20-775"><a href="#cb20-775" aria-hidden="true" tabindex="-1"></a>BLS_LABOR[<span class="st">"value_type"</span>] <span class="op">=</span> BLS_LABOR[<span class="st">"series_title"</span>].<span class="bu">str</span>.extract(<span class="vs">r"^([^:]+)"</span>)</span>
<span id="cb20-776"><a href="#cb20-776" aria-hidden="true" tabindex="-1"></a>BLS_LABOR[<span class="st">"town"</span>] <span class="op">=</span> BLS_LABOR[<span class="st">"series_title"</span>].<span class="bu">str</span>.extract(</span>
<span id="cb20-777"><a href="#cb20-777" aria-hidden="true" tabindex="-1"></a>    <span class="vs">r": (.*?)(?= (?:city/town|town|city|borough/town), CT)"</span></span>
<span id="cb20-778"><a href="#cb20-778" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-779"><a href="#cb20-779" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-780"><a href="#cb20-780" aria-hidden="true" tabindex="-1"></a>BLS_LABOR[<span class="st">"town"</span>] <span class="op">=</span> BLS_LABOR[<span class="st">"town"</span>].replace({<span class="st">"Milford (consolidated)"</span>: <span class="st">"Milford"</span>})</span>
<span id="cb20-781"><a href="#cb20-781" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-782"><a href="#cb20-782" aria-hidden="true" tabindex="-1"></a><span class="co"># Add month number</span></span>
<span id="cb20-783"><a href="#cb20-783" aria-hidden="true" tabindex="-1"></a>month_map <span class="op">=</span> {name: i <span class="cf">for</span> i, name <span class="kw">in</span> <span class="bu">enumerate</span>([</span>
<span id="cb20-784"><a href="#cb20-784" aria-hidden="true" tabindex="-1"></a>    <span class="st">'January'</span>, <span class="st">'February'</span>, <span class="st">'March'</span>, <span class="st">'April'</span>, <span class="st">'May'</span>, <span class="st">'June'</span>,</span>
<span id="cb20-785"><a href="#cb20-785" aria-hidden="true" tabindex="-1"></a>    <span class="st">'July'</span>, <span class="st">'August'</span>, <span class="st">'September'</span>, <span class="st">'October'</span>, <span class="st">'November'</span>, <span class="st">'December'</span>], <span class="dv">1</span>)}</span>
<span id="cb20-786"><a href="#cb20-786" aria-hidden="true" tabindex="-1"></a>BLS_LABOR[<span class="st">"month_number"</span>] <span class="op">=</span> BLS_LABOR[<span class="st">"periodName"</span>].<span class="bu">map</span>(month_map)</span>
<span id="cb20-787"><a href="#cb20-787" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-788"><a href="#cb20-788" aria-hidden="true" tabindex="-1"></a><span class="co"># Pivot the data</span></span>
<span id="cb20-789"><a href="#cb20-789" aria-hidden="true" tabindex="-1"></a>BLS_LABOR <span class="op">=</span> BLS_LABOR.pivot_table(</span>
<span id="cb20-790"><a href="#cb20-790" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span>[<span class="st">"year"</span>, <span class="st">"month_number"</span>, <span class="st">"town"</span>], </span>
<span id="cb20-791"><a href="#cb20-791" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span><span class="st">"value_type"</span>, </span>
<span id="cb20-792"><a href="#cb20-792" aria-hidden="true" tabindex="-1"></a>    values<span class="op">=</span><span class="st">"value"</span>, </span>
<span id="cb20-793"><a href="#cb20-793" aria-hidden="true" tabindex="-1"></a>    aggfunc<span class="op">=</span><span class="st">"first"</span></span>
<span id="cb20-794"><a href="#cb20-794" aria-hidden="true" tabindex="-1"></a>).reset_index()</span>
<span id="cb20-795"><a href="#cb20-795" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-796"><a href="#cb20-796" aria-hidden="true" tabindex="-1"></a><span class="co"># Rename columns</span></span>
<span id="cb20-797"><a href="#cb20-797" aria-hidden="true" tabindex="-1"></a>BLS_LABOR <span class="op">=</span> BLS_LABOR.rename(columns<span class="op">=</span>{</span>
<span id="cb20-798"><a href="#cb20-798" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Unemployment Rate"</span>: <span class="st">"unemployment_rate"</span>,</span>
<span id="cb20-799"><a href="#cb20-799" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Unemployment"</span>: <span class="st">"unemployment"</span>,</span>
<span id="cb20-800"><a href="#cb20-800" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Employment"</span>: <span class="st">"employment"</span>,</span>
<span id="cb20-801"><a href="#cb20-801" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Labor Force"</span>: <span class="st">"labor_force"</span></span>
<span id="cb20-802"><a href="#cb20-802" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb20-803"><a href="#cb20-803" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-804"><a href="#cb20-804" aria-hidden="true" tabindex="-1"></a><span class="co"># Download CT Town &lt;- County mapping</span></span>
<span id="cb20-805"><a href="#cb20-805" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">"https://libguides.ctstatelibrary.org/cttowns"</span></span>
<span id="cb20-806"><a href="#cb20-806" aria-hidden="true" tabindex="-1"></a>soup <span class="op">=</span> BeautifulSoup(requests.get(url).content, <span class="st">"html.parser"</span>)</span>
<span id="cb20-807"><a href="#cb20-807" aria-hidden="true" tabindex="-1"></a>tables <span class="op">=</span> pd.read_html(<span class="bu">str</span>(soup))</span>
<span id="cb20-808"><a href="#cb20-808" aria-hidden="true" tabindex="-1"></a>ct_towns_counties <span class="op">=</span> tables[<span class="dv">0</span>]</span>
<span id="cb20-809"><a href="#cb20-809" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-810"><a href="#cb20-810" aria-hidden="true" tabindex="-1"></a><span class="co"># Clean header and rows</span></span>
<span id="cb20-811"><a href="#cb20-811" aria-hidden="true" tabindex="-1"></a>ct_towns_counties.columns <span class="op">=</span> ct_towns_counties.iloc[<span class="dv">0</span>]</span>
<span id="cb20-812"><a href="#cb20-812" aria-hidden="true" tabindex="-1"></a>ct_towns_counties <span class="op">=</span> ct_towns_counties.drop(index<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb20-813"><a href="#cb20-813" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-814"><a href="#cb20-814" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge county data</span></span>
<span id="cb20-815"><a href="#cb20-815" aria-hidden="true" tabindex="-1"></a>BLS_LABOR <span class="op">=</span> BLS_LABOR.merge(</span>
<span id="cb20-816"><a href="#cb20-816" aria-hidden="true" tabindex="-1"></a>    ct_towns_counties[[<span class="st">"Town name"</span>, <span class="st">"County"</span>]],</span>
<span id="cb20-817"><a href="#cb20-817" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"left"</span>, left_on<span class="op">=</span><span class="st">"town"</span>, right_on<span class="op">=</span><span class="st">"Town name"</span></span>
<span id="cb20-818"><a href="#cb20-818" aria-hidden="true" tabindex="-1"></a>).rename(columns<span class="op">=</span>{<span class="st">"County"</span>: <span class="st">"county"</span>}).drop(columns<span class="op">=</span>[<span class="st">"Town name"</span>])</span>
<span id="cb20-819"><a href="#cb20-819" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-820"><a href="#cb20-820" aria-hidden="true" tabindex="-1"></a><span class="co"># Save to CSV</span></span>
<span id="cb20-821"><a href="#cb20-821" aria-hidden="true" tabindex="-1"></a>csv_file.parent.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb20-822"><a href="#cb20-822" aria-hidden="true" tabindex="-1"></a>BLS_LABOR.to_csv(csv_file, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb20-823"><a href="#cb20-823" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-824"><a href="#cb20-824" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-825"><a href="#cb20-825" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-826"><a href="#cb20-826" aria-hidden="true" tabindex="-1"></a><span class="fu">## Municipal Financial Indicators</span></span>
<span id="cb20-827"><a href="#cb20-827" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-828"><a href="#cb20-828" aria-hidden="true" tabindex="-1"></a>Besides providing the Real Estate Sales data set, the CT OPM publishes a comprehensive collection of municipal financial data for all 169 towns in Connecticut^<span class="co">[</span><span class="ot">@ct_mfi_2024;@ct_mfi_2003_2007;@ct_mfi_2007_2011;@ct_mfi_2007_2012;@ct_mfi_2011_2015</span><span class="co">]</span>. These datasets are highly detailed and include annual town-level information on total taxes collected, total revenues, total expenditures, fund balances, among other fiscal indicators. This data set is particularly useful for examining trends in local government revenue, spending priorities, and financial stability.</span>
<span id="cb20-829"><a href="#cb20-829" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-830"><a href="#cb20-830" aria-hidden="true" tabindex="-1"></a>Since the CT OPM stores some of its older data in Microsoft Access database (MDB) files, I needed to use the <span class="in">`mdbtools`</span> utility to read these files on a non-Windows system^<span class="co">[</span><span class="ot">@mdbtools</span><span class="co">]</span>. To streamline this process, I wrote a helper function, <span class="in">`ensure_mdbtools()`</span>, which checks for the presence of <span class="in">`mdbtools`</span> and installs it if necessary. This ensures that the required tooling is available before attempting to import any of the data. The code for <span class="in">`ensure_mdbtools()`</span> is presented below. </span>
<span id="cb20-833"><a href="#cb20-833" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb20-834"><a href="#cb20-834" aria-hidden="true" tabindex="-1"></a><span class="co">#' Ensure mdbtools is installed on the system</span></span>
<span id="cb20-835"><a href="#cb20-835" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-836"><a href="#cb20-836" aria-hidden="true" tabindex="-1"></a><span class="co">#' Checks if the `mdb-export` command from the `mdbtools` package is available.</span></span>
<span id="cb20-837"><a href="#cb20-837" aria-hidden="true" tabindex="-1"></a><span class="co">#' If not found, attempts to install `mdbtools` using Homebrew on macOS.</span></span>
<span id="cb20-838"><a href="#cb20-838" aria-hidden="true" tabindex="-1"></a><span class="co">#' Stops execution with an error if Homebrew is not installed or installation fails.</span></span>
<span id="cb20-839"><a href="#cb20-839" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-840"><a href="#cb20-840" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return</span></span>
<span id="cb20-841"><a href="#cb20-841" aria-hidden="true" tabindex="-1"></a><span class="co">#' Invisibly returns `NULL`. Side effect is installing `mdbtools` if needed.</span></span>
<span id="cb20-842"><a href="#cb20-842" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-843"><a href="#cb20-843" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb20-844"><a href="#cb20-844" aria-hidden="true" tabindex="-1"></a><span class="co">#' \dontrun{</span></span>
<span id="cb20-845"><a href="#cb20-845" aria-hidden="true" tabindex="-1"></a><span class="co">#' ensure_mdbtools()</span></span>
<span id="cb20-846"><a href="#cb20-846" aria-hidden="true" tabindex="-1"></a><span class="co">#' }</span></span>
<span id="cb20-847"><a href="#cb20-847" aria-hidden="true" tabindex="-1"></a>ensure_mdbtools <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb20-848"><a href="#cb20-848" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if mdb-export is already available</span></span>
<span id="cb20-849"><a href="#cb20-849" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">system</span>(<span class="st">"which mdb-export"</span>, <span class="at">ignore.stdout =</span> <span class="cn">TRUE</span>, <span class="at">ignore.stderr =</span> <span class="cn">TRUE</span>) <span class="sc">!=</span> <span class="dv">0</span>) {</span>
<span id="cb20-850"><a href="#cb20-850" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"mdbtools not found. Attempting to install via Homebrew..."</span>)</span>
<span id="cb20-851"><a href="#cb20-851" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-852"><a href="#cb20-852" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if Homebrew is installed</span></span>
<span id="cb20-853"><a href="#cb20-853" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">system</span>(<span class="st">"which brew"</span>, <span class="at">ignore.stdout =</span> <span class="cn">TRUE</span>, <span class="at">ignore.stderr =</span> <span class="cn">TRUE</span>) <span class="sc">!=</span> <span class="dv">0</span>) {</span>
<span id="cb20-854"><a href="#cb20-854" aria-hidden="true" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">"Unable to install mdbtools: Homebrew is not installed."</span>)</span>
<span id="cb20-855"><a href="#cb20-855" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-856"><a href="#cb20-856" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-857"><a href="#cb20-857" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Try installing mdbtools</span></span>
<span id="cb20-858"><a href="#cb20-858" aria-hidden="true" tabindex="-1"></a>    install_status <span class="ot">&lt;-</span> <span class="fu">system</span>(<span class="st">"brew install mdbtools"</span>)</span>
<span id="cb20-859"><a href="#cb20-859" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-860"><a href="#cb20-860" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (install_status <span class="sc">!=</span> <span class="dv">0</span>) {</span>
<span id="cb20-861"><a href="#cb20-861" aria-hidden="true" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">"Failed to install mdbtools using Homebrew."</span>)</span>
<span id="cb20-862"><a href="#cb20-862" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb20-863"><a href="#cb20-863" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"mdbtools successfully installed."</span>)</span>
<span id="cb20-864"><a href="#cb20-864" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-865"><a href="#cb20-865" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb20-866"><a href="#cb20-866" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"mdbtools is already installed."</span>)</span>
<span id="cb20-867"><a href="#cb20-867" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-868"><a href="#cb20-868" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-869"><a href="#cb20-869" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-870"><a href="#cb20-870" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-871"><a href="#cb20-871" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-872"><a href="#cb20-872" aria-hidden="true" tabindex="-1"></a>Once <span class="in">`mdbtools`</span> has been installed, I can download the data and access the information in the MDB files. The code for downloading and merging the municipal fiscal indicators datafiles is included below.</span>
<span id="cb20-875"><a href="#cb20-875" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb20-876"><a href="#cb20-876" aria-hidden="true" tabindex="-1"></a><span class="co">#' Load Connecticut Municipal Fiscal Indicators Data (2014-2022)</span></span>
<span id="cb20-877"><a href="#cb20-877" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-878"><a href="#cb20-878" aria-hidden="true" tabindex="-1"></a><span class="co">#' Downloads and processes municipal fiscal data from the Connecticut open data portal</span></span>
<span id="cb20-879"><a href="#cb20-879" aria-hidden="true" tabindex="-1"></a><span class="co">#' if a local CSV file does not already exist. The function:</span></span>
<span id="cb20-880"><a href="#cb20-880" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Ensures the target directory exists,</span></span>
<span id="cb20-881"><a href="#cb20-881" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Loads necessary R scripts and packages,</span></span>
<span id="cb20-882"><a href="#cb20-882" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Fetches data via API call (limited to 2000 records),</span></span>
<span id="cb20-883"><a href="#cb20-883" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Cleans and formats the data, including town name fixes and joining county info,</span></span>
<span id="cb20-884"><a href="#cb20-884" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Converts relevant columns to numeric types,</span></span>
<span id="cb20-885"><a href="#cb20-885" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Filters out statewide aggregates,</span></span>
<span id="cb20-886"><a href="#cb20-886" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Saves the cleaned data locally as a CSV for future use,</span></span>
<span id="cb20-887"><a href="#cb20-887" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Otherwise loads data directly from the local CSV file.</span></span>
<span id="cb20-888"><a href="#cb20-888" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-889"><a href="#cb20-889" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A tibble with municipal fiscal indicators data for CT towns (2014-2022).</span></span>
<span id="cb20-890"><a href="#cb20-890" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb20-891"><a href="#cb20-891" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb20-892"><a href="#cb20-892" aria-hidden="true" tabindex="-1"></a><span class="co">#' ct_mfi &lt;- load_MFI_2014_2022_data()</span></span>
<span id="cb20-893"><a href="#cb20-893" aria-hidden="true" tabindex="-1"></a><span class="co">#' head(ct_mfi)</span></span>
<span id="cb20-894"><a href="#cb20-894" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb20-895"><a href="#cb20-895" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb20-896"><a href="#cb20-896" aria-hidden="true" tabindex="-1"></a>load_MFI_2014_2022_data <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb20-897"><a href="#cb20-897" aria-hidden="true" tabindex="-1"></a>  target_dir <span class="ot">&lt;-</span> <span class="st">"data/individual_report/2014-2022"</span></span>
<span id="cb20-898"><a href="#cb20-898" aria-hidden="true" tabindex="-1"></a>  file_name  <span class="ot">&lt;-</span> <span class="st">"ct_municipal_fiscal_indicators_2014_2022.csv"</span></span>
<span id="cb20-899"><a href="#cb20-899" aria-hidden="true" tabindex="-1"></a>  file_path  <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, file_name)</span>
<span id="cb20-900"><a href="#cb20-900" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-901"><a href="#cb20-901" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create directory if it doesn't exist</span></span>
<span id="cb20-902"><a href="#cb20-902" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(target_dir)) {</span>
<span id="cb20-903"><a href="#cb20-903" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(target_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-904"><a href="#cb20-904" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-905"><a href="#cb20-905" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-906"><a href="#cb20-906" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Download and process data if file doesn't exist</span></span>
<span id="cb20-907"><a href="#cb20-907" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(file_path)) {</span>
<span id="cb20-908"><a href="#cb20-908" aria-hidden="true" tabindex="-1"></a>    base_url <span class="ot">&lt;-</span> <span class="st">"https://data.ct.gov/resource/ej6f-y2wf.json"</span></span>
<span id="cb20-909"><a href="#cb20-909" aria-hidden="true" tabindex="-1"></a>    full_url <span class="ot">&lt;-</span> <span class="fu">paste0</span>(base_url, <span class="st">"?$limit=2000"</span>)</span>
<span id="cb20-910"><a href="#cb20-910" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-911"><a href="#cb20-911" aria-hidden="true" tabindex="-1"></a>    response <span class="ot">&lt;-</span> <span class="fu">GET</span>(full_url)</span>
<span id="cb20-912"><a href="#cb20-912" aria-hidden="true" tabindex="-1"></a>    raw_data <span class="ot">&lt;-</span> <span class="fu">fromJSON</span>(<span class="fu">content</span>(response, <span class="at">as =</span> <span class="st">"text"</span>))</span>
<span id="cb20-913"><a href="#cb20-913" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-914"><a href="#cb20-914" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load town mapping</span></span>
<span id="cb20-915"><a href="#cb20-915" aria-hidden="true" tabindex="-1"></a>    town_mapping <span class="ot">&lt;-</span> <span class="fu">load_ct_town_mapping</span>()</span>
<span id="cb20-916"><a href="#cb20-916" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-917"><a href="#cb20-917" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clean and join data</span></span>
<span id="cb20-918"><a href="#cb20-918" aria-hidden="true" tabindex="-1"></a>    cleaned_data <span class="ot">&lt;-</span> raw_data <span class="sc">|&gt;</span></span>
<span id="cb20-919"><a href="#cb20-919" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb20-920"><a href="#cb20-920" aria-hidden="true" tabindex="-1"></a>        <span class="at">town =</span> <span class="fu">str_to_title</span>(town),</span>
<span id="cb20-921"><a href="#cb20-921" aria-hidden="true" tabindex="-1"></a>        <span class="at">town =</span> <span class="fu">case_when</span>(</span>
<span id="cb20-922"><a href="#cb20-922" aria-hidden="true" tabindex="-1"></a>          town <span class="sc">==</span> <span class="st">"Groton (City)"</span> <span class="sc">~</span> <span class="st">"Groton"</span>,</span>
<span id="cb20-923"><a href="#cb20-923" aria-hidden="true" tabindex="-1"></a>          <span class="cn">TRUE</span> <span class="sc">~</span> town</span>
<span id="cb20-924"><a href="#cb20-924" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb20-925"><a href="#cb20-925" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb20-926"><a href="#cb20-926" aria-hidden="true" tabindex="-1"></a>      <span class="fu">left_join</span>(</span>
<span id="cb20-927"><a href="#cb20-927" aria-hidden="true" tabindex="-1"></a>        town_mapping <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="st">`</span><span class="at">Town name</span><span class="st">`</span>, County),</span>
<span id="cb20-928"><a href="#cb20-928" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"town"</span> <span class="ot">=</span> <span class="st">"Town name"</span>)</span>
<span id="cb20-929"><a href="#cb20-929" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb20-930"><a href="#cb20-930" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb20-931"><a href="#cb20-931" aria-hidden="true" tabindex="-1"></a>        <span class="at">property_tax_revenues =</span> <span class="fu">as.numeric</span>(property_tax_revenues),</span>
<span id="cb20-932"><a href="#cb20-932" aria-hidden="true" tabindex="-1"></a>        <span class="at">fiscal_year_end =</span> <span class="fu">as.integer</span>(fiscal_year_end),</span>
<span id="cb20-933"><a href="#cb20-933" aria-hidden="true" tabindex="-1"></a>        <span class="fu">across</span>(</span>
<span id="cb20-934"><a href="#cb20-934" aria-hidden="true" tabindex="-1"></a>          <span class="fu">where</span>(<span class="sc">~</span> <span class="fu">is.character</span>(.) <span class="sc">&amp;&amp;</span> <span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(<span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(.))))),</span>
<span id="cb20-935"><a href="#cb20-935" aria-hidden="true" tabindex="-1"></a>          as.numeric</span>
<span id="cb20-936"><a href="#cb20-936" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb20-937"><a href="#cb20-937" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb20-938"><a href="#cb20-938" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(town <span class="sc">!=</span> <span class="st">"Statewide"</span>)</span>
<span id="cb20-939"><a href="#cb20-939" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-940"><a href="#cb20-940" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(cleaned_data, file_path)</span>
<span id="cb20-941"><a href="#cb20-941" aria-hidden="true" tabindex="-1"></a>    ct_revenue_data <span class="ot">&lt;-</span> cleaned_data</span>
<span id="cb20-942"><a href="#cb20-942" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-943"><a href="#cb20-943" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb20-944"><a href="#cb20-944" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Reading existing data from CSV..."</span>)</span>
<span id="cb20-945"><a href="#cb20-945" aria-hidden="true" tabindex="-1"></a>    ct_revenue_data <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(file_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb20-946"><a href="#cb20-946" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-947"><a href="#cb20-947" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(ct_revenue_data)</span>
<span id="cb20-948"><a href="#cb20-948" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-949"><a href="#cb20-949" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-950"><a href="#cb20-950" aria-hidden="true" tabindex="-1"></a><span class="co">#' Load and Process CT Municipal Fiscal Indicators (2003–2007)</span></span>
<span id="cb20-951"><a href="#cb20-951" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-952"><a href="#cb20-952" aria-hidden="true" tabindex="-1"></a><span class="co">#' Downloads, extracts, cleans, and processes Connecticut municipal fiscal indicator data</span></span>
<span id="cb20-953"><a href="#cb20-953" aria-hidden="true" tabindex="-1"></a><span class="co">#' from 2003 to 2007. This includes:</span></span>
<span id="cb20-954"><a href="#cb20-954" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Downloading and extracting data from a Microsoft Access database (.mdb)</span></span>
<span id="cb20-955"><a href="#cb20-955" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Parsing multiple related datasets (FISCIN, NetGL, ACMR)</span></span>
<span id="cb20-956"><a href="#cb20-956" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Cleaning and harmonizing town names</span></span>
<span id="cb20-957"><a href="#cb20-957" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Merging fiscal data, mill rates, and grand lists</span></span>
<span id="cb20-958"><a href="#cb20-958" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Estimating property tax revenues</span></span>
<span id="cb20-959"><a href="#cb20-959" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Joining with county-level town mapping</span></span>
<span id="cb20-960"><a href="#cb20-960" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-961"><a href="#cb20-961" aria-hidden="true" tabindex="-1"></a><span class="co">#' The final dataset is cached locally as a CSV to avoid repeated downloads and processing.</span></span>
<span id="cb20-962"><a href="#cb20-962" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-963"><a href="#cb20-963" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A cleaned `data.frame` (tibble) containing fiscal indicators from 2003–2007,</span></span>
<span id="cb20-964"><a href="#cb20-964" aria-hidden="true" tabindex="-1"></a><span class="co">#' including town name, county, net grand list, mill rate, estimated property tax revenue,</span></span>
<span id="cb20-965"><a href="#cb20-965" aria-hidden="true" tabindex="-1"></a><span class="co">#' Moody's bond ratings, population, and other selected fiscal variables.</span></span>
<span id="cb20-966"><a href="#cb20-966" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-967"><a href="#cb20-967" aria-hidden="true" tabindex="-1"></a><span class="co">#' @note Requires `mdbtools` to be installed on the system (via Homebrew on macOS).</span></span>
<span id="cb20-968"><a href="#cb20-968" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-969"><a href="#cb20-969" aria-hidden="true" tabindex="-1"></a><span class="co">#' @import dplyr readr stringr purrr tidyr</span></span>
<span id="cb20-970"><a href="#cb20-970" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb20-971"><a href="#cb20-971" aria-hidden="true" tabindex="-1"></a>load_MFI_2003_2007_data <span class="ot">&lt;-</span> <span class="cf">function</span>(){</span>
<span id="cb20-972"><a href="#cb20-972" aria-hidden="true" tabindex="-1"></a>  target_dir <span class="ot">&lt;-</span> <span class="st">'data/individual_report/2003-2007'</span></span>
<span id="cb20-973"><a href="#cb20-973" aria-hidden="true" tabindex="-1"></a>  f_name <span class="ot">&lt;-</span> <span class="st">"ct_municipal_fiscal_indicators_2003_2007.csv"</span></span>
<span id="cb20-974"><a href="#cb20-974" aria-hidden="true" tabindex="-1"></a>  f_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, f_name)</span>
<span id="cb20-975"><a href="#cb20-975" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-976"><a href="#cb20-976" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(target_dir)){</span>
<span id="cb20-977"><a href="#cb20-977" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(target_dir, <span class="at">recursive=</span><span class="cn">TRUE</span>)</span>
<span id="cb20-978"><a href="#cb20-978" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-979"><a href="#cb20-979" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-980"><a href="#cb20-980" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(f_path)){</span>
<span id="cb20-981"><a href="#cb20-981" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-982"><a href="#cb20-982" aria-hidden="true" tabindex="-1"></a>    mdb_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, <span class="st">"2003-2007.mdb"</span>)</span>
<span id="cb20-983"><a href="#cb20-983" aria-hidden="true" tabindex="-1"></a>    output_dir <span class="ot">&lt;-</span> target_dir</span>
<span id="cb20-984"><a href="#cb20-984" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(mdb_file)){</span>
<span id="cb20-985"><a href="#cb20-985" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Define the URL</span></span>
<span id="cb20-986"><a href="#cb20-986" aria-hidden="true" tabindex="-1"></a>      <span class="fu">download.file</span>(<span class="st">"https://data.ct.gov/download/psxm-7fts/application%2Fx-msaccess"</span>, <span class="at">destfile =</span> mdb_file)</span>
<span id="cb20-987"><a href="#cb20-987" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-988"><a href="#cb20-988" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-989"><a href="#cb20-989" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ensure_mdbtools</span>()</span>
<span id="cb20-990"><a href="#cb20-990" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-991"><a href="#cb20-991" aria-hidden="true" tabindex="-1"></a>    <span class="co"># List all table names in the MDB file</span></span>
<span id="cb20-992"><a href="#cb20-992" aria-hidden="true" tabindex="-1"></a>    tables <span class="ot">&lt;-</span> <span class="fu">system</span>(<span class="fu">paste</span>(<span class="st">"mdb-tables -1"</span>, <span class="fu">shQuote</span>(mdb_file)), <span class="at">intern =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-993"><a href="#cb20-993" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-994"><a href="#cb20-994" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Loop through each table and export to CSV</span></span>
<span id="cb20-995"><a href="#cb20-995" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (table_name <span class="cf">in</span> tables) {</span>
<span id="cb20-996"><a href="#cb20-996" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Clean up table name for file output (e.g., replace spaces with underscores)</span></span>
<span id="cb20-997"><a href="#cb20-997" aria-hidden="true" tabindex="-1"></a>      output_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(output_dir, <span class="fu">paste0</span>(<span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">"_"</span>, table_name), <span class="st">".csv"</span>))</span>
<span id="cb20-998"><a href="#cb20-998" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb20-999"><a href="#cb20-999" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Construct and run the export command</span></span>
<span id="cb20-1000"><a href="#cb20-1000" aria-hidden="true" tabindex="-1"></a>      cmd <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"mdb-export"</span>, <span class="fu">shQuote</span>(mdb_file), <span class="fu">shQuote</span>(table_name), <span class="st">"&gt;"</span>, <span class="fu">shQuote</span>(output_file))</span>
<span id="cb20-1001"><a href="#cb20-1001" aria-hidden="true" tabindex="-1"></a>      <span class="fu">system</span>(cmd)</span>
<span id="cb20-1002"><a href="#cb20-1002" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-1003"><a href="#cb20-1003" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1004"><a href="#cb20-1004" aria-hidden="true" tabindex="-1"></a>    all_fiscin <span class="ot">=</span> <span class="fu">data.frame</span>()</span>
<span id="cb20-1005"><a href="#cb20-1005" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1006"><a href="#cb20-1006" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialize empty data frame</span></span>
<span id="cb20-1007"><a href="#cb20-1007" aria-hidden="true" tabindex="-1"></a>    all_fiscin <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb20-1008"><a href="#cb20-1008" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1009"><a href="#cb20-1009" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Read and combine all FISCIN files</span></span>
<span id="cb20-1010"><a href="#cb20-1010" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (y <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>) {</span>
<span id="cb20-1011"><a href="#cb20-1011" aria-hidden="true" tabindex="-1"></a>      df <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">file.path</span>(target_dir, <span class="fu">paste0</span>(<span class="st">"FISCIN0"</span>, y, <span class="st">".csv"</span>)), <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-1012"><a href="#cb20-1012" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rename_with</span>(str_to_lower)</span>
<span id="cb20-1013"><a href="#cb20-1013" aria-hidden="true" tabindex="-1"></a>      all_fiscin <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(all_fiscin, df)</span>
<span id="cb20-1014"><a href="#cb20-1014" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-1015"><a href="#cb20-1015" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1016"><a href="#cb20-1016" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute coalesced columns outside mutate</span></span>
<span id="cb20-1017"><a href="#cb20-1017" aria-hidden="true" tabindex="-1"></a>    moodys_bond_rating <span class="ot">&lt;-</span> <span class="fu">coalesce</span>(<span class="sc">!!!</span><span class="fu">select</span>(all_fiscin, <span class="fu">starts_with</span>(<span class="st">"moody's_bond_ratings_july_200"</span>)))</span>
<span id="cb20-1018"><a href="#cb20-1018" aria-hidden="true" tabindex="-1"></a>    population <span class="ot">&lt;-</span> <span class="fu">coalesce</span>(<span class="sc">!!!</span><span class="fu">select</span>(all_fiscin, <span class="fu">matches</span>(<span class="st">"^</span><span class="sc">\\</span><span class="st">d{4} population$"</span>)))</span>
<span id="cb20-1019"><a href="#cb20-1019" aria-hidden="true" tabindex="-1"></a>    tanf_recipients <span class="ot">&lt;-</span> <span class="fu">coalesce</span>(<span class="sc">!!!</span><span class="fu">select</span>(all_fiscin, <span class="fu">starts_with</span>(<span class="st">"tanf"</span>)))</span>
<span id="cb20-1020"><a href="#cb20-1020" aria-hidden="true" tabindex="-1"></a>    acglfy <span class="ot">&lt;-</span> <span class="fu">coalesce</span>(<span class="sc">!!!</span><span class="fu">select</span>(all_fiscin, <span class="fu">starts_with</span>(<span class="st">"acglfy"</span>)))</span>
<span id="cb20-1021"><a href="#cb20-1021" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1022"><a href="#cb20-1022" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Final transformation</span></span>
<span id="cb20-1023"><a href="#cb20-1023" aria-hidden="true" tabindex="-1"></a>    all_fiscin <span class="ot">&lt;-</span> all_fiscin <span class="sc">|&gt;</span></span>
<span id="cb20-1024"><a href="#cb20-1024" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb20-1025"><a href="#cb20-1025" aria-hidden="true" tabindex="-1"></a>        <span class="at">municipality =</span> <span class="fu">str_to_title</span>(municipality),</span>
<span id="cb20-1026"><a href="#cb20-1026" aria-hidden="true" tabindex="-1"></a>        <span class="at">moodys_bond_rating =</span> moodys_bond_rating,</span>
<span id="cb20-1027"><a href="#cb20-1027" aria-hidden="true" tabindex="-1"></a>        <span class="at">population =</span> population,</span>
<span id="cb20-1028"><a href="#cb20-1028" aria-hidden="true" tabindex="-1"></a>        <span class="at">tanf_recipients =</span> tanf_recipients,</span>
<span id="cb20-1029"><a href="#cb20-1029" aria-hidden="true" tabindex="-1"></a>        <span class="at">acglfy =</span> acglfy</span>
<span id="cb20-1030"><a href="#cb20-1030" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb20-1031"><a href="#cb20-1031" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(</span>
<span id="cb20-1032"><a href="#cb20-1032" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span><span class="fu">matches</span>(<span class="st">"moody's_bond_ratings_july_200"</span>),</span>
<span id="cb20-1033"><a href="#cb20-1033" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span><span class="fu">matches</span>(<span class="st">"^</span><span class="sc">\\</span><span class="st">d{4} population$"</span>),</span>
<span id="cb20-1034"><a href="#cb20-1034" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span><span class="fu">matches</span>(<span class="st">"^acglfy0"</span>),</span>
<span id="cb20-1035"><a href="#cb20-1035" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span><span class="fu">matches</span>(<span class="st">"^tanf0"</span>)</span>
<span id="cb20-1036"><a href="#cb20-1036" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb20-1037"><a href="#cb20-1037" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename_with</span>(<span class="sc">~</span> .x <span class="sc">|&gt;</span></span>
<span id="cb20-1038"><a href="#cb20-1038" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">str_replace_all</span>(<span class="st">" "</span>, <span class="st">"_"</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-1039"><a href="#cb20-1039" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">str_replace_all</span>(<span class="st">"[^A-Za-z0-9_]"</span>, <span class="st">""</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-1040"><a href="#cb20-1040" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">str_replace_all</span>(<span class="st">"__"</span>, <span class="st">"_"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb20-1041"><a href="#cb20-1041" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">town =</span> municipality)</span>
<span id="cb20-1042"><a href="#cb20-1042" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1043"><a href="#cb20-1043" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1044"><a href="#cb20-1044" aria-hidden="true" tabindex="-1"></a>    all_gls <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb20-1045"><a href="#cb20-1045" aria-hidden="true" tabindex="-1"></a>    all_acmrs <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb20-1046"><a href="#cb20-1046" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1047"><a href="#cb20-1047" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (year <span class="cf">in</span> <span class="dv">2003</span><span class="sc">:</span><span class="dv">2007</span>) {</span>
<span id="cb20-1048"><a href="#cb20-1048" aria-hidden="true" tabindex="-1"></a>      acmr_file_path <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"data/2003-2007/ACMR_"</span>, year, <span class="st">"_GL_Year.csv"</span>)</span>
<span id="cb20-1049"><a href="#cb20-1049" aria-hidden="true" tabindex="-1"></a>      gl_file_path <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"data/2003-2007/NetGL"</span>, year, <span class="st">".csv"</span>)</span>
<span id="cb20-1050"><a href="#cb20-1050" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (year <span class="sc">==</span> <span class="dv">2004</span>){</span>
<span id="cb20-1051"><a href="#cb20-1051" aria-hidden="true" tabindex="-1"></a>        gl_file_path <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"data/2003-2007/NetGL_"</span>, year, <span class="st">".csv"</span>)</span>
<span id="cb20-1052"><a href="#cb20-1052" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb20-1053"><a href="#cb20-1053" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb20-1054"><a href="#cb20-1054" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (year <span class="sc">!=</span> <span class="dv">2007</span>){</span>
<span id="cb20-1055"><a href="#cb20-1055" aria-hidden="true" tabindex="-1"></a>        df1 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(gl_file_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) </span>
<span id="cb20-1056"><a href="#cb20-1056" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-1057"><a href="#cb20-1057" aria-hidden="true" tabindex="-1"></a>        df1 <span class="ot">&lt;-</span> df1 <span class="sc">|&gt;</span></span>
<span id="cb20-1058"><a href="#cb20-1058" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(<span class="at">gl_year =</span> year) <span class="sc">|&gt;</span> </span>
<span id="cb20-1059"><a href="#cb20-1059" aria-hidden="true" tabindex="-1"></a>          <span class="fu">rename_with</span>(</span>
<span id="cb20-1060"><a href="#cb20-1060" aria-hidden="true" tabindex="-1"></a>            <span class="sc">~</span> <span class="fu">str_replace</span>(., <span class="st">"Net Grand List.*"</span>, <span class="fu">paste0</span>(<span class="st">"Net Grand List - "</span>, year, <span class="st">" GL Year"</span>)),</span>
<span id="cb20-1061"><a href="#cb20-1061" aria-hidden="true" tabindex="-1"></a>            <span class="fu">matches</span>(<span class="st">"Net Grand List"</span>)</span>
<span id="cb20-1062"><a href="#cb20-1062" aria-hidden="true" tabindex="-1"></a>          ) <span class="sc">|&gt;</span></span>
<span id="cb20-1063"><a href="#cb20-1063" aria-hidden="true" tabindex="-1"></a>          <span class="fu">pivot_longer</span>(</span>
<span id="cb20-1064"><a href="#cb20-1064" aria-hidden="true" tabindex="-1"></a>            <span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"Net Grand List"</span>),</span>
<span id="cb20-1065"><a href="#cb20-1065" aria-hidden="true" tabindex="-1"></a>            <span class="at">names_to =</span> <span class="st">"gl_year_label"</span>,</span>
<span id="cb20-1066"><a href="#cb20-1066" aria-hidden="true" tabindex="-1"></a>            <span class="at">values_to =</span> <span class="st">"net_grand_list"</span></span>
<span id="cb20-1067"><a href="#cb20-1067" aria-hidden="true" tabindex="-1"></a>          ) <span class="sc">|&gt;</span></span>
<span id="cb20-1068"><a href="#cb20-1068" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(</span>
<span id="cb20-1069"><a href="#cb20-1069" aria-hidden="true" tabindex="-1"></a>            <span class="at">gl_year =</span> <span class="fu">as.integer</span>(<span class="fu">str_extract</span>(gl_year_label, <span class="st">"</span><span class="sc">\\</span><span class="st">d{4}"</span>))</span>
<span id="cb20-1070"><a href="#cb20-1070" aria-hidden="true" tabindex="-1"></a>          ) <span class="sc">|&gt;</span></span>
<span id="cb20-1071"><a href="#cb20-1071" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(net_grand_list))</span>
<span id="cb20-1072"><a href="#cb20-1072" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-1073"><a href="#cb20-1073" aria-hidden="true" tabindex="-1"></a>        all_gls <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(all_gls, df1)</span>
<span id="cb20-1074"><a href="#cb20-1074" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb20-1075"><a href="#cb20-1075" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb20-1076"><a href="#cb20-1076" aria-hidden="true" tabindex="-1"></a>      df2 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(acmr_file_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb20-1077"><a href="#cb20-1077" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb20-1078"><a href="#cb20-1078" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (year <span class="sc">==</span> <span class="dv">2003</span>){</span>
<span id="cb20-1079"><a href="#cb20-1079" aria-hidden="true" tabindex="-1"></a>        df2_long <span class="ot">&lt;-</span> df2 <span class="sc">|&gt;</span></span>
<span id="cb20-1080"><a href="#cb20-1080" aria-hidden="true" tabindex="-1"></a>          <span class="fu">pivot_longer</span>(</span>
<span id="cb20-1081"><a href="#cb20-1081" aria-hidden="true" tabindex="-1"></a>            <span class="at">cols =</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Millrate FY 2004-2005</span><span class="st">`</span>, <span class="st">`</span><span class="at">FY 2003-04 Millrate</span><span class="st">`</span>),</span>
<span id="cb20-1082"><a href="#cb20-1082" aria-hidden="true" tabindex="-1"></a>            <span class="at">names_to =</span> <span class="st">"year"</span>,</span>
<span id="cb20-1083"><a href="#cb20-1083" aria-hidden="true" tabindex="-1"></a>            <span class="at">values_to =</span> <span class="st">"millrate"</span></span>
<span id="cb20-1084"><a href="#cb20-1084" aria-hidden="true" tabindex="-1"></a>          ) <span class="sc">|&gt;</span></span>
<span id="cb20-1085"><a href="#cb20-1085" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(</span>
<span id="cb20-1086"><a href="#cb20-1086" aria-hidden="true" tabindex="-1"></a>            <span class="at">year =</span> <span class="fu">case_when</span>(</span>
<span id="cb20-1087"><a href="#cb20-1087" aria-hidden="true" tabindex="-1"></a>              year <span class="sc">==</span> <span class="st">"Millrate FY 2004-2005"</span> <span class="sc">~</span> <span class="dv">2004</span>,</span>
<span id="cb20-1088"><a href="#cb20-1088" aria-hidden="true" tabindex="-1"></a>              year <span class="sc">==</span> <span class="st">"FY 2003-04 Millrate"</span> <span class="sc">~</span> <span class="dv">2003</span></span>
<span id="cb20-1089"><a href="#cb20-1089" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb20-1090"><a href="#cb20-1090" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb20-1091"><a href="#cb20-1091" aria-hidden="true" tabindex="-1"></a>        all_acmrs <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(all_acmrs, df2_long)</span>
<span id="cb20-1092"><a href="#cb20-1092" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span>{</span>
<span id="cb20-1093"><a href="#cb20-1093" aria-hidden="true" tabindex="-1"></a>        df2 <span class="ot">&lt;-</span> df2 <span class="sc">|&gt;</span></span>
<span id="cb20-1094"><a href="#cb20-1094" aria-hidden="true" tabindex="-1"></a>          <span class="fu">rename</span>(<span class="at">millrate =</span> <span class="fu">matches</span>(<span class="st">"Mil"</span>))</span>
<span id="cb20-1095"><a href="#cb20-1095" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-1096"><a href="#cb20-1096" aria-hidden="true" tabindex="-1"></a>        year_col <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"Year"</span>, <span class="fu">names</span>(df2), <span class="at">value =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-1097"><a href="#cb20-1097" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-1098"><a href="#cb20-1098" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">length</span>(year_col) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb20-1099"><a href="#cb20-1099" aria-hidden="true" tabindex="-1"></a>          df2 <span class="ot">&lt;-</span> df2 <span class="sc">|&gt;</span></span>
<span id="cb20-1100"><a href="#cb20-1100" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mutate</span>(<span class="at">year =</span> year) </span>
<span id="cb20-1101"><a href="#cb20-1101" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb20-1102"><a href="#cb20-1102" aria-hidden="true" tabindex="-1"></a>          df2 <span class="ot">&lt;-</span> df2 <span class="sc">|&gt;</span></span>
<span id="cb20-1103"><a href="#cb20-1103" aria-hidden="true" tabindex="-1"></a>            <span class="fu">rename_with</span>(<span class="sc">~</span> <span class="st">"year"</span>, <span class="at">.cols =</span> <span class="fu">all_of</span>(year_col[<span class="dv">1</span>]))</span>
<span id="cb20-1104"><a href="#cb20-1104" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb20-1105"><a href="#cb20-1105" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-1106"><a href="#cb20-1106" aria-hidden="true" tabindex="-1"></a>        all_acmrs <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(all_acmrs, df2)</span>
<span id="cb20-1107"><a href="#cb20-1107" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb20-1108"><a href="#cb20-1108" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-1109"><a href="#cb20-1109" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1110"><a href="#cb20-1110" aria-hidden="true" tabindex="-1"></a>    all_gls <span class="ot">&lt;-</span></span>
<span id="cb20-1111"><a href="#cb20-1111" aria-hidden="true" tabindex="-1"></a>      all_gls <span class="sc">|&gt;</span></span>
<span id="cb20-1112"><a href="#cb20-1112" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span>gl_year_label) <span class="sc">|&gt;</span></span>
<span id="cb20-1113"><a href="#cb20-1113" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(</span>
<span id="cb20-1114"><a href="#cb20-1114" aria-hidden="true" tabindex="-1"></a>        <span class="at">town =</span> Municipality,</span>
<span id="cb20-1115"><a href="#cb20-1115" aria-hidden="true" tabindex="-1"></a>        <span class="at">comptroller_town_code =</span> <span class="st">`</span><span class="at">Comptroller Town Code</span><span class="st">`</span>,</span>
<span id="cb20-1116"><a href="#cb20-1116" aria-hidden="true" tabindex="-1"></a>        <span class="at">comments =</span> Comments,</span>
<span id="cb20-1117"><a href="#cb20-1117" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb20-1118"><a href="#cb20-1118" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb20-1119"><a href="#cb20-1119" aria-hidden="true" tabindex="-1"></a>        <span class="at">town =</span> <span class="fu">str_to_title</span>(town),</span>
<span id="cb20-1120"><a href="#cb20-1120" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb20-1121"><a href="#cb20-1121" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1122"><a href="#cb20-1122" aria-hidden="true" tabindex="-1"></a>    all_acmrs <span class="ot">&lt;-</span></span>
<span id="cb20-1123"><a href="#cb20-1123" aria-hidden="true" tabindex="-1"></a>      all_acmrs <span class="sc">|&gt;</span></span>
<span id="cb20-1124"><a href="#cb20-1124" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(</span>
<span id="cb20-1125"><a href="#cb20-1125" aria-hidden="true" tabindex="-1"></a>        <span class="at">town =</span> Municipality</span>
<span id="cb20-1126"><a href="#cb20-1126" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb20-1127"><a href="#cb20-1127" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb20-1128"><a href="#cb20-1128" aria-hidden="true" tabindex="-1"></a>        <span class="at">town =</span> <span class="fu">str_to_title</span>(town),</span>
<span id="cb20-1129"><a href="#cb20-1129" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb20-1130"><a href="#cb20-1130" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1131"><a href="#cb20-1131" aria-hidden="true" tabindex="-1"></a>    ct_towns_counties <span class="ot">&lt;-</span> <span class="fu">load_ct_town_mapping</span>()</span>
<span id="cb20-1132"><a href="#cb20-1132" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1133"><a href="#cb20-1133" aria-hidden="true" tabindex="-1"></a>    final <span class="ot">&lt;-</span> <span class="fu">inner_join</span>(</span>
<span id="cb20-1134"><a href="#cb20-1134" aria-hidden="true" tabindex="-1"></a>      all_gls, all_acmrs, <span class="fu">join_by</span>(town <span class="sc">==</span> town, gl_year <span class="sc">==</span> year)</span>
<span id="cb20-1135"><a href="#cb20-1135" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> <span class="fu">mutate</span>(</span>
<span id="cb20-1136"><a href="#cb20-1136" aria-hidden="true" tabindex="-1"></a>      <span class="at">property_tax_revenue =</span> (millrate<span class="sc">/</span><span class="dv">1000</span>) <span class="sc">*</span> net_grand_list</span>
<span id="cb20-1137"><a href="#cb20-1137" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> <span class="fu">rename</span>(<span class="at">year =</span> gl_year) <span class="sc">|&gt;</span></span>
<span id="cb20-1138"><a href="#cb20-1138" aria-hidden="true" tabindex="-1"></a>      <span class="fu">inner_join</span>(all_fiscin, <span class="fu">join_by</span>(town <span class="sc">==</span> town, year <span class="sc">==</span> fisc_year_end )) <span class="sc">|&gt;</span></span>
<span id="cb20-1139"><a href="#cb20-1139" aria-hidden="true" tabindex="-1"></a>      <span class="fu">inner_join</span>(ct_towns_counties <span class="sc">|&gt;</span> <span class="fu">rename</span>(<span class="at">county =</span> County) <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="st">"Town name"</span>, county), <span class="fu">join_by</span>(town <span class="sc">==</span> <span class="st">"Town name"</span>))</span>
<span id="cb20-1140"><a href="#cb20-1140" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1141"><a href="#cb20-1141" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(final, f_path)</span>
<span id="cb20-1142"><a href="#cb20-1142" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span>{</span>
<span id="cb20-1143"><a href="#cb20-1143" aria-hidden="true" tabindex="-1"></a>    final <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(f_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb20-1144"><a href="#cb20-1144" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-1145"><a href="#cb20-1145" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(final)</span>
<span id="cb20-1146"><a href="#cb20-1146" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-1147"><a href="#cb20-1147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1148"><a href="#cb20-1148" aria-hidden="true" tabindex="-1"></a><span class="co">#' Load Connecticut Municipal Fiscal Indicators Data (2007-2011)</span></span>
<span id="cb20-1149"><a href="#cb20-1149" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-1150"><a href="#cb20-1150" aria-hidden="true" tabindex="-1"></a><span class="co">#' This function downloads, extracts, processes, and merges municipal fiscal data for</span></span>
<span id="cb20-1151"><a href="#cb20-1151" aria-hidden="true" tabindex="-1"></a><span class="co">#' Connecticut towns from 2007 to 2011. It handles the Microsoft Access database file (.mdb),</span></span>
<span id="cb20-1152"><a href="#cb20-1152" aria-hidden="true" tabindex="-1"></a><span class="co">#' exports its tables to CSV files using `mdbtools`, reads and cleans specific fiscal indicator</span></span>
<span id="cb20-1153"><a href="#cb20-1153" aria-hidden="true" tabindex="-1"></a><span class="co">#' CSVs, and combines these with net grand list and mill rate data.</span></span>
<span id="cb20-1154"><a href="#cb20-1154" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-1155"><a href="#cb20-1155" aria-hidden="true" tabindex="-1"></a><span class="co">#' If the processed CSV summary file already exists locally, it loads and returns it directly.</span></span>
<span id="cb20-1156"><a href="#cb20-1156" aria-hidden="true" tabindex="-1"></a><span class="co">#' Otherwise, it downloads the MDB file, extracts tables, processes and merges relevant data,</span></span>
<span id="cb20-1157"><a href="#cb20-1157" aria-hidden="true" tabindex="-1"></a><span class="co">#' and saves the combined data for future use.</span></span>
<span id="cb20-1158"><a href="#cb20-1158" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-1159"><a href="#cb20-1159" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A tibble containing merged fiscal, tax, and municipal data for Connecticut towns from 2007-2011,</span></span>
<span id="cb20-1160"><a href="#cb20-1160" aria-hidden="true" tabindex="-1"></a><span class="co">#' with columns including town, year, property tax revenue, population, Moody's bond rating,</span></span>
<span id="cb20-1161"><a href="#cb20-1161" aria-hidden="true" tabindex="-1"></a><span class="co">#' and other fiscal indicators.</span></span>
<span id="cb20-1162"><a href="#cb20-1162" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-1163"><a href="#cb20-1163" aria-hidden="true" tabindex="-1"></a><span class="co">#' @details</span></span>
<span id="cb20-1164"><a href="#cb20-1164" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Requires `mdbtools` installed and available in the system PATH for exporting Access tables.</span></span>
<span id="cb20-1165"><a href="#cb20-1165" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Downloads data from the Connecticut Open Data portal if necessary.</span></span>
<span id="cb20-1166"><a href="#cb20-1166" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Uses `dplyr` and `tidyverse` functions for data manipulation.</span></span>
<span id="cb20-1167"><a href="#cb20-1167" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Cleans column names and consolidates yearly variables into single columns.</span></span>
<span id="cb20-1168"><a href="#cb20-1168" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Joins town-level fiscal indicators with tax and county data.</span></span>
<span id="cb20-1169"><a href="#cb20-1169" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-1170"><a href="#cb20-1170" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom readr read_csv write_csv</span></span>
<span id="cb20-1171"><a href="#cb20-1171" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom dplyr rename_with mutate select rename inner_join bind_rows filter</span></span>
<span id="cb20-1172"><a href="#cb20-1172" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom stringr str_to_lower str_to_title str_replace_all str_extract</span></span>
<span id="cb20-1173"><a href="#cb20-1173" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom tidyr pivot_longer</span></span>
<span id="cb20-1174"><a href="#cb20-1174" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-1175"><a href="#cb20-1175" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb20-1176"><a href="#cb20-1176" aria-hidden="true" tabindex="-1"></a><span class="co">#' \dontrun{</span></span>
<span id="cb20-1177"><a href="#cb20-1177" aria-hidden="true" tabindex="-1"></a><span class="co">#' fiscal_data &lt;- load_MFI_2007_2011_data()</span></span>
<span id="cb20-1178"><a href="#cb20-1178" aria-hidden="true" tabindex="-1"></a><span class="co">#' head(fiscal_data)</span></span>
<span id="cb20-1179"><a href="#cb20-1179" aria-hidden="true" tabindex="-1"></a><span class="co">#' }</span></span>
<span id="cb20-1180"><a href="#cb20-1180" aria-hidden="true" tabindex="-1"></a>load_MFI_2007_2011_data <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb20-1181"><a href="#cb20-1181" aria-hidden="true" tabindex="-1"></a>  target_dir <span class="ot">&lt;-</span> <span class="st">'data/individual_report/2007-2011'</span></span>
<span id="cb20-1182"><a href="#cb20-1182" aria-hidden="true" tabindex="-1"></a>  f_name <span class="ot">&lt;-</span> <span class="st">"ct_municipal_fiscal_indicators_2007_2011.csv"</span></span>
<span id="cb20-1183"><a href="#cb20-1183" aria-hidden="true" tabindex="-1"></a>  f_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, f_name)</span>
<span id="cb20-1184"><a href="#cb20-1184" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-1185"><a href="#cb20-1185" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(target_dir)) {</span>
<span id="cb20-1186"><a href="#cb20-1186" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(target_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-1187"><a href="#cb20-1187" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-1188"><a href="#cb20-1188" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-1189"><a href="#cb20-1189" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(f_path)) {</span>
<span id="cb20-1190"><a href="#cb20-1190" aria-hidden="true" tabindex="-1"></a>    mdb_fname <span class="ot">&lt;-</span> <span class="st">"2007-2011.mdb"</span></span>
<span id="cb20-1191"><a href="#cb20-1191" aria-hidden="true" tabindex="-1"></a>    mdb_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, mdb_fname)</span>
<span id="cb20-1192"><a href="#cb20-1192" aria-hidden="true" tabindex="-1"></a>    output_dir <span class="ot">&lt;-</span> target_dir</span>
<span id="cb20-1193"><a href="#cb20-1193" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1194"><a href="#cb20-1194" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(mdb_file)){</span>
<span id="cb20-1195"><a href="#cb20-1195" aria-hidden="true" tabindex="-1"></a>      <span class="fu">download.file</span>(</span>
<span id="cb20-1196"><a href="#cb20-1196" aria-hidden="true" tabindex="-1"></a>        <span class="st">"https://data.ct.gov/download/vwi6-xdyb/application%2Fx-msaccess"</span>,</span>
<span id="cb20-1197"><a href="#cb20-1197" aria-hidden="true" tabindex="-1"></a>        <span class="at">destfile =</span> <span class="fu">file.path</span>(target_dir, mdb_fname)</span>
<span id="cb20-1198"><a href="#cb20-1198" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb20-1199"><a href="#cb20-1199" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-1200"><a href="#cb20-1200" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1201"><a href="#cb20-1201" aria-hidden="true" tabindex="-1"></a>    tables <span class="ot">&lt;-</span> <span class="fu">system</span>(<span class="fu">paste</span>(<span class="st">"mdb-tables -1"</span>, <span class="fu">shQuote</span>(mdb_file)), <span class="at">intern =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-1202"><a href="#cb20-1202" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1203"><a href="#cb20-1203" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (table_name <span class="cf">in</span> tables) {</span>
<span id="cb20-1204"><a href="#cb20-1204" aria-hidden="true" tabindex="-1"></a>      output_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(output_dir, <span class="fu">paste0</span>(<span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">"_"</span>, table_name), <span class="st">".csv"</span>))</span>
<span id="cb20-1205"><a href="#cb20-1205" aria-hidden="true" tabindex="-1"></a>      cmd <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"mdb-export"</span>, <span class="fu">shQuote</span>(mdb_file), <span class="fu">shQuote</span>(table_name), <span class="st">"&gt;"</span>, <span class="fu">shQuote</span>(output_file))</span>
<span id="cb20-1206"><a href="#cb20-1206" aria-hidden="true" tabindex="-1"></a>      <span class="fu">system</span>(cmd)</span>
<span id="cb20-1207"><a href="#cb20-1207" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-1208"><a href="#cb20-1208" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1209"><a href="#cb20-1209" aria-hidden="true" tabindex="-1"></a>    all_fiscin <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb20-1210"><a href="#cb20-1210" aria-hidden="true" tabindex="-1"></a>    all_fiscin <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(<span class="dv">8</span><span class="sc">:</span><span class="dv">11</span>, <span class="sc">~</span> {</span>
<span id="cb20-1211"><a href="#cb20-1211" aria-hidden="true" tabindex="-1"></a>      <span class="fu">read_csv</span>(<span class="fu">file.path</span>(target_dir, <span class="fu">paste0</span>(<span class="st">"FISCIN"</span>, <span class="fu">sprintf</span>(<span class="st">"%02d"</span>, .x), <span class="st">".csv"</span>)), <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-1212"><a href="#cb20-1212" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rename_with</span>(str_to_lower)</span>
<span id="cb20-1213"><a href="#cb20-1213" aria-hidden="true" tabindex="-1"></a>    }) <span class="sc">|&gt;</span></span>
<span id="cb20-1214"><a href="#cb20-1214" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb20-1215"><a href="#cb20-1215" aria-hidden="true" tabindex="-1"></a>        <span class="at">population =</span> <span class="fu">coalesce</span>(<span class="st">`</span><span class="at">2011 population</span><span class="st">`</span>, <span class="st">`</span><span class="at">2010 population</span><span class="st">`</span>, <span class="st">`</span><span class="at">2009 population</span><span class="st">`</span>, <span class="st">`</span><span class="at">2008 population</span><span class="st">`</span>),</span>
<span id="cb20-1216"><a href="#cb20-1216" aria-hidden="true" tabindex="-1"></a>        <span class="at">moodys_bond_rating =</span> <span class="fu">coalesce</span>(<span class="st">`</span><span class="at">moody's_bond_ratings_july2011</span><span class="st">`</span>, <span class="st">`</span><span class="at">moody's_bond_ratings_july2010</span><span class="st">`</span>, <span class="st">`</span><span class="at">moody's_bond_ratings_july2009</span><span class="st">`</span>, <span class="st">`</span><span class="at">moody's_bond_ratings_july_2008</span><span class="st">`</span>),</span>
<span id="cb20-1217"><a href="#cb20-1217" aria-hidden="true" tabindex="-1"></a>        <span class="at">acglfy =</span> <span class="fu">coalesce</span>(acglfy11, acglfy10, acglfy09, acglfy08),</span>
<span id="cb20-1218"><a href="#cb20-1218" aria-hidden="true" tabindex="-1"></a>        <span class="at">tanf_recipients =</span> <span class="fu">coalesce</span>(<span class="st">`</span><span class="at">tanf11 recipients</span><span class="st">`</span>, <span class="st">`</span><span class="at">tanf10 recipients</span><span class="st">`</span>, <span class="st">`</span><span class="at">tanf09 recipients</span><span class="st">`</span>, <span class="st">`</span><span class="at">tanf08 recipients</span><span class="st">`</span>)</span>
<span id="cb20-1219"><a href="#cb20-1219" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb20-1220"><a href="#cb20-1220" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(</span>
<span id="cb20-1221"><a href="#cb20-1221" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span><span class="fu">matches</span>(<span class="st">"moody's_bond_ratings_july_200"</span>),</span>
<span id="cb20-1222"><a href="#cb20-1222" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span><span class="fu">matches</span>(<span class="st">"moody's_bond_ratings_july20"</span>),</span>
<span id="cb20-1223"><a href="#cb20-1223" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span><span class="st">"2011 population"</span>, <span class="sc">-</span><span class="st">"2010 population"</span>, <span class="sc">-</span><span class="st">"2009 population"</span>, <span class="sc">-</span><span class="st">"2008 population"</span>,</span>
<span id="cb20-1224"><a href="#cb20-1224" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span><span class="fu">matches</span>(<span class="st">"acglfy0"</span>), <span class="sc">-</span><span class="fu">matches</span>(<span class="st">"acglfy1"</span>),</span>
<span id="cb20-1225"><a href="#cb20-1225" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span><span class="fu">matches</span>(<span class="st">"tanf0"</span>), <span class="sc">-</span><span class="fu">matches</span>(<span class="st">"tanf1"</span>)</span>
<span id="cb20-1226"><a href="#cb20-1226" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb20-1227"><a href="#cb20-1227" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename_with</span>(<span class="sc">~</span> .x <span class="sc">|&gt;</span></span>
<span id="cb20-1228"><a href="#cb20-1228" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">str_replace_all</span>(<span class="st">" "</span>, <span class="st">"_"</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-1229"><a href="#cb20-1229" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">str_replace_all</span>(<span class="st">"[^A-Za-z0-9_]"</span>, <span class="st">""</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-1230"><a href="#cb20-1230" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">str_replace_all</span>(<span class="st">"__"</span>, <span class="st">"_"</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-1231"><a href="#cb20-1231" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">str_replace_all</span>(<span class="st">"2011_"</span>, <span class="st">""</span>)) <span class="sc">|&gt;</span></span>
<span id="cb20-1232"><a href="#cb20-1232" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">town =</span> municipality) <span class="sc">|&gt;</span></span>
<span id="cb20-1233"><a href="#cb20-1233" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">town =</span> <span class="fu">str_to_title</span>(town))</span>
<span id="cb20-1234"><a href="#cb20-1234" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1235"><a href="#cb20-1235" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1236"><a href="#cb20-1236" aria-hidden="true" tabindex="-1"></a>    all_gls <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb20-1237"><a href="#cb20-1237" aria-hidden="true" tabindex="-1"></a>    all_acmrs <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb20-1238"><a href="#cb20-1238" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1239"><a href="#cb20-1239" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (year <span class="cf">in</span> <span class="dv">2007</span><span class="sc">:</span><span class="dv">2011</span>) {</span>
<span id="cb20-1240"><a href="#cb20-1240" aria-hidden="true" tabindex="-1"></a>      gl_file_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, <span class="fu">paste0</span>(<span class="st">"NetGL"</span>, year, <span class="st">".csv"</span>))</span>
<span id="cb20-1241"><a href="#cb20-1241" aria-hidden="true" tabindex="-1"></a>      acmr_file_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, <span class="fu">paste0</span>(<span class="st">"ACMR_"</span>, year, <span class="st">"_GL_Year.csv"</span>))</span>
<span id="cb20-1242"><a href="#cb20-1242" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb20-1243"><a href="#cb20-1243" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (year <span class="sc">&lt;=</span> <span class="dv">2008</span>) {</span>
<span id="cb20-1244"><a href="#cb20-1244" aria-hidden="true" tabindex="-1"></a>        df1 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">file.path</span>(target_dir, <span class="st">"NGL_2003-08_GL_Years.csv"</span>), <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-1245"><a href="#cb20-1245" aria-hidden="true" tabindex="-1"></a>          <span class="fu">select</span>(Municipality, Numbered, <span class="fu">matches</span>(<span class="fu">paste0</span>(year, <span class="st">" NGL"</span>))) <span class="sc">|&gt;</span></span>
<span id="cb20-1246"><a href="#cb20-1246" aria-hidden="true" tabindex="-1"></a>          <span class="fu">rename</span>(<span class="at">net_grand_list =</span> <span class="fu">matches</span>(<span class="fu">paste0</span>(year, <span class="st">" NGL"</span>))) <span class="sc">|&gt;</span></span>
<span id="cb20-1247"><a href="#cb20-1247" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(<span class="at">year =</span> year)</span>
<span id="cb20-1248"><a href="#cb20-1248" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">file.exists</span>(gl_file_path)) {</span>
<span id="cb20-1249"><a href="#cb20-1249" aria-hidden="true" tabindex="-1"></a>        df1 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(gl_file_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-1250"><a href="#cb20-1250" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(<span class="at">gl_year =</span> year) <span class="sc">|&gt;</span></span>
<span id="cb20-1251"><a href="#cb20-1251" aria-hidden="true" tabindex="-1"></a>          <span class="fu">rename_with</span>(</span>
<span id="cb20-1252"><a href="#cb20-1252" aria-hidden="true" tabindex="-1"></a>            <span class="sc">~</span> <span class="fu">str_replace</span>(., <span class="st">"Net Grand List.*"</span>, <span class="fu">paste0</span>(<span class="st">"Net Grand List - "</span>, year, <span class="st">" GL Year"</span>)),</span>
<span id="cb20-1253"><a href="#cb20-1253" aria-hidden="true" tabindex="-1"></a>            <span class="fu">matches</span>(<span class="st">"Net Grand List"</span>)</span>
<span id="cb20-1254"><a href="#cb20-1254" aria-hidden="true" tabindex="-1"></a>          ) <span class="sc">|&gt;</span></span>
<span id="cb20-1255"><a href="#cb20-1255" aria-hidden="true" tabindex="-1"></a>          <span class="fu">pivot_longer</span>(</span>
<span id="cb20-1256"><a href="#cb20-1256" aria-hidden="true" tabindex="-1"></a>            <span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"Net Grand List"</span>),</span>
<span id="cb20-1257"><a href="#cb20-1257" aria-hidden="true" tabindex="-1"></a>            <span class="at">names_to =</span> <span class="st">"gl_year_label"</span>,</span>
<span id="cb20-1258"><a href="#cb20-1258" aria-hidden="true" tabindex="-1"></a>            <span class="at">values_to =</span> <span class="st">"net_grand_list"</span></span>
<span id="cb20-1259"><a href="#cb20-1259" aria-hidden="true" tabindex="-1"></a>          ) <span class="sc">|&gt;</span></span>
<span id="cb20-1260"><a href="#cb20-1260" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(<span class="at">gl_year =</span> <span class="fu">as.integer</span>(<span class="fu">str_extract</span>(gl_year_label, <span class="st">"</span><span class="sc">\\</span><span class="st">d{4}"</span>))) <span class="sc">|&gt;</span></span>
<span id="cb20-1261"><a href="#cb20-1261" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(net_grand_list))</span>
<span id="cb20-1262"><a href="#cb20-1262" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb20-1263"><a href="#cb20-1263" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb20-1264"><a href="#cb20-1264" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"df1"</span>)) {</span>
<span id="cb20-1265"><a href="#cb20-1265" aria-hidden="true" tabindex="-1"></a>        all_gls <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(all_gls, df1 <span class="sc">|&gt;</span> <span class="fu">rename_with</span>(tolower))</span>
<span id="cb20-1266"><a href="#cb20-1266" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rm</span>(df1)</span>
<span id="cb20-1267"><a href="#cb20-1267" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb20-1268"><a href="#cb20-1268" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb20-1269"><a href="#cb20-1269" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">file.exists</span>(acmr_file_path)) {</span>
<span id="cb20-1270"><a href="#cb20-1270" aria-hidden="true" tabindex="-1"></a>        df2 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(acmr_file_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-1271"><a href="#cb20-1271" aria-hidden="true" tabindex="-1"></a>          <span class="fu">rename_with</span>(<span class="sc">~</span> <span class="st">"millrate"</span>, <span class="at">.cols =</span> <span class="fu">matches</span>(<span class="st">"Mil Rates|Mill Rates"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb20-1272"><a href="#cb20-1272" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(<span class="at">year =</span> year)</span>
<span id="cb20-1273"><a href="#cb20-1273" aria-hidden="true" tabindex="-1"></a>        all_acmrs <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(all_acmrs, df2 <span class="sc">|&gt;</span> <span class="fu">rename_with</span>(tolower))</span>
<span id="cb20-1274"><a href="#cb20-1274" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb20-1275"><a href="#cb20-1275" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-1276"><a href="#cb20-1276" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1277"><a href="#cb20-1277" aria-hidden="true" tabindex="-1"></a>    all_gls <span class="ot">&lt;-</span> all_gls <span class="sc">|&gt;</span></span>
<span id="cb20-1278"><a href="#cb20-1278" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">if_else</span>(<span class="sc">!</span><span class="fu">is.na</span>(gl_year), gl_year, year)) <span class="sc">|&gt;</span></span>
<span id="cb20-1279"><a href="#cb20-1279" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(gl_year_label, gl_year)) <span class="sc">|&gt;</span></span>
<span id="cb20-1280"><a href="#cb20-1280" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">town =</span> municipality) <span class="sc">|&gt;</span></span>
<span id="cb20-1281"><a href="#cb20-1281" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">town =</span> <span class="fu">str_to_title</span>(town))</span>
<span id="cb20-1282"><a href="#cb20-1282" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1283"><a href="#cb20-1283" aria-hidden="true" tabindex="-1"></a>    all_acmrs <span class="ot">&lt;-</span> all_acmrs <span class="sc">|&gt;</span></span>
<span id="cb20-1284"><a href="#cb20-1284" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">town =</span> municipality) <span class="sc">|&gt;</span></span>
<span id="cb20-1285"><a href="#cb20-1285" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">town =</span> <span class="fu">str_to_title</span>(town))</span>
<span id="cb20-1286"><a href="#cb20-1286" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1287"><a href="#cb20-1287" aria-hidden="true" tabindex="-1"></a>    ct_towns_counties <span class="ot">&lt;-</span> <span class="fu">load_ct_town_mapping</span>()</span>
<span id="cb20-1288"><a href="#cb20-1288" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1289"><a href="#cb20-1289" aria-hidden="true" tabindex="-1"></a>    final <span class="ot">&lt;-</span> <span class="fu">inner_join</span>(all_gls, all_acmrs, <span class="fu">join_by</span>(town <span class="sc">==</span> town, year <span class="sc">==</span> year)) <span class="sc">|&gt;</span></span>
<span id="cb20-1290"><a href="#cb20-1290" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">property_tax_revenue =</span> (millrate <span class="sc">/</span> <span class="dv">1000</span>) <span class="sc">*</span> net_grand_list) <span class="sc">|&gt;</span></span>
<span id="cb20-1291"><a href="#cb20-1291" aria-hidden="true" tabindex="-1"></a>      <span class="fu">inner_join</span>(all_fiscin, <span class="fu">join_by</span>(town <span class="sc">==</span> town, year <span class="sc">==</span> fisc_year_end)) <span class="sc">|&gt;</span></span>
<span id="cb20-1292"><a href="#cb20-1292" aria-hidden="true" tabindex="-1"></a>      <span class="fu">inner_join</span>(ct_towns_counties <span class="sc">|&gt;</span> <span class="fu">rename</span>(<span class="at">county =</span> County) <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="st">"Town name"</span>, county), <span class="fu">join_by</span>(town <span class="sc">==</span> <span class="st">"Town name"</span>))</span>
<span id="cb20-1293"><a href="#cb20-1293" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1294"><a href="#cb20-1294" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(final, f_path)</span>
<span id="cb20-1295"><a href="#cb20-1295" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb20-1296"><a href="#cb20-1296" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Reading existing data from CSV..."</span>)</span>
<span id="cb20-1297"><a href="#cb20-1297" aria-hidden="true" tabindex="-1"></a>    final <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(f_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb20-1298"><a href="#cb20-1298" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-1299"><a href="#cb20-1299" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-1300"><a href="#cb20-1300" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(final)</span>
<span id="cb20-1301"><a href="#cb20-1301" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-1302"><a href="#cb20-1302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1303"><a href="#cb20-1303" aria-hidden="true" tabindex="-1"></a><span class="co">#' Load and Clean CT Municipal Fiscal Indicators (2007–2012)</span></span>
<span id="cb20-1304"><a href="#cb20-1304" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-1305"><a href="#cb20-1305" aria-hidden="true" tabindex="-1"></a><span class="co">#' This function downloads, cleans, and formats Connecticut municipal fiscal indicators data</span></span>
<span id="cb20-1306"><a href="#cb20-1306" aria-hidden="true" tabindex="-1"></a><span class="co">#' for the years 2007 to 2012 from a public JSON API provided by the state. It saves the</span></span>
<span id="cb20-1307"><a href="#cb20-1307" aria-hidden="true" tabindex="-1"></a><span class="co">#' cleaned data to disk to avoid redundant downloads and processing in future runs.</span></span>
<span id="cb20-1308"><a href="#cb20-1308" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-1309"><a href="#cb20-1309" aria-hidden="true" tabindex="-1"></a><span class="co">#' Steps performed:</span></span>
<span id="cb20-1310"><a href="#cb20-1310" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Downloads JSON data if a local CSV file does not already exist.</span></span>
<span id="cb20-1311"><a href="#cb20-1311" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Cleans non-numeric fields and coerces them into numeric types.</span></span>
<span id="cb20-1312"><a href="#cb20-1312" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Standardizes town names and joins them with county mapping data.</span></span>
<span id="cb20-1313"><a href="#cb20-1313" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Calculates derived variables (e.g., property tax revenues).</span></span>
<span id="cb20-1314"><a href="#cb20-1314" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Filters out aggregate rows (e.g., "Statewide").</span></span>
<span id="cb20-1315"><a href="#cb20-1315" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Saves the cleaned data to a CSV file for future use.</span></span>
<span id="cb20-1316"><a href="#cb20-1316" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-1317"><a href="#cb20-1317" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A cleaned and joined data.frame (tibble) containing fiscal indicators</span></span>
<span id="cb20-1318"><a href="#cb20-1318" aria-hidden="true" tabindex="-1"></a><span class="co">#' for CT municipalities, including town, county, fiscal year, and tax data.</span></span>
<span id="cb20-1319"><a href="#cb20-1319" aria-hidden="true" tabindex="-1"></a><span class="co">#' @import dplyr, readr, httr, jsonlite, stringr</span></span>
<span id="cb20-1320"><a href="#cb20-1320" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb20-1321"><a href="#cb20-1321" aria-hidden="true" tabindex="-1"></a>load_MFI_2007_2012_data <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb20-1322"><a href="#cb20-1322" aria-hidden="true" tabindex="-1"></a>  target_dir <span class="ot">&lt;-</span> <span class="st">'data/individual_report/2007-2012'</span></span>
<span id="cb20-1323"><a href="#cb20-1323" aria-hidden="true" tabindex="-1"></a>  f_name <span class="ot">&lt;-</span> <span class="st">"ct_municipal_fiscal_indicators_2007_2012.csv"</span></span>
<span id="cb20-1324"><a href="#cb20-1324" aria-hidden="true" tabindex="-1"></a>  f_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, f_name)</span>
<span id="cb20-1325"><a href="#cb20-1325" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-1326"><a href="#cb20-1326" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(target_dir)) {</span>
<span id="cb20-1327"><a href="#cb20-1327" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(target_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-1328"><a href="#cb20-1328" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-1329"><a href="#cb20-1329" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-1330"><a href="#cb20-1330" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(f_path)) {</span>
<span id="cb20-1331"><a href="#cb20-1331" aria-hidden="true" tabindex="-1"></a>    clean_numeric <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb20-1332"><a href="#cb20-1332" aria-hidden="true" tabindex="-1"></a>      x <span class="sc">|&gt;</span></span>
<span id="cb20-1333"><a href="#cb20-1333" aria-hidden="true" tabindex="-1"></a>        <span class="fu">str_replace_all</span>(<span class="st">"[^0-9.-]"</span>, <span class="st">""</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-1334"><a href="#cb20-1334" aria-hidden="true" tabindex="-1"></a>        <span class="fu">as.numeric</span>()</span>
<span id="cb20-1335"><a href="#cb20-1335" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-1336"><a href="#cb20-1336" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1337"><a href="#cb20-1337" aria-hidden="true" tabindex="-1"></a>    base_url <span class="ot">&lt;-</span> <span class="st">"https://data.ct.gov/resource/h7h2-manp.json"</span></span>
<span id="cb20-1338"><a href="#cb20-1338" aria-hidden="true" tabindex="-1"></a>    full_url <span class="ot">&lt;-</span> <span class="fu">paste0</span>(base_url, <span class="st">"?$limit=2000"</span>)</span>
<span id="cb20-1339"><a href="#cb20-1339" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1340"><a href="#cb20-1340" aria-hidden="true" tabindex="-1"></a>    response <span class="ot">&lt;-</span> <span class="fu">GET</span>(full_url)</span>
<span id="cb20-1341"><a href="#cb20-1341" aria-hidden="true" tabindex="-1"></a>    ct_revenue_data <span class="ot">&lt;-</span> jsonlite<span class="sc">::</span><span class="fu">fromJSON</span>(<span class="fu">content</span>(response, <span class="at">as =</span> <span class="st">"text"</span>)) <span class="sc">|&gt;</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb20-1342"><a href="#cb20-1342" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1343"><a href="#cb20-1343" aria-hidden="true" tabindex="-1"></a>    ct_towns_counties <span class="ot">&lt;-</span> <span class="fu">load_ct_town_mapping</span>()</span>
<span id="cb20-1344"><a href="#cb20-1344" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1345"><a href="#cb20-1345" aria-hidden="true" tabindex="-1"></a>    ct_revenue_data <span class="ot">&lt;-</span> ct_revenue_data <span class="sc">|&gt;</span></span>
<span id="cb20-1346"><a href="#cb20-1346" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb20-1347"><a href="#cb20-1347" aria-hidden="true" tabindex="-1"></a>        <span class="at">town =</span> <span class="fu">str_to_title</span>(municipality),</span>
<span id="cb20-1348"><a href="#cb20-1348" aria-hidden="true" tabindex="-1"></a>        <span class="at">town =</span> <span class="fu">if_else</span>(town <span class="sc">==</span> <span class="st">"Groton (City Of)"</span>, <span class="st">"Groton"</span>, town)</span>
<span id="cb20-1349"><a href="#cb20-1349" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb20-1350"><a href="#cb20-1350" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span>municipality) <span class="sc">|&gt;</span></span>
<span id="cb20-1351"><a href="#cb20-1351" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb20-1352"><a href="#cb20-1352" aria-hidden="true" tabindex="-1"></a>        <span class="at">fisc_year_end =</span> <span class="fu">str_trim</span>(fisc_year_end),</span>
<span id="cb20-1353"><a href="#cb20-1353" aria-hidden="true" tabindex="-1"></a>        <span class="at">fiscal_year_end =</span> <span class="fu">as.double</span>(fisc_year_end)</span>
<span id="cb20-1354"><a href="#cb20-1354" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb20-1355"><a href="#cb20-1355" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span>fisc_year_end) <span class="sc">|&gt;</span></span>
<span id="cb20-1356"><a href="#cb20-1356" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb20-1357"><a href="#cb20-1357" aria-hidden="true" tabindex="-1"></a>        <span class="fu">across</span>(</span>
<span id="cb20-1358"><a href="#cb20-1358" aria-hidden="true" tabindex="-1"></a>          <span class="at">.cols =</span> <span class="sc">-</span><span class="fu">c</span>(fiscal_year_end, town, initials, county_identifier),</span>
<span id="cb20-1359"><a href="#cb20-1359" aria-hidden="true" tabindex="-1"></a>          <span class="at">.fns =</span> <span class="sc">~</span> {</span>
<span id="cb20-1360"><a href="#cb20-1360" aria-hidden="true" tabindex="-1"></a>            num_check <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(.))</span>
<span id="cb20-1361"><a href="#cb20-1361" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(<span class="fu">is.na</span>(num_check))) <span class="fu">clean_numeric</span>(.) <span class="cf">else</span> .</span>
<span id="cb20-1362"><a href="#cb20-1362" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb20-1363"><a href="#cb20-1363" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb20-1364"><a href="#cb20-1364" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb20-1365"><a href="#cb20-1365" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb20-1366"><a href="#cb20-1366" aria-hidden="true" tabindex="-1"></a>        <span class="at">property_tax_revenues =</span> <span class="fu">as.numeric</span>(egl) <span class="sc">*</span> (<span class="fu">as.numeric</span>(acmr) <span class="sc">/</span> <span class="dv">1000</span>)</span>
<span id="cb20-1367"><a href="#cb20-1367" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb20-1368"><a href="#cb20-1368" aria-hidden="true" tabindex="-1"></a>      <span class="fu">left_join</span>(</span>
<span id="cb20-1369"><a href="#cb20-1369" aria-hidden="true" tabindex="-1"></a>        ct_towns_counties <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="st">`</span><span class="at">Town name</span><span class="st">`</span>, County),</span>
<span id="cb20-1370"><a href="#cb20-1370" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"town"</span> <span class="ot">=</span> <span class="st">"Town name"</span>)</span>
<span id="cb20-1371"><a href="#cb20-1371" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb20-1372"><a href="#cb20-1372" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb20-1373"><a href="#cb20-1373" aria-hidden="true" tabindex="-1"></a>        <span class="fu">across</span>(</span>
<span id="cb20-1374"><a href="#cb20-1374" aria-hidden="true" tabindex="-1"></a>          <span class="fu">where</span>(<span class="sc">~</span> <span class="fu">is.character</span>(.) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">anyNA</span>(<span class="fu">suppressWarnings</span>(<span class="fu">as.numeric</span>(.)))),</span>
<span id="cb20-1375"><a href="#cb20-1375" aria-hidden="true" tabindex="-1"></a>          <span class="sc">~</span> <span class="fu">as.numeric</span>(.)</span>
<span id="cb20-1376"><a href="#cb20-1376" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb20-1377"><a href="#cb20-1377" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb20-1378"><a href="#cb20-1378" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(town <span class="sc">!=</span> <span class="st">"Statewide"</span>)</span>
<span id="cb20-1379"><a href="#cb20-1379" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1380"><a href="#cb20-1380" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(ct_revenue_data, f_path)</span>
<span id="cb20-1381"><a href="#cb20-1381" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb20-1382"><a href="#cb20-1382" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Reading existing data from CSV..."</span>)</span>
<span id="cb20-1383"><a href="#cb20-1383" aria-hidden="true" tabindex="-1"></a>    ct_revenue_data <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(f_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb20-1384"><a href="#cb20-1384" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-1385"><a href="#cb20-1385" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-1386"><a href="#cb20-1386" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(ct_revenue_data)</span>
<span id="cb20-1387"><a href="#cb20-1387" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-1388"><a href="#cb20-1388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1389"><a href="#cb20-1389" aria-hidden="true" tabindex="-1"></a><span class="co">#' Load and Process CT Municipal Fiscal Indicators (2011–2015)</span></span>
<span id="cb20-1390"><a href="#cb20-1390" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-1391"><a href="#cb20-1391" aria-hidden="true" tabindex="-1"></a><span class="co">#' This function downloads, extracts, and processes Connecticut municipal fiscal indicators data</span></span>
<span id="cb20-1392"><a href="#cb20-1392" aria-hidden="true" tabindex="-1"></a><span class="co">#' for the years 2011–2015. The data is retrieved from a ZIP archive containing an Access (.mdb) database.</span></span>
<span id="cb20-1393"><a href="#cb20-1393" aria-hidden="true" tabindex="-1"></a><span class="co">#' It extracts multiple tables, merges key indicators (e.g., population, TANF recipients, Moody's bond ratings,</span></span>
<span id="cb20-1394"><a href="#cb20-1394" aria-hidden="true" tabindex="-1"></a><span class="co">#' net assets), and computes derived metrics such as property tax revenue. The processed dataset is saved</span></span>
<span id="cb20-1395"><a href="#cb20-1395" aria-hidden="true" tabindex="-1"></a><span class="co">#' as a CSV file for future use to avoid repeated downloading and processing.</span></span>
<span id="cb20-1396"><a href="#cb20-1396" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-1397"><a href="#cb20-1397" aria-hidden="true" tabindex="-1"></a><span class="co">#' Processing steps include:</span></span>
<span id="cb20-1398"><a href="#cb20-1398" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Downloading and unzipping MDB archive from a public data portal if not already present</span></span>
<span id="cb20-1399"><a href="#cb20-1399" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Extracting all tables from the Access database using mdb-tools</span></span>
<span id="cb20-1400"><a href="#cb20-1400" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Cleaning and combining fiscal data (FISCIN tables from 2010–2015)</span></span>
<span id="cb20-1401"><a href="#cb20-1401" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Combining Net Grand List and mill rate (ACMR) tables from 2009–2015</span></span>
<span id="cb20-1402"><a href="#cb20-1402" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Computing `property_tax_revenue` from Net Grand List and mill rate</span></span>
<span id="cb20-1403"><a href="#cb20-1403" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Standardizing and coalescing fiscal year and town-level indicators</span></span>
<span id="cb20-1404"><a href="#cb20-1404" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Merging with a town-to-county mapping dataset</span></span>
<span id="cb20-1405"><a href="#cb20-1405" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-1406"><a href="#cb20-1406" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A cleaned and joined `data.frame` (tibble) containing town-level fiscal, demographic, and revenue data</span></span>
<span id="cb20-1407"><a href="#cb20-1407" aria-hidden="true" tabindex="-1"></a><span class="co">#'         for CT municipalities from 2011 to 2015, including columns such as `town`, `year`, `population`,</span></span>
<span id="cb20-1408"><a href="#cb20-1408" aria-hidden="true" tabindex="-1"></a><span class="co">#'         `net_grand_list`, `millrate`, `property_tax_revenue`, `moodys_bond_rating`, `tanf_recipients`, and `county`.</span></span>
<span id="cb20-1409"><a href="#cb20-1409" aria-hidden="true" tabindex="-1"></a><span class="co">#' @import dplyr, readr, tidyr, stringr</span></span>
<span id="cb20-1410"><a href="#cb20-1410" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb20-1411"><a href="#cb20-1411" aria-hidden="true" tabindex="-1"></a>load_MFI_2011_2015_data <span class="ot">&lt;-</span> <span class="cf">function</span>(){</span>
<span id="cb20-1412"><a href="#cb20-1412" aria-hidden="true" tabindex="-1"></a>  target_dir <span class="ot">&lt;-</span> <span class="st">'data/individual_report/2011-2015'</span></span>
<span id="cb20-1413"><a href="#cb20-1413" aria-hidden="true" tabindex="-1"></a>  f_name <span class="ot">&lt;-</span> <span class="st">"ct_municipal_fiscal_indicators_2011_2015.csv"</span></span>
<span id="cb20-1414"><a href="#cb20-1414" aria-hidden="true" tabindex="-1"></a>  f_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, f_name)</span>
<span id="cb20-1415"><a href="#cb20-1415" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-1416"><a href="#cb20-1416" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(target_dir)){</span>
<span id="cb20-1417"><a href="#cb20-1417" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(target_dir, <span class="at">recursive=</span><span class="cn">TRUE</span>)</span>
<span id="cb20-1418"><a href="#cb20-1418" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-1419"><a href="#cb20-1419" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-1420"><a href="#cb20-1420" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(f_path)){</span>
<span id="cb20-1421"><a href="#cb20-1421" aria-hidden="true" tabindex="-1"></a>    mdb_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, <span class="st">"MuniFiscalIndicators_11_15.mdb"</span>)</span>
<span id="cb20-1422"><a href="#cb20-1422" aria-hidden="true" tabindex="-1"></a>    output_dir <span class="ot">&lt;-</span> target_dir</span>
<span id="cb20-1423"><a href="#cb20-1423" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1424"><a href="#cb20-1424" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(<span class="fu">file.path</span>(target_dir, <span class="st">"2011-2015.zip"</span>))){</span>
<span id="cb20-1425"><a href="#cb20-1425" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Define the URL</span></span>
<span id="cb20-1426"><a href="#cb20-1426" aria-hidden="true" tabindex="-1"></a>      <span class="fu">download.file</span>(<span class="st">"https://data.ct.gov/download/uij9-wzqw/application%2Fzip"</span>, <span class="at">destfile =</span> <span class="fu">file.path</span>(target_dir, <span class="st">"2011-2015.zip"</span>))</span>
<span id="cb20-1427"><a href="#cb20-1427" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-1428"><a href="#cb20-1428" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1429"><a href="#cb20-1429" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unzip</span>(<span class="fu">file.path</span>(target_dir, <span class="st">"2011-2015.zip"</span>),<span class="at">exdir =</span> <span class="fu">file.path</span>(target_dir))</span>
<span id="cb20-1430"><a href="#cb20-1430" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1431"><a href="#cb20-1431" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ensure_mdbtools</span>()</span>
<span id="cb20-1432"><a href="#cb20-1432" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1433"><a href="#cb20-1433" aria-hidden="true" tabindex="-1"></a>    <span class="co"># List all table names in the MDB file</span></span>
<span id="cb20-1434"><a href="#cb20-1434" aria-hidden="true" tabindex="-1"></a>    tables <span class="ot">&lt;-</span> <span class="fu">system</span>(<span class="fu">paste</span>(<span class="st">"mdb-tables -1"</span>, <span class="fu">shQuote</span>(mdb_file)), <span class="at">intern =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-1435"><a href="#cb20-1435" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1436"><a href="#cb20-1436" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Loop through each table and export to CSV</span></span>
<span id="cb20-1437"><a href="#cb20-1437" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (table_name <span class="cf">in</span> tables) {</span>
<span id="cb20-1438"><a href="#cb20-1438" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Clean up table name for file output (e.g., replace spaces with underscores)</span></span>
<span id="cb20-1439"><a href="#cb20-1439" aria-hidden="true" tabindex="-1"></a>      output_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(output_dir, <span class="fu">paste0</span>(<span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">"_"</span>, table_name), <span class="st">".csv"</span>))</span>
<span id="cb20-1440"><a href="#cb20-1440" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb20-1441"><a href="#cb20-1441" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Construct and run the export command</span></span>
<span id="cb20-1442"><a href="#cb20-1442" aria-hidden="true" tabindex="-1"></a>      cmd <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"mdb-export"</span>, <span class="fu">shQuote</span>(mdb_file), <span class="fu">shQuote</span>(table_name), <span class="st">"&gt;"</span>, <span class="fu">shQuote</span>(output_file))</span>
<span id="cb20-1443"><a href="#cb20-1443" aria-hidden="true" tabindex="-1"></a>      <span class="fu">system</span>(cmd)</span>
<span id="cb20-1444"><a href="#cb20-1444" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-1445"><a href="#cb20-1445" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1446"><a href="#cb20-1446" aria-hidden="true" tabindex="-1"></a>    all_fiscin <span class="ot">=</span> <span class="fu">data.frame</span>()</span>
<span id="cb20-1447"><a href="#cb20-1447" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1448"><a href="#cb20-1448" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (y <span class="cf">in</span> <span class="dv">10</span><span class="sc">:</span><span class="dv">15</span>){</span>
<span id="cb20-1449"><a href="#cb20-1449" aria-hidden="true" tabindex="-1"></a>      fiscin_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir,<span class="fu">paste0</span>(<span class="st">"FISCIN"</span>,<span class="fu">sprintf</span>(<span class="st">"%02d"</span>, y),<span class="st">".csv"</span>))</span>
<span id="cb20-1450"><a href="#cb20-1450" aria-hidden="true" tabindex="-1"></a>      df <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(fiscin_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-1451"><a href="#cb20-1451" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rename_with</span>(str_to_lower)</span>
<span id="cb20-1452"><a href="#cb20-1452" aria-hidden="true" tabindex="-1"></a>      all_fiscin <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(all_fiscin, df)</span>
<span id="cb20-1453"><a href="#cb20-1453" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-1454"><a href="#cb20-1454" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1455"><a href="#cb20-1455" aria-hidden="true" tabindex="-1"></a>    all_fiscin <span class="ot">&lt;-</span> </span>
<span id="cb20-1456"><a href="#cb20-1456" aria-hidden="true" tabindex="-1"></a>      all_fiscin <span class="sc">|&gt;</span></span>
<span id="cb20-1457"><a href="#cb20-1457" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb20-1458"><a href="#cb20-1458" aria-hidden="true" tabindex="-1"></a>        <span class="at">population =</span> <span class="fu">coalesce</span>(</span>
<span id="cb20-1459"><a href="#cb20-1459" aria-hidden="true" tabindex="-1"></a>          <span class="st">`</span><span class="at">2015 population</span><span class="st">`</span>, <span class="st">`</span><span class="at">2014 population</span><span class="st">`</span>, <span class="st">`</span><span class="at">2013 population</span><span class="st">`</span>, <span class="st">`</span><span class="at">2012 population</span><span class="st">`</span>,</span>
<span id="cb20-1460"><a href="#cb20-1460" aria-hidden="true" tabindex="-1"></a>          <span class="st">`</span><span class="at">2011 population</span><span class="st">`</span>, <span class="st">`</span><span class="at">2010 population</span><span class="st">`</span></span>
<span id="cb20-1461"><a href="#cb20-1461" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb20-1462"><a href="#cb20-1462" aria-hidden="true" tabindex="-1"></a>        <span class="at">moodys_bond_rating =</span> <span class="fu">coalesce</span>(</span>
<span id="cb20-1463"><a href="#cb20-1463" aria-hidden="true" tabindex="-1"></a>          <span class="st">`</span><span class="at">moody's_bond_ratings_nov_2016</span><span class="st">`</span>, <span class="st">`</span><span class="at">moody's_bond_ratings_july_2015</span><span class="st">`</span>,</span>
<span id="cb20-1464"><a href="#cb20-1464" aria-hidden="true" tabindex="-1"></a>          <span class="st">`</span><span class="at">moody's_bond_ratings_dec_2014</span><span class="st">`</span>, <span class="st">`</span><span class="at">moody's_bond_ratings_july_2014</span><span class="st">`</span>,</span>
<span id="cb20-1465"><a href="#cb20-1465" aria-hidden="true" tabindex="-1"></a>          <span class="st">`</span><span class="at">moody's_bond_ratings_july_2013</span><span class="st">`</span>, <span class="st">`</span><span class="at">moody's_bond_ratings_july2012</span><span class="st">`</span>,</span>
<span id="cb20-1466"><a href="#cb20-1466" aria-hidden="true" tabindex="-1"></a>          <span class="st">`</span><span class="at">moody's_bond_ratings_july2011</span><span class="st">`</span>, <span class="st">`</span><span class="at">moody's_bond_ratings_july2010</span><span class="st">`</span></span>
<span id="cb20-1467"><a href="#cb20-1467" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb20-1468"><a href="#cb20-1468" aria-hidden="true" tabindex="-1"></a>        <span class="at">acglfy =</span> <span class="fu">coalesce</span>(acglfy15, acglfy14, acglfy13, acglfy12, acglfy11, acglfy10),</span>
<span id="cb20-1469"><a href="#cb20-1469" aria-hidden="true" tabindex="-1"></a>        <span class="at">tanf_recipients =</span> <span class="fu">coalesce</span>(</span>
<span id="cb20-1470"><a href="#cb20-1470" aria-hidden="true" tabindex="-1"></a>          <span class="st">`</span><span class="at">tanf15 recipients</span><span class="st">`</span>, <span class="st">`</span><span class="at">tanf14 recipients</span><span class="st">`</span>, <span class="st">`</span><span class="at">tanf13 recipients</span><span class="st">`</span>, <span class="st">`</span><span class="at">tanf12 recipients</span><span class="st">`</span>,</span>
<span id="cb20-1471"><a href="#cb20-1471" aria-hidden="true" tabindex="-1"></a>          <span class="st">`</span><span class="at">tanf11 recipients</span><span class="st">`</span>, <span class="st">`</span><span class="at">tanf10 recipients</span><span class="st">`</span></span>
<span id="cb20-1472"><a href="#cb20-1472" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb20-1473"><a href="#cb20-1473" aria-hidden="true" tabindex="-1"></a>        <span class="at">net_assets =</span> <span class="fu">coalesce</span>(<span class="st">`</span><span class="at">total net assets</span><span class="st">`</span>, <span class="st">`</span><span class="at">total net position</span><span class="st">`</span>),</span>
<span id="cb20-1474"><a href="#cb20-1474" aria-hidden="true" tabindex="-1"></a>        <span class="at">change_in_net_assets =</span> <span class="fu">coalesce</span>(<span class="st">`</span><span class="at">change in net assets</span><span class="st">`</span>, <span class="st">`</span><span class="at">change in net position</span><span class="st">`</span>),</span>
<span id="cb20-1475"><a href="#cb20-1475" aria-hidden="true" tabindex="-1"></a>        <span class="at">unrestricted_net =</span> <span class="fu">coalesce</span>(<span class="st">`</span><span class="at">unrestricted net assets</span><span class="st">`</span>, <span class="st">`</span><span class="at">unrestricted net position</span><span class="st">`</span>),</span>
<span id="cb20-1476"><a href="#cb20-1476" aria-hidden="true" tabindex="-1"></a>        <span class="at">invested_in_capital =</span> <span class="fu">coalesce</span>(</span>
<span id="cb20-1477"><a href="#cb20-1477" aria-hidden="true" tabindex="-1"></a>          <span class="st">`</span><span class="at">invested in capital assets net of related debt</span><span class="st">`</span>,</span>
<span id="cb20-1478"><a href="#cb20-1478" aria-hidden="true" tabindex="-1"></a>          <span class="st">`</span><span class="at">net investment in capital assets</span><span class="st">`</span></span>
<span id="cb20-1479"><a href="#cb20-1479" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb20-1480"><a href="#cb20-1480" aria-hidden="true" tabindex="-1"></a>        <span class="at">restatement =</span> <span class="fu">coalesce</span>(</span>
<span id="cb20-1481"><a href="#cb20-1481" aria-hidden="true" tabindex="-1"></a>          <span class="st">`</span><span class="at">restatement (y or n)</span><span class="st">`</span>,</span>
<span id="cb20-1482"><a href="#cb20-1482" aria-hidden="true" tabindex="-1"></a>          <span class="st">`</span><span class="at">restatement of fund balance (y or n)</span><span class="st">`</span></span>
<span id="cb20-1483"><a href="#cb20-1483" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb20-1484"><a href="#cb20-1484" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb20-1485"><a href="#cb20-1485" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(</span>
<span id="cb20-1486"><a href="#cb20-1486" aria-hidden="true" tabindex="-1"></a>        <span class="fu">matches</span>(<span class="st">"^20</span><span class="sc">\\</span><span class="st">d{2} population$"</span>),</span>
<span id="cb20-1487"><a href="#cb20-1487" aria-hidden="true" tabindex="-1"></a>        <span class="fu">matches</span>(<span class="st">"moody's_bond_ratings"</span>),</span>
<span id="cb20-1488"><a href="#cb20-1488" aria-hidden="true" tabindex="-1"></a>        <span class="fu">matches</span>(<span class="st">"^acglfy</span><span class="sc">\\</span><span class="st">d{2}$"</span>),</span>
<span id="cb20-1489"><a href="#cb20-1489" aria-hidden="true" tabindex="-1"></a>        <span class="fu">matches</span>(<span class="st">"^tanf</span><span class="sc">\\</span><span class="st">d{2} recipients$"</span>),</span>
<span id="cb20-1490"><a href="#cb20-1490" aria-hidden="true" tabindex="-1"></a>        <span class="st">"total net assets"</span>, <span class="st">"total net position"</span>,</span>
<span id="cb20-1491"><a href="#cb20-1491" aria-hidden="true" tabindex="-1"></a>        <span class="st">"change in net assets"</span>, <span class="st">"change in net position"</span>,</span>
<span id="cb20-1492"><a href="#cb20-1492" aria-hidden="true" tabindex="-1"></a>        <span class="st">"unrestricted net assets"</span>, <span class="st">"unrestricted net position"</span>,</span>
<span id="cb20-1493"><a href="#cb20-1493" aria-hidden="true" tabindex="-1"></a>        <span class="st">"invested in capital assets net of related debt"</span>, <span class="st">"net investment in capital assets"</span>,</span>
<span id="cb20-1494"><a href="#cb20-1494" aria-hidden="true" tabindex="-1"></a>        <span class="st">"restatement (y or n)"</span>, <span class="st">"restatement of fund balance (y or n)"</span></span>
<span id="cb20-1495"><a href="#cb20-1495" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb20-1496"><a href="#cb20-1496" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span> </span>
<span id="cb20-1497"><a href="#cb20-1497" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename_with</span>(<span class="sc">~</span> .x <span class="sc">|&gt;</span></span>
<span id="cb20-1498"><a href="#cb20-1498" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">str_replace_all</span>(<span class="st">" "</span>, <span class="st">"_"</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-1499"><a href="#cb20-1499" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">str_replace_all</span>(<span class="st">"[^A-Za-z0-9_]"</span>, <span class="st">""</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-1500"><a href="#cb20-1500" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">str_replace_all</span>(<span class="st">"__"</span>, <span class="st">"_"</span>)</span>
<span id="cb20-1501"><a href="#cb20-1501" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span> </span>
<span id="cb20-1502"><a href="#cb20-1502" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">town =</span> municipality) <span class="sc">|&gt;</span></span>
<span id="cb20-1503"><a href="#cb20-1503" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb20-1504"><a href="#cb20-1504" aria-hidden="true" tabindex="-1"></a>        <span class="at">town =</span> <span class="fu">str_to_title</span>(town),</span>
<span id="cb20-1505"><a href="#cb20-1505" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb20-1506"><a href="#cb20-1506" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1507"><a href="#cb20-1507" aria-hidden="true" tabindex="-1"></a>    all_gls <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb20-1508"><a href="#cb20-1508" aria-hidden="true" tabindex="-1"></a>    all_acmrs <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb20-1509"><a href="#cb20-1509" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1510"><a href="#cb20-1510" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (year <span class="cf">in</span> <span class="fu">c</span>(<span class="dv">2009</span><span class="sc">:</span><span class="dv">2015</span>)){</span>
<span id="cb20-1511"><a href="#cb20-1511" aria-hidden="true" tabindex="-1"></a>      gl_file_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, <span class="fu">paste0</span>(<span class="st">"NetGL"</span>, year, <span class="st">".csv"</span>))</span>
<span id="cb20-1512"><a href="#cb20-1512" aria-hidden="true" tabindex="-1"></a>      acmr_file_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, <span class="fu">paste0</span>(<span class="st">"ACMR_"</span>, year, <span class="st">"_GL_Year.csv"</span>))</span>
<span id="cb20-1513"><a href="#cb20-1513" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb20-1514"><a href="#cb20-1514" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">file.exists</span>(gl_file_path)){</span>
<span id="cb20-1515"><a href="#cb20-1515" aria-hidden="true" tabindex="-1"></a>        df1 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(gl_file_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-1516"><a href="#cb20-1516" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(<span class="at">gl_year =</span> year) <span class="sc">|&gt;</span> </span>
<span id="cb20-1517"><a href="#cb20-1517" aria-hidden="true" tabindex="-1"></a>          <span class="fu">rename_with</span>(</span>
<span id="cb20-1518"><a href="#cb20-1518" aria-hidden="true" tabindex="-1"></a>            <span class="sc">~</span> <span class="fu">str_replace</span>(., <span class="st">"Net Grand List.*"</span>, <span class="fu">paste0</span>(<span class="st">"Net Grand List - "</span>, year, <span class="st">" GL Year"</span>)),</span>
<span id="cb20-1519"><a href="#cb20-1519" aria-hidden="true" tabindex="-1"></a>            <span class="fu">matches</span>(<span class="st">"Net Grand List"</span>)</span>
<span id="cb20-1520"><a href="#cb20-1520" aria-hidden="true" tabindex="-1"></a>          ) <span class="sc">|&gt;</span></span>
<span id="cb20-1521"><a href="#cb20-1521" aria-hidden="true" tabindex="-1"></a>          <span class="fu">pivot_longer</span>(</span>
<span id="cb20-1522"><a href="#cb20-1522" aria-hidden="true" tabindex="-1"></a>            <span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"Net Grand List"</span>),</span>
<span id="cb20-1523"><a href="#cb20-1523" aria-hidden="true" tabindex="-1"></a>            <span class="at">names_to =</span> <span class="st">"gl_year_label"</span>,</span>
<span id="cb20-1524"><a href="#cb20-1524" aria-hidden="true" tabindex="-1"></a>            <span class="at">values_to =</span> <span class="st">"net_grand_list"</span></span>
<span id="cb20-1525"><a href="#cb20-1525" aria-hidden="true" tabindex="-1"></a>          ) <span class="sc">|&gt;</span></span>
<span id="cb20-1526"><a href="#cb20-1526" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(</span>
<span id="cb20-1527"><a href="#cb20-1527" aria-hidden="true" tabindex="-1"></a>            <span class="at">gl_year =</span> <span class="fu">as.integer</span>(<span class="fu">str_extract</span>(gl_year_label, <span class="st">"</span><span class="sc">\\</span><span class="st">d{4}"</span>))</span>
<span id="cb20-1528"><a href="#cb20-1528" aria-hidden="true" tabindex="-1"></a>          ) <span class="sc">|&gt;</span></span>
<span id="cb20-1529"><a href="#cb20-1529" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(net_grand_list))</span>
<span id="cb20-1530"><a href="#cb20-1530" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb20-1531"><a href="#cb20-1531" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb20-1532"><a href="#cb20-1532" aria-hidden="true" tabindex="-1"></a>      all_gls <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(all_gls, df1 <span class="sc">|&gt;</span> <span class="fu">rename_with</span>(tolower))</span>
<span id="cb20-1533"><a href="#cb20-1533" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb20-1534"><a href="#cb20-1534" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">file.exists</span>(acmr_file_path)){</span>
<span id="cb20-1535"><a href="#cb20-1535" aria-hidden="true" tabindex="-1"></a>        df2 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(acmr_file_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) </span>
<span id="cb20-1536"><a href="#cb20-1536" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-1537"><a href="#cb20-1537" aria-hidden="true" tabindex="-1"></a>        df2 <span class="ot">&lt;-</span> df2 <span class="sc">|&gt;</span></span>
<span id="cb20-1538"><a href="#cb20-1538" aria-hidden="true" tabindex="-1"></a>          <span class="fu">rename</span>(<span class="at">millrate =</span> <span class="fu">matches</span>(<span class="st">"Mil"</span>))</span>
<span id="cb20-1539"><a href="#cb20-1539" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-1540"><a href="#cb20-1540" aria-hidden="true" tabindex="-1"></a>        year_col <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"Year"</span>, <span class="fu">names</span>(df2), <span class="at">value =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-1541"><a href="#cb20-1541" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-1542"><a href="#cb20-1542" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">length</span>(year_col) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb20-1543"><a href="#cb20-1543" aria-hidden="true" tabindex="-1"></a>          df2 <span class="ot">&lt;-</span> df2 <span class="sc">|&gt;</span></span>
<span id="cb20-1544"><a href="#cb20-1544" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mutate</span>(<span class="at">year =</span> year) </span>
<span id="cb20-1545"><a href="#cb20-1545" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb20-1546"><a href="#cb20-1546" aria-hidden="true" tabindex="-1"></a>          df2 <span class="ot">&lt;-</span> df2 <span class="sc">|&gt;</span></span>
<span id="cb20-1547"><a href="#cb20-1547" aria-hidden="true" tabindex="-1"></a>            <span class="fu">rename_with</span>(<span class="sc">~</span> <span class="st">"year"</span>, <span class="at">.cols =</span> <span class="fu">all_of</span>(year_col[<span class="dv">1</span>]))</span>
<span id="cb20-1548"><a href="#cb20-1548" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb20-1549"><a href="#cb20-1549" aria-hidden="true" tabindex="-1"></a>        all_acmrs <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(all_acmrs, df2)</span>
<span id="cb20-1550"><a href="#cb20-1550" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-1551"><a href="#cb20-1551" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb20-1552"><a href="#cb20-1552" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-1553"><a href="#cb20-1553" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1554"><a href="#cb20-1554" aria-hidden="true" tabindex="-1"></a>    all_gls <span class="ot">&lt;-</span></span>
<span id="cb20-1555"><a href="#cb20-1555" aria-hidden="true" tabindex="-1"></a>      all_gls <span class="sc">|&gt;</span></span>
<span id="cb20-1556"><a href="#cb20-1556" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">case_when</span>(</span>
<span id="cb20-1557"><a href="#cb20-1557" aria-hidden="true" tabindex="-1"></a>        <span class="sc">!</span><span class="fu">is.na</span>(gl_year) <span class="sc">~</span> gl_year,</span>
<span id="cb20-1558"><a href="#cb20-1558" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> year</span>
<span id="cb20-1559"><a href="#cb20-1559" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb20-1560"><a href="#cb20-1560" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb20-1561"><a href="#cb20-1561" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(gl_year_label, gl_year)) <span class="sc">|&gt;</span></span>
<span id="cb20-1562"><a href="#cb20-1562" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(</span>
<span id="cb20-1563"><a href="#cb20-1563" aria-hidden="true" tabindex="-1"></a>        <span class="at">town =</span> municipality,</span>
<span id="cb20-1564"><a href="#cb20-1564" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb20-1565"><a href="#cb20-1565" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb20-1566"><a href="#cb20-1566" aria-hidden="true" tabindex="-1"></a>        <span class="at">town =</span> <span class="fu">str_to_title</span>(town),</span>
<span id="cb20-1567"><a href="#cb20-1567" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb20-1568"><a href="#cb20-1568" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1569"><a href="#cb20-1569" aria-hidden="true" tabindex="-1"></a>    all_acmrs <span class="ot">&lt;-</span></span>
<span id="cb20-1570"><a href="#cb20-1570" aria-hidden="true" tabindex="-1"></a>      all_acmrs <span class="sc">|&gt;</span> </span>
<span id="cb20-1571"><a href="#cb20-1571" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">millrate =</span> <span class="fu">case_when</span>(</span>
<span id="cb20-1572"><a href="#cb20-1572" aria-hidden="true" tabindex="-1"></a>        <span class="fu">is.na</span>(millrate) <span class="sc">~</span> <span class="fu">coalesce</span>(millrate1,millrate2, millrate3),</span>
<span id="cb20-1573"><a href="#cb20-1573" aria-hidden="true" tabindex="-1"></a>        <span class="cn">TRUE</span> <span class="sc">~</span> millrate</span>
<span id="cb20-1574"><a href="#cb20-1574" aria-hidden="true" tabindex="-1"></a>      ))</span>
<span id="cb20-1575"><a href="#cb20-1575" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1576"><a href="#cb20-1576" aria-hidden="true" tabindex="-1"></a>    all_acmrs <span class="ot">&lt;-</span></span>
<span id="cb20-1577"><a href="#cb20-1577" aria-hidden="true" tabindex="-1"></a>      all_acmrs <span class="sc">|&gt;</span></span>
<span id="cb20-1578"><a href="#cb20-1578" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(</span>
<span id="cb20-1579"><a href="#cb20-1579" aria-hidden="true" tabindex="-1"></a>        <span class="at">town =</span> Municipality</span>
<span id="cb20-1580"><a href="#cb20-1580" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb20-1581"><a href="#cb20-1581" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb20-1582"><a href="#cb20-1582" aria-hidden="true" tabindex="-1"></a>        <span class="at">town =</span> <span class="fu">str_to_title</span>(town),</span>
<span id="cb20-1583"><a href="#cb20-1583" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb20-1584"><a href="#cb20-1584" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1585"><a href="#cb20-1585" aria-hidden="true" tabindex="-1"></a>    ct_towns_counties <span class="ot">&lt;-</span> <span class="fu">load_ct_town_mapping</span>()</span>
<span id="cb20-1586"><a href="#cb20-1586" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1587"><a href="#cb20-1587" aria-hidden="true" tabindex="-1"></a>    final <span class="ot">&lt;-</span> <span class="fu">inner_join</span>(</span>
<span id="cb20-1588"><a href="#cb20-1588" aria-hidden="true" tabindex="-1"></a>      all_gls, all_acmrs, <span class="fu">join_by</span>(town <span class="sc">==</span> town, year <span class="sc">==</span> year)</span>
<span id="cb20-1589"><a href="#cb20-1589" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> <span class="fu">mutate</span>(</span>
<span id="cb20-1590"><a href="#cb20-1590" aria-hidden="true" tabindex="-1"></a>      <span class="at">property_tax_revenue =</span> (millrate<span class="sc">/</span><span class="dv">1000</span>) <span class="sc">*</span> net_grand_list</span>
<span id="cb20-1591"><a href="#cb20-1591" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb20-1592"><a href="#cb20-1592" aria-hidden="true" tabindex="-1"></a>      <span class="fu">inner_join</span>(all_fiscin, <span class="fu">join_by</span>(town <span class="sc">==</span> town, year <span class="sc">==</span> fisc_year_end )) <span class="sc">|&gt;</span></span>
<span id="cb20-1593"><a href="#cb20-1593" aria-hidden="true" tabindex="-1"></a>      <span class="fu">inner_join</span>(ct_towns_counties <span class="sc">|&gt;</span> <span class="fu">rename</span>(<span class="at">county =</span> County) <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="st">"Town name"</span>, county), <span class="fu">join_by</span>(town <span class="sc">==</span> <span class="st">"Town name"</span>))</span>
<span id="cb20-1594"><a href="#cb20-1594" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1595"><a href="#cb20-1595" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(final, f_path)</span>
<span id="cb20-1596"><a href="#cb20-1596" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span>{</span>
<span id="cb20-1597"><a href="#cb20-1597" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Reading existing data from CSV..."</span>)</span>
<span id="cb20-1598"><a href="#cb20-1598" aria-hidden="true" tabindex="-1"></a>    final <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(f_path,, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb20-1599"><a href="#cb20-1599" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-1600"><a href="#cb20-1600" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(final)</span>
<span id="cb20-1601"><a href="#cb20-1601" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-1602"><a href="#cb20-1602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1603"><a href="#cb20-1603" aria-hidden="true" tabindex="-1"></a><span class="co">#' Load and Consolidate CT Municipal Fiscal Revenue Data (2003–2022)</span></span>
<span id="cb20-1604"><a href="#cb20-1604" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-1605"><a href="#cb20-1605" aria-hidden="true" tabindex="-1"></a><span class="co">#' This function loads, cleans, and merges Connecticut municipal fiscal indicators data</span></span>
<span id="cb20-1606"><a href="#cb20-1606" aria-hidden="true" tabindex="-1"></a><span class="co">#' from multiple overlapping sources spanning the years 2003 to 2022. If the consolidated</span></span>
<span id="cb20-1607"><a href="#cb20-1607" aria-hidden="true" tabindex="-1"></a><span class="co">#' dataset is not already cached locally, it triggers the loading of five different MFI</span></span>
<span id="cb20-1608"><a href="#cb20-1608" aria-hidden="true" tabindex="-1"></a><span class="co">#' (Municipal Fiscal Indicators) datasets, coalesces overlapping columns, and standardizes</span></span>
<span id="cb20-1609"><a href="#cb20-1609" aria-hidden="true" tabindex="-1"></a><span class="co">#' key fiscal metrics across years and data formats.</span></span>
<span id="cb20-1610"><a href="#cb20-1610" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-1611"><a href="#cb20-1611" aria-hidden="true" tabindex="-1"></a><span class="co">#' Data sources:</span></span>
<span id="cb20-1612"><a href="#cb20-1612" aria-hidden="true" tabindex="-1"></a><span class="co">#' - 2003–2007</span></span>
<span id="cb20-1613"><a href="#cb20-1613" aria-hidden="true" tabindex="-1"></a><span class="co">#' - 2007–2011</span></span>
<span id="cb20-1614"><a href="#cb20-1614" aria-hidden="true" tabindex="-1"></a><span class="co">#' - 2007–2012</span></span>
<span id="cb20-1615"><a href="#cb20-1615" aria-hidden="true" tabindex="-1"></a><span class="co">#' - 2011–2015</span></span>
<span id="cb20-1616"><a href="#cb20-1616" aria-hidden="true" tabindex="-1"></a><span class="co">#' - 2014–2022</span></span>
<span id="cb20-1617"><a href="#cb20-1617" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-1618"><a href="#cb20-1618" aria-hidden="true" tabindex="-1"></a><span class="co">#' Cleaning operations include:</span></span>
<span id="cb20-1619"><a href="#cb20-1619" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Column name normalization using `janitor::clean_names`</span></span>
<span id="cb20-1620"><a href="#cb20-1620" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Coalescing duplicate columns for common metrics (e.g., tax rates, population, revenues)</span></span>
<span id="cb20-1621"><a href="#cb20-1621" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Renaming columns for consistency across years and sources</span></span>
<span id="cb20-1622"><a href="#cb20-1622" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Removing superseded or redundant columns</span></span>
<span id="cb20-1623"><a href="#cb20-1623" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Saving the cleaned and unified dataset as a CSV file to avoid redundant computation</span></span>
<span id="cb20-1624"><a href="#cb20-1624" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-1625"><a href="#cb20-1625" aria-hidden="true" tabindex="-1"></a><span class="co">#' Key output variables include: `year`, `town`, `property_tax_revenues`, `millrate`,</span></span>
<span id="cb20-1626"><a href="#cb20-1626" aria-hidden="true" tabindex="-1"></a><span class="co">#' `total_fund_balance`, `education_expenditures`, `school_enrollment_average`, `population`,</span></span>
<span id="cb20-1627"><a href="#cb20-1627" aria-hidden="true" tabindex="-1"></a><span class="co">#' `equalized_net_grand_list`, `moodys_bond_rating`, `restatement_y_or_n`, `unemployment_annual_average`,</span></span>
<span id="cb20-1628"><a href="#cb20-1628" aria-hidden="true" tabindex="-1"></a><span class="co">#' `invested_in_capital_assets_net_of_related_debt`, among others.</span></span>
<span id="cb20-1629"><a href="#cb20-1629" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-1630"><a href="#cb20-1630" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A cleaned and standardized `data.frame` (tibble) of Connecticut municipal revenue data</span></span>
<span id="cb20-1631"><a href="#cb20-1631" aria-hidden="true" tabindex="-1"></a><span class="co">#'         from 2003 to 2022, merged from multiple historical sources and enriched with unified fiscal indicators.</span></span>
<span id="cb20-1632"><a href="#cb20-1632" aria-hidden="true" tabindex="-1"></a><span class="co">#' @import dplyr, readr, janitor</span></span>
<span id="cb20-1633"><a href="#cb20-1633" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb20-1634"><a href="#cb20-1634" aria-hidden="true" tabindex="-1"></a>load_revenue_data <span class="ot">&lt;-</span> <span class="cf">function</span>(){</span>
<span id="cb20-1635"><a href="#cb20-1635" aria-hidden="true" tabindex="-1"></a>  target_dir <span class="ot">&lt;-</span> <span class="st">'data/individual_report'</span></span>
<span id="cb20-1636"><a href="#cb20-1636" aria-hidden="true" tabindex="-1"></a>  f_name <span class="ot">&lt;-</span> <span class="st">"MUNICIPAL_FISCAL_INDICATORS_CT_2003_2022.csv"</span></span>
<span id="cb20-1637"><a href="#cb20-1637" aria-hidden="true" tabindex="-1"></a>  f_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, f_name)</span>
<span id="cb20-1638"><a href="#cb20-1638" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-1639"><a href="#cb20-1639" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(target_dir)){</span>
<span id="cb20-1640"><a href="#cb20-1640" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(target_dir, <span class="at">recursive=</span><span class="cn">TRUE</span>)</span>
<span id="cb20-1641"><a href="#cb20-1641" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-1642"><a href="#cb20-1642" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-1643"><a href="#cb20-1643" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(f_path)){</span>
<span id="cb20-1644"><a href="#cb20-1644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1645"><a href="#cb20-1645" aria-hidden="true" tabindex="-1"></a>    CT_REVENUE_2014_2022 <span class="ot">&lt;-</span> <span class="fu">load_MFI_2014_2022_data</span>() <span class="sc">|&gt;</span> <span class="fu">clean_names</span>()</span>
<span id="cb20-1646"><a href="#cb20-1646" aria-hidden="true" tabindex="-1"></a>    CT_REVENUE_2003_2007 <span class="ot">&lt;-</span> <span class="fu">load_MFI_2003_2007_data</span>() <span class="sc">|&gt;</span> <span class="fu">clean_names</span>()</span>
<span id="cb20-1647"><a href="#cb20-1647" aria-hidden="true" tabindex="-1"></a>    CT_REVENUE_2007_2011 <span class="ot">&lt;-</span> <span class="fu">load_MFI_2007_2011_data</span>() <span class="sc">|&gt;</span> <span class="fu">clean_names</span>()</span>
<span id="cb20-1648"><a href="#cb20-1648" aria-hidden="true" tabindex="-1"></a>    CT_REVENUE_2007_2012 <span class="ot">&lt;-</span> <span class="fu">load_MFI_2007_2012_data</span>() <span class="sc">|&gt;</span> <span class="fu">clean_names</span>()</span>
<span id="cb20-1649"><a href="#cb20-1649" aria-hidden="true" tabindex="-1"></a>    CT_REVENUE_2011_2015 <span class="ot">&lt;-</span> <span class="fu">load_MFI_2011_2015_data</span>() <span class="sc">|&gt;</span> <span class="fu">clean_names</span>()</span>
<span id="cb20-1650"><a href="#cb20-1650" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1651"><a href="#cb20-1651" aria-hidden="true" tabindex="-1"></a>    CT_REVENUE <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(CT_REVENUE_2014_2022, CT_REVENUE_2003_2007, CT_REVENUE_2007_2011, CT_REVENUE_2007_2012, CT_REVENUE_2011_2015)</span>
<span id="cb20-1652"><a href="#cb20-1652" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1653"><a href="#cb20-1653" aria-hidden="true" tabindex="-1"></a>    CT_REVENUE <span class="ot">&lt;-</span> </span>
<span id="cb20-1654"><a href="#cb20-1654" aria-hidden="true" tabindex="-1"></a>      CT_REVENUE <span class="sc">|&gt;</span> </span>
<span id="cb20-1655"><a href="#cb20-1655" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb20-1656"><a href="#cb20-1656" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Taxes</span></span>
<span id="cb20-1657"><a href="#cb20-1657" aria-hidden="true" tabindex="-1"></a>        <span class="at">current_year_adjusted_tax =</span> <span class="fu">coalesce</span>(current_year_adjusted_tax, curr_year_adjusted_taxes_collectible),</span>
<span id="cb20-1658"><a href="#cb20-1658" aria-hidden="true" tabindex="-1"></a>        <span class="at">current_year_tax_collection =</span> <span class="fu">coalesce</span>(current_year_tax_collection, curr_year_tax_collection_rate),</span>
<span id="cb20-1659"><a href="#cb20-1659" aria-hidden="true" tabindex="-1"></a>        <span class="at">property_tax_revenues =</span> <span class="fu">coalesce</span>(property_tax_revenues, property_tax_revenue),</span>
<span id="cb20-1660"><a href="#cb20-1660" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-1661"><a href="#cb20-1661" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fund balances</span></span>
<span id="cb20-1662"><a href="#cb20-1662" aria-hidden="true" tabindex="-1"></a>        <span class="at">assigned =</span> <span class="fu">coalesce</span>(assigned, assigned_fund_bal),</span>
<span id="cb20-1663"><a href="#cb20-1663" aria-hidden="true" tabindex="-1"></a>        <span class="at">committed =</span> <span class="fu">coalesce</span>(committed, committed_fund_bal),</span>
<span id="cb20-1664"><a href="#cb20-1664" aria-hidden="true" tabindex="-1"></a>        <span class="at">design_fund_bal =</span> <span class="fu">coalesce</span>(design_fund_bal),</span>
<span id="cb20-1665"><a href="#cb20-1665" aria-hidden="true" tabindex="-1"></a>        <span class="at">nonspendable =</span> <span class="fu">coalesce</span>(nonspendable, nonspendable_fund_bal),</span>
<span id="cb20-1666"><a href="#cb20-1666" aria-hidden="true" tabindex="-1"></a>        <span class="at">restricted =</span> <span class="fu">coalesce</span>(restricted, restricted_fund_bal),</span>
<span id="cb20-1667"><a href="#cb20-1667" aria-hidden="true" tabindex="-1"></a>        <span class="at">total_fund_balance =</span> <span class="fu">coalesce</span>(total_fund_balance, total_fund_bal),</span>
<span id="cb20-1668"><a href="#cb20-1668" aria-hidden="true" tabindex="-1"></a>        <span class="at">unassigned =</span> <span class="fu">coalesce</span>(unassigned, unassigned_fund_bal),</span>
<span id="cb20-1669"><a href="#cb20-1669" aria-hidden="true" tabindex="-1"></a>        <span class="at">unrestricted =</span> <span class="fu">coalesce</span>(unrestricted_fund_bal),</span>
<span id="cb20-1670"><a href="#cb20-1670" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-1671"><a href="#cb20-1671" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Revenues &amp; transfers</span></span>
<span id="cb20-1672"><a href="#cb20-1672" aria-hidden="true" tabindex="-1"></a>        <span class="at">total_revenues =</span> <span class="fu">coalesce</span>(total_revenues, total_revenue),</span>
<span id="cb20-1673"><a href="#cb20-1673" aria-hidden="true" tabindex="-1"></a>        <span class="at">total_revenues_and_other =</span> <span class="fu">coalesce</span>(total_revenues_and_other),</span>
<span id="cb20-1674"><a href="#cb20-1674" aria-hidden="true" tabindex="-1"></a>        <span class="at">intergovernmental_revenues =</span> <span class="fu">coalesce</span>(intergovernmental_revenues, inter_gov_rev),</span>
<span id="cb20-1675"><a href="#cb20-1675" aria-hidden="true" tabindex="-1"></a>        <span class="at">total_transfers_in_from_other =</span> <span class="fu">coalesce</span>(total_transfers_in_from_other, total_trans_from_genl_fund),</span>
<span id="cb20-1676"><a href="#cb20-1676" aria-hidden="true" tabindex="-1"></a>        <span class="at">total_transfers_out_to_other =</span> <span class="fu">coalesce</span>(total_transfers_out_to_other, total_trans_to_genl_fund),</span>
<span id="cb20-1677"><a href="#cb20-1677" aria-hidden="true" tabindex="-1"></a>        <span class="at">millrate =</span> <span class="fu">coalesce</span>(millrate, millrate1, millrate2, millrate3),</span>
<span id="cb20-1678"><a href="#cb20-1678" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-1679"><a href="#cb20-1679" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Expenditures</span></span>
<span id="cb20-1680"><a href="#cb20-1680" aria-hidden="true" tabindex="-1"></a>        <span class="at">education_expenditures =</span> <span class="fu">coalesce</span>(education_expenditures, education),</span>
<span id="cb20-1681"><a href="#cb20-1681" aria-hidden="true" tabindex="-1"></a>        <span class="at">total_net_assets =</span> <span class="fu">coalesce</span>(net_assets,total_net_assets),</span>
<span id="cb20-1682"><a href="#cb20-1682" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-1683"><a href="#cb20-1683" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Enrollment / population</span></span>
<span id="cb20-1684"><a href="#cb20-1684" aria-hidden="true" tabindex="-1"></a>        <span class="at">school_enrollment_average =</span> <span class="fu">coalesce</span>(school_enrollment_average, enrollmt),</span>
<span id="cb20-1685"><a href="#cb20-1685" aria-hidden="true" tabindex="-1"></a>        <span class="at">population =</span> <span class="fu">coalesce</span>(population, population_state_dept_of_public_health),</span>
<span id="cb20-1686"><a href="#cb20-1686" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-1687"><a href="#cb20-1687" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Labor</span></span>
<span id="cb20-1688"><a href="#cb20-1688" aria-hidden="true" tabindex="-1"></a>        <span class="at">unemployment_annual_average =</span> <span class="fu">coalesce</span>(unemployment_annual_average, empl),</span>
<span id="cb20-1689"><a href="#cb20-1689" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-1690"><a href="#cb20-1690" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Equalized values</span></span>
<span id="cb20-1691"><a href="#cb20-1691" aria-hidden="true" tabindex="-1"></a>        <span class="at">equalized_net_grand_list =</span> <span class="fu">coalesce</span>(equalized_net_grand_list, egl),</span>
<span id="cb20-1692"><a href="#cb20-1692" aria-hidden="true" tabindex="-1"></a>        <span class="at">equalized_mill_rate =</span> <span class="fu">coalesce</span>(equalized_mill_rate, acmr),</span>
<span id="cb20-1693"><a href="#cb20-1693" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-1694"><a href="#cb20-1694" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Net assets / liabilities</span></span>
<span id="cb20-1695"><a href="#cb20-1695" aria-hidden="true" tabindex="-1"></a>        <span class="at">invested_in_capital_assets_net_of_related_debt =</span> <span class="fu">coalesce</span>(invested_in_capital_assets_net_of_related_debt, invested_in_capital),</span>
<span id="cb20-1696"><a href="#cb20-1696" aria-hidden="true" tabindex="-1"></a>        <span class="at">unrestricted_net_assets =</span> <span class="fu">coalesce</span>(unrestricted_net_assets, unrestricted_net),</span>
<span id="cb20-1697"><a href="#cb20-1697" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-1698"><a href="#cb20-1698" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Moody's ratings</span></span>
<span id="cb20-1699"><a href="#cb20-1699" aria-hidden="true" tabindex="-1"></a>        <span class="at">moodys_bond_rating =</span> <span class="fu">coalesce</span>(moodys_bond_rating, moody_s_bond_ratings, bond_rating_moodys_as_of),</span>
<span id="cb20-1700"><a href="#cb20-1700" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-1701"><a href="#cb20-1701" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Restatement flag</span></span>
<span id="cb20-1702"><a href="#cb20-1702" aria-hidden="true" tabindex="-1"></a>        <span class="at">restatement_y_or_n =</span> <span class="fu">coalesce</span>(restatement_y_or_n, restatement),</span>
<span id="cb20-1703"><a href="#cb20-1703" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-1704"><a href="#cb20-1704" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Misc</span></span>
<span id="cb20-1705"><a href="#cb20-1705" aria-hidden="true" tabindex="-1"></a>        <span class="at">year =</span> <span class="fu">coalesce</span>(year, fiscal_year_end),</span>
<span id="cb20-1706"><a href="#cb20-1706" aria-hidden="true" tabindex="-1"></a>        <span class="at">comments =</span> <span class="fu">coalesce</span>(comments, comments_2, comments_a, comments_b),</span>
<span id="cb20-1707"><a href="#cb20-1707" aria-hidden="true" tabindex="-1"></a>        <span class="at">tax_code =</span> <span class="fu">coalesce</span>(tax_code, town_code, comptroller_town_code, comptroller_town_code_x, comptroller_town_code_y)</span>
<span id="cb20-1708"><a href="#cb20-1708" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-1709"><a href="#cb20-1709" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">|&gt;</span></span>
<span id="cb20-1710"><a href="#cb20-1710" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(</span>
<span id="cb20-1711"><a href="#cb20-1711" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>curr_year_adjusted_taxes_collectible,</span>
<span id="cb20-1712"><a href="#cb20-1712" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>curr_year_tax_collection_rate,</span>
<span id="cb20-1713"><a href="#cb20-1713" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>property_tax_revenue,</span>
<span id="cb20-1714"><a href="#cb20-1714" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>assigned_fund_bal,</span>
<span id="cb20-1715"><a href="#cb20-1715" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>committed_fund_bal,</span>
<span id="cb20-1716"><a href="#cb20-1716" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>nonspendable_fund_bal,</span>
<span id="cb20-1717"><a href="#cb20-1717" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>restricted_fund_bal,</span>
<span id="cb20-1718"><a href="#cb20-1718" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>total_fund_bal,</span>
<span id="cb20-1719"><a href="#cb20-1719" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>unassigned_fund_bal,</span>
<span id="cb20-1720"><a href="#cb20-1720" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>unrestricted_fund_bal,</span>
<span id="cb20-1721"><a href="#cb20-1721" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>total_revenue,</span>
<span id="cb20-1722"><a href="#cb20-1722" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>inter_gov_rev,</span>
<span id="cb20-1723"><a href="#cb20-1723" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>total_trans_from_genl_fund,</span>
<span id="cb20-1724"><a href="#cb20-1724" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>total_trans_to_genl_fund,</span>
<span id="cb20-1725"><a href="#cb20-1725" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>millrate1,</span>
<span id="cb20-1726"><a href="#cb20-1726" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>millrate2,</span>
<span id="cb20-1727"><a href="#cb20-1727" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>millrate3,</span>
<span id="cb20-1728"><a href="#cb20-1728" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>education,</span>
<span id="cb20-1729"><a href="#cb20-1729" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>enrollmt,</span>
<span id="cb20-1730"><a href="#cb20-1730" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>empl,</span>
<span id="cb20-1731"><a href="#cb20-1731" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>egl,</span>
<span id="cb20-1732"><a href="#cb20-1732" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>acmr,</span>
<span id="cb20-1733"><a href="#cb20-1733" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>invested_in_capital,</span>
<span id="cb20-1734"><a href="#cb20-1734" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>unrestricted_net,</span>
<span id="cb20-1735"><a href="#cb20-1735" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>moody_s_bond_ratings,</span>
<span id="cb20-1736"><a href="#cb20-1736" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>restatement, </span>
<span id="cb20-1737"><a href="#cb20-1737" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>fiscal_year_end,</span>
<span id="cb20-1738"><a href="#cb20-1738" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>bond_rating_moodys_as_of,</span>
<span id="cb20-1739"><a href="#cb20-1739" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>population_state_dept_of_public_health,</span>
<span id="cb20-1740"><a href="#cb20-1740" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>comments_2, <span class="sc">-</span>comments_a, <span class="sc">-</span>comments_b,</span>
<span id="cb20-1741"><a href="#cb20-1741" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>comptroller_town_code_x, <span class="sc">-</span>comptroller_town_code_y,</span>
<span id="cb20-1742"><a href="#cb20-1742" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>town_code, <span class="sc">-</span>comptroller_town_code, <span class="sc">-</span>county_identifier,</span>
<span id="cb20-1743"><a href="#cb20-1743" aria-hidden="true" tabindex="-1"></a>        <span class="sc">-</span>numbered_x, <span class="sc">-</span>numbered_y, <span class="sc">-</span>numbered,<span class="sc">-</span>net_assets</span>
<span id="cb20-1744"><a href="#cb20-1744" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb20-1745"><a href="#cb20-1745" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1746"><a href="#cb20-1746" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(CT_REVENUE, f_path)</span>
<span id="cb20-1747"><a href="#cb20-1747" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1748"><a href="#cb20-1748" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span>{</span>
<span id="cb20-1749"><a href="#cb20-1749" aria-hidden="true" tabindex="-1"></a>    CT_REVENUE <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(f_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb20-1750"><a href="#cb20-1750" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-1751"><a href="#cb20-1751" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(CT_REVENUE)</span>
<span id="cb20-1752"><a href="#cb20-1752" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-1753"><a href="#cb20-1753" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1754"><a href="#cb20-1754" aria-hidden="true" tabindex="-1"></a>CT_REVENUE <span class="ot">&lt;-</span> <span class="fu">load_revenue_data</span>()</span>
<span id="cb20-1755"><a href="#cb20-1755" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-1756"><a href="#cb20-1756" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1757"><a href="#cb20-1757" aria-hidden="true" tabindex="-1"></a><span class="fu"># Merging</span></span>
<span id="cb20-1758"><a href="#cb20-1758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1759"><a href="#cb20-1759" aria-hidden="true" tabindex="-1"></a>Because the economic data spans multiple geographic units (e.g., county, town, and property level), I needed to standardize the level of geographic aggregation across datasets. County was the most consistent and broadly shared geographic unit, so I aggregated datasets as needed to the county level. This allowed me to create a unified data frame containing the fiscal data, as shown in the code below.</span>
<span id="cb20-1762"><a href="#cb20-1762" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb20-1763"><a href="#cb20-1763" aria-hidden="true" tabindex="-1"></a>CT_ECONOMY <span class="ot">&lt;-</span></span>
<span id="cb20-1764"><a href="#cb20-1764" aria-hidden="true" tabindex="-1"></a>  CAGDP2 <span class="sc">|&gt;</span> </span>
<span id="cb20-1765"><a href="#cb20-1765" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb20-1766"><a href="#cb20-1766" aria-hidden="true" tabindex="-1"></a>    industry_desc <span class="sc">==</span> <span class="st">"All industry total"</span>,</span>
<span id="cb20-1767"><a href="#cb20-1767" aria-hidden="true" tabindex="-1"></a>    county <span class="sc">!=</span> <span class="st">"Connecticut"</span></span>
<span id="cb20-1768"><a href="#cb20-1768" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb20-1769"><a href="#cb20-1769" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(CAINC1 <span class="sc">|&gt;</span></span>
<span id="cb20-1770"><a href="#cb20-1770" aria-hidden="true" tabindex="-1"></a>              <span class="fu">filter</span>(county <span class="sc">!=</span> <span class="st">"Connecticut"</span>),</span>
<span id="cb20-1771"><a href="#cb20-1771" aria-hidden="true" tabindex="-1"></a>            <span class="fu">join_by</span>(</span>
<span id="cb20-1772"><a href="#cb20-1772" aria-hidden="true" tabindex="-1"></a>              year <span class="sc">==</span> year,</span>
<span id="cb20-1773"><a href="#cb20-1773" aria-hidden="true" tabindex="-1"></a>              county <span class="sc">==</span> county)) <span class="sc">|&gt;</span></span>
<span id="cb20-1774"><a href="#cb20-1774" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(CAINC4 <span class="sc">|&gt;</span></span>
<span id="cb20-1775"><a href="#cb20-1775" aria-hidden="true" tabindex="-1"></a>              <span class="fu">filter</span>(county <span class="sc">!=</span> <span class="st">"Connecticut"</span>), </span>
<span id="cb20-1776"><a href="#cb20-1776" aria-hidden="true" tabindex="-1"></a>             <span class="fu">join_by</span>(year <span class="sc">==</span> year, </span>
<span id="cb20-1777"><a href="#cb20-1777" aria-hidden="true" tabindex="-1"></a>                     county <span class="sc">==</span> county, </span>
<span id="cb20-1778"><a href="#cb20-1778" aria-hidden="true" tabindex="-1"></a>                     population <span class="sc">==</span> population, </span>
<span id="cb20-1779"><a href="#cb20-1779" aria-hidden="true" tabindex="-1"></a>                     per_capita_personal_income <span class="sc">==</span> per_capita_personal_income)) <span class="sc">|&gt;</span></span>
<span id="cb20-1780"><a href="#cb20-1780" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(CAINC30 <span class="sc">|&gt;</span></span>
<span id="cb20-1781"><a href="#cb20-1781" aria-hidden="true" tabindex="-1"></a>              <span class="fu">filter</span>(county <span class="sc">!=</span> <span class="st">"Connecticut"</span>), </span>
<span id="cb20-1782"><a href="#cb20-1782" aria-hidden="true" tabindex="-1"></a>             <span class="fu">join_by</span>(year <span class="sc">==</span> year, </span>
<span id="cb20-1783"><a href="#cb20-1783" aria-hidden="true" tabindex="-1"></a>                     county <span class="sc">==</span> county, </span>
<span id="cb20-1784"><a href="#cb20-1784" aria-hidden="true" tabindex="-1"></a>                     population <span class="sc">==</span> population)) <span class="sc">|&gt;</span></span>
<span id="cb20-1785"><a href="#cb20-1785" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(CAINC91,</span>
<span id="cb20-1786"><a href="#cb20-1786" aria-hidden="true" tabindex="-1"></a>             <span class="fu">join_by</span>(year <span class="sc">==</span> year,</span>
<span id="cb20-1787"><a href="#cb20-1787" aria-hidden="true" tabindex="-1"></a>                     county <span class="sc">==</span> county)) <span class="sc">|&gt;</span></span>
<span id="cb20-1788"><a href="#cb20-1788" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(CT_REVENUE <span class="sc">|&gt;</span></span>
<span id="cb20-1789"><a href="#cb20-1789" aria-hidden="true" tabindex="-1"></a>              <span class="fu">group_by</span>(</span>
<span id="cb20-1790"><a href="#cb20-1790" aria-hidden="true" tabindex="-1"></a>                county, year</span>
<span id="cb20-1791"><a href="#cb20-1791" aria-hidden="true" tabindex="-1"></a>                ) <span class="sc">|&gt;</span></span>
<span id="cb20-1792"><a href="#cb20-1792" aria-hidden="true" tabindex="-1"></a>              <span class="fu">summarize</span>(</span>
<span id="cb20-1793"><a href="#cb20-1793" aria-hidden="true" tabindex="-1"></a>                <span class="fu">across</span>(<span class="fu">c</span>(</span>
<span id="cb20-1794"><a href="#cb20-1794" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"equalized_net_grand_list"</span>,<span class="st">"current_year_adjusted_tax"</span>,</span>
<span id="cb20-1795"><a href="#cb20-1795" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"property_tax_revenues"</span>, <span class="st">"intergovernmental_revenues"</span>,</span>
<span id="cb20-1796"><a href="#cb20-1796" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"total_revenues"</span>,<span class="st">"total_transfers_in_from_other"</span>,</span>
<span id="cb20-1797"><a href="#cb20-1797" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"total_revenues_and_other"</span>,<span class="st">"education_expenditures"</span>,</span>
<span id="cb20-1798"><a href="#cb20-1798" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"operating_expenditures"</span>, <span class="st">"total_expenditures"</span>,<span class="st">"total_transfers_out_to_other"</span>,</span>
<span id="cb20-1799"><a href="#cb20-1799" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"total_expenditures_and_other"</span>,<span class="st">"net_change_in_fund_balance"</span>,</span>
<span id="cb20-1800"><a href="#cb20-1800" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"nonspendable"</span>,<span class="st">"restricted"</span>,<span class="st">"committed"</span>,<span class="st">"assigned"</span>,<span class="st">"unassigned"</span>,</span>
<span id="cb20-1801"><a href="#cb20-1801" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"total_fund_balance"</span>,<span class="st">"net_pension_liability"</span>,<span class="st">"net_opeb_liability"</span>,</span>
<span id="cb20-1802"><a href="#cb20-1802" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"bonded_long_term_debt"</span>,<span class="st">"annual_debt_service"</span>,<span class="st">"tax_rev"</span>,</span>
<span id="cb20-1803"><a href="#cb20-1803" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"debt_service"</span>,<span class="st">"other_financing_sources"</span>,</span>
<span id="cb20-1804"><a href="#cb20-1804" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"operating_surplus_deficit_including_sources_and_uses"</span>,</span>
<span id="cb20-1805"><a href="#cb20-1805" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"rsd_debt"</span>,<span class="st">"town_bonded_long_term_debt"</span>,<span class="st">"total_bonded_long_term_debt_rsd_town"</span>,</span>
<span id="cb20-1806"><a href="#cb20-1806" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"reserv_fund_bal"</span>,<span class="st">"design_fund_bal"</span>,<span class="st">"unreserved_fund_bal"</span>,</span>
<span id="cb20-1807"><a href="#cb20-1807" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"fund_equity_enterprise"</span>, <span class="st">"fund_equity_internal_service"</span>,</span>
<span id="cb20-1808"><a href="#cb20-1808" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"curr_year_taxes_collected"</span>,<span class="st">"total_adjusted_taxes_collectible"</span>,</span>
<span id="cb20-1809"><a href="#cb20-1809" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"total_taxes_collected"</span>,<span class="st">"overal_total_tax_collection_rate"</span>,</span>
<span id="cb20-1810"><a href="#cb20-1810" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"area_lmt"</span>,<span class="st">"invested_in_capital_assets_net_of_related_debt"</span>,</span>
<span id="cb20-1811"><a href="#cb20-1811" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"unrestricted_net_assets"</span>, <span class="st">"total_net_assets"</span>,</span>
<span id="cb20-1812"><a href="#cb20-1812" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"change_in_net_assets"</span>,<span class="st">"population"</span>,<span class="st">"tanf_recipients"</span>,</span>
<span id="cb20-1813"><a href="#cb20-1813" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"acglfy"</span>,<span class="st">"onbehalf_payments_obp_teachers_retirement_plan"</span>,</span>
<span id="cb20-1814"><a href="#cb20-1814" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"obp_allocation_from_pob_contribution"</span>,<span class="st">"unrestricted"</span>,</span>
<span id="cb20-1815"><a href="#cb20-1815" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"total_net_pension_liability"</span></span>
<span id="cb20-1816"><a href="#cb20-1816" aria-hidden="true" tabindex="-1"></a>                ), <span class="sc">~</span> <span class="fu">sum</span>(.x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb20-1817"><a href="#cb20-1817" aria-hidden="true" tabindex="-1"></a>                <span class="fu">across</span>(<span class="fu">c</span>(<span class="st">"school_enrollment_average"</span>,<span class="st">"unemployment_annual_average"</span>,</span>
<span id="cb20-1818"><a href="#cb20-1818" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"equalized_mill_rate"</span>,<span class="st">"mill_rate_real_estate_personal"</span>,</span>
<span id="cb20-1819"><a href="#cb20-1819" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"mill_rate_motor_vehicle"</span>,<span class="st">"current_year_tax_collection"</span>,</span>
<span id="cb20-1820"><a href="#cb20-1820" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"total_taxes_collected_as"</span>,<span class="st">"millrate"</span></span>
<span id="cb20-1821"><a href="#cb20-1821" aria-hidden="true" tabindex="-1"></a>                ), <span class="sc">~</span> <span class="fu">median</span>(.x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb20-1822"><a href="#cb20-1822" aria-hidden="true" tabindex="-1"></a>                <span class="fu">across</span>(<span class="fu">c</span>(<span class="st">"tax_code"</span>,</span>
<span id="cb20-1823"><a href="#cb20-1823" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"municipality_fips"</span>, <span class="st">"municipality_fips_geoid"</span>,</span>
<span id="cb20-1824"><a href="#cb20-1824" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"moodys_bond_rating"</span>,</span>
<span id="cb20-1825"><a href="#cb20-1825" aria-hidden="true" tabindex="-1"></a>                ), <span class="sc">~</span> <span class="fu">first</span>(.x))</span>
<span id="cb20-1826"><a href="#cb20-1826" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb20-1827"><a href="#cb20-1827" aria-hidden="true" tabindex="-1"></a>              )</span>
<span id="cb20-1828"><a href="#cb20-1828" aria-hidden="true" tabindex="-1"></a>            ,</span>
<span id="cb20-1829"><a href="#cb20-1829" aria-hidden="true" tabindex="-1"></a>             <span class="fu">join_by</span>(</span>
<span id="cb20-1830"><a href="#cb20-1830" aria-hidden="true" tabindex="-1"></a>               year <span class="sc">==</span> year,</span>
<span id="cb20-1831"><a href="#cb20-1831" aria-hidden="true" tabindex="-1"></a>               county <span class="sc">==</span> county</span>
<span id="cb20-1832"><a href="#cb20-1832" aria-hidden="true" tabindex="-1"></a>               )</span>
<span id="cb20-1833"><a href="#cb20-1833" aria-hidden="true" tabindex="-1"></a>            ) <span class="sc">|&gt;</span></span>
<span id="cb20-1834"><a href="#cb20-1834" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(BLS_LABOR <span class="sc">|&gt;</span></span>
<span id="cb20-1835"><a href="#cb20-1835" aria-hidden="true" tabindex="-1"></a>              <span class="fu">group_by</span>(county, year) <span class="sc">|&gt;</span></span>
<span id="cb20-1836"><a href="#cb20-1836" aria-hidden="true" tabindex="-1"></a>              <span class="fu">summarize</span>(</span>
<span id="cb20-1837"><a href="#cb20-1837" aria-hidden="true" tabindex="-1"></a>                <span class="at">unemployment_rate =</span> <span class="fu">median</span>(unemployment_rate),</span>
<span id="cb20-1838"><a href="#cb20-1838" aria-hidden="true" tabindex="-1"></a>                <span class="at">unemployment =</span> <span class="fu">median</span>(unemployment)</span>
<span id="cb20-1839"><a href="#cb20-1839" aria-hidden="true" tabindex="-1"></a>                ), <span class="fu">join_by</span>(year <span class="sc">==</span> year, county <span class="sc">==</span> county))</span>
<span id="cb20-1840"><a href="#cb20-1840" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1841"><a href="#cb20-1841" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1842"><a href="#cb20-1842" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify .x and .y columns</span></span>
<span id="cb20-1843"><a href="#cb20-1843" aria-hidden="true" tabindex="-1"></a>x_vars <span class="ot">&lt;-</span> <span class="fu">names</span>(CT_ECONOMY)[<span class="fu">grepl</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">.x$"</span>, <span class="fu">names</span>(CT_ECONOMY))]</span>
<span id="cb20-1844"><a href="#cb20-1844" aria-hidden="true" tabindex="-1"></a>y_vars <span class="ot">&lt;-</span> <span class="fu">names</span>(CT_ECONOMY)[<span class="fu">grepl</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">.y$"</span>, <span class="fu">names</span>(CT_ECONOMY))]</span>
<span id="cb20-1845"><a href="#cb20-1845" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1846"><a href="#cb20-1846" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through matching pairs</span></span>
<span id="cb20-1847"><a href="#cb20-1847" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (x <span class="cf">in</span> x_vars) {</span>
<span id="cb20-1848"><a href="#cb20-1848" aria-hidden="true" tabindex="-1"></a>  base <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">.x$"</span>, <span class="st">""</span>, x)</span>
<span id="cb20-1849"><a href="#cb20-1849" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">paste0</span>(base, <span class="st">".y"</span>)</span>
<span id="cb20-1850"><a href="#cb20-1850" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-1851"><a href="#cb20-1851" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (y <span class="sc">%in%</span> y_vars) {</span>
<span id="cb20-1852"><a href="#cb20-1852" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Coerce both to character for comparison</span></span>
<span id="cb20-1853"><a href="#cb20-1853" aria-hidden="true" tabindex="-1"></a>    x_vals <span class="ot">&lt;-</span> <span class="fu">as.character</span>(CT_ECONOMY[[x]])</span>
<span id="cb20-1854"><a href="#cb20-1854" aria-hidden="true" tabindex="-1"></a>    y_vals <span class="ot">&lt;-</span> <span class="fu">as.character</span>(CT_ECONOMY[[y]])</span>
<span id="cb20-1855"><a href="#cb20-1855" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1856"><a href="#cb20-1856" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compare, handling NA</span></span>
<span id="cb20-1857"><a href="#cb20-1857" aria-hidden="true" tabindex="-1"></a>    same_vals <span class="ot">&lt;-</span> (x_vals <span class="sc">==</span> y_vals) <span class="sc">|</span> (<span class="fu">is.na</span>(x_vals) <span class="sc">&amp;</span> <span class="fu">is.na</span>(y_vals))</span>
<span id="cb20-1858"><a href="#cb20-1858" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1859"><a href="#cb20-1859" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">all</span>(same_vals, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb20-1860"><a href="#cb20-1860" aria-hidden="true" tabindex="-1"></a>      <span class="co"># If all values are the same, keep one and drop the other</span></span>
<span id="cb20-1861"><a href="#cb20-1861" aria-hidden="true" tabindex="-1"></a>      CT_ECONOMY[[base]] <span class="ot">&lt;-</span> CT_ECONOMY[[x]]</span>
<span id="cb20-1862"><a href="#cb20-1862" aria-hidden="true" tabindex="-1"></a>      CT_ECONOMY[[x]] <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb20-1863"><a href="#cb20-1863" aria-hidden="true" tabindex="-1"></a>      CT_ECONOMY[[y]] <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb20-1864"><a href="#cb20-1864" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-1865"><a href="#cb20-1865" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-1866"><a href="#cb20-1866" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-1867"><a href="#cb20-1867" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1868"><a href="#cb20-1868" aria-hidden="true" tabindex="-1"></a>CT_ECONOMY <span class="ot">&lt;-</span> </span>
<span id="cb20-1869"><a href="#cb20-1869" aria-hidden="true" tabindex="-1"></a>  CT_ECONOMY <span class="sc">|&gt;</span></span>
<span id="cb20-1870"><a href="#cb20-1870" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">population =</span> <span class="fu">coalesce</span>(<span class="st">`</span><span class="at">population.x</span><span class="st">`</span>, <span class="st">`</span><span class="at">population.y</span><span class="st">`</span>)) <span class="sc">|&gt;</span></span>
<span id="cb20-1871"><a href="#cb20-1871" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(<span class="st">"population.x"</span>,<span class="st">"population.y"</span>)) <span class="sc">|&gt;</span> <span class="fu">clean_names</span>()</span>
<span id="cb20-1872"><a href="#cb20-1872" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-1873"><a href="#cb20-1873" aria-hidden="true" tabindex="-1"></a>Then I added the real estate sales data, as reproduced in the code below.</span>
<span id="cb20-1876"><a href="#cb20-1876" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb20-1877"><a href="#cb20-1877" aria-hidden="true" tabindex="-1"></a>CT_SALES_SUMMARY <span class="ot">&lt;-</span> </span>
<span id="cb20-1878"><a href="#cb20-1878" aria-hidden="true" tabindex="-1"></a>  CT_SALES <span class="sc">|&gt;</span></span>
<span id="cb20-1879"><a href="#cb20-1879" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year_recorded, county) <span class="sc">|&gt;</span></span>
<span id="cb20-1880"><a href="#cb20-1880" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb20-1881"><a href="#cb20-1881" aria-hidden="true" tabindex="-1"></a>    <span class="at">median_sale_price =</span> <span class="fu">median</span>(sale_amount, <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb20-1882"><a href="#cb20-1882" aria-hidden="true" tabindex="-1"></a>    <span class="at">median_sales_ratio =</span> <span class="fu">median</span>(sales_ratio, <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb20-1883"><a href="#cb20-1883" aria-hidden="true" tabindex="-1"></a>    <span class="at">sum_sale_price =</span> <span class="fu">sum</span>(sale_amount, <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb20-1884"><a href="#cb20-1884" aria-hidden="true" tabindex="-1"></a>    <span class="at">most_common_property_type =</span> property_type[<span class="fu">which.max</span>(<span class="fu">tabulate</span>(<span class="fu">match</span>(property_type, <span class="fu">unique</span>(property_type))))],</span>
<span id="cb20-1885"><a href="#cb20-1885" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb20-1886"><a href="#cb20-1886" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb20-1887"><a href="#cb20-1887" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1888"><a href="#cb20-1888" aria-hidden="true" tabindex="-1"></a>CT_SALES_ECONOMY <span class="ot">&lt;-</span></span>
<span id="cb20-1889"><a href="#cb20-1889" aria-hidden="true" tabindex="-1"></a>  CT_SALES_SUMMARY <span class="sc">|&gt;</span></span>
<span id="cb20-1890"><a href="#cb20-1890" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(CT_ECONOMY, </span>
<span id="cb20-1891"><a href="#cb20-1891" aria-hidden="true" tabindex="-1"></a>             <span class="fu">join_by</span>(<span class="st">"county"</span> <span class="sc">==</span> <span class="st">"county"</span>, <span class="st">"year_recorded"</span> <span class="sc">==</span> <span class="st">"year"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb20-1892"><a href="#cb20-1892" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb20-1893"><a href="#cb20-1893" aria-hidden="true" tabindex="-1"></a>    <span class="at">log_median_sale_price =</span> <span class="fu">log</span>(median_sale_price, <span class="at">base =</span> <span class="dv">10</span>),</span>
<span id="cb20-1894"><a href="#cb20-1894" aria-hidden="true" tabindex="-1"></a>    <span class="at">sqrt_median_sale_price =</span> <span class="fu">sqrt</span>(median_sale_price),</span>
<span id="cb20-1895"><a href="#cb20-1895" aria-hidden="true" tabindex="-1"></a>    <span class="at">inv_median_sale_price =</span> <span class="dv">1</span><span class="sc">/</span>median_sale_price,</span>
<span id="cb20-1896"><a href="#cb20-1896" aria-hidden="true" tabindex="-1"></a>    <span class="at">per_capita_gdp =</span> gdp <span class="sc">/</span> population,</span>
<span id="cb20-1897"><a href="#cb20-1897" aria-hidden="true" tabindex="-1"></a>    <span class="at">per_capita_property_tax_revenues =</span> property_tax_revenues <span class="sc">/</span> population,</span>
<span id="cb20-1898"><a href="#cb20-1898" aria-hidden="true" tabindex="-1"></a>    <span class="at">per_capita_ui_comp =</span> unemployment_insurance_compensation <span class="sc">/</span> population,</span>
<span id="cb20-1899"><a href="#cb20-1899" aria-hidden="true" tabindex="-1"></a>    <span class="at">per_capita_farm_income =</span> farm_income<span class="sc">/</span>population,</span>
<span id="cb20-1900"><a href="#cb20-1900" aria-hidden="true" tabindex="-1"></a>    <span class="at">per_capita_employer_contributions_soc_ins =</span> employer_contributions_for_government_social_insurance <span class="sc">/</span> population,</span>
<span id="cb20-1901"><a href="#cb20-1901" aria-hidden="true" tabindex="-1"></a>    <span class="at">per_capita_wages_and_salaries =</span> wages_and_salaries <span class="sc">/</span> population,</span>
<span id="cb20-1902"><a href="#cb20-1902" aria-hidden="true" tabindex="-1"></a>    <span class="at">per_capita_proprietors_income =</span> proprietors_income <span class="sc">/</span> population,</span>
<span id="cb20-1903"><a href="#cb20-1903" aria-hidden="true" tabindex="-1"></a>    <span class="at">per_capita_annual_debt_service =</span> annual_debt_service <span class="sc">/</span> population,</span>
<span id="cb20-1904"><a href="#cb20-1904" aria-hidden="true" tabindex="-1"></a>    <span class="at">per_capita_dividends_proportion =</span> ((per_capita_dividends_interest_and_rent <span class="sc">*</span> population) <span class="sc">/</span> personal_income) <span class="sc">/</span> population,</span>
<span id="cb20-1905"><a href="#cb20-1905" aria-hidden="true" tabindex="-1"></a>    <span class="at">dividends_proportion =</span> ((per_capita_dividends_interest_and_rent <span class="sc">*</span> population) <span class="sc">/</span> personal_income),</span>
<span id="cb20-1906"><a href="#cb20-1906" aria-hidden="true" tabindex="-1"></a>    <span class="at">per_capita_farm_proportion =</span> (farm_income <span class="sc">/</span> personal_income) <span class="sc">/</span> population,</span>
<span id="cb20-1907"><a href="#cb20-1907" aria-hidden="true" tabindex="-1"></a>    <span class="at">farm_proportion =</span> (farm_income <span class="sc">/</span> personal_income),</span>
<span id="cb20-1908"><a href="#cb20-1908" aria-hidden="true" tabindex="-1"></a>    <span class="at">retirement_proportion =</span> (retirement_and_other <span class="sc">/</span> personal_income),</span>
<span id="cb20-1909"><a href="#cb20-1909" aria-hidden="true" tabindex="-1"></a>    <span class="at">per_capita_wage_salary_proportion =</span> (wages_and_salaries <span class="sc">/</span> personal_income) <span class="sc">/</span> population,</span>
<span id="cb20-1910"><a href="#cb20-1910" aria-hidden="true" tabindex="-1"></a>    <span class="at">wage_salary_proportion =</span> (wages_and_salaries <span class="sc">/</span> personal_income),</span>
<span id="cb20-1911"><a href="#cb20-1911" aria-hidden="true" tabindex="-1"></a>    <span class="at">ui_comp_proportion =</span> (unemployment_insurance_compensation <span class="sc">/</span> personal_income),</span>
<span id="cb20-1912"><a href="#cb20-1912" aria-hidden="true" tabindex="-1"></a>    <span class="at">proprietors_income_proportion =</span> proprietors_income <span class="sc">/</span> personal_income</span>
<span id="cb20-1913"><a href="#cb20-1913" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb20-1914"><a href="#cb20-1914" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-1915"><a href="#cb20-1915" aria-hidden="true" tabindex="-1"></a>Finally, I wanted to add county population classifications to the merged dataset to include it as a categorical predictor in the modeling portion of the analysis. I accomplished that with the following code.</span>
<span id="cb20-1916"><a href="#cb20-1916" aria-hidden="true" tabindex="-1"></a><span class="in">``` {r}</span></span>
<span id="cb20-1917"><a href="#cb20-1917" aria-hidden="true" tabindex="-1"></a><span class="in">quantiles &lt;- quantile(CT_SALES_ECONOMY$population, probs = c(0.33, 0.66), na.rm = TRUE)</span></span>
<span id="cb20-1918"><a href="#cb20-1918" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1919"><a href="#cb20-1919" aria-hidden="true" tabindex="-1"></a><span class="in">CT_SALES_ECONOMY &lt;-</span></span>
<span id="cb20-1920"><a href="#cb20-1920" aria-hidden="true" tabindex="-1"></a><span class="in">  CT_SALES_ECONOMY |&gt;</span></span>
<span id="cb20-1921"><a href="#cb20-1921" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb20-1922"><a href="#cb20-1922" aria-hidden="true" tabindex="-1"></a><span class="in">    population_class = case_when(</span></span>
<span id="cb20-1923"><a href="#cb20-1923" aria-hidden="true" tabindex="-1"></a><span class="in">      population &lt; quantiles[[1]] ~ "small",</span></span>
<span id="cb20-1924"><a href="#cb20-1924" aria-hidden="true" tabindex="-1"></a><span class="in">      population &gt;= quantiles[[1]] &amp; population &lt; quantiles[[2]] ~ "medium",</span></span>
<span id="cb20-1925"><a href="#cb20-1925" aria-hidden="true" tabindex="-1"></a><span class="in">      population &gt;= quantiles[[2]] ~ "large",</span></span>
<span id="cb20-1926"><a href="#cb20-1926" aria-hidden="true" tabindex="-1"></a><span class="in">      TRUE ~ NA_character_</span></span>
<span id="cb20-1927"><a href="#cb20-1927" aria-hidden="true" tabindex="-1"></a><span class="in">    )</span></span>
<span id="cb20-1928"><a href="#cb20-1928" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb20-1929"><a href="#cb20-1929" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-1930"><a href="#cb20-1930" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1931"><a href="#cb20-1931" aria-hidden="true" tabindex="-1"></a><span class="fu"># Main Statistical Analysis</span></span>
<span id="cb20-1932"><a href="#cb20-1932" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1933"><a href="#cb20-1933" aria-hidden="true" tabindex="-1"></a>My goal was to build a random forest model that explains as much variance in median sales price (Y) as possible using a set of economic predictors. To do this, I broke the broad concept of "the economy" into three core dimensions of economic strength, and selected 11 predictors which fit into the delineated categories.</span>
<span id="cb20-1934"><a href="#cb20-1934" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1935"><a href="#cb20-1935" aria-hidden="true" tabindex="-1"></a>| **Economic Dimension**                  | **Associated Variables**                                                                                                                    |</span>
<span id="cb20-1936"><a href="#cb20-1936" aria-hidden="true" tabindex="-1"></a>| --------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------- |</span>
<span id="cb20-1937"><a href="#cb20-1937" aria-hidden="true" tabindex="-1"></a>| **Government Capacity &amp; Fiscal Health** | Per Capita GDP, Per Capita Property Tax Revenues, Per Capita Annual Debt Service                                                            |</span>
<span id="cb20-1938"><a href="#cb20-1938" aria-hidden="true" tabindex="-1"></a>| **Labor Market Conditions**             | Unemployment Rate, Unemployment Insurance Compensation Proportion                                                                           |</span>
<span id="cb20-1939"><a href="#cb20-1939" aria-hidden="true" tabindex="-1"></a>| **Household Income**                    | Per Capita Income, Dividends Proportion, Farm Proportion, Retirement Proportion, Wage and Salary Proportion, Proprietors’ Income Proportion |</span>
<span id="cb20-1940"><a href="#cb20-1940" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1941"><a href="#cb20-1941" aria-hidden="true" tabindex="-1"></a>I define the predictor and response variables in the lines of code below.</span>
<span id="cb20-1944"><a href="#cb20-1944" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb20-1945"><a href="#cb20-1945" aria-hidden="true" tabindex="-1"></a>NUMERIC_PREDICTORS <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb20-1946"><a href="#cb20-1946" aria-hidden="true" tabindex="-1"></a>  <span class="st">"per_capita_gdp"</span>,</span>
<span id="cb20-1947"><a href="#cb20-1947" aria-hidden="true" tabindex="-1"></a>  <span class="st">"per_capita_property_tax_revenues"</span>,</span>
<span id="cb20-1948"><a href="#cb20-1948" aria-hidden="true" tabindex="-1"></a>  <span class="st">"unemployment_rate"</span>,</span>
<span id="cb20-1949"><a href="#cb20-1949" aria-hidden="true" tabindex="-1"></a>  <span class="st">"per_capita_personal_income"</span>,</span>
<span id="cb20-1950"><a href="#cb20-1950" aria-hidden="true" tabindex="-1"></a>  <span class="st">"per_capita_annual_debt_service"</span>,</span>
<span id="cb20-1951"><a href="#cb20-1951" aria-hidden="true" tabindex="-1"></a>  <span class="st">"dividends_proportion"</span>,</span>
<span id="cb20-1952"><a href="#cb20-1952" aria-hidden="true" tabindex="-1"></a>  <span class="st">"farm_proportion"</span>,</span>
<span id="cb20-1953"><a href="#cb20-1953" aria-hidden="true" tabindex="-1"></a>  <span class="st">"retirement_proportion"</span>,</span>
<span id="cb20-1954"><a href="#cb20-1954" aria-hidden="true" tabindex="-1"></a>  <span class="st">"wage_salary_proportion"</span>,</span>
<span id="cb20-1955"><a href="#cb20-1955" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ui_comp_proportion"</span>,</span>
<span id="cb20-1956"><a href="#cb20-1956" aria-hidden="true" tabindex="-1"></a>  <span class="st">"proprietors_income_proportion"</span></span>
<span id="cb20-1957"><a href="#cb20-1957" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-1958"><a href="#cb20-1958" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1959"><a href="#cb20-1959" aria-hidden="true" tabindex="-1"></a>FACTOR_PREDICTORS <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"population_class"</span>)</span>
<span id="cb20-1960"><a href="#cb20-1960" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1961"><a href="#cb20-1961" aria-hidden="true" tabindex="-1"></a>RESPONSE <span class="ot">&lt;-</span> <span class="st">"median_sale_price"</span></span>
<span id="cb20-1962"><a href="#cb20-1962" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-1963"><a href="#cb20-1963" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1964"><a href="#cb20-1964" aria-hidden="true" tabindex="-1"></a><span class="fu">## Box-Cox Transformations</span></span>
<span id="cb20-1965"><a href="#cb20-1965" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1966"><a href="#cb20-1966" aria-hidden="true" tabindex="-1"></a>First, I applied the Box-Cox transformation to the predictor variables to address potential violations of the normality assumption in the data. This method helps stabilize variance and makes the data more normally distributed, improving model performance. The code used for this transformation is shown below.</span>
<span id="cb20-1967"><a href="#cb20-1967" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1968"><a href="#cb20-1968" aria-hidden="true" tabindex="-1"></a><span class="in">``` {r}</span></span>
<span id="cb20-1969"><a href="#cb20-1969" aria-hidden="true" tabindex="-1"></a><span class="in">#' Transform Features for Modeling</span></span>
<span id="cb20-1970"><a href="#cb20-1970" aria-hidden="true" tabindex="-1"></a><span class="in">#'</span></span>
<span id="cb20-1971"><a href="#cb20-1971" aria-hidden="true" tabindex="-1"></a><span class="in">#' This function prepares a dataset for modeling by:</span></span>
<span id="cb20-1972"><a href="#cb20-1972" aria-hidden="true" tabindex="-1"></a><span class="in">#' - Removing rows with missing values in the response or predictor variables</span></span>
<span id="cb20-1973"><a href="#cb20-1973" aria-hidden="true" tabindex="-1"></a><span class="in">#' - Estimating Box-Cox transformation parameters for numeric predictors</span></span>
<span id="cb20-1974"><a href="#cb20-1974" aria-hidden="true" tabindex="-1"></a><span class="in">#' - Applying Box-Cox transformations to the numeric predictors</span></span>
<span id="cb20-1975"><a href="#cb20-1975" aria-hidden="true" tabindex="-1"></a><span class="in">#' - Applying a specified transformation to the response variable</span></span>
<span id="cb20-1976"><a href="#cb20-1976" aria-hidden="true" tabindex="-1"></a><span class="in">#' - Returning a data frame with transformed predictors and response</span></span>
<span id="cb20-1977"><a href="#cb20-1977" aria-hidden="true" tabindex="-1"></a><span class="in">#'</span></span>
<span id="cb20-1978"><a href="#cb20-1978" aria-hidden="true" tabindex="-1"></a><span class="in">#' @param data A data frame containing at least the predictors and a response column.</span></span>
<span id="cb20-1979"><a href="#cb20-1979" aria-hidden="true" tabindex="-1"></a><span class="in">#'             Uses globally defined `NUMERIC_PREDICTORS` and `RESPONSE`.</span></span>
<span id="cb20-1980"><a href="#cb20-1980" aria-hidden="true" tabindex="-1"></a><span class="in">#' @return A cleaned and transformed data frame ready for modeling.</span></span>
<span id="cb20-1981"><a href="#cb20-1981" aria-hidden="true" tabindex="-1"></a><span class="in">#' @importFrom car powerTransform</span></span>
<span id="cb20-1982"><a href="#cb20-1982" aria-hidden="true" tabindex="-1"></a><span class="in">#' @importFrom purrr map2_dfc</span></span>
<span id="cb20-1983"><a href="#cb20-1983" aria-hidden="true" tabindex="-1"></a><span class="in">#' @importFrom dplyr filter if_all mutate bind_cols</span></span>
<span id="cb20-1984"><a href="#cb20-1984" aria-hidden="true" tabindex="-1"></a><span class="in">transform_features &lt;- function(data) {</span></span>
<span id="cb20-1985"><a href="#cb20-1985" aria-hidden="true" tabindex="-1"></a><span class="in">  numeric_predictors &lt;- NUMERIC_PREDICTORS</span></span>
<span id="cb20-1986"><a href="#cb20-1986" aria-hidden="true" tabindex="-1"></a><span class="in">  factor_predictors &lt;- FACTOR_PREDICTORS</span></span>
<span id="cb20-1987"><a href="#cb20-1987" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1988"><a href="#cb20-1988" aria-hidden="true" tabindex="-1"></a><span class="in">  # Remove rows with missing values in predictors or response</span></span>
<span id="cb20-1989"><a href="#cb20-1989" aria-hidden="true" tabindex="-1"></a><span class="in">  data_clean &lt;- data |&gt;</span></span>
<span id="cb20-1990"><a href="#cb20-1990" aria-hidden="true" tabindex="-1"></a><span class="in">    filter(!is.na(median_sale_price)) |&gt;</span></span>
<span id="cb20-1991"><a href="#cb20-1991" aria-hidden="true" tabindex="-1"></a><span class="in">    filter(if_all(all_of(c(numeric_predictors, factor_predictors)), ~ !is.na(.)))</span></span>
<span id="cb20-1992"><a href="#cb20-1992" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1993"><a href="#cb20-1993" aria-hidden="true" tabindex="-1"></a><span class="in">  # Estimate Box-Cox lambdas for numeric predictors</span></span>
<span id="cb20-1994"><a href="#cb20-1994" aria-hidden="true" tabindex="-1"></a><span class="in">  bc_model &lt;- powerTransform(data_clean[numeric_predictors])</span></span>
<span id="cb20-1995"><a href="#cb20-1995" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb20-1996"><a href="#cb20-1996" aria-hidden="true" tabindex="-1"></a><span class="in">  cat("Box-Cox Lambda Table:\n")</span></span>
<span id="cb20-1997"><a href="#cb20-1997" aria-hidden="true" tabindex="-1"></a><span class="in">  print(summary(bc_model))</span></span>
<span id="cb20-1998"><a href="#cb20-1998" aria-hidden="true" tabindex="-1"></a><span class="in">  cat("######################\n")</span></span>
<span id="cb20-1999"><a href="#cb20-1999" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-2000"><a href="#cb20-2000" aria-hidden="true" tabindex="-1"></a><span class="in">  lambdas &lt;- bc_model$lambda</span></span>
<span id="cb20-2001"><a href="#cb20-2001" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-2002"><a href="#cb20-2002" aria-hidden="true" tabindex="-1"></a><span class="in">  # Apply Box-Cox transformation to numeric predictors</span></span>
<span id="cb20-2003"><a href="#cb20-2003" aria-hidden="true" tabindex="-1"></a><span class="in">  bc_transformed &lt;- map2_dfc(data_clean[numeric_predictors], lambdas, function(x, lambda) {</span></span>
<span id="cb20-2004"><a href="#cb20-2004" aria-hidden="true" tabindex="-1"></a><span class="in">    if (lambda == 0) log(x) else (x^lambda - 1) / lambda</span></span>
<span id="cb20-2005"><a href="#cb20-2005" aria-hidden="true" tabindex="-1"></a><span class="in">  })</span></span>
<span id="cb20-2006"><a href="#cb20-2006" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-2007"><a href="#cb20-2007" aria-hidden="true" tabindex="-1"></a><span class="in">  colnames(bc_transformed) &lt;- paste0("bc_transformed_", numeric_predictors)</span></span>
<span id="cb20-2008"><a href="#cb20-2008" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-2009"><a href="#cb20-2009" aria-hidden="true" tabindex="-1"></a><span class="in">  # Transform the response variable</span></span>
<span id="cb20-2010"><a href="#cb20-2010" aria-hidden="true" tabindex="-1"></a><span class="in">  data_clean &lt;- data_clean |&gt;</span></span>
<span id="cb20-2011"><a href="#cb20-2011" aria-hidden="true" tabindex="-1"></a><span class="in">    mutate(response = case_when(</span></span>
<span id="cb20-2012"><a href="#cb20-2012" aria-hidden="true" tabindex="-1"></a><span class="in">      RESPONSE == "log_median_sale_price" ~ log_median_sale_price,</span></span>
<span id="cb20-2013"><a href="#cb20-2013" aria-hidden="true" tabindex="-1"></a><span class="in">      RESPONSE == "sqrt_median_sale_price" ~ sqrt_median_sale_price,</span></span>
<span id="cb20-2014"><a href="#cb20-2014" aria-hidden="true" tabindex="-1"></a><span class="in">      RESPONSE == "inv_median_sale_price" ~ inv_median_sale_price,</span></span>
<span id="cb20-2015"><a href="#cb20-2015" aria-hidden="true" tabindex="-1"></a><span class="in">      TRUE ~ median_sale_price</span></span>
<span id="cb20-2016"><a href="#cb20-2016" aria-hidden="true" tabindex="-1"></a><span class="in">    ))</span></span>
<span id="cb20-2017"><a href="#cb20-2017" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-2018"><a href="#cb20-2018" aria-hidden="true" tabindex="-1"></a><span class="in">  # Combine transformed predictors, factors, and response</span></span>
<span id="cb20-2019"><a href="#cb20-2019" aria-hidden="true" tabindex="-1"></a><span class="in">  final_data &lt;- bind_cols(</span></span>
<span id="cb20-2020"><a href="#cb20-2020" aria-hidden="true" tabindex="-1"></a><span class="in">    data_clean[factor_predictors],</span></span>
<span id="cb20-2021"><a href="#cb20-2021" aria-hidden="true" tabindex="-1"></a><span class="in">    bc_transformed,</span></span>
<span id="cb20-2022"><a href="#cb20-2022" aria-hidden="true" tabindex="-1"></a><span class="in">    response = data_clean$response</span></span>
<span id="cb20-2023"><a href="#cb20-2023" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb20-2024"><a href="#cb20-2024" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-2025"><a href="#cb20-2025" aria-hidden="true" tabindex="-1"></a><span class="in">  return(final_data)</span></span>
<span id="cb20-2026"><a href="#cb20-2026" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb20-2027"><a href="#cb20-2027" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-2028"><a href="#cb20-2028" aria-hidden="true" tabindex="-1"></a>The estimated Box-Cox $\lambda$ values for each predictor are summarized in the table below:</span>
<span id="cb20-2029"><a href="#cb20-2029" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-2030"><a href="#cb20-2030" aria-hidden="true" tabindex="-1"></a>| Predictor                         | Est Power |</span>
<span id="cb20-2031"><a href="#cb20-2031" aria-hidden="true" tabindex="-1"></a>| --------------------------------- | --------- |</span>
<span id="cb20-2032"><a href="#cb20-2032" aria-hidden="true" tabindex="-1"></a>| Per Capita GDP                    | -0.4589   |</span>
<span id="cb20-2033"><a href="#cb20-2033" aria-hidden="true" tabindex="-1"></a>| Per Capita Property Tax Revenues  | 1.6948    |</span>
<span id="cb20-2034"><a href="#cb20-2034" aria-hidden="true" tabindex="-1"></a>| Unemployment Rate                 | -0.2257   |</span>
<span id="cb20-2035"><a href="#cb20-2035" aria-hidden="true" tabindex="-1"></a>| Per Capita Personal Income        | -0.0226   |</span>
<span id="cb20-2036"><a href="#cb20-2036" aria-hidden="true" tabindex="-1"></a>| Per Capita Annual Debt Service    | 0.7702    |</span>
<span id="cb20-2037"><a href="#cb20-2037" aria-hidden="true" tabindex="-1"></a>| Dividends Proportion              | -1.4057   |</span>
<span id="cb20-2038"><a href="#cb20-2038" aria-hidden="true" tabindex="-1"></a>| Farm Proportion                   | 0.1607    |</span>
<span id="cb20-2039"><a href="#cb20-2039" aria-hidden="true" tabindex="-1"></a>| Retirement Proportion             | 0.4059    |</span>
<span id="cb20-2040"><a href="#cb20-2040" aria-hidden="true" tabindex="-1"></a>| Wage and Salary Proportion        | -0.4699   |</span>
<span id="cb20-2041"><a href="#cb20-2041" aria-hidden="true" tabindex="-1"></a>| Unemployment Insurance Proportion | -0.1981   |</span>
<span id="cb20-2042"><a href="#cb20-2042" aria-hidden="true" tabindex="-1"></a>| Proprietors' Income Proportion    | -0.1797   |</span>
<span id="cb20-2043"><a href="#cb20-2043" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-2044"><a href="#cb20-2044" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-2045"><a href="#cb20-2045" aria-hidden="true" tabindex="-1"></a>Two likelihood ratio tests were conducted to evaluate the necessity and appropriateness of these transformations. The first test compared the fitted $\lambda$ values to the null hypothesis that all $\lambda$ equal zero. The test statistic (LRT = 85.21, df = 11) produced a highly significant p-value (p $\approx$ 1.44e-13), indicating that the estimated $\lambda$ values differ significantly from zero and that a pure log transformation is not sufficient for all predictors. The second test compared the fitted $\lambda$ values to the hypothesis that $\lambda=1$ for all of the predictors. This test was also highly significant (LRT = 383.71, df = 11, p &lt; 2.22e$^{-16}$), confirming that the predictors require transformation to improve model fit.</span>
<span id="cb20-2046"><a href="#cb20-2046" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-2047"><a href="#cb20-2047" aria-hidden="true" tabindex="-1"></a>Together, these tests support the use of the Box-Cox method with the estimated $\lambda$ rather than defaulting to no transformation or simple log transformations.</span>
<span id="cb20-2048"><a href="#cb20-2048" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-2049"><a href="#cb20-2049" aria-hidden="true" tabindex="-1"></a><span class="fu">## Correlation Matrix</span></span>
<span id="cb20-2050"><a href="#cb20-2050" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-2051"><a href="#cb20-2051" aria-hidden="true" tabindex="-1"></a>Next, I calculated the correlation matrix, and identified predictors with correlations &gt; 0.8. The following pairs were identified as highly correlated:</span>
<span id="cb20-2052"><a href="#cb20-2052" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-2053"><a href="#cb20-2053" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Box-Cox transformed per capita property tax_revenues and Box-Cox transformed per capita personal income ($r = 0.97$)</span>
<span id="cb20-2054"><a href="#cb20-2054" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Box-Cox transformed per capita GDP and Box-Cox transformed per capita annual debt service ($r = 0.80$)</span>
<span id="cb20-2055"><a href="#cb20-2055" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Box-Cox transformed per capita_property_tax_revenues and Box-Cox transformed per capita annual debt service ($r = 0.83$)</span>
<span id="cb20-2056"><a href="#cb20-2056" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Box-Cox transformed dividends proportion and Box-Cox transformed retirement proportion ($r = -0.83$)</span>
<span id="cb20-2057"><a href="#cb20-2057" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-2058"><a href="#cb20-2058" aria-hidden="true" tabindex="-1"></a>After examining scatterplots of these pairs, I determined that the variables provide distinct information despite high correlation, and decided to retain all predictors. The code for the correlation check is in <span class="in">`run_rf_pipeline()`</span>, which I will define later.</span>
<span id="cb20-2059"><a href="#cb20-2059" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-2060"><a href="#cb20-2060" aria-hidden="true" tabindex="-1"></a><span class="fu">## Backwards Elimination</span></span>
<span id="cb20-2061"><a href="#cb20-2061" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-2062"><a href="#cb20-2062" aria-hidden="true" tabindex="-1"></a>After examining the correlation matrix, I fit a random forest model using the selected predictors. I then applied a backward elimination algorithm that iteratively removes the least important predictor, as determined by the percentage increase in mean squared error. The implementation of this process is shown in the code below.</span>
<span id="cb20-2065"><a href="#cb20-2065" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb20-2066"><a href="#cb20-2066" aria-hidden="true" tabindex="-1"></a><span class="co">#' Perform backward elimination for random forest model predictors</span></span>
<span id="cb20-2067"><a href="#cb20-2067" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-2068"><a href="#cb20-2068" aria-hidden="true" tabindex="-1"></a><span class="co">#' This function iteratively fits random forest models, starting with all specified predictors,</span></span>
<span id="cb20-2069"><a href="#cb20-2069" aria-hidden="true" tabindex="-1"></a><span class="co">#' and at each step removes the least important predictor based on "%IncMSE" importance measure.</span></span>
<span id="cb20-2070"><a href="#cb20-2070" aria-hidden="true" tabindex="-1"></a><span class="co">#' The process continues until a minimum number of predictors (`min_vars`) is reached.</span></span>
<span id="cb20-2071"><a href="#cb20-2071" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-2072"><a href="#cb20-2072" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param data A data frame containing the response variable and predictors.</span></span>
<span id="cb20-2073"><a href="#cb20-2073" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param response A string specifying the name of the response variable in `data`.</span></span>
<span id="cb20-2074"><a href="#cb20-2074" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param predictors A character vector of predictor variable names to include initially.</span></span>
<span id="cb20-2075"><a href="#cb20-2075" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param min_vars An integer specifying the minimum number of predictors to keep (default is 2).</span></span>
<span id="cb20-2076"><a href="#cb20-2076" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param ntree Number of trees to grow in the random forest (default is 5000).</span></span>
<span id="cb20-2077"><a href="#cb20-2077" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param verbose Logical; if TRUE, prints progress messages during elimination (default TRUE).</span></span>
<span id="cb20-2078"><a href="#cb20-2078" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-2079"><a href="#cb20-2079" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A list of model performance results for each iteration. Each list element contains:</span></span>
<span id="cb20-2080"><a href="#cb20-2080" aria-hidden="true" tabindex="-1"></a><span class="co">#' \itemize{</span></span>
<span id="cb20-2081"><a href="#cb20-2081" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \item \code{predictors}: the set of predictors used in the model</span></span>
<span id="cb20-2082"><a href="#cb20-2082" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \item \code{var_explained}: percent variance explained by the model on training data</span></span>
<span id="cb20-2083"><a href="#cb20-2083" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \item \code{mse}: mean squared error of the model</span></span>
<span id="cb20-2084"><a href="#cb20-2084" aria-hidden="true" tabindex="-1"></a><span class="co">#'   \item \code{importance}: variable importance scores (%IncMSE) for each predictor</span></span>
<span id="cb20-2085"><a href="#cb20-2085" aria-hidden="true" tabindex="-1"></a><span class="co">#' }</span></span>
<span id="cb20-2086"><a href="#cb20-2086" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-2087"><a href="#cb20-2087" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb20-2088"><a href="#cb20-2088" aria-hidden="true" tabindex="-1"></a><span class="co">#' \dontrun{</span></span>
<span id="cb20-2089"><a href="#cb20-2089" aria-hidden="true" tabindex="-1"></a><span class="co">#' results &lt;- backward_elimination_rf(</span></span>
<span id="cb20-2090"><a href="#cb20-2090" aria-hidden="true" tabindex="-1"></a><span class="co">#'   data = mydata,</span></span>
<span id="cb20-2091"><a href="#cb20-2091" aria-hidden="true" tabindex="-1"></a><span class="co">#'   response = "target_variable",</span></span>
<span id="cb20-2092"><a href="#cb20-2092" aria-hidden="true" tabindex="-1"></a><span class="co">#'   predictors = c("var1", "var2", "var3"),</span></span>
<span id="cb20-2093"><a href="#cb20-2093" aria-hidden="true" tabindex="-1"></a><span class="co">#'   min_vars = 2,</span></span>
<span id="cb20-2094"><a href="#cb20-2094" aria-hidden="true" tabindex="-1"></a><span class="co">#'   ntree = 1000</span></span>
<span id="cb20-2095"><a href="#cb20-2095" aria-hidden="true" tabindex="-1"></a><span class="co">#' )</span></span>
<span id="cb20-2096"><a href="#cb20-2096" aria-hidden="true" tabindex="-1"></a><span class="co">#' }</span></span>
<span id="cb20-2097"><a href="#cb20-2097" aria-hidden="true" tabindex="-1"></a>backward_elimination_rf <span class="ot">&lt;-</span> <span class="cf">function</span>(data, response, predictors, <span class="at">min_vars =</span> <span class="dv">4</span>, <span class="at">ntree =</span> <span class="dv">5000</span>, <span class="at">verbose =</span> <span class="cn">TRUE</span>) {</span>
<span id="cb20-2098"><a href="#cb20-2098" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb20-2099"><a href="#cb20-2099" aria-hidden="true" tabindex="-1"></a>  current_predictors <span class="ot">&lt;-</span> predictors</span>
<span id="cb20-2100"><a href="#cb20-2100" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-2101"><a href="#cb20-2101" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> (<span class="fu">length</span>(current_predictors) <span class="sc">&gt;=</span> min_vars) {</span>
<span id="cb20-2102"><a href="#cb20-2102" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Build formula</span></span>
<span id="cb20-2103"><a href="#cb20-2103" aria-hidden="true" tabindex="-1"></a>    formula <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(<span class="st">"response ~"</span>, <span class="fu">paste</span>(current_predictors, <span class="at">collapse =</span> <span class="st">" + "</span>)))</span>
<span id="cb20-2104"><a href="#cb20-2104" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-2105"><a href="#cb20-2105" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Train model</span></span>
<span id="cb20-2106"><a href="#cb20-2106" aria-hidden="true" tabindex="-1"></a>    rf_model <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(formula, <span class="at">data =</span> data, <span class="at">importance =</span> <span class="cn">TRUE</span>, <span class="at">ntree =</span> ntree)</span>
<span id="cb20-2107"><a href="#cb20-2107" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-2108"><a href="#cb20-2108" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Store performance</span></span>
<span id="cb20-2109"><a href="#cb20-2109" aria-hidden="true" tabindex="-1"></a>    model_perf <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb20-2110"><a href="#cb20-2110" aria-hidden="true" tabindex="-1"></a>      <span class="at">predictors =</span> current_predictors,</span>
<span id="cb20-2111"><a href="#cb20-2111" aria-hidden="true" tabindex="-1"></a>      <span class="at">var_explained =</span> rf_model<span class="sc">$</span>rsq[<span class="fu">length</span>(rf_model<span class="sc">$</span>rsq)] <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb20-2112"><a href="#cb20-2112" aria-hidden="true" tabindex="-1"></a>      <span class="at">mse =</span> rf_model<span class="sc">$</span>mse[<span class="fu">length</span>(rf_model<span class="sc">$</span>mse)],</span>
<span id="cb20-2113"><a href="#cb20-2113" aria-hidden="true" tabindex="-1"></a>      <span class="at">importance =</span> <span class="fu">importance</span>(rf_model)[, <span class="st">"%IncMSE"</span>]</span>
<span id="cb20-2114"><a href="#cb20-2114" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb20-2115"><a href="#cb20-2115" aria-hidden="true" tabindex="-1"></a>    results[[<span class="fu">length</span>(results) <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">&lt;-</span> model_perf</span>
<span id="cb20-2116"><a href="#cb20-2116" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-2117"><a href="#cb20-2117" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (verbose) {</span>
<span id="cb20-2118"><a href="#cb20-2118" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Variables:"</span>, <span class="fu">paste</span>(current_predictors, <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb20-2119"><a href="#cb20-2119" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\t</span><span class="st">% Var Explained:"</span>, <span class="fu">round</span>(model_perf<span class="sc">$</span>var_explained, <span class="dv">2</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb20-2120"><a href="#cb20-2120" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-2121"><a href="#cb20-2121" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-2122"><a href="#cb20-2122" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Drop least important predictor</span></span>
<span id="cb20-2123"><a href="#cb20-2123" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(current_predictors) <span class="sc">&gt;</span> min_vars) {</span>
<span id="cb20-2124"><a href="#cb20-2124" aria-hidden="true" tabindex="-1"></a>      least_important <span class="ot">&lt;-</span> <span class="fu">names</span>(<span class="fu">which.min</span>(model_perf<span class="sc">$</span>importance))</span>
<span id="cb20-2125"><a href="#cb20-2125" aria-hidden="true" tabindex="-1"></a>      current_predictors <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(current_predictors, least_important)</span>
<span id="cb20-2126"><a href="#cb20-2126" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb20-2127"><a href="#cb20-2127" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span></span>
<span id="cb20-2128"><a href="#cb20-2128" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-2129"><a href="#cb20-2129" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-2130"><a href="#cb20-2130" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results)</span>
<span id="cb20-2131"><a href="#cb20-2131" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-2132"><a href="#cb20-2132" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-2133"><a href="#cb20-2133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-2134"><a href="#cb20-2134" aria-hidden="true" tabindex="-1"></a><span class="fu">## Model Validation</span></span>
<span id="cb20-2135"><a href="#cb20-2135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-2136"><a href="#cb20-2136" aria-hidden="true" tabindex="-1"></a>I used several diagnostic tools to assess the performance and reliability of the final random forest model.</span>
<span id="cb20-2137"><a href="#cb20-2137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-2138"><a href="#cb20-2138" aria-hidden="true" tabindex="-1"></a><span class="fu">### Coefficient of Determination</span></span>
<span id="cb20-2139"><a href="#cb20-2139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-2140"><a href="#cb20-2140" aria-hidden="true" tabindex="-1"></a>After selecting the final model through backward elimination, I fit the model to a 70/30 train-test split to evaluate its performance. I calculated the test set $R^2$ and RMSE to measure how well the model generalizes to unseen data. This was done using the function below.</span>
<span id="cb20-2143"><a href="#cb20-2143" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb20-2144"><a href="#cb20-2144" aria-hidden="true" tabindex="-1"></a><span class="co">#' Fit Random Forest Model with Train-Test Split and Evaluate Performance</span></span>
<span id="cb20-2145"><a href="#cb20-2145" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-2146"><a href="#cb20-2146" aria-hidden="true" tabindex="-1"></a><span class="co">#' Splits the data into training (70%) and testing (30%) sets, fits a random forest model on the training set,</span></span>
<span id="cb20-2147"><a href="#cb20-2147" aria-hidden="true" tabindex="-1"></a><span class="co">#' and evaluates performance on the test set. Returns the fitted model, predictions, performance metrics, and variable importance.</span></span>
<span id="cb20-2148"><a href="#cb20-2148" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-2149"><a href="#cb20-2149" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param data Data frame containing the response and predictor variables.</span></span>
<span id="cb20-2150"><a href="#cb20-2150" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param formula A formula object specifying the model (e.g., response ~ predictors).</span></span>
<span id="cb20-2151"><a href="#cb20-2151" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-2152"><a href="#cb20-2152" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A list containing:</span></span>
<span id="cb20-2153"><a href="#cb20-2153" aria-hidden="true" tabindex="-1"></a><span class="co">#' \item{model}{The fitted random forest model object.}</span></span>
<span id="cb20-2154"><a href="#cb20-2154" aria-hidden="true" tabindex="-1"></a><span class="co">#' \item{r_squared}{R-squared value on the test data.}</span></span>
<span id="cb20-2155"><a href="#cb20-2155" aria-hidden="true" tabindex="-1"></a><span class="co">#' \item{rmse}{Root Mean Squared Error on the test data.}</span></span>
<span id="cb20-2156"><a href="#cb20-2156" aria-hidden="true" tabindex="-1"></a><span class="co">#' \item{predictions}{Predicted values on the test data.}</span></span>
<span id="cb20-2157"><a href="#cb20-2157" aria-hidden="true" tabindex="-1"></a><span class="co">#' \item{test_data}{The subset of data used as the test set.}</span></span>
<span id="cb20-2158"><a href="#cb20-2158" aria-hidden="true" tabindex="-1"></a><span class="co">#' \item{importance}{Variable importance scores from the fitted model.}</span></span>
<span id="cb20-2159"><a href="#cb20-2159" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb20-2160"><a href="#cb20-2160" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb20-2161"><a href="#cb20-2161" aria-hidden="true" tabindex="-1"></a>fit_rf_model <span class="ot">&lt;-</span> <span class="cf">function</span>(data, formula) {</span>
<span id="cb20-2162"><a href="#cb20-2162" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(SEED)</span>
<span id="cb20-2163"><a href="#cb20-2163" aria-hidden="true" tabindex="-1"></a>  sample_size <span class="ot">&lt;-</span> <span class="fu">floor</span>(<span class="fl">0.7</span> <span class="sc">*</span> <span class="fu">nrow</span>(data))</span>
<span id="cb20-2164"><a href="#cb20-2164" aria-hidden="true" tabindex="-1"></a>  train_idx <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">seq_len</span>(<span class="fu">nrow</span>(data)), <span class="at">size =</span> sample_size)</span>
<span id="cb20-2165"><a href="#cb20-2165" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-2166"><a href="#cb20-2166" aria-hidden="true" tabindex="-1"></a>  train_data <span class="ot">&lt;-</span> data[train_idx, ]</span>
<span id="cb20-2167"><a href="#cb20-2167" aria-hidden="true" tabindex="-1"></a>  test_data <span class="ot">&lt;-</span> data[<span class="sc">-</span>train_idx, ]</span>
<span id="cb20-2168"><a href="#cb20-2168" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-2169"><a href="#cb20-2169" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(formula, <span class="at">data =</span> train_data, <span class="at">ntree =</span> <span class="dv">500</span>, <span class="at">importance =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-2170"><a href="#cb20-2170" aria-hidden="true" tabindex="-1"></a>  predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, <span class="at">newdata =</span> test_data)</span>
<span id="cb20-2171"><a href="#cb20-2171" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-2172"><a href="#cb20-2172" aria-hidden="true" tabindex="-1"></a>  r_squared <span class="ot">&lt;-</span> <span class="fu">cor</span>(predictions, test_data<span class="sc">$</span>response)<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb20-2173"><a href="#cb20-2173" aria-hidden="true" tabindex="-1"></a>  rmse <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>((predictions <span class="sc">-</span> test_data<span class="sc">$</span>response)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb20-2174"><a href="#cb20-2174" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-2175"><a href="#cb20-2175" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-2176"><a href="#cb20-2176" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-2177"><a href="#cb20-2177" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">model =</span> model, <span class="at">r_squared =</span> r_squared, <span class="at">rmse =</span> rmse, <span class="at">predictions =</span> predictions, <span class="at">test_data =</span> test_data, <span class="at">importance =</span> model<span class="sc">$</span>importance)</span>
<span id="cb20-2178"><a href="#cb20-2178" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-2179"><a href="#cb20-2179" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-2180"><a href="#cb20-2180" aria-hidden="true" tabindex="-1"></a>In this analysis, the test set $R^2 = 0.8981$, and the RMSE = 18661.07. This indicates that the final random forest model explains approximately 89.8% of the variance in median real estate sale prices on unseen data. The relatively low RMSE suggests that the typical prediction error is within a reasonable range, given the scale of home prices in Connecticut. </span>
<span id="cb20-2181"><a href="#cb20-2181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-2182"><a href="#cb20-2182" aria-hidden="true" tabindex="-1"></a><span class="fu">### Residual Plots</span></span>
<span id="cb20-2183"><a href="#cb20-2183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-2184"><a href="#cb20-2184" aria-hidden="true" tabindex="-1"></a><span class="al">![](figs/median_sale_price/residuals_vs_predicted_plot.png)</span></span>
<span id="cb20-2185"><a href="#cb20-2185" aria-hidden="true" tabindex="-1"></a>A good model should show residuals randomly scattered around zero, with no clear patterns or heteroscedasticity. In this residuals vs. predicted values plot, the residuals appear roughly centered around zero, suggesting that the model is not systematically over- or under-predicting.</span>
<span id="cb20-2186"><a href="#cb20-2186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-2187"><a href="#cb20-2187" aria-hidden="true" tabindex="-1"></a>The main pipeline function, <span class="in">`run_rf_pipeline()`</span>, for the complete statistical analysis--from Box-Cox transformations to model diagnostics--and its associated helper functions are found in the code below:</span>
<span id="cb20-2190"><a href="#cb20-2190" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb20-2191"><a href="#cb20-2191" aria-hidden="true" tabindex="-1"></a><span class="co">#' Print Summary and Diagnostics for a Random Forest Model</span></span>
<span id="cb20-2192"><a href="#cb20-2192" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-2193"><a href="#cb20-2193" aria-hidden="true" tabindex="-1"></a><span class="co">#' Displays the model formula, transformed predictor variable names, a summary of the random forest model,</span></span>
<span id="cb20-2194"><a href="#cb20-2194" aria-hidden="true" tabindex="-1"></a><span class="co">#' variable importance scores, and generates a variable importance plot.</span></span>
<span id="cb20-2195"><a href="#cb20-2195" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-2196"><a href="#cb20-2196" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param rf_model A fitted random forest model object.</span></span>
<span id="cb20-2197"><a href="#cb20-2197" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param formula The formula object used to fit the model.</span></span>
<span id="cb20-2198"><a href="#cb20-2198" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param data Data frame containing the transformed predictor variables.</span></span>
<span id="cb20-2199"><a href="#cb20-2199" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-2200"><a href="#cb20-2200" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return None (prints output and plot to console).</span></span>
<span id="cb20-2201"><a href="#cb20-2201" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb20-2202"><a href="#cb20-2202" aria-hidden="true" tabindex="-1"></a>inspect_rf_model <span class="ot">&lt;-</span> <span class="cf">function</span>(rf_model, formula, data) {</span>
<span id="cb20-2203"><a href="#cb20-2203" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Model formula used:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb20-2204"><a href="#cb20-2204" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(formula)</span>
<span id="cb20-2205"><a href="#cb20-2205" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-2206"><a href="#cb20-2206" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Transformed predictor variables:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb20-2207"><a href="#cb20-2207" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">colnames</span>(data))</span>
<span id="cb20-2208"><a href="#cb20-2208" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-2209"><a href="#cb20-2209" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Random Forest Summary:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb20-2210"><a href="#cb20-2210" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(rf_model)</span>
<span id="cb20-2211"><a href="#cb20-2211" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-2212"><a href="#cb20-2212" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Variable Importance:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb20-2213"><a href="#cb20-2213" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">importance</span>(rf_model))</span>
<span id="cb20-2214"><a href="#cb20-2214" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-2215"><a href="#cb20-2215" aria-hidden="true" tabindex="-1"></a>  <span class="fu">varImpPlot</span>(rf_model, <span class="at">main =</span> <span class="st">"Variable Importance Plot"</span>)</span>
<span id="cb20-2216"><a href="#cb20-2216" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-2217"><a href="#cb20-2217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-2218"><a href="#cb20-2218" aria-hidden="true" tabindex="-1"></a><span class="co">#' Plot Predicted vs Actual Values and Residuals, Save Plots to File</span></span>
<span id="cb20-2219"><a href="#cb20-2219" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-2220"><a href="#cb20-2220" aria-hidden="true" tabindex="-1"></a><span class="co">#' Generates and saves scatter plots of predicted vs actual values and residuals vs predicted values for a random forest model.</span></span>
<span id="cb20-2221"><a href="#cb20-2221" aria-hidden="true" tabindex="-1"></a><span class="co">#' Also prints the plots to the console.</span></span>
<span id="cb20-2222"><a href="#cb20-2222" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-2223"><a href="#cb20-2223" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param predictions Numeric vector of predicted values from the model.</span></span>
<span id="cb20-2224"><a href="#cb20-2224" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param actuals Numeric vector of actual observed values.</span></span>
<span id="cb20-2225"><a href="#cb20-2225" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param save_dir Character string specifying the directory path to save the plots. Default is "figs/RESPONSE".</span></span>
<span id="cb20-2226"><a href="#cb20-2226" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-2227"><a href="#cb20-2227" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return Numeric vector of residuals (actuals - predictions).</span></span>
<span id="cb20-2228"><a href="#cb20-2228" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb20-2229"><a href="#cb20-2229" aria-hidden="true" tabindex="-1"></a>plot_rf_results <span class="ot">&lt;-</span> <span class="cf">function</span>(predictions, actuals, <span class="at">save_dir =</span> <span class="fu">file.path</span>(<span class="st">"figs"</span>,RESPONSE)) {</span>
<span id="cb20-2230"><a href="#cb20-2230" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">predicted =</span> predictions, <span class="at">actual =</span> actuals)</span>
<span id="cb20-2231"><a href="#cb20-2231" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>residuals <span class="ot">&lt;-</span> df<span class="sc">$</span>actual <span class="sc">-</span> df<span class="sc">$</span>predicted</span>
<span id="cb20-2232"><a href="#cb20-2232" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-2233"><a href="#cb20-2233" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create directory if it doesn't exist</span></span>
<span id="cb20-2234"><a href="#cb20-2234" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="fu">file.path</span>(save_dir))) {</span>
<span id="cb20-2235"><a href="#cb20-2235" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(save_dir)</span>
<span id="cb20-2236"><a href="#cb20-2236" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-2237"><a href="#cb20-2237" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-2238"><a href="#cb20-2238" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Predicted vs Actual plot</span></span>
<span id="cb20-2239"><a href="#cb20-2239" aria-hidden="true" tabindex="-1"></a>  p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">x =</span> actual, <span class="at">y =</span> predicted)) <span class="sc">+</span></span>
<span id="cb20-2240"><a href="#cb20-2240" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb20-2241"><a href="#cb20-2241" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_abline</span>(<span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb20-2242"><a href="#cb20-2242" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Predicted vs Actual"</span>, <span class="at">x =</span> <span class="st">"Actual"</span>, <span class="at">y =</span> <span class="st">"Predicted"</span>)</span>
<span id="cb20-2243"><a href="#cb20-2243" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-2244"><a href="#cb20-2244" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-2245"><a href="#cb20-2245" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Residuals vs Predicted plot</span></span>
<span id="cb20-2246"><a href="#cb20-2246" aria-hidden="true" tabindex="-1"></a>  p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">x =</span> predicted, <span class="at">y =</span> residuals)) <span class="sc">+</span></span>
<span id="cb20-2247"><a href="#cb20-2247" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">color =</span> <span class="st">"darkgreen"</span>) <span class="sc">+</span></span>
<span id="cb20-2248"><a href="#cb20-2248" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb20-2249"><a href="#cb20-2249" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Residuals vs Predicted"</span>, <span class="at">x =</span> <span class="st">"Predicted"</span>, <span class="at">y =</span> <span class="st">"Residuals"</span>)</span>
<span id="cb20-2250"><a href="#cb20-2250" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-2251"><a href="#cb20-2251" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-2252"><a href="#cb20-2252" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Save plots to the specified directory with descriptive names</span></span>
<span id="cb20-2253"><a href="#cb20-2253" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="fu">file.path</span>(save_dir, <span class="st">"predicted_vs_actual_plot.png"</span>), p1, <span class="at">width =</span> <span class="dv">8</span>, <span class="at">height =</span> <span class="dv">6</span>)</span>
<span id="cb20-2254"><a href="#cb20-2254" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="fu">file.path</span>(save_dir, <span class="st">"residuals_vs_predicted_plot.png"</span>), p2, <span class="at">width =</span> <span class="dv">8</span>, <span class="at">height =</span> <span class="dv">6</span>)</span>
<span id="cb20-2255"><a href="#cb20-2255" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-2256"><a href="#cb20-2256" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Print both plots</span></span>
<span id="cb20-2257"><a href="#cb20-2257" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(p1)</span>
<span id="cb20-2258"><a href="#cb20-2258" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(p2)</span>
<span id="cb20-2259"><a href="#cb20-2259" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-2260"><a href="#cb20-2260" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df<span class="sc">$</span>residuals)</span>
<span id="cb20-2261"><a href="#cb20-2261" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-2262"><a href="#cb20-2262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-2263"><a href="#cb20-2263" aria-hidden="true" tabindex="-1"></a><span class="co">#' Plot Residuals vs Each Predictor Variable, Save Plots to File</span></span>
<span id="cb20-2264"><a href="#cb20-2264" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-2265"><a href="#cb20-2265" aria-hidden="true" tabindex="-1"></a><span class="co">#' Creates and saves scatter plots showing residuals against each predictor variable to help diagnose model fit.</span></span>
<span id="cb20-2266"><a href="#cb20-2266" aria-hidden="true" tabindex="-1"></a><span class="co">#' Prints each plot to the console.</span></span>
<span id="cb20-2267"><a href="#cb20-2267" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-2268"><a href="#cb20-2268" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param predictions Numeric vector of predicted values from the model.</span></span>
<span id="cb20-2269"><a href="#cb20-2269" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param actuals Numeric vector of actual observed values.</span></span>
<span id="cb20-2270"><a href="#cb20-2270" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param data Data frame containing the predictor variables.</span></span>
<span id="cb20-2271"><a href="#cb20-2271" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param predictors Character vector of predictor variable names to plot residuals against.</span></span>
<span id="cb20-2272"><a href="#cb20-2272" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param save_dir Character string specifying the directory path to save the plots. Default is "figs".</span></span>
<span id="cb20-2273"><a href="#cb20-2273" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-2274"><a href="#cb20-2274" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return None (invisible NULL).</span></span>
<span id="cb20-2275"><a href="#cb20-2275" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb20-2276"><a href="#cb20-2276" aria-hidden="true" tabindex="-1"></a>plot_residuals_vs_predictors <span class="ot">&lt;-</span> <span class="cf">function</span>(predictions, actuals, data, predictors, <span class="at">save_dir =</span> <span class="st">"figs"</span>) {</span>
<span id="cb20-2277"><a href="#cb20-2277" aria-hidden="true" tabindex="-1"></a>  residuals <span class="ot">&lt;-</span> actuals <span class="sc">-</span> predictions</span>
<span id="cb20-2278"><a href="#cb20-2278" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">residuals =</span> residuals)</span>
<span id="cb20-2279"><a href="#cb20-2279" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">cbind</span>(df, data[, predictors, <span class="at">drop =</span> <span class="cn">FALSE</span>])</span>
<span id="cb20-2280"><a href="#cb20-2280" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-2281"><a href="#cb20-2281" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create directory if it doesn't exist</span></span>
<span id="cb20-2282"><a href="#cb20-2282" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(save_dir)) {</span>
<span id="cb20-2283"><a href="#cb20-2283" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(save_dir)</span>
<span id="cb20-2284"><a href="#cb20-2284" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-2285"><a href="#cb20-2285" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-2286"><a href="#cb20-2286" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (predictor <span class="cf">in</span> predictors) {</span>
<span id="cb20-2287"><a href="#cb20-2287" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes_string</span>(<span class="at">x =</span> predictor, <span class="at">y =</span> <span class="st">"residuals"</span>)) <span class="sc">+</span></span>
<span id="cb20-2288"><a href="#cb20-2288" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">color =</span> <span class="st">"purple"</span>) <span class="sc">+</span></span>
<span id="cb20-2289"><a href="#cb20-2289" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb20-2290"><a href="#cb20-2290" aria-hidden="true" tabindex="-1"></a>      <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste</span>(<span class="st">"Residuals vs"</span>, predictor),</span>
<span id="cb20-2291"><a href="#cb20-2291" aria-hidden="true" tabindex="-1"></a>           <span class="at">x =</span> predictor, <span class="at">y =</span> <span class="st">"Residuals"</span>) <span class="sc">+</span></span>
<span id="cb20-2292"><a href="#cb20-2292" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_minimal</span>()</span>
<span id="cb20-2293"><a href="#cb20-2293" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-2294"><a href="#cb20-2294" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggsave</span>(<span class="fu">file.path</span>(save_dir, RESPONSE, <span class="fu">paste0</span>(<span class="st">"residuals_vs_"</span>, predictor, <span class="st">".png"</span>)),</span>
<span id="cb20-2295"><a href="#cb20-2295" aria-hidden="true" tabindex="-1"></a>           p, <span class="at">width =</span> <span class="dv">8</span>, <span class="at">height =</span> <span class="dv">6</span>)</span>
<span id="cb20-2296"><a href="#cb20-2296" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-2297"><a href="#cb20-2297" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(p)</span>
<span id="cb20-2298"><a href="#cb20-2298" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-2299"><a href="#cb20-2299" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-2300"><a href="#cb20-2300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-2301"><a href="#cb20-2301" aria-hidden="true" tabindex="-1"></a><span class="co">#' Run Full Random Forest Modeling Pipeline with Backward Elimination and Diagnostics</span></span>
<span id="cb20-2302"><a href="#cb20-2302" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-2303"><a href="#cb20-2303" aria-hidden="true" tabindex="-1"></a><span class="co">#' Executes the entire modeling workflow on the provided dataset, including:</span></span>
<span id="cb20-2304"><a href="#cb20-2304" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Filtering and transforming features</span></span>
<span id="cb20-2305"><a href="#cb20-2305" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Correlation check and optional variable removal</span></span>
<span id="cb20-2306"><a href="#cb20-2306" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Random forest modeling with backward elimination based on variable importance (%IncMSE)</span></span>
<span id="cb20-2307"><a href="#cb20-2307" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Selection of best model balancing explained variance and parsimony</span></span>
<span id="cb20-2308"><a href="#cb20-2308" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Model fitting and performance evaluation on test data</span></span>
<span id="cb20-2309"><a href="#cb20-2309" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Generation and saving of partial dependence plots</span></span>
<span id="cb20-2310"><a href="#cb20-2310" aria-hidden="true" tabindex="-1"></a><span class="co">#' - Plotting residual diagnostics and saving results</span></span>
<span id="cb20-2311"><a href="#cb20-2311" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-2312"><a href="#cb20-2312" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param data Data frame containing the input data, including response and predictor variables.</span></span>
<span id="cb20-2313"><a href="#cb20-2313" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb20-2314"><a href="#cb20-2314" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A list containing:</span></span>
<span id="cb20-2315"><a href="#cb20-2315" aria-hidden="true" tabindex="-1"></a><span class="co">#' \item{model}{The final fitted random forest model object.}</span></span>
<span id="cb20-2316"><a href="#cb20-2316" aria-hidden="true" tabindex="-1"></a><span class="co">#' \item{outliers}{Data frame of test set observations with large residuals (absolute residual &gt; 0.3).}</span></span>
<span id="cb20-2317"><a href="#cb20-2317" aria-hidden="true" tabindex="-1"></a><span class="co">#' \item{backward_results}{List of results from the backward elimination process.}</span></span>
<span id="cb20-2318"><a href="#cb20-2318" aria-hidden="true" tabindex="-1"></a><span class="co">#' \item{importance}{Variable importance scores from the final model.}</span></span>
<span id="cb20-2319"><a href="#cb20-2319" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb20-2320"><a href="#cb20-2320" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb20-2321"><a href="#cb20-2321" aria-hidden="true" tabindex="-1"></a>run_rf_pipeline <span class="ot">&lt;-</span> <span class="cf">function</span>(data) {</span>
<span id="cb20-2322"><a href="#cb20-2322" aria-hidden="true" tabindex="-1"></a>  corr_threshold <span class="ot">&lt;-</span> CORR_THRESHOLD</span>
<span id="cb20-2323"><a href="#cb20-2323" aria-hidden="true" tabindex="-1"></a>  numeric_predictors <span class="ot">&lt;-</span> NUMERIC_PREDICTORS</span>
<span id="cb20-2324"><a href="#cb20-2324" aria-hidden="true" tabindex="-1"></a>  factor_predictors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"population_class"</span>)</span>
<span id="cb20-2325"><a href="#cb20-2325" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-2326"><a href="#cb20-2326" aria-hidden="true" tabindex="-1"></a>  clean_data <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span></span>
<span id="cb20-2327"><a href="#cb20-2327" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(</span>
<span id="cb20-2328"><a href="#cb20-2328" aria-hidden="true" tabindex="-1"></a>      <span class="fu">if_all</span>(<span class="fu">all_of</span>(numeric_predictors), <span class="sc">~</span> <span class="sc">!</span><span class="fu">is.na</span>(.) <span class="sc">&amp;</span> . <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb20-2329"><a href="#cb20-2329" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb20-2330"><a href="#cb20-2330" aria-hidden="true" tabindex="-1"></a>    <span class="fu">transform_features</span>() <span class="sc">|&gt;</span></span>
<span id="cb20-2331"><a href="#cb20-2331" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(</span>
<span id="cb20-2332"><a href="#cb20-2332" aria-hidden="true" tabindex="-1"></a>      response,</span>
<span id="cb20-2333"><a href="#cb20-2333" aria-hidden="true" tabindex="-1"></a>      <span class="fu">all_of</span>(<span class="fu">paste0</span>(<span class="st">"bc_transformed_"</span>, numeric_predictors)),</span>
<span id="cb20-2334"><a href="#cb20-2334" aria-hidden="true" tabindex="-1"></a>      <span class="fu">all_of</span>(factor_predictors)</span>
<span id="cb20-2335"><a href="#cb20-2335" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb20-2336"><a href="#cb20-2336" aria-hidden="true" tabindex="-1"></a>    <span class="fu">na.omit</span>()</span>
<span id="cb20-2337"><a href="#cb20-2337" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-2338"><a href="#cb20-2338" aria-hidden="true" tabindex="-1"></a>  predictors <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">paste0</span>(<span class="st">"bc_transformed_"</span>, numeric_predictors), <span class="st">"population_class"</span>)</span>
<span id="cb20-2339"><a href="#cb20-2339" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-2340"><a href="#cb20-2340" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- CORRELATION CHECK ---</span></span>
<span id="cb20-2341"><a href="#cb20-2341" aria-hidden="true" tabindex="-1"></a>  numeric_data <span class="ot">&lt;-</span> clean_data <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="fu">all_of</span>(<span class="fu">paste0</span>(<span class="st">"bc_transformed_"</span>, numeric_predictors)))</span>
<span id="cb20-2342"><a href="#cb20-2342" aria-hidden="true" tabindex="-1"></a>  cor_matrix <span class="ot">&lt;-</span> <span class="fu">cor</span>(numeric_data)</span>
<span id="cb20-2343"><a href="#cb20-2343" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-2344"><a href="#cb20-2344" aria-hidden="true" tabindex="-1"></a>  high_corr_pairs <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">abs</span>(cor_matrix) <span class="sc">&gt;</span> corr_threshold <span class="sc">&amp;</span> <span class="fu">upper.tri</span>(cor_matrix), <span class="at">arr.ind =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-2345"><a href="#cb20-2345" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-2346"><a href="#cb20-2346" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(high_corr_pairs) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb20-2347"><a href="#cb20-2347" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Highly correlated predictors found:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb20-2348"><a href="#cb20-2348" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(high_corr_pairs))) {</span>
<span id="cb20-2349"><a href="#cb20-2349" aria-hidden="true" tabindex="-1"></a>      var1 <span class="ot">&lt;-</span> <span class="fu">rownames</span>(cor_matrix)[high_corr_pairs[i, <span class="dv">1</span>]]</span>
<span id="cb20-2350"><a href="#cb20-2350" aria-hidden="true" tabindex="-1"></a>      var2 <span class="ot">&lt;-</span> <span class="fu">colnames</span>(cor_matrix)[high_corr_pairs[i, <span class="dv">2</span>]]</span>
<span id="cb20-2351"><a href="#cb20-2351" aria-hidden="true" tabindex="-1"></a>      corr_val <span class="ot">&lt;-</span> cor_matrix[high_corr_pairs[i, <span class="dv">1</span>], high_corr_pairs[i, <span class="dv">2</span>]]</span>
<span id="cb20-2352"><a href="#cb20-2352" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  - %s and %s (cor = %.2f)</span><span class="sc">\n</span><span class="st">"</span>, var1, var2, corr_val))</span>
<span id="cb20-2353"><a href="#cb20-2353" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-2354"><a href="#cb20-2354" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-2355"><a href="#cb20-2355" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Consider dropping one variable from each highly correlated pair.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb20-2356"><a href="#cb20-2356" aria-hidden="true" tabindex="-1"></a>    drop_vars <span class="ot">&lt;-</span> <span class="fu">readline</span>(<span class="at">prompt =</span> <span class="st">"Enter comma-separated variables to drop (or press Enter to skip): "</span>)</span>
<span id="cb20-2357"><a href="#cb20-2357" aria-hidden="true" tabindex="-1"></a>    drop_vars <span class="ot">&lt;-</span> <span class="fu">trimws</span>(<span class="fu">strsplit</span>(drop_vars, <span class="st">","</span>)[[<span class="dv">1</span>]])</span>
<span id="cb20-2358"><a href="#cb20-2358" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-2359"><a href="#cb20-2359" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(drop_vars) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> <span class="fu">any</span>(<span class="fu">nzchar</span>(drop_vars))){</span>
<span id="cb20-2360"><a href="#cb20-2360" aria-hidden="true" tabindex="-1"></a>      predictors <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(predictors, drop_vars)</span>
<span id="cb20-2361"><a href="#cb20-2361" aria-hidden="true" tabindex="-1"></a>      clean_data <span class="ot">&lt;-</span> clean_data <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span><span class="fu">all_of</span>(drop_vars))</span>
<span id="cb20-2362"><a href="#cb20-2362" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-2363"><a href="#cb20-2363" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb20-2364"><a href="#cb20-2364" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"No highly correlated predictor pairs found above the threshold.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb20-2365"><a href="#cb20-2365" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-2366"><a href="#cb20-2366" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Run backward elimination</span></span>
<span id="cb20-2367"><a href="#cb20-2367" aria-hidden="true" tabindex="-1"></a>  elim_results <span class="ot">&lt;-</span> <span class="fu">backward_elimination_rf</span>(</span>
<span id="cb20-2368"><a href="#cb20-2368" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> clean_data,</span>
<span id="cb20-2369"><a href="#cb20-2369" aria-hidden="true" tabindex="-1"></a>    <span class="at">response =</span> RESPONSE,</span>
<span id="cb20-2370"><a href="#cb20-2370" aria-hidden="true" tabindex="-1"></a>    <span class="at">predictors =</span> predictors,</span>
<span id="cb20-2371"><a href="#cb20-2371" aria-hidden="true" tabindex="-1"></a>    <span class="at">min_vars =</span> <span class="dv">3</span>,</span>
<span id="cb20-2372"><a href="#cb20-2372" aria-hidden="true" tabindex="-1"></a>    <span class="at">ntree =</span> <span class="dv">5000</span>,</span>
<span id="cb20-2373"><a href="#cb20-2373" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="cn">TRUE</span></span>
<span id="cb20-2374"><a href="#cb20-2374" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb20-2375"><a href="#cb20-2375" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-2376"><a href="#cb20-2376" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Choose the best model: prioritize high var_explained and fewest predictors</span></span>
<span id="cb20-2377"><a href="#cb20-2377" aria-hidden="true" tabindex="-1"></a>  best_model_idx <span class="ot">&lt;-</span> <span class="fu">which.max</span>(<span class="fu">map_dbl</span>(elim_results, <span class="st">"var_explained"</span>))</span>
<span id="cb20-2378"><a href="#cb20-2378" aria-hidden="true" tabindex="-1"></a>  best_model <span class="ot">&lt;-</span> elim_results[[best_model_idx]]</span>
<span id="cb20-2379"><a href="#cb20-2379" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-2380"><a href="#cb20-2380" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If there are multiple models with the same variance explained, choose the one with fewer predictors</span></span>
<span id="cb20-2381"><a href="#cb20-2381" aria-hidden="true" tabindex="-1"></a>  best_model_with_fewest_predictors <span class="ot">&lt;-</span> best_model</span>
<span id="cb20-2382"><a href="#cb20-2382" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(elim_results)) {</span>
<span id="cb20-2383"><a href="#cb20-2383" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (elim_results[[i]]<span class="sc">$</span>var_explained <span class="sc">==</span> best_model<span class="sc">$</span>var_explained) {</span>
<span id="cb20-2384"><a href="#cb20-2384" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">length</span>(elim_results[[i]]<span class="sc">$</span>predictors) <span class="sc">&lt;</span> <span class="fu">length</span>(best_model<span class="sc">$</span>predictors)) {</span>
<span id="cb20-2385"><a href="#cb20-2385" aria-hidden="true" tabindex="-1"></a>        best_model_with_fewest_predictors <span class="ot">&lt;-</span> elim_results[[i]]</span>
<span id="cb20-2386"><a href="#cb20-2386" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb20-2387"><a href="#cb20-2387" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-2388"><a href="#cb20-2388" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-2389"><a href="#cb20-2389" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-2390"><a href="#cb20-2390" aria-hidden="true" tabindex="-1"></a>  final_predictors <span class="ot">&lt;-</span> best_model_with_fewest_predictors<span class="sc">$</span>predictors</span>
<span id="cb20-2391"><a href="#cb20-2391" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-2392"><a href="#cb20-2392" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Final predictors used:"</span>, <span class="fu">paste</span>(final_predictors, <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb20-2393"><a href="#cb20-2393" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-2394"><a href="#cb20-2394" aria-hidden="true" tabindex="-1"></a>  formula <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(<span class="st">"response ~"</span>, <span class="fu">paste</span>(final_predictors, <span class="at">collapse =</span> <span class="st">" + "</span>)))</span>
<span id="cb20-2395"><a href="#cb20-2395" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-2396"><a href="#cb20-2396" aria-hidden="true" tabindex="-1"></a>  rf_results <span class="ot">&lt;-</span> <span class="fu">fit_rf_model</span>(clean_data, formula)</span>
<span id="cb20-2397"><a href="#cb20-2397" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-2398"><a href="#cb20-2398" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Test R-squared:"</span>, <span class="fu">round</span>(rf_results<span class="sc">$</span>r_squared, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb20-2399"><a href="#cb20-2399" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Test RMSE:"</span>, <span class="fu">round</span>(rf_results<span class="sc">$</span>rmse, <span class="dv">2</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb20-2400"><a href="#cb20-2400" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-2401"><a href="#cb20-2401" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Partial Dependence Plot for retirement proportion ---</span></span>
<span id="cb20-2402"><a href="#cb20-2402" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-2403"><a href="#cb20-2403" aria-hidden="true" tabindex="-1"></a>  <span class="co"># List of variables you want to include in the grid</span></span>
<span id="cb20-2404"><a href="#cb20-2404" aria-hidden="true" tabindex="-1"></a>  top_vars <span class="ot">&lt;-</span> <span class="fu">rownames</span>(<span class="fu">as.data.frame</span>(<span class="fu">importance</span>(rf_results<span class="sc">$</span>model, <span class="at">type =</span> <span class="dv">1</span>)))</span>
<span id="cb20-2405"><a href="#cb20-2405" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-2406"><a href="#cb20-2406" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create PDPs for each variable and combine them</span></span>
<span id="cb20-2407"><a href="#cb20-2407" aria-hidden="true" tabindex="-1"></a>  pdp_list <span class="ot">&lt;-</span> <span class="fu">map</span>(top_vars, <span class="cf">function</span>(var) {</span>
<span id="cb20-2408"><a href="#cb20-2408" aria-hidden="true" tabindex="-1"></a>    pd <span class="ot">&lt;-</span> pdp<span class="sc">::</span><span class="fu">partial</span>(</span>
<span id="cb20-2409"><a href="#cb20-2409" aria-hidden="true" tabindex="-1"></a>      <span class="at">object =</span> rf_results<span class="sc">$</span>model,</span>
<span id="cb20-2410"><a href="#cb20-2410" aria-hidden="true" tabindex="-1"></a>      <span class="at">pred.var =</span> var,</span>
<span id="cb20-2411"><a href="#cb20-2411" aria-hidden="true" tabindex="-1"></a>      <span class="at">train =</span> clean_data <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="fu">all_of</span>(top_vars),response),</span>
<span id="cb20-2412"><a href="#cb20-2412" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot =</span> <span class="cn">FALSE</span></span>
<span id="cb20-2413"><a href="#cb20-2413" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb20-2414"><a href="#cb20-2414" aria-hidden="true" tabindex="-1"></a>    pd<span class="sc">$</span>variable <span class="ot">&lt;-</span> var</span>
<span id="cb20-2415"><a href="#cb20-2415" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(pd)</span>
<span id="cb20-2416"><a href="#cb20-2416" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb20-2417"><a href="#cb20-2417" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-2418"><a href="#cb20-2418" aria-hidden="true" tabindex="-1"></a>  pdp_df <span class="ot">=</span> <span class="fu">data.frame</span>()</span>
<span id="cb20-2419"><a href="#cb20-2419" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (list_item <span class="cf">in</span> pdp_list){</span>
<span id="cb20-2420"><a href="#cb20-2420" aria-hidden="true" tabindex="-1"></a>    df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(list_item)</span>
<span id="cb20-2421"><a href="#cb20-2421" aria-hidden="true" tabindex="-1"></a>    pred <span class="ot">&lt;-</span> </span>
<span id="cb20-2422"><a href="#cb20-2422" aria-hidden="true" tabindex="-1"></a>      df <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="fu">matches</span>(<span class="st">"bc_transformed"</span>)) <span class="sc">|&gt;</span> <span class="fu">colnames</span>()</span>
<span id="cb20-2423"><a href="#cb20-2423" aria-hidden="true" tabindex="-1"></a>    df <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span> </span>
<span id="cb20-2424"><a href="#cb20-2424" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">x =</span> pred)</span>
<span id="cb20-2425"><a href="#cb20-2425" aria-hidden="true" tabindex="-1"></a>    pdp_df <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(pdp_df, df)</span>
<span id="cb20-2426"><a href="#cb20-2426" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-2427"><a href="#cb20-2427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-2428"><a href="#cb20-2428" aria-hidden="true" tabindex="-1"></a>  pdp_df <span class="ot">&lt;-</span> pdp_df <span class="sc">|&gt;</span></span>
<span id="cb20-2429"><a href="#cb20-2429" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb20-2430"><a href="#cb20-2430" aria-hidden="true" tabindex="-1"></a>      <span class="at">variable =</span> variable <span class="sc">|&gt;</span> </span>
<span id="cb20-2431"><a href="#cb20-2431" aria-hidden="true" tabindex="-1"></a>        <span class="fu">str_remove</span>(<span class="st">"bc_transformed_"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb20-2432"><a href="#cb20-2432" aria-hidden="true" tabindex="-1"></a>        <span class="fu">str_replace_all</span>(<span class="st">"_"</span>, <span class="st">" "</span>) <span class="sc">|&gt;</span> </span>
<span id="cb20-2433"><a href="#cb20-2433" aria-hidden="true" tabindex="-1"></a>        <span class="fu">str_to_sentence</span>() <span class="sc">|&gt;</span> </span>
<span id="cb20-2434"><a href="#cb20-2434" aria-hidden="true" tabindex="-1"></a>        <span class="fu">str_replace</span>(<span class="st">"gdp"</span>, <span class="st">"GDP"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb20-2435"><a href="#cb20-2435" aria-hidden="true" tabindex="-1"></a>        <span class="fu">str_replace</span>(<span class="st">"proportion"</span>, <span class="st">"income (%)"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb20-2436"><a href="#cb20-2436" aria-hidden="true" tabindex="-1"></a>        <span class="fu">str_replace</span>(<span class="st">"Per capita"</span>, <span class="st">"Per-capita"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb20-2437"><a href="#cb20-2437" aria-hidden="true" tabindex="-1"></a>        <span class="fu">str_replace</span>(<span class="st">"Wage salary"</span>, <span class="st">"Wages and salary"</span>)</span>
<span id="cb20-2438"><a href="#cb20-2438" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb20-2439"><a href="#cb20-2439" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-2440"><a href="#cb20-2440" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot using facet_wrap</span></span>
<span id="cb20-2441"><a href="#cb20-2441" aria-hidden="true" tabindex="-1"></a>  pdp_plot_grid <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(pdp_df, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> yhat <span class="sc">/</span> <span class="dv">1000</span>)) <span class="sc">+</span> </span>
<span id="cb20-2442"><a href="#cb20-2442" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"steelblue"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb20-2443"><a href="#cb20-2443" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span> variable, <span class="at">scales =</span> <span class="st">"free_x"</span>) <span class="sc">+</span></span>
<span id="cb20-2444"><a href="#cb20-2444" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb20-2445"><a href="#cb20-2445" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Predictor Value (transformed)"</span>,</span>
<span id="cb20-2446"><a href="#cb20-2446" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Predicted Median Sale Price ($K)"</span>, </span>
<span id="cb20-2447"><a href="#cb20-2447" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Partial Dependence Plots"</span></span>
<span id="cb20-2448"><a href="#cb20-2448" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb20-2449"><a href="#cb20-2449" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> <span class="fu">label_dollar</span>(<span class="at">suffix =</span> <span class="st">"K"</span>, <span class="at">prefix =</span> <span class="st">"$"</span>, <span class="at">accuracy =</span> <span class="dv">1</span>)) <span class="sc">+</span> </span>
<span id="cb20-2450"><a href="#cb20-2450" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span>
<span id="cb20-2451"><a href="#cb20-2451" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-2452"><a href="#cb20-2452" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Save the grid plot</span></span>
<span id="cb20-2453"><a href="#cb20-2453" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="st">"figs/pdp_grid.png"</span>, pdp_plot_grid, <span class="at">width =</span> <span class="dv">10</span>, <span class="at">height =</span> <span class="dv">6</span>)</span>
<span id="cb20-2454"><a href="#cb20-2454" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-2455"><a href="#cb20-2455" aria-hidden="true" tabindex="-1"></a>  residuals <span class="ot">&lt;-</span> <span class="fu">plot_rf_results</span>(rf_results<span class="sc">$</span>predictions, rf_results<span class="sc">$</span>test_data<span class="sc">$</span>response)</span>
<span id="cb20-2456"><a href="#cb20-2456" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-2457"><a href="#cb20-2457" aria-hidden="true" tabindex="-1"></a>  outliers <span class="ot">&lt;-</span> rf_results<span class="sc">$</span>test_data[<span class="fu">abs</span>(residuals) <span class="sc">&gt;</span> <span class="fl">0.3</span>, ]</span>
<span id="cb20-2458"><a href="#cb20-2458" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-2459"><a href="#cb20-2459" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inspect_rf_model</span>(rf_results<span class="sc">$</span>model, formula, clean_data)</span>
<span id="cb20-2460"><a href="#cb20-2460" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-2461"><a href="#cb20-2461" aria-hidden="true" tabindex="-1"></a>  residuals <span class="ot">&lt;-</span> <span class="fu">plot_rf_results</span>(rf_results<span class="sc">$</span>predictions, rf_results<span class="sc">$</span>test_data<span class="sc">$</span>response)</span>
<span id="cb20-2462"><a href="#cb20-2462" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-2463"><a href="#cb20-2463" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot residuals vs each predictor</span></span>
<span id="cb20-2464"><a href="#cb20-2464" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_residuals_vs_predictors</span>(</span>
<span id="cb20-2465"><a href="#cb20-2465" aria-hidden="true" tabindex="-1"></a>    <span class="at">predictions =</span> rf_results<span class="sc">$</span>predictions,</span>
<span id="cb20-2466"><a href="#cb20-2466" aria-hidden="true" tabindex="-1"></a>    <span class="at">actuals =</span> rf_results<span class="sc">$</span>test_data<span class="sc">$</span>response,</span>
<span id="cb20-2467"><a href="#cb20-2467" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> rf_results<span class="sc">$</span>test_data,</span>
<span id="cb20-2468"><a href="#cb20-2468" aria-hidden="true" tabindex="-1"></a>    <span class="at">predictors =</span> final_predictors,</span>
<span id="cb20-2469"><a href="#cb20-2469" aria-hidden="true" tabindex="-1"></a>    <span class="at">save_dir =</span> <span class="st">"figs"</span></span>
<span id="cb20-2470"><a href="#cb20-2470" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb20-2471"><a href="#cb20-2471" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-2472"><a href="#cb20-2472" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">model =</span> rf_results<span class="sc">$</span>model, <span class="at">outliers =</span> outliers, <span class="at">backward_results =</span> elim_results, <span class="at">importance =</span> rf_results<span class="sc">$</span>importance))</span>
<span id="cb20-2473"><a href="#cb20-2473" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-2474"><a href="#cb20-2474" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-2475"><a href="#cb20-2475" aria-hidden="true" tabindex="-1"></a>The final model is:</span>
<span id="cb20-2476"><a href="#cb20-2476" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-2477"><a href="#cb20-2477" aria-hidden="true" tabindex="-1"></a><span class="in">Random Forest Summary:</span></span>
<span id="cb20-2478"><a href="#cb20-2478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-2479"><a href="#cb20-2479" aria-hidden="true" tabindex="-1"></a><span class="in">Call:</span></span>
<span id="cb20-2480"><a href="#cb20-2480" aria-hidden="true" tabindex="-1"></a><span class="in"> randomForest(formula = formula, data = train_data, ntree = 500,      importance = TRUE) </span></span>
<span id="cb20-2481"><a href="#cb20-2481" aria-hidden="true" tabindex="-1"></a><span class="in">               Type of random forest: regression</span></span>
<span id="cb20-2482"><a href="#cb20-2482" aria-hidden="true" tabindex="-1"></a><span class="in">                     Number of trees: 500</span></span>
<span id="cb20-2483"><a href="#cb20-2483" aria-hidden="true" tabindex="-1"></a><span class="in">No. of variables tried at each split: 2</span></span>
<span id="cb20-2484"><a href="#cb20-2484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-2485"><a href="#cb20-2485" aria-hidden="true" tabindex="-1"></a><span class="in">          Mean of squared residuals: 735163952</span></span>
<span id="cb20-2486"><a href="#cb20-2486" aria-hidden="true" tabindex="-1"></a><span class="in">                    % Var explained: 85.77</span></span>
<span id="cb20-2487"><a href="#cb20-2487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-2488"><a href="#cb20-2488" aria-hidden="true" tabindex="-1"></a><span class="in">Variable Importance:</span></span>
<span id="cb20-2489"><a href="#cb20-2489" aria-hidden="true" tabindex="-1"></a><span class="in">                                                  %IncMSE IncNodePurity</span></span>
<span id="cb20-2490"><a href="#cb20-2490" aria-hidden="true" tabindex="-1"></a><span class="in">bc_transformed_per_capita_property_tax_revenues 12.503693   48364055442</span></span>
<span id="cb20-2491"><a href="#cb20-2491" aria-hidden="true" tabindex="-1"></a><span class="in">bc_transformed_per_capita_personal_income       13.373119   47956084292</span></span>
<span id="cb20-2492"><a href="#cb20-2492" aria-hidden="true" tabindex="-1"></a><span class="in">bc_transformed_per_capita_annual_debt_service   10.253276   34566690121</span></span>
<span id="cb20-2493"><a href="#cb20-2493" aria-hidden="true" tabindex="-1"></a><span class="in">bc_transformed_dividends_proportion             10.267172   42577015458</span></span>
<span id="cb20-2494"><a href="#cb20-2494" aria-hidden="true" tabindex="-1"></a><span class="in">bc_transformed_retirement_proportion            11.088946   47134800132</span></span>
<span id="cb20-2495"><a href="#cb20-2495" aria-hidden="true" tabindex="-1"></a><span class="in">bc_transformed_ui_comp_proportion                7.364885   11584204293</span></span>
<span id="cb20-2496"><a href="#cb20-2496" aria-hidden="true" tabindex="-1"></a><span class="in">bc_transformed_proprietors_income_proportion     6.634609   20111304578</span></span>
<span id="cb20-2497"><a href="#cb20-2497" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-2498"><a href="#cb20-2498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-2499"><a href="#cb20-2499" aria-hidden="true" tabindex="-1"></a><span class="fu"># Conclusion</span></span>
<span id="cb20-2500"><a href="#cb20-2500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-2501"><a href="#cb20-2501" aria-hidden="true" tabindex="-1"></a>Overall, the model diagnostics suggest that the final random forest model performs well in predicting median real estate sales prices across Connecticut counties. The high test set $R^2$ value and relatively low RMSE indicate strong predictive power and a good fit to the data. The residuals plot shows no major patterns or systematic bias, leading me to the conclusion that the model's errors are fairly random. These findings support the conclusion that county-level economic indicators are significant predictors of housing market outcomes. In particular, variables related to income levels, fiscal health, and employment conditions show strong correlations with real estate prices and shape property values across the state.</span>
<span id="cb20-2502"><a href="#cb20-2502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-2503"><a href="#cb20-2503" aria-hidden="true" tabindex="-1"></a>That said, the analysis is subject to a few limitations. Aggregating data to the county level considerably reduced the sample size and limited the model's ability to detect more granular patterns. Additionally, missing values in the original datasets required exclusion of certain observations, further reducing the sample size and potentially decreasing the robustness of the model. Future work could benefit from more detailed, town-level data and a wider temporal range to capture economic dynamics over time.</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>